\chapter{The Semantics of Separation Logic}

In this chapter, we'll describe the semantics of our separation logic.
Rather than working directly with the heap model of separation logic,
we will approach the semantics in a somewhat more modular
style. 

First, we'll define what we mean by ``semantics of separation logic''
in terms of \emph{BI algebras}, which give an algebraic semantics of
separation logic in the same way that the Heyting algebras give
semantics to intuitionistic logics. Then, we'll look at how we can
construct a BI-algebra from sets of elements of an arbitrary partial
commutative monoid, proving that we can satisfy each of the axioms of
a BI algebra.

Then, we'll conclude show that our predomain of heaps actually forms a
partial commutative monoid, which means that we can now apply the
theorems and definitions of the previous sections to immediately get the
heap model we want. 

\section{BI Algebras}

A \emph{BI algebra} is a Heyting algebra with additional residuated
monoidal structure to model the separating conjunction and wand. This
means that a BI algebra is a partial order $(B, \leq)$ with operations
$(\top, \land, \implies, \bot, \vee, I, *, \wand)$ satisfying:

\begin{enumerate}
\item $\forall p \in B.\; p \leq \top$
\item $\forall p \in B.\; \bot \leq p$
\item $\forall p,q,r \in B.$ if $r \leq p$ and $r \leq q$, then
      $r \leq p \land q$ and 
      $p \land q \leq p$ and $p \land q \leq q$
\item $\forall p,q,r \in B.$ if $p \leq r$ and $q \leq r$, then
      $p \vee q \leq r$ and
      $p \vee q \leq p$ and $p \vee q \leq q$.
\item $\forall p, q, r.\; p \land q \leq r \iff p \leq q \implies r$
\item $\forall p.\; p * I = p$
\item $\forall p, q.\; p * q = q * r$
\item $\forall p, q, r.\; (p * q) * r = p * (q * r)$
\item $\forall p, q, r.\; p * q \leq r \iff p \leq q \wand r$
\end{enumerate}

The first five conditions are just the usual conditions for a Heyting
algebra (that it have greatest and least elements, greatest lower
bounds and least upper bounds, and that it have an implication). The
next three are the monoid structure axioms, that say $I$ is the unit,
and that $*$ is commutative and associative. The last axiom asserts
the existence of a wand that is adjoint to the separating conjunction
the same way that the implication is adjoint to the ordinary
conjunction.

In addition, we'll also ask that this algebra be \emph{complete},
which means that meets and joins of arbitrary sets of elements be
well-defined.

\begin{enumerate}
\item[10.] $\forall r\in B, P \subseteq B.$ if $(\forall p \in P.\; r \leq p)$, then  
      $r \leq \bigwedge P $ and 
      $\forall p \in P.\; \bigwedge P \leq p$
\item[11.] $\forall r \in B, P \subseteq B.$ if $(\forall p \in P.\; p \leq r)$, then  
      $\bigvee P \leq r$ and 
      $\forall p \in P.\; p \leq \bigvee P$
\end{enumerate}

We'll eventually use completeness in order to interpret quantifiers as 
possibly-infinitary conjunctions or disjunctions. 


\subsection{Partial Commutative Monoids}

A partial commutative monoid is a triple $(M, e, \cdot)$, where 
$e \in M$, and $(\cdot)$ is a partial operation from $M \times M$ to 
$M$. We write $m \# m'$ to mean that $m$ and $m'$ are compatible -- 
that is, $\exists m''.\; m \cdot m' = m''$. Furthermore, the following
properties hold: 

\begin{itemize}
\item $e$ is a unit, so that $e \cdot m = m$. 
\item $\cdot$ is commutative. $m \cdot m' = m' \cdot m$, if defined.
\item $\cdot$ is associative. $m \cdot (m' \cdot m'') = (m \cdot m') \cdot m''$, if defined.
\end{itemize}

\begin{lemma}{(Disjointness Distributes)}
If $(m_1\cdot m_2) \# m_3$, then $m_1 \# m_3$ and $m_2 \# m_3$
\end{lemma}
\begin{proof}
Suppose $(m_1\cdot m_2) \# m_3$. Then, we know there is some $m = (m_1 \cdot m_2) \cdot m_3$. 
Then, by associativity and commutativity, we know that $m = (m_1 \cdot m_3) \cdot m_2$. If
it were the case that $m_1 \cdot m_3$ was not defined, then $m$ would not be defined, which
is a contradiction. Therefore $m_1 \# m_3$. Similarly, $m_2 \# m_3$. 
\end{proof}


\subsubsection{BI-Algebras over Partial Commutative Monoids}

Given a partial commutative monoid, we can show that the powerset $\powerset{M}$ 
forms a BI-algebra. 

\begin{lemma}{(Powersets of Partial Commutative Monoids)}
Given a partial commutative monoid $(M, e, \cdot)$, its powerset
$(\powerset{M}, \subseteq)$ forms a BI-algebra
with the following operations:

\begin{itemize}
\item $\top = M$
\item $p \land q = p \cap q$
\item $p \implies q = \setof{m \in M \;|\;\mbox{if }m \in p \mbox{ then } m \in q}$
\item $\bot = \emptyset$ 
\item $p \vee q = p \cup q$
\item $I = \setof{e}$
\item $p * q = \setof{m \in M\;|\; \exists m_1, m_2.\; 
                       m_1 \# m_2 \land m_1 \in p \land m_2 \in q \land m_1\cdot m_2 = m}$
\item $p \wand q = \{ m \in M \;|\; \forall m' \in p.\; \mbox{if } m \# m' \mbox{ then } m \cdot m' \in q \}$
\item $\bigwedge P = \bigcap P$ 
\item $\bigvee P = \bigcup P$
\end{itemize}
\end{lemma}


\begin{proof}
\begin{enumerate}
\item  We want to show $\forall p \in \powerset{M}.\; p \leq \top$
  \begin{tabbedproof}
        Assume $p \in \powerset{M}$ \\
    \oo By definition of powerset, we have $p \subseteq M$ \\
    \oo By definition of $\top$, we have $p \subseteq \top$ \\
    \oo By definition of $\leq$, we have $p \leq \top$ \\
  \end{tabbedproof}

\item We want to show $\forall p \in B.\; \bot \leq p$
  \begin{tabbedproof}
        Assume $p \in \powerset{M}$ \\ 
    \oo By definition of $\emptyset$, we have $\emptyset \subseteq p$ \\
    \oo By definition of $\bot$, $\leq$, we have $\bot \leq p$ \\
  \end{tabbedproof}

\item We want to show $\forall p,q,r \in \powerset{M}.$ if $r \leq p$ and $r \leq q$, then
      $r \leq p \land q$ and 
      $p \land q \leq p$ and $p \land q \leq q$

   \begin{tabbedproof}
      Assume $p,q,r \in \powerset{M}$ \\
      Assume $r \leq p$, $r \leq q$ \\[1em]

      \oo Expanding definition of $\leq$, we have $r \subseteq p$ and $r \subseteq q$ \\
      \oo By properties of $\cap$, we have $r \cap r \subseteq p \cap q$ \\
      \oo Hence $r \subseteq p \cap q$ \\
      \oo By definition of $\leq$ and $\land$, we have $r \leq p \land q$ \\[1em]
      \oo By properties of $\cap$, we have $p \cap q \subseteq p$ \\
      \oo By definition of $\leq$ and $\land$, we have $p \wedge q \leq p$ \\[1em]
      \oo By properties of $\cap$, we have $p \cap q \subseteq q$ \\
      \oo By definition of $\leq$ and $\land$, we have $p \wedge q \leq q$ \\
   \end{tabbedproof}

\item We want to show $\forall p,q,r \in \powerset{M}.$ if $p \leq r$ and $q \leq r$, then
      $p \vee q \leq r$ and
      $p \leq p \vee q$ and $q \leq p \vee q$.

  \begin{tabbedproof}
    Assume $p, q, r \in \powerset{M}$, $p \leq r$, $q \leq $ \\[1em]
    \oo By definition of $\leq$, we have $p \subseteq r$, $q \subseteq r$ \\
    \oo By set properties, we have $p \cup q \subseteq r$ \\
    \oo By definition of $\leq$, we have $p \vee q \leq r$ \\[1em]

    \oo By set properties we have $p \subseteq p \cup q$ \\
    \oo By definitions of $\leq$ and $\vee$, we have $p \leq p \vee q$ \\[1em]
  
    \oo By set properties, we have $q \subseteq p \cup q$ \\
    \oo By definitions of $\leq$ and $\vee$, we have  $q \leq p \vee q$ \\
  \end{tabbedproof}

\item We want to show $\forall p, q, r \in \powerset{M}.\; p \land q \leq r \iff p \leq q \implies r$

  \begin{tabbedproof}
    Assume $p,q,r \in \powerset{M}$ \\[1em]

    $\To$ direction: \\
    \oo Assume $p \land q \leq r$ \\
    \ooo By definitions of $\leq$ and $\land$, we have $p \cap q \subseteq r$ \\
    \ooo We want to show $p \leq q \implies r$ \\
    \ooo So we want to show $p \subseteq (q \implies r)$ \\
    \ooo So we want to show $\forall m$, if $m \in p$ then $m \in (q \implies r)$ \\
    \ooo Assume $m$ and $m \in p$ \\
    \oooo Want to show $m \in q \implies r$ \\
    \oooo Equivalent to showing if $m \in q$, then $m \in r$ \\
    \oooo Assume $m \in q$ \\
    \ooooo Since $m \in p$ and $m \in q$, we know $m \in p \cap q$. \\
    \ooooo Since $p \cap q \subseteq r$, we know $m \in r$ \\
    \ooo Therefore $p \subseteq q \implies r$ \\
    \ooo By definition of $\leq$, we see $p \leq q \implies r$ \\[1em]

    $\Leftarrow$ direction:\\
    \oo Assume $p \leq q \implies r$ \\
    \ooo By definition of $\leq$, we know $p \subseteq q \implies r$ \\
    \ooo We want to show $p \land q \leq r$ \\
    \ooo So we want to show $p \cap q \subseteq r$ \\
    \ooo So we want to show $\forall m$, if $m \in p \cap q$ then $m \in r$ \\
    \ooo Assume $m \in p \cap q$ \\
    \oooo Hence $m \in p$ and $m \in q$ \\
    \oooo Since $p \subseteq q \implies r$, we know for all $m$, if $m \in p$, then if $m \in q$, then $m \in r$ \\
    \oooo Hence $m \in r$ \\
    \ooo Hence $p \cap q \subseteq r$ \\
    \ooo By definition of $\leq$ and $\land$, we conclude $p \land q \leq r$ \\
  \end{tabbedproof}

\item We want to show $\forall p \in \powerset{M}.\; p * I = p$

  \begin{eqnproof}[\mbox{Assume } p \in \powerset{M}]
    \eline[p * I]
          {\setof{m \in M\;|\; \exists m_1 \in p, m_2 \in I.\;
                                    m_1 \# m_2 \land m_1\cdot m_2 = m}}
          {}
    \eline{\setof{m \in M\;|\; \exists m_1 \in p, m_2 \in \setof{e}.\;
                                    m_1 \# m_2 \land m_1\cdot m_2 = m}}
          {}
    \eline{\setof{m \in M\;|\; \exists m_1 \in p.\; m_1 \# e \land m_1 \cdot e = m}}
          {Simplification}
    \eline{\setof{m \in M\;|\; \exists m_1 \in p.\; m_1 = m}}
          {Monoid axioms}
    \eline{\setof{m \in M\;|\; m \in p}}
          {Simplification}
    \eline{p}
          {}
  \end{eqnproof}

\item We want to show $\forall p, q \in \powerset{M}.\; p * q = q * r$

  \begin{eqnproof}[\mbox{Assume }p,q \in \powerset{M}]
    \eline[p * q]
          {\setof{m \in M\;|\; \exists m_1 \in p, m_2 \in q.\; 
                       m_1 \# m_2 \land m_1\cdot m_2 = m}}
          {Definition}
    \eline{\setof{m \in M\;|\; \exists m_2 \in q, m_1 \in p.\; 
                       m_1 \# m_2 \land m_1\cdot m_2 = m}}
          {Logical manipulation}
    \eline{\setof{m \in M\;|\; \exists m_2 \in q, m_1 \in p.\; 
                       m_2 \# m_1 \land m_2\cdot m_1 = m}}
          {Commutativity}
    \eline{q * p}
          {Definition}    
  \end{eqnproof}

\item We want to show $\forall p, q, r \in \powerset{M}.\; (p * q) * r = p * (q * r)$

  \begin{eqnproof}
     \eline[p * q]
           {\setof{m_1 \;|\; \exists m_p \in p, m_q \in q.\; 
                             m_p \# m_q \land m_p \cdot m_q = m_1}}
           {Definition}
     \eline[(p * q) * r]
           {\setof{m \;|\; \exists m_1 \in p * q, m_r \in r.\; 
                             m_1 \# m_r \land m_1 \cdot m_r = m}}
           {Definition}
     \elines{\{ m\;|\; \exists m_1 \in p * q, m_p \in p, m_q \in q, m_r \in r. \\ 
             \qquad m_p \# m_q \land m_p \cdot m_q = m_1 \\
             \qquad m_1 \# m_r \land m_1 \cdot m_r = m \}\\ }
            {Comprehension}
     \elines{\{ m\;|\; \exists m_p \in p, m_q \in q, m_r \in r. \\ 
             \qquad m_p \# m_q \land 
                   (m_p\cdot m_q) \# m_r \land (m_p \cdot m_q) \cdot m_r = m \}\\ }
            {Simplification}
     \elines{\{ m\;|\; \exists m_p \in p, m_q \in q, m_r \in r. \\ 
             \qquad m_p \# m_q \land 
                   m_p \# m_r \land m_q \# m_r \land (m_p \cdot m_q) \cdot m_r = m \}\\ }
            {Distribute $\#$}
     \elines{\{ m\;|\; \exists m_p \in p, m_q \in q, m_r \in r. \\ 
             \qquad m_p \# m_q \land 
                   m_p \# m_r \land m_q \# m_r \land m_p \cdot (m_q \cdot m_r) = m \}\\ }
            {Associativity}
     \elines{\{ m\;|\; \exists m_p \in p, m_q \in q, m_r \in r. \\ 
             \qquad m_p \# (m_q \cdot m_r) \land 
                    m_q \# m_r \land m_p \cdot (m_q \cdot m_r) = m \}\\ }
            {Redistributing $\#$}
     \elines{\{ m\;|\; \exists m_p \in p, m_q \in q, m_r \in r, m_2 \in q * r \\ 
             \qquad m_p \# (m_q \cdot m_r) \land m_2 = m_q \cdot m_r \\
             \qquad m_q \# m_r \land m_p \cdot (m_q \cdot m_r) = m \}\\ }
            {Introducing $m_2$}
     \elines{\{m \;|\; \exists m_p \in p, m_2 \in q * r.\;
              m_p \# m_2 \land m_p \cdot m_2 = m \}\\ }
            {Comprehension}
     \elines{p * (q * r)}
            {Definition}
  \end{eqnproof}

\item We want to show that for all $p, q, r \in \powerset{M}$, $p * q \leq r$ if and
only if $p \leq q \wand r$. 

  \begin{tabbedproof}
    Assume $p, q, r \in \powerset{M}$. \\
    \oo First, we'll give the $\To$ direction. \\
    \ooo Assume $p * q \leq r$ \\
    \ooo Expanding definitions, 
          $\comprehend{m}{\exists m_1, m_2.\; m_1 \# m_2 \land m_1 \in p \land m_2 \in q 
                                             \land m_1 \cdot m_2 = m}
           \subseteq r$ \\
    \ooo Thus, $\forall m.\; (\exists m_1, m_2.\; m_1 \# m_2 \land m_1 \in p \land m_2 \in q 
                                             \land m_1 \cdot m_2 = m)$ implies $m \in r$. \\
    \ooo By turning existentials on the left into universals, and instantiating $m$, \\
    \oooo
             $\forall m_1, m_2.\; (m_1 \# m_2 \land m_1 \in p \land m_2 \in q) \implies (m_1 \cdot m_2) \in r$ [HYP1] \\
    \ooo Now, to show $p \leq q \wand r$, we must show
         for all $m$, if $m \in p$, that $m \in q \wand r$. \\
    \ooo Assume $m$, $m \in p$. [HYP2] \\
    \oooo Now, we want to show $m \in \comprehend{m}{\forall m' \in q.\; m\# m' \land m' \implies (m \cdot m') \in r}$ \\
    \oooo This is equivalent to showing $\forall m' \in q.\; m\# m' \land m' \implies (m \cdot m') \in r$ \\
    \oooo Assume $m'$, $m' \in q$, $m \# m'$. [HYP3] \\ 
    \ooooo Instantiating [HYP1] with $m$ and $m'$ and the hypotheses in [HYP2] and [HYP3], \\
    \ooooo we can conclude $(m \cdot m') \in r$.  \\

    \oo Now, we'll show the $\Leftarrow$ direction. \\
    \ooo Assume $p \leq q \wand r$. \\
    \oooo Expanding definitions, $p \subseteq \comprehend{m}{\forall m' \in q. m \# m' \land m' \in q \implies (m \cdot m') \in r}$ \\
    \oooo This is equivalent to $\forall m. m \in p \implies \forall m' \in q.\; m \# m' \land m' \in q \implies (m \cdot m') \in r$.  \\
    \oooo This is equivalent to $\forall m, m'.\; m \in p \land m' \in q \land m \# m' \implies (m \cdot m') \in r$ \\
    \oooo This is equivalent to $\forall m_o, m, m'.\; m \in p \land m' \in q \land m \# m' \land m_o = m\cdot m' \implies m_o \in r$ \\
    \oooo This is equivalent to $\forall m_o, (\exists m, m'.\; m \in p \land m' \in q \land m \# m' \land m_o = m\cdot m') \implies m_o \in r$ \\
    \oooo This is equivalent to $\forall m_o, m_o \in (p * q) \implies m_o \in r$ \\
    \oooo This is equivalent to $p * q \subseteq r$ \\
    \oooo This is equivalent to $p * q \leq r$ \\

  \end{tabbedproof}

\item We want to show $\forall r, P \subseteq B$, if $(\forall p \in P.\; r \leq p)$, then
$r \leq \bigwedge P$ and $\forall p \in P.\; \bigwedge P \leq p$. 

  \begin{tabbedproof}
    \oo Assume $r$, $P$, $P \subseteq B$, and $(\forall p \in P.\; r \leq p)$ \\[1em]
    \ooo First, we want to show $r \leq \bigwedge P$. \\
    \oooo This is equivalent to showing $r \subseteq \bigcap P$ \\
    \oooo This is equivalent to showing that for all $m \in r$, $m \in \bigcap P$. \\
    \oooo Assume $m$, $m \in r$.  \\
    \ooooo Showing $m \in \bigcap P$ is equivalent to $\forall p \in P. m \in p$ \\
    \ooooo Assume $p \in P$.  \\
    \oooooo Instantiating hypothesis with $p$, $r \subseteq p$. \\
    \oooooo This means $\forall m'. m' \in r \implies m' \in p$. \\
    \oooooo Instantiating $m'$ with $m$, we learn $m \in p$. \\
    \oooo Therefore, $r \leq \bigwedge P$. \\[1em]
    \ooo Second, we want to show that $\forall p \in P.\; \bigwedge P \leq p$. \\
    \ooo Assume $p$, $p \in P$. \\
    \oooo Now, we want to show $\bigwedge P \leq p$. \\
    \oooo This is equivalent to showing $\bigcap P \subseteq p$. \\
    \oooo This is equivalent to showing $\forall m.\; m \in \bigcap P \implies m \in p$ \\
    \oooo Assume $m$, $m \in \bigcap P$.  \\
    \ooooo Therefore, $\forall p' \in P.\; m \in p'$. \\
    \ooooo Instantiating $p'$ with $p$, we get $m \in p$. \\
  \end{tabbedproof}

\item We want to show $\forall r, P \subseteq B$, if $(\forall p \in P.\; p \leq r)$, then
$\bigvee P \leq r$ and $\forall p \in P.\; p \leq \bigvee P$. 

  \begin{tabbedproof}
    \oo Assume $r, P \subseteq B$, and $(\forall p \in P.\; p \leq r)$ \\[1em]
    \ooo First, we want to show $\bigvee P \leq r$ \\
    \oooo This is equivalent to showing $\bigcup P \subseteq r$ \\
    \oooo This is equivalent to showing $\forall m.\; m \in \bigcup P \implies m \in r$ \\
    \oooo Assume $m$, $m \in \bigcup P$. \\
    \ooooo $m \in \bigcup P$ is equivalent to $\exists p \in P.\; m \in p$ \\
    \ooooo Suppose $p' \in P$ is the witness, and that $m \in p'$ \\ 
    \oooooo Instantiating the quantifier $p$ in the hypothesis, we get $p' \leq r$ \\
    \oooooo This means $\forall m', m' \in p' \implies m' \in r$ \\
    \oooooo Instantiating the quantifier $m'$ with $m$,  we conclude $m \in r$.  \\
    \oooo Therefore, $\forall m.\; m \in \bigcup P \implies m \in r$ \\[1em]
    \ooo Second, we want to show $\forall p \in P.\; p \leq \bigvee P$. \\
    \oooo Assume $p$, $p \in P$ \\
    \ooooo We want to show $p \leq \bigvee P$ \\
    \ooooo This is equivalent to showing $p \subseteq \bigcup P$ \\
    \ooooo This is equivalent to showing $\forall m.\; m \in p \implies m \in \bigcup P$ \\
    \ooooo This is equivalent to showing $\forall m.\; m \in p \implies \exists p' \in P.\; m \in p'$ \\
    \ooooo Assume $m$, $m \in p$ \\
    \oooooo Take $p'$ to be $p$, since $p \in P$. \\
    \oooooo Thus, $m \in p$ by hypothesis \\
    \oooo Therefore, $p \leq \bigvee P$ \\
  \end{tabbedproof}

\end{enumerate}


\end{proof}

\subsection{Sets of Heaps form a BI algebra}

Now, we'll take our predomain $H$ and form a BI algebra from it. To do so, we will
map it with the forgetful functor $U$, so that we forget the partial order structure 
and let $U(H)$ be an ordinary set. 

Now, $U(H) = \sum L \in \powersetfin{Loc}.\; (\prod \sempair{n}{A} \in L.\; \interp{\judgeWK[\cdot]{A}{\bigstar}}\;(*)\;(K,K))$

In what follows, we will usually suppress the $U$, in order to reduce clutter. 

Now, we can define the operations on it as follows: 

\begin{itemize}
\item The unit element $e \triangleq \sempair{\emptyset}{\emptyset}$
\item The operation $(L, f) \cdot (L', g)$ is defined when $L \cap L' = \emptyset$, and
      is equal to 

\begin{displaymath}
 \left(L \cup L', \lambda x.\;\left\{\begin{array}{ll}
                                 f(x) & \mathsf{when}\; x \in L \\
                                 g(x) & \mathsf{when}\; x \in L'
                               \end{array}
                         \right.\right)
 \end{displaymath}
\end{itemize}

The lambda-expression in the operation definition actually defines a
function. Since we know that since $L$ and $L'$ are disjoint, this
means that any element of $x \in L \cup L'$ is exclusively either in
$L$ or $L'$, which means that the definition is unambiguous. Since $f$
and $g$ are well-typed with respect to the index sets $L$ and $L'$
respectively, our new function must be as well.

Now, we can check the properties. 

\begin{itemize}

\item First, we'll check that $e$ is a unit. Suppose we have $m = (L, f) \in H$. 

\begin{eqnproof}
  \eline[(\emptyset, \emptyset) \cdot (L, f)]
        {\left(\emptyset \cup L, \lambda x.\; \left\{\begin{array}{ll}
                                                      \emptyset(x) & \mathsf{when}\; x \in \emptyset \\
                                                       f(x) & \mathsf{when}\; x \in L \\
                                                     \end{array}
                                              \right.\right)}
        {Definition}
  \eline{\left(L, \lambda x.\; \begin{array}{ll}
                                  f(x) & \mathsf{when}\; x \in L \\
                               \end{array} \right)}
        {Simplification}
  \eline{\sempair{L}{f}}
        {Simplification}
\end{eqnproof}

\item Second, we'll check commutativity. Suppose we have $(L,f) \in H$ and $(L',g) \in H$. 

  \begin{eqnproof}
    \eline[(L,f) \cdot (L',g)] 
          { \left(L \cup L', \lambda x.\;\left\{\begin{array}{ll}
                                 f(x) & \mathsf{when}\; x \in L \\
                                 g(x) & \mathsf{when}\; x \in L'
                               \end{array}
                         \right.\right)}
          {Definition}
    \eline{\left(L' \cup L, \lambda x.\;\left\{\begin{array}{ll}
                                 f(x) & \mathsf{when}\; x \in L \\
                                 g(x) & \mathsf{when}\; x \in L' \\
                               \end{array}
                         \right.\right)}
          {Commutativity of $\cup$}
    \eline{\left(L' \cup L, \lambda x.\;\left\{\begin{array}{ll}
                                 g(x) & \mathsf{when}\; x \in L' \\
                                 f(x) & \mathsf{when}\; x \in L \\
                               \end{array}
                         \right.\right)}
          {Reordering Cases}
    \eline{(L',g) \cdot (L,f)}
          {Definition}
  \end{eqnproof}

\item Now, we'll check associativity. Suppose $(L,f)$, $(L',g)$, and $(L'',h)$ are in $H$. 

  \begin{eqnproof}
    \eline[(L,f)\cdot((L',g)\cdot(L'',h))]
          {(L,f)\cdot \left(L' \cup L'', 
                            \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     g(x) & \mathsf{when}\; x \in L' \\
                                     h(x) & \mathsf{when}\; x \in L'' \\
                                  \end{array}\right.\right)}
          {Definition}
     \eline{\left(L \cup (L' \cup L''), 
                            \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     f(x) & \mathsf{when}\; x \in L \\
                                     g(x) & \mathsf{when}\; x \in L' \\
                                     h(x) & \mathsf{when}\; x \in L'' \\
                                  \end{array}\right.\right)}
           {Definition}
     \eline{\left((L \cup L') \cup L'', 
                            \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     f(x) & \mathsf{when}\; x \in L \\
                                     g(x) & \mathsf{when}\; x \in L' \\
                                     h(x) & \mathsf{when}\; x \in L'' \\
                                  \end{array}\right.\right)}
           {Associativity}
      \eline{\left(L \cup L', 
                    \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     f(x) & \mathsf{when}\; x \in L \\
                                     g(x) & \mathsf{when}\; x \in L' \\
                                  \end{array}\right.\right) \cdot (L'', h)}
            {Definition}
    \eline{((L,f)\cdot(L',g))\cdot(L'',h)}
          {Definition}
  \end{eqnproof}
\end{itemize}

Therefore, we can conclude that sets of heaps form a complete BI algebra. 

\section{Semantics of Specifications}

Before we can give the semantics of specifications, we're going to run
into a very sticky issue: our denotational semantics does not validate
the frame property. The formal semantics of the $\newref{A}{e}$
command allocates a new reference by finding the largest numeric id of
any reference in the heap's domain, and then allocating a reference
whose numeric id is one greater than that.

This means that the behavior of the memory allocator is deterministic,
which means that our semantic domain can include awkward programs
which crash if the heap is larger than a certain size. Obviously,
safety monotonicity property cannot hold for such programs, because
extending the heap enough will cause these programs to crash.  
 
On the other hand, we don't actually want to prove the correctness of
any of these pathological programs: all the programs we actually want
to write and prove correct are actually well-behaved.

To operationalize this idea, we will adopt an idea of Birkedal and
Yang's. They proposed changing the interpretation of program
specifications from a boolean semantics (in which each specification
is either true or false) into a Kripke interpretation.

The modal frame they proposed was one in which worlds were sets of
assertions of separation logic (i.e., elements of a BI algebra). 
Intuitively, we can think of each world as ``the set of assertions
that can be safely framed onto this specification''. A specification
is then true when all assertions can be framed onto it, which is 
how we will end up justifying the frame rule.

As we did for assertions, we'll give this semantics in a modular
way. We'll first define a preorder on elements of a BI algebra --- the
extension ordering --- and then use this ordering to give the truth
values as upwards-closed sets of assertions.

\section{World Preorders}

We can define a world preorder $W(B)$ over a BI algebra $B$ as
follows.  The elements of $W(B)$ are the elements of $B$, and for any
two elements $p$ and $q$, the ordering $p \sqsubseteq q$ is defined as
follows:

\begin{displaymath}
p \sqsubseteq q \iff \exists r.\; p * r = q
\end{displaymath}

To verify the relation $\sqsubseteq$ is a preorder, we need to 
show it is reflexive and transitive. 

$p \sqsubseteq p$ holds because we can take $r$ to be $I$. 


To show transitivity, we must show that $p_1 \sqsubseteq p_3$, given
that $p_1 \sqsubseteq p_2$ and $p_2 \sqsubseteq p_3$.

\begin{tabbedproof}
\oo Assume $p_1 \sqsubseteq p_2$  \\
\oo Assume $p_2 \sqsubseteq p_3$  \\
\ooo By definition of $\sqsubseteq$, $\exists r.\; p_1 * r = p_2$ \\
\ooo By definition of $\sqsubseteq$, $\exists r'.\; p_2 * r' = p_3$ \\
\ooo Let $r$ and $r'$ be the witnesses in lines 3 and 4, so we have \\
\oooo $p_1 * r = p_2$ \\
\oooo $p_2 * r' = p_3$ \\
\oooo Substituting for $p_2$, we get $p_1 * r * r' = p_3$ \\
\oooo Taking as witness $r'' = r * r'$, we show $\exists r''.\; p_1 * r'' = p_3$ \\
\ooo By definition of $\sqsubseteq$, $p_1 \sqsubseteq p_3$ \\
\end{tabbedproof}

\section{Heyting Algebras over Preorders}

Given any preorder $(P, \sqsubseteq)$, we can construct a complete
Heyting algebra by considering the set of its upward-closed subsets
$\upset{P}$:

\begin{displaymath}
\upset{P} = 
  \{ S \in \mathcal{P}(P) \;|\;
     \forall p \in S, \forall q \in B. \mbox{ if } p \sqsubseteq q \mbox{ then } q \in S 
  \}
\end{displaymath}

The ordering relation for the Heyting algebra is set inclusion, and
the operations are:

\begin{itemize}
\item $\top = P$
\item $\bot = \emptyset$
\item $S \land S' = S \cap S'$
\item $S \vee S' = S \cup S'$
\item $\bigwedge_{i \in I} S_i = \bigcap_{i \in I} S_i$
\item $\bigvee_{i \in I} S_i = \bigcup_{i \in I} S_i$
\item $S \implies S' = \{ r \in P \;|\; \forall r' \sqsupseteq r.\; 	
                          \mbox{if } r' \in S \mbox{ then } r' \in S' \}$
\end{itemize}

To show that these operations actually form a Heyting algebra, we need
to show that they satisfy the Heyting algebra axioms. First, we need
to show that the meet and join are the greatest lower bounds and least
upper bounds respectively. To do this, we'll just show that arbitrary
meets and joins exist, and then the nullary and binary meets and joins
will fall out as a special case.

\begin{lemma}{(Meets in the algebra of specifications)}
If $X \subseteq \upset{P}$, then $\bigwedge X$ defines a meet. 
\end{lemma}

\begin{proof}
So, first, we need to show that if for all $i \in I$, $S_i \in \upset{P}$, 
then $\bigwedge_{i \in I} S_i \in \upset{P}$. First, we need to show that 
the intersection of a family of upwards-closed subsets is itself an
upwards-closed subset. 

\begin{tabbedproof}
\oo Assume $\forall i \in I.\; S_i \in \upset{P}$ \\
\ooo We want to show $\bigwedge_{i \in I} S_i \in \upset{P}$ \\ 
\ooo So we want to show $\forall x \in \bigwedge_{i \in I} S_i$ and for all $y \in P$, if $x \sqsubseteq y$ then $y \in \bigwedge_{i \in I} S_i$ \\
\ooo Assume $x$, $x \in \bigwedge_{i \in I} S_i$, $y$, $y \in P$, $x \sqsubseteq y$ \\
\oooo Since $\bigwedge_{i \in I} S_i = \bigcap_{i \in I} S_i$, we know 
      $\forall i \in I.\; x \in S_i$ \\
\oooo Assume $i \in I$ \\
\ooooo Since $x \in S_i$, $x \sqsubseteq y$, and $S_i$ is upwards-closed, $y \in S_i$ \\
\oooo Therefore, $\forall i \in I$, $y \in S_i$ \\
\ooo Therefore $\forall x \in \bigwedge_{i \in I} S_i$ and for all $y \in P$, if $x \sqsubseteq y$ then $y \in \bigwedge_{i \in I} S_i$ \\
\ooo Which means $\bigwedge_{i \in I} S_i \in \upset{P}$ \\ 
\end{tabbedproof}

\noindent Next, we need to show that the Heyting algebra axiom for meets. 
Stated formally,
this is $\forall S \in \upset{P}$, if $X \subseteq
\upset{P}$ and $(\forall S' \in X.\; S \leq S')$, then $S
\leq \bigwedge X$ and $\forall S' \in X, \bigwedge X \leq S'$.
\\

\begin{tabbedproof}
\oo Assume $S \in \upset{P}, X \subseteq \upset{P},$ and   
           $(\forall S' \in X.\; S \leq S')$ \\
\ooo First, we want to show $S \leq \bigwedge X$ \\
\oooo This is equivalent to showing $\forall p.\; p \in S \implies p \in \bigwedge X$ \\
\oooo Assume $p \in S$ \\
\ooooo We want to show $p \in \bigwedge X$, so we want to show $\forall S' \in X.\; p \in S'$. \\
\ooooo Assume $S' \in X$ \\
\oooooo From the hypothesis in 1, we know $S \leq S'$ \\
\oooooo This means $\forall p.\; p \in S \implies p \in S'$ \\
\oooooo Instantiate the quantifier with $p$ and use hypothesis 4 to conclude $p \in S'$ \\
\oooo Therefore, $\forall p.\; p \in S \implies p \in \bigwedge X$, so $S \leq \bigwedge X$ \\[1em]
\ooo Second, we want to show $\forall S' \in X.\; \bigwedge X \leq S'$ \\
\ooo Assume $S' \in X$ \\
\oooo We want to show $\bigwedge X \leq S'$, so we must show $\forall p.\; p \in \bigwedge X \implies p \in S'$ \\
\oooo Assume $p \in \bigwedge X$ \\
\ooooo Therefore, we know $\forall S' \in X.\; p \in S'$ \\
\ooooo Instantiate the quantifier with $S'$ to conclude $p \in S'$ \\
\oooo Therefore $\bigwedge X \leq S'$ \\
\ooo Therefore $\forall S' \in X.\; \bigwedge X \leq S'$ \\
\end{tabbedproof}
\end{proof}



\begin{lemma}{(Joins in the algebra of specifications)}
If $X \subseteq \upset{P}$, then $\bigvee X$ defines an arbitrary join. 
\end{lemma}
\begin{proof}
First, we need to verify the join we defined actually gives us an upwards-closed set.
So we first need to show that if $X \subseteq \upset{P}$, then $\bigvee{X} \in \upset{P}$

\vspace{0.5em}

\begin{tabbedproof}
\oo Assume  $X \subseteq \upset{P}$ \\
\ooo We want to show $\bigvee{X} \in \upset{P}$ \\
\ooo This means $\forall x \in \bigvee{X}, y \in P,$ if $x \sqsubseteq y$ then $y \in \bigvee{X}$\\
\ooo Assume $x \in \bigvee X$, $y \in P$, $x \sqsubseteq y$ \\
\oooo Since $x \in \bigvee X$, we know $\exists S \in X.\; x \in S$ \\
\oooo Let $S$ be the witness of the existential, so $S \in X$ and $x \in S$ \\ 
\ooooo  Since $S$ is upwards-closed, $x \in S$, and $x \sqsubseteq y$, we know $y \in S$ \\
\ooo Therefore we can conclude $\exists S \in X.\; y \in S$ \\
\ooo Therefore $y \in \bigvee X$ \\
\end{tabbedproof}

\noindent Now, we need to show the Heyting axioms for disjunction. Formally stated, it is $\forall S \in \upset{P}, X \subseteq
\upset{P}$, if $(\forall S' \in X.\; S' \leq S)$, then $\bigvee X \leq
S$ and $\forall S' \in X.\; S' \leq \bigvee X$.

\vspace{0.5em}

\begin{tabbedproof}
\oo Assume $S \in \upset{P}, X \subseteq \upset{P}$, and $\forall S' \in X.\; S' \leq S$ \\
\ooo First, we want to show $\bigvee X \leq S$ \\
\oooo This is the same as $\forall p, p \in \bigvee X \implies p \in S$ \\
\oooo Assume $p \in \bigvee X$ \\
\ooooo This means $\exists S' \in X.\; p \in S'$ \\
\ooooo Let $S'$ be the witness to the existential, so $S' \in X$ and $p \in S'$ \\
\oooooo Instantiating the quantifier in the hypothesis with $S'$, we get $S' \leq S$ \\
\oooooo This means $\forall p \in S', p \in S$ \\
\oooooo Instantiating the quantifier with $p$, we  get $p \in S$ \\
\oooo Therefore $\forall p, p \in \bigvee X \implies p \in S$ \\
\oooo This is equivalent to $\bigvee X \leq S$ \\[1em]

\ooo Second, we want to show $\forall S' \in X.\; S' \leq \bigvee X$ \\
\oooo Assume $S' \in X$ \\
\ooooo We want to show $S' \leq \bigvee X$ \\
\ooooo This means $\forall p \in S', p \in \bigvee X$ \\
\ooooo Assume $p \in S'$ \\
\oooooo We want to show $p \in \bigvee X$ \\
\oooooo This means we must show $\exists S' \in X.\; p \in S'$ \\
\oooooo Witness the existential with $S'$, so we can show $p \in S'$ by hypothesis \\
\oooo  Therefore $\forall S' \in X.\; S' \leq \bigvee X$ \\
\end{tabbedproof}
\end{proof}




\begin{lemma}{(Implication)}
If $S_1, S_2 \in \upset{P}$, then
$S_1 \implies S_2 \in \upset{P}$. 
\end{lemma}

\begin{proof}
First, we'll check that the definition gives us an upwards-closed set.

\vspace{0.5em}

\begin{tabbedproof}
\oo Assume $x \in S_1 \implies S_2$, and that $y \sqsupseteq x$ \\
\ooo From this, we know $\forall r' \sqsupseteq x, $ if $r' \in S_1$ then $r' \in S_2$ \\
\ooo We want to show $\forall r' \sqsupseteq y, $ if $r' \in S_1$ then $r' \in S_2$ \\
\ooo Assume $r' \sqsupseteq y$ and $r' \in S_1$ \\
\oooo Since $r' \sqsupseteq y$ and $r' \sqsupseteq x$, we know $r' \sqsupseteq x$ \\
\oooo From this  and $r' \in S_1$, we can use the hypothesis in line 2 to get $r' \in S_2$ \\
\ooo Therefore $\forall r' \sqsupseteq y, $ if $r' \in S_1$ then $r' \in S_2$ \\
\end{tabbedproof}

\noindent Now that we know that $\implies$ has the correct codomain, we need to
verify that it satisfies the following axiom: 
\begin{displaymath}
S_1 \land S_2 \subseteq R \iff S_1 \subseteq S_2 \implies R
\end{displaymath}

\noindent This is equivalent to showing that 

\begin{displaymath}
(\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R) \iff
(\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R)
\end{displaymath}

\noindent First, let's show the $\Rightarrow$ direction.
\\

\begin{tabular}{ll}
Assume $\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R$ &
(1)
\\

Assume $x \in S_1$ &
(2)
\\

Assume $r' \sqsupseteq x$ &
(3)
\\

Assume $r' \in S_2$ & 
(4)
\\

$r' \in S_1$ & 
Since $x \in S_1$ and $r' \sqsupseteq x$ \\

$r' \in S_1 \cap S_2$ & 
Since $r' \in S_1$ and $r' \in S_2$ \\

$r' \in R$ &
By assumption (1) \\

$r' \in S_2 \Rightarrow r' \in R$ &
Implication intro (4) \\

$\forall r' \sqsupseteq x.\; r' \in S_2 \Rightarrow r' \in R$ &
Universal intro (3) \\

$x \in \{ r \in P \;|\; \forall r' \sqsupseteq r.\; r' \in S_2 \Rightarrow r' \in R$ &
Comprehension intro \\

$x \in S_2 \implies R$ &
Definition of $\implies$ \\

$\forall x.\; x \in S_1. \Rightarrow x \in S_2 \implies R$ &
Universal intro (2) \\

$(\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R) \Rightarrow (\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R)$ &
Implication intro (1) \\
\end{tabular}
\\

Next, let's show the $\Leftarrow$ direction. 
\\

\begin{tabular}{ll}
Assume $\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R$ &
(1) \\

Assume $x \in S_1 \land S_2$ & 
(2) \\

$x \in S_1$ & 
Since $x \in S_1 \land S_2$ (2)\\

$x \in S_2$ & 
Since $x \in S_1 \land S_2$ (3) \\

$x \in S_2 \implies R$ & 
By (2) and (1) \\

$x \in \{ r \in P \;|\; \forall r' \sqsupseteq r.\; \mbox{if } r' \in S_2 \mbox{ then } r' \in R \}$ &
Definition of $\implies$ \\

$\forall r' \sqsupseteq x.\; \mbox{if } r' \in S_2 \mbox{ then } r' \in R$ &
Comprehension instantiation (4) \\

$x \sqsupseteq x$ & 
Reflexivity (5) \\

$\mbox{if } x \in S_2 \mbox{ then } x \in R$ & 
Instantation of (4) with (5) \\

$x \in R$ & 
Implication elim via (3) \\

$\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R$ & 
Universal/Implication intro (2) \\

$(\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R) \Rightarrow (\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R)$ & 
Implication intro (1) \\
\end{tabular}
\end{proof}

These lemmas establish that $\upset{P}$ forms a complete Heyting algebra. 

\section{Semantic Hoare Triples}

In this section, we'll define \emph{semantics Hoare triples}, which will be the basic
elements we'll use to define our specification logic. As always, the definition
will come in a piece-wise fashion. We'll start by defining ``basic Hoare triples'',
which will be given semantics in a relatively familiar boolean fashion. We'll then
use these to define our true Kripke-style semantic Hoare triples. 

\subsection{Basic Hoare Triples}

Since we have a continuation semantics, it is natural to define a
continuation style interpretation of basic Hoare triples, as well.

\subsubsection{Approximating Postconditions}

Given a $Q \in \interp{A} \to \powerset{H}$, we define $Approx(Q)$ as the set:
\begin{displaymath}
  Approx(Q) \triangleq \comprehend{k \in \interp{A} \to H \to O}
                         {\forall v \in \interp{A}, h \in H.\; 
                            k\;v\;h = \bot \implies h \in Q(v)}
\end{displaymath}

These define a set of continuations which ``continuously approximate''
the postcondition $Q$ -- they are the set of continuations which run
forever when given a value and heap in $Q$.

Now, from this set we'll define the function $Best(Q)$, which will be the
``best continuous approximation'' to Q. 

\begin{displaymath}
  Best(Q) \triangleq \lambda v \in \interp{A}.\; \lambda h \in H.\; 
    \left\{\begin{array}{ll}
             \top & \mbox{when } \exists k \in Approx(Q).\; k\;v\;h = \top \\
             \bot & \mbox{otherwise}
           \end{array}
    \right.
\end{displaymath}

Of course, we have to verify that $Best(Q)$ is actually a continuous function. 

\begin{itemize}
\item First, we need to check that $Best(Q)$ is a monotone function. 

\begin{tabbedproof}
\oo Suppose we have $v \sqsubseteq v'$ and $h \sqsubseteq h'$. \\
\ooo We know $Best(Q)\;v\;h \in O$. Analyzing this by cases, we see \\
\ooo Suppose $Best(Q)\;v\;h = \bot$ \\
\oooo Since $\forall o \in O.\; \bot \sqsubseteq o$, it follows that 
      $\bot \sqsubseteq Best(Q)\;v'\;h'$ \\
\oooo So $Best(Q)\;v\;h \sqsubseteq Best(Q)\;v'\;h'$ \\
\ooo Suppose $Best(Q)\;v\;h = \top$ \\
\oooo By definition of $Best(Q)$, $\exists k \in Approx(Q).\; k\;v\;h = \top$ \\
\oooo Let $k \in Approx(Q)$ be the witness such that $k\;v\;h = \top$ \\ 
\ooooo Since $k$ is monotone, $k\;v\;h \sqsubseteq k\;v'\;h'$ \\
\ooooo So $\top \sqsubseteq k\;v'\;h'$ \\
\ooooo Since $\top$ is maximal in $O$, $k\;v'\;h' = \top$ \\
\ooooo So we can take $k$ to be the witness such that $\exists k.\; k\;v'\;h' = \top$ \\
\oooo Therefore $Best(Q)\;v'\;h' = \top$ \\
\oooo Therefore $Best(Q)\;v\;h \sqsubseteq Best(Q)\;v'\;h'$ \\
\end{tabbedproof}

\item Second, we need to show that $Best(Q)$ preserves limits. 

\begin{tabbedproof}
\oo Suppose we have two chains $v_i$ and $h_i$ such that $i \leq j$
implies $v_i \sqsubseteq v_j$ and $h_i \sqsubseteq h_j$. \\
\ooo We want to show that $\bigsqcup_i Best(Q)\;v_i\;h_i = Best(Q)\;(\sqcup v_i)\;(\sqcup h_i)$ \\
\ooo By excluded middle, either some $k$ in $Approx(Q)$ such that $k\;(\sqcup v_i)\;(\sqcup h_i) = \top$, or not. \\
\ooo Suppose that $\exists k \in Approx(Q).\; k\;(\sqcup v_i)\;(\sqcup h_i) = \top$ \\
\oooo Therefore $Best(Q)\;(\sqcup v_i)\;(\sqcup h_i) = \top$ \\
\oooo By continuity of $k$, $\bigsqcup_i k\;v_i\;h_i = \top$ \\
\oooo Since $O$ is discrete, there is an $n$ such that $k\;v_n\;h_n = \top$ \\
\oooo Therefore, for all $j \geq n$, $Best(Q)\;v_n\;h_n = \top$ \\
\oooo This means $\bigsqcup_i Best(Q)\;v_i\;h_n = \top$ \\
\oooo Therefore $\bigsqcup_i Best(Q)\;v_i\;h_n = Best(Q)\;(\sqcup v_i)\;(\sqcup h_i)$ \\
\ooo Suppose that $\lnot(\exists k \in Approx(Q).\; k\;(\sqcup v_i)\;(\sqcup h_i) = \top$ \\
\oooo This is equivalent to $\forall k \in Approx(Q).\; k\;(\sqcup v_i)\;(\sqcup h_i) = \bot$ \\
\oooo This means $Best(Q)\;(\sqcup v_i)\;(\sqcup h_i) = \bot$ \\
\oooo Now, assume $k \in Approx(Q)$ \\
\ooooo So $k\;(\sqcup v_i)\;(\sqcup h_i) = \bot$ \\
\ooooo By continuity, $\bigsqcup_i k\;v_i\;h_i = \bot$ \\
\ooooo Therefore for all $i$, $k\;v_i\;h_i = \bot$ \\
\oooo So for all $k \in Approx(Q)$ and $i$, we know $k\;v_i\;h_i = \bot$ \\
\oooo This is equivalent to $\forall i.\; \lnot(\exists k \in Approx(Q).\; k\;v_i\;h_i = \top)$\\
\oooo Therefore, for all $i$, we know $Best(Q)\;v_i\;h_i = \bot$ \\
\oooo Therefore, we know $\bigsqcup_i Best(Q)\;v_i\;h_i = \bot$ \\
\oooo So we conclude $\bigsqcup_i Best(Q)\;v_i\;h_i = Best(Q)\;(\sqcup v_i)\;(\sqcup h_i)$\\
\end{tabbedproof}
\end{itemize}
This establishes that $Best(Q)$ is a continuous function. 

\subsubsection{Basic Boolean Hoare Triples}

Supposing that $p$ is an element of the BI algebra $\powerset{H}$, $c$ is an element
of the domain of commands $(A \to K) \to K$, and $q$ is an $A$-indexed predicate, of
type $A \to \powerset{H}$, then we can define the basic boolean Hoare triple 
$\basicspec{p}{c}{a:A}{q}$:

\begin{displaymath}
  \basicspec{p}{c}{a:A}{q(a)} \triangleq
    \forall h \in p.\; \left(c\;Best(q)\;h = \bot\right)
\end{displaymath}

If $c$ is given a continuation which will run forever (i.e., equals
$\bot$) whenever it receives a heap in $q$, then given a heap $h \in
p$, $c$ with that continuation and that heap will also run forever.

The reason that we interpret triples this way is to make the fixed
point induction rule a sound rule of inference.



\subsection{Kripke Interpretation}

Now, we can give the Kripke interpretation of semantic triples. Given a semantic
assertion $p$, an element $c$ of the domain of $A$-commands $(A \to K) \to K$, 
and a $A$-predicate $q \in A \to \powerset{H}$, we define the meaning of a 
semantic triple as: 

\begin{displaymath}
  \spec{p}{c}{a:A}{q(a)} \triangleq
    \comprehend{ r \in \powerset{H} }
               {\forall s \sqsupseteq r.\; \basicspec{p * s}{c}{a:A}{q(a) * s}}
\end{displaymath}

\begin{lemma}{(Semantic Triples are Specifications)}
  For suitable $p,c,A$, and $q$, we have that 
$\spec{p}{c}{a:A}{q(a)} \in \upset{\powerset{H}}$
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo We want to show $\spec{p}{c}{a:A}{q(a)} \in \upset{\powerset{H}}$ \\
\oo This is equivalent to $\forall r,s$ if $r \in \spec{p}{c}{a:A}{q(a)}$ and $s \sqsupseteq r$,
then $s \in \spec{p}{c}{a:A}{q}$ \\
\oo Assume $r,s, r \in \spec{p}{c}{a:A}{q(a)}$, and $s \sqsupseteq r$ \\
\ooo $r \in \spec{p}{c}{a:A}{q(a)}$ is equivalent to 
     $\forall s \sqsupseteq r.\; \basicspec{p * s}{c}{a:A}{q(a) * s}$ \\
\ooo We want to show $s \in \spec{p}{c}{a:A}{q}$ \\
\ooo This is equivalent to showing 
     $\forall t \sqsupseteq s.\; \basicspec{p * t}{c}{a:A}{q(a) * t}$ \\
\ooo Assume $t$, $t \sqsupseteq s$ \\
\oooo By transitivity with $t \sqsupseteq s$ and $s \sqsupseteq r$, we know $t \sqsupseteq r$ \\
\oooo Instantiating quantifier in line 4 with $t$, $\basicspec{p * t}{c}{a:A}{q(a) * t}$ \\
\ooo Therefore $\forall t \sqsupseteq s.\; \basicspec{p * t}{c}{a:A}{q(a) * t}$ \\
\ooo Therefore $s \in \spec{p}{c}{a:A}{q}$ \\
\oo Therefore $\forall r,s$ if $r \in \spec{p}{c}{a:A}{q(a)}$ and $s \sqsupseteq r$,
    then $s \in \spec{p}{c}{a:A}{q}$ \\
\oo We have shown $\spec{p}{c}{a:A}{q(a)} \in \upset{\powerset{H}}$ \\ 
\end{tabbedproof}
\end{proof}

\subsubsection{Fixed Point Induction}

The reason we have gone to all this trouble of using continuous
approximations to the postcondition is to create an admissibility
property which will allow us to justify a fixed point induction rule.

\begin{lemma}{(Bottom Satisfies All Specifications)}
We have that $\spec{p}{\bot}{a:A}{q(a)} = \powerset{H}$. 
\end{lemma}
\begin{proof}
\begin{tabbedproof}
\oo We want to show $\spec{p}{\bot}{a:A}{q(a)} = \powerset{H}$ \\
\oo It suffices to show $\forall r \in \powerset{H}, r \in \spec{p}{\bot}{a:A}{q(a)}$ \\
\oo Assume $r \in \powerset{H}$ \\
\ooo We want to show $r \in \spec{p}{\bot}{a:A}{q(a)}$, which is equivalent to 
     $\forall s \sqsupseteq r.\; \basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\ooo Assume $s \sqsupseteq r$ \\
\oooo We want to show $\basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\oooo This is equivalent to $\forall h \in p. \bot\;Best(q)\;h = \bot$ \\
\oooo Assume $h \in p$ \\
\ooooo  By definition of least element, $\bot\;Best(q)\;h = \bot$ \\
\oooo Therefore $\forall h \in p. \bot\;Best(q)\;h = \bot$ \\
\oooo Therefore $\basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\ooo Therefore $\forall s \sqsupseteq r.\; \basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\ooo Therefore $r \in \spec{p}{\bot}{a:A}{q(a)}$ \\
\oo Therefore $\forall r \in \powerset{H}, r \in \spec{p}{\bot}{a:A}{q(a)}$ \\
\oo Therefore $\spec{p}{\bot}{a:A}{q(a)} = \powerset{H}$ \\
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Admissibility of Triple Subsets)}
Define $\spec{p}{-}{a:A}{q(a)}$ to be 

\begin{displaymath}
\spec{p}{-}{a:A}{q(a)} \triangleq
         \comprehend{c \in (A \to K) \to K}
                   { \spec{p}{c}{a:A}{q(a)} = \powerset{H} }
\end{displaymath}

Then, $\spec{p}{-}{a:A}{q(a)}$ forms an admissible subset of $(A \to K) \to K$. 
That is, given a chain $c_i \in \spec{p}{-}{a:A}{q(a)}$, we know that 
$\spec{p}{\sqcup_i c_i}{a:A}{q(a)}$. 
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo Suppose we have a chain $c_i \in \spec{p}{-}{a:A}{q(a)}$. \\
\ooo We want to show that $\sqcup_i c_i \in \spec{p}{\sqcup_i c_i}{a:A}{q(a)}$ \\
\ooo This is equivalent to $\spec{p}{\sqcup c_i}{a:A}{q(a)} = \powerset{H}$ \\
\ooo This is equivalent to 
     $\forall r \in \powerset{H}, s \sqsupseteq r.\; 
         \basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\ooo Assume $r \in \powerset{H}, s \sqsupseteq r$ \\
\oooo We want to show $\basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\oooo This is equivalent to $\forall h \in p * s.\; (\sqcup c_i)\; Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooo Assume $h \in p * s$ \\ 
\ooooo By continuity, we know $(\sqcup c_i)\; Best(\semfun{a}{q(a)*s})\;h = 
                               \bigsqcup (c_i\;Best(\semfun{a}{q(a)*s})\;h)$ \\
\ooooo Suppose $c$ is an element of the chain of $c_i$ \\
\oooooo Then we know $c \in \spec{p}{-}{a:A}{q}$ \\
\oooooo This is equivalent to $\spec{p}{c}{a:A}{q} = \powerset{H}$ \\
\oooooo This is equivalent to $\forall r, s \sqsupseteq r.\; \basicspec{p*s}{c}{a:A}{q(a)*s}$ \\
\oooooo This is equivalent to $\forall r, s \sqsupseteq r, h \in p*s, c\;Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooooo Instantiating quantifiers with $r$, $s$, and $h$, we get $c\;Best(\semfun{a}{q(a)*s})\;h = \bot$\\
\ooooo Therefore $\forall c \in \comprehend{c_i}{i \in \N}$, $c\;Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\ooooo Therefore $\bigsqcup (c_i\;Best(\semfun{a}{q(a)*s})\;h) = \bot$ \\
\ooooo Therefore $(\sqcup c_i)\;Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooo Therefore $\forall h \in p * s.\; (\sqcup c_i)\; Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooo Therefore $\basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\ooo Therefore $\forall r \in \powerset{H}, s \sqsupseteq r.\; 
                   \basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\ooo Therefore $\spec{p}{\sqcup c_i}{a:A}{q(a)} = \powerset{H}$ \\
\ooo Therefore $\sqcup_i c_i \in \spec{p}{\sqcup_i c_i}{a:A}{q(a)}$ \\
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Semantic Fixed Point Induction)}
If we know that for all $x$, $\spec{p}{x}{a:A}{q(a)} = \powerset{H}$ implies $\spec{p}{f(x)}{a:A}{q(a)}) = \powerset{H}$, then we know that $\spec{p}{fix(f)}{a:A}{q(a)} = \powerset{H}$
\end{lemma}

\begin{proof}
First, observe that $f^n(\bot)$ forms a chain -- that is, for all $i$, $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$.
\begin{tabbedproof}
\oo We want to show $\forall i$, $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\oo We proceed by induction on $i$ \\
\ooo Case $i = 0$: \\
\oooo We want to show $\bot \sqsubseteq f(\bot)$ \\
\oooo This follows immediately from the fact that $\bot$ is the least element of a domain. \\
\ooo Case $i = j + 1$ \\
\oooo We want to show $f^j(\bot) \sqsubseteq f^{j+1}(\bot) \implies f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\oooo Assume $f^j(\bot) \sqsubseteq f^{j+1}(\bot)$ \\
\ooooo By monotonicity of $f$, $f(f^j(\bot)) \sqsubseteq f(f^{j+1}(\bot))$ \\
\ooooo Therefore $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\oo Therefore $\forall i$, $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\end{tabbedproof}

\noindent Now, observe that for every $n$, $f^n(\bot) \in \spec{p}{-}{a:A}{q}$. \\

\begin{tabbedproof}
\oo Assume for all $x$, $\spec{p}{x}{a:A}{q(a)} = \powerset{H}$ implies $\spec{p}{f(x)}{a:A}{q(a)}) = \powerset{H}$ \\
\ooo We want to show $\forall n, f^n(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\ 
\ooo We proceed by induction on $n$: \\
\oooo Case $n = 0$ \\
\ooooo We want to show $\bot \in \spec{p}{-}{a:A}{q(a)}$ \\
\ooooo This follows from the fact that bottom satisfies all specifications. \\
\oooo Case $n = m + 1$ \\
\ooooo We want to show $f^m(\bot) \in \spec{p}{-}{a:A}{q} \implies
                        f^{m+1}(\bot) \in \spec{p}{-}{a:A}{q}$ \\
\ooooo Assume $f^m(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\
\oooooo This means $\spec{p}{f^m(\bot)}{a:A}{q(a)} = \powerset{H}$ \\
\oooooo Instantiate line 1 with $f^m(\bot)$, to conclude
          $\spec{p}{f(f^m(\bot))}{a:A}{q(a)}) = \powerset{H}$ \\
\oooooo This means $\spec{p}{f^{m+1}(\bot)}{a:A}{q(a)} = \powerset{H}$ \\
\oooooo This means $f^{m+1}(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\
\ooo Therefore $\forall n, f^n(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\ 
\end{tabbedproof}
Finally, by the admissibility of $\spec{p}{-}{a:A}{q(a)}$, we know that
$\sqcup f^n(\bot) \in \spec{p}{-}{a:A}{q(a)}$. Since $\sqcup f^n(\bot) = fix(f)$, we 
know that $\spec{p}{fix(f)}{a:A}{q(a)} = \powerset{H}$. 
\end{proof}



\section{The Framing Operator}

One nice feature of the Kripke-style interpretation of specifications
is that it naturally validates higher-order frame rules.

We will define, define an operation $S \otimes p$, where $S \in \upset{W(\powerset{H})}$ and
$p \in W(\powerset{H})$:

\begin{displaymath}
S \otimes p = \comprehend{ r \in W(\powerset{H}) }{ r * p \in S }
\end{displaymath}

Now, we can show that $S \otimes p$ is in $\upset{W(\powerset{H}})$, and that 
$S \subseteq S \otimes p $. The reason to do this is to give a semantics
to the frame rule. Intuitively, if $S$ is a specification, then $S \otimes p$ 
will be that specification with $p$ framed on to it. So we need to show that
first, $S \otimes p$ actually is an element of our Heyting algebra of 
specification truth values, and second, we want the frame rule to be 
sound -- we want $S$ to always imply $S \otimes p$. 

To show that $S \otimes p \in \upset{W(\powerset{H})}$, we need to show that for all 
$x,y$, if $x \in S \otimes p$ and $y \sqsupseteq x$, then $y \in S \otimes p$. 
\\

\begin{tabbedproof}
\oo We want to show for all $x,y$, if $x \in S \otimes p$ and $y \sqsupseteq x$, then $y \in S \otimes p$ \\
\oo Assume $x, y, x \in S \otimes p, y \sqsupseteq x$ \\
\ooo From $x \in S \otimes p$, we know $x * p \in S$ \\
\ooo From $y \sqsupseteq x$, we know $\exists r.\; y = x * r$ \\
\ooo Let $r$ be the witness so that $y = x * r$ \\
\oooo Since $S$ is upwards-closed, $x * p * r \in S$ \\
\oooo Since $x * p * r = (x * r) *p$, we know  $y * p \in S$ \\
\oooo Therefore $y \in S \otimes p$ \\
\end{tabbedproof}

To show $S \subseteq S \otimes p$, we need to show that if $x \in S$, then $x \in S \otimes p$. 

\begin{tabbedproof}
\oo Assume $x \in S$ \\
\ooo Since $\sqsubseteq$ is the extension ordering, $x \sqsubseteq x * p$ \\   
\ooo Since $S$ is upwards-closed, $x * p \in S$\\
\ooo Therefore $x \in S \otimes p$ \\
\end{tabbedproof}

\subsection{Framing Commutes With Logical Operators}

\begin{lemma}{(Framing onto Semantic Triples)}
We have that 
\begin{displaymath}
\spec{p}{c}{a:A}{q(a)} \otimes r = \spec{p * r}{c}{a:A}{q(a) * r}  
\end{displaymath}
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo We want to show $\spec{p}{c}{a:A}{q(a)} \otimes r = \spec{p * r}{c}{a:A}{q(a) * r}$. \\
\oo This means $\forall s \in W(\powerset{H}).\; s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ if and
only if $s \in \spec{p * r}{c}{a:A}{q(a) * r}$. \\
\ooo Assume $s \in W(\powerset{H})$ \\
\oooo $\To$ direction: \\
\ooooo Assume $s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ \\
\oooooo This means $s * r \in \spec{p}{c}{a:A}{q(a)}$ \\
\oooooo This means $\forall t \sqsupseteq s * r.\; \basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo We want to show $s \in \spec{p * r}{c}{a:A}{q(a) * r}$ \\
\oooooo So we want $\forall t' \sqsupseteq s.\; \basicspec{p * r * t'}{c}{a:A}{q(a) * r * t'}$\\
\oooooo Assume $t' \in \sqsupseteq s$ \\
\ooooooo Clearly, $t' * r \sqsupseteq s * r$ \\
\ooooooo Instantiate quantifier in 7 with $t' * r$ to conclude
         $\basicspec{p * t' * r}{c}{a:A}{q * t' * r}$ \\
\ooooooo Rearranging, we get $\basicspec{p * r * t'}{c}{a:A}{q * r * t'}$ \\
\oooooo Therefore $\forall t' \sqsupseteq s.\; \basicspec{p * r * t'}{c}{a:A}{q(a) * r * t'}$\\
\oooooo Therefore $s \in \spec{p * r}{c}{a:A}{q(a) * r}$ \\[0.5em]

\oooo $\Leftarrow$ direction: \\
\ooooo Assume $s \in \spec{p * r}{c}{a:A}{q(a) * r}$. \\
\oooooo This means $\forall t \sqsupseteq s.\; \basicspec{p * r * t}{c}{a:A}{q(a) * r * t}$ \\
\oooooo We want to show $s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ \\
\oooooo So we want $s * r \in \spec{p}{c}{a:A}{q(a)}$ \\
\oooooo So we want $\forall t \sqsupseteq s * r.\; \basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo Assume $t \sqsupseteq s * r$ \\
\ooooooo Since $t \sqsupseteq s * r$, we know $\exists u.\; t = s * r * u$ \\
\ooooooo Let $u$ be the witness such that $t = s * r * u$ \\
\ooooooo Now, note that $s * u \sqsupseteq s$ \\
\ooooooo Instantiate quantifier in 18 with $s * u$, so 
         $\basicspec{p * r * s * u}{c}{a:A}{q(a) * r * s * u}$ \\
\ooooooo Rearranging, $\basicspec{p * s * r * u}{c}{a:A}{q(a) * s * r * u}$ \\
\ooooooo By equality in 24, $\basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo Therefore $\forall t \sqsupseteq s * r.\; \basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo Therefore $s * r \in \spec{p}{c}{a:A}{q(a)}$ \\
\oooooo Therefore $s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ 
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Framing Commutes with Meets)}
We have that 
\begin{displaymath}
\left(\bigwedge_{i \in I} S_i\right) \otimes p = \bigwedge_{i \in I} (S_i \otimes p)
\end{displaymath}
\end{lemma}

\begin{proof}
To show $\left(\bigwedge_{i \in I} S_i\right) \otimes p = \bigwedge_{i \in I} (S_i \otimes p)$,
we need to show $\forall r.\; r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ if
and only if $r \in \bigwedge_{i \in I} (S_i \otimes p)$. 

\begin{tabbedproof}
\oo Assume $r \in W(\powerset{H})$ \\[0.5em]

\ooo $\To$ direction: \\
\oooo Assume $r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ \\
\ooooo From assumption, we know $r * p \in \bigwedge_{i \in I} S_i$ \\
\ooooo This means that $\forall i \in I.\; r * p \in S_i$ \\
\ooooo We want to show $r \in \bigwedge_{i \in I} (S_i \otimes p)$ \\
\ooooo So we want $\forall i \in I.\; r \in (S_i \otimes p)$ \\
\ooooo So we want $\forall i \in I.\; r * p \in S_i$ \\
\ooooo Assume $i \in I$ \\
\oooooo We want to show $r * p \in S_i$ \\
\oooooo Instantiating line 5 with $i$, we get $r * p \in S_i$ \\[0.5em]

\ooo $\Leftarrow$ direction:  \\
\oooo Assume $r \in \bigwedge_{i \in I} (S_i \otimes p)$  \\
\ooooo From this, we know that $\forall i \in I.\; r \in (S_i \otimes p)$ \\
\ooooo We want to show $r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ \\
\ooooo So we want to show $r * p \in \bigwedge_{i \in I} S_i$ \\
\ooooo So we want to show $\forall i \in I.\; r * p \in S_i$ \\
\ooooo Assume $i \in I$ \\
\oooooo Instantiating line 14 with $i$, we get $r \in (S_i \otimes p)$ \\
\oooooo This means $r * p \in S_i$ \\
\ooooo Therefore $\forall i \in I.\; r * p \in S_i$ \\
\ooooo Therefore $r * p \in \bigwedge_{i \in I} S_i$ \\
\ooooo Therefore $r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ 
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Framing Commutes with Joins)}
We have that 
\begin{displaymath}
\left(\bigvee_{i \in I} S_i\right) \otimes p = \bigvee_{i \in I} (S_i \otimes p)
\end{displaymath}
\end{lemma}

\begin{proof}
Showing this is equivalent to showing $\forall r.\; r \in
\left(\bigvee_{i \in I} S_i\right) \otimes p$ if and only if $r \in
\bigvee_{i \in I} (S_i \otimes p)$.

\begin{tabbedproof}
\oo Assume $r$ \\[0.5em]
\ooo  $\To$ direction: \\
\oooo Assume $r \in \left(\bigvee_{i \in I} S_i\right) \otimes p$ \\
\oooo This means $r * p \in \bigvee_{i \in I} S_i$ \\
\oooo This means $\exists i \in I.\; r * p \in S_i$ \\
\oooo We want to show $r \in \bigvee_{i \in I} (S_i \otimes p)$ \\
\oooo So we want to show $\exists i \in I.\; r \in (S_i \otimes p)$ \\
\oooo Let $i$ be the witness in 5, such that $r * p \in S_i$ \\
\ooooo From this, we see $r \in (S_i \otimes p)$ \\
\ooooo From this and $i$, we conclude $\exists i \in I.\; r \in (S \otimes p)$ \\
\oooo Therefore $r \in \bigvee_{i \in I} (S_i \otimes p)$ \\[0.5em]

\ooo $\From$ direction: \\
\oooo Assume $r \in \bigvee_{i \in I} (S_i \otimes p)$. \\
\ooooo From this, $\exists i \in I.\; r \in (S_i \otimes p)$ \\
\ooooo We want to show $r \in \left(\bigvee_{i \in I} S_i\right) \otimes p$ \\
\ooooo So we want $r * p \in \bigvee_{i \in I} S_i$ \\
\ooooo So we want $\exists i \in I.\; r * p \in S_i$ \\
\ooooo Let $i \in I$ be the witness in 14, so that $r \in (S_i \otimes p)$ \\
\oooooo From this, $r * p \in S_i$ \\
\oooooo With this and $i \in I$, we know $\exists i \in I.\; r * p \in S_i$ \\
\ooooo Therefore $r * p \in \bigvee_{i \in I} S_i$ \\
\ooooo Therefore $r \in \left(\bigvee_{i \in I} S_i\right) \otimes p$ \\
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Framing Commutes Through Implication)}
We have that
\begin{displaymath}
  (S_1 \implies S_2) \otimes p = (S_1 \otimes p) \implies (S_2 \otimes p) 
\end{displaymath}
\end{lemma}

\begin{proof}
This is equivalent to showing that $\forall r, r \in [(S_1 \implies S_2) \otimes p]$ if and
only if $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$. 

\begin{tabbedproof}
\oo Assume $r$ \\
\ooo $\To$ direction:\\
\oooo Assume $r \in [(S_1 \implies S_2) \otimes p]$ \\
\ooooo This means $r * p \in (S_1 \implies S_2)$ \\
\ooooo This means $\forall s \sqsupseteq r * p,$ if $s \in S_1$ then $s \in S_2$ \\
\ooooo We want to show $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$ \\
\ooooo So we want $\forall s \sqsupseteq r,$ if  $s \in S_1 \otimes p$ then $s \in S_2 \otimes p$ \\
\ooooo Assume $s \sqsupseteq r$ and $s \in S_1 \otimes p$ \\
\oooooo From this $s * p \in S_1$ \\ 
\oooooo Since $s * p \sqsupseteq s$ and $s \sqsupseteq r$, we have $s * p \sqsupseteq r$ \\
\oooooo Instantiating line 5 with $s * p$, we have if $s * p \in S_1$ then $s * p \in S_2$ \\
\oooooo Using this and line 9, we have $s * p \in S_2$ \\
\oooooo From this, we have $s \in S_2 \otimes p$ \\
\ooooo Therefore $\forall s \sqsupseteq r,$ if  $s \in S_1 \otimes p$ then $s \in S_2 \otimes p$ \\
\ooooo Therefore $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$ \\

\ooo $\From$ direction: \\
\oooo Assume $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$ \\
\ooooo From this, $\forall s \sqsupseteq r,$ if $s \in (S_1 \otimes p)$, then $s \in (S_2 \otimes p)$ \\
\ooooo We want to show $r \in [(S_1 \implies S_2) \otimes p]$ \\
\ooooo So we want $r * p \in (S_1 \implies S_2)$ \\
\ooooo So we want $\forall s \sqsupseteq r * p$, if $s \in S_1$ then $s \in S_2$ \\
\ooooo Assume $s \sqsupseteq r * p$ and $s \in S_1$ \\
\oooooo From this, $\exists t.\; s = t * r * p$ \\
\oooooo Let $t$ be the witness such that $s = t * r * p$ \\ 
\ooooooo Note $t * r \sqsupseteq r$ \\
\ooooooo Instantiating 18 with $t * r$, we get if $t * r \in (S_1 \otimes p)$, then $t * r \in (S_2 \otimes p)$ \\
\ooooooo From this, we have if $t * r * p \in S_1$ then $t * r * p \in S_2$ \\
\ooooooo So we have if $s \in S_1$, then $s \in S_2$ \\
\ooooooo From this and 22, we have $s \in S_2$ \\
\ooooo Therefore $\forall s \sqsupseteq r * p$, if $s \in S_1$ then $s \in S_2$ \\
\ooooo Therefore $r * p \in (S_1 \implies S_2)$ \\
\ooooo Therefore $r \in [(S_1 \implies S_2) \otimes p]$ 
\end{tabbedproof}
\end{proof}

\section{Syntax of Assertions and Specifications}

In this section, we'll give the syntax of specifications and
assertions, and then we'll give their semantics.

The syntactic categories are given in Figure~\ref{logic-syntax}. The
sorts $\omega$ include $\assert$, the sort of propositions in
separation logic, the kinds $\kappa$, the polytypes $A$, and
implications over these sorts $\omega \To \omega'$. Note that both
types and kinds are counted as sorts of our logic, which mean that
assertions in separation logic will be permitted to quantify over both
terms and types.  We'll need this ability in order to reason properly
about polymorphic programs -- for example, to specify the behavior of
a polymorphic length function on lists.

The terms (for which we will use $p$ $q$ as metavariables) which are
categorized by our sorts are also given in Figure~\ref{logic-syntax}.
They include lambda-abstraction and application for the exponential
sort $\omega \To \omega'$, terms $e$ for the sorts $A$, type
expressions $\tau$ for the sorts $\kappa$, and the assertions of
separation logic for the sort $\assert$. These include the usual
propositional logical connectives --- $\top, p \land q, p \implies q,
\bot, p \vee q$ -- as well as the spatial connectives $\emp, p * q, p
\wand q$, and $e \pointsto_A e'$. Note that the points-to proposition
is typed; it indicates that $e$ is a reference of type $\reftype{A}$
with contents $e'$ of type $A$. 

The quantifiers $\forall u:\omega.\; p$ and $\exists u:\omega.\; p$
are higher-order quantifiers. They can range over all sorts, including
the sort of assertions $\assert$, and so we have the full power of
higher-order separation logic available.  Finally, we have the
\emph{specification embedding assertion} $\validprop{S}$.  This is an
\emph{assertion} that the specification $S$ is true, and is useful for
writing assertions that include facts about the behavior of code.

The specifications $S$ begin with the basic Hoare triple
$\spec{p}{c}{a:A}{q}$, which says that the computation $c$, when run
from a pre-state in $p$, will end in a post-state in $q$, with its
return value named by $a$. Similarly, we have the monadic Hoare triple
form $\mspec{p}{e}{a:A}{q}$ which says that the suspended monadic
computation $e$ (of type $\monad{A}$), will take a pre-state $p$ to a
post-state $q$ if it were to be run. The specification $\setof{p}$ is
the assertion-embedding specification, which says that $p$ is a
tautology of separation logic. 

This does mean that assertions and specifications are mutually
recursive, which means that we will have to give the semantics of 
these two syntaxes simultaneously. This is one of the reasons we
spent the first half of this chapter developing the semantics with
no reference to the intended syntax at all -- I wanted to make sure
the semantic domains were all well-defined before giving the highly
mutually-recursive semantics of the program logic. 

\begin{figure}
\begin{displaymath}
\begin{array}{llcl}
\mbox{Sorts} & \omega & ::= & \omega \To \omega \bnfalt \kappa \bnfalt
A \bnfalt \assert \\[1em]

\mbox{Terms} & 
p,q & ::= & u \bnfalt \pfun{u}{\omega}{p} \bnfalt p\;q \bnfalt \tau \bnfalt e \\
&   &  |  & \top \bnfalt p \land q \bnfalt p \implies q \bnfalt \bot \bnfalt p \vee q \\
&   &  |  & \emp \bnfalt p * q \bnfalt p \wand q \bnfalt e \pointsto_A e' \\
&   &  |  & \forall u:\omega.\; p \bnfalt \exists u:\omega.\; p \bnfalt p =_\omega q \bnfalt
            \validprop{S} \\[1em]

\mbox{Specifications} & 
S & ::= & \spec{p}{c}{a:A}{q} \bnfalt \mspec{p}{e}{a:A}{q} \bnfalt \setof{P} \\
& &  |  & S \specand S' \bnfalt S \specimp S' \bnfalt S \specor S' \\
& &  |  & \forall u:\omega.\; S \bnfalt \exists u:\omega.\; S \\[1em]

\mbox{Contexts} & 
\Delta & ::= & \cdot \bnfalt \Delta, u:\omega \\[1em]
\end{array}
\end{displaymath}
\caption{Syntax of Assertions and Specifications}
\label{logic-syntax}  
\end{figure}



A context $\Delta$ is a sequence of sorted variables of the form
$u:\omega$. However, the fact that kinds are sorts, and that types are
also sorts which can depend on type variables, means that we need a
judgement to establish whether a sort is well-formed with respect to a
context, and likewise we will need a judgement to establish whether
the context is well-formed.

The judgement $\judgeACtx{\Delta}$, given in
Figure~\ref{logic-sort-ok}, establishes whether a particular context
is well-formed. It is mutually recursive with the judgement
$\judgeSort{\omega}$ (also given in Figure~\ref{logic-sort-ok}), which
judges whether or not the sort $\omega$ is well-formed. This judgement
is purely structural, except for the case when a type is judged
$\judgeSort{A}$, in the rule \textsc{SortType}. In this case, we use
the restriction operator $\restrictkind{\Delta}$ to pick out the
variables of the form $\alpha:\kappa$ out of $\Delta$, and then we
check to see whether $A$ is a well-kinded polytype with respect to
that subset of the context. This operator is defined in
Figure~\ref{context-ops}. 

Finally, we need an equality judgement for sorts, since we have an
equality theory for types. The judgement
$\judgeSortEq{\omega}{\omega'}$, defined in
Figure~\ref{logic-sort-ok}, judges whether two sorts are equal, by
means of an almost-congruence. That is, the rules of this judgement
are all congruence rules, except for the single case
\textsc{SortEqType}, which inherits from the equality judgement for
polytypes.

Now that we have defined what the sorts are, we define what it means
for a term to be well-sorted in context with the judgement
$\judgeA{p}{\omega}$, defined in Figure~\ref{logic-prop-ok}.

\begin{figure}
\begin{mathpar}
\boxed{\judgeACtx{\Delta}} 
\\
\inferrule*[right=CtxNil]
          { }
          {\judgeACtx{\cdot}}
\and
\inferrule*[right=CtxCons]
          {\judgeACtx{\Delta} \\
           \judgeSort{\omega}}
          {\judgeACtx{\Delta, u:\omega}}
\\
\boxed{\judgeSort{\omega}}
\\
\inferrule*[right=SortKind]
          {\judgeACtx{\Delta}}
          {\judgeSort{\kappa}}
% \and
% \inferrule*[right=SortPolyKind]
%           {\judgeACtx{\Delta}}
%           {\judgeSort{\bigstar}}
\and
\inferrule*[right=SortType]
          {\judgeACtx{\Delta} \\
           \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
          {\judgeSort{A}}
\and
\inferrule*[right=SortProp]
          {\judgeACtx{\Delta}}
          {\judgeSort{\assert}}
\and
\inferrule*[right=SortImp]
          {\judgeSort{\omega} \\ \judgeSort{\omega'}}
          {\judgeSort{\omega \To \omega'}}
\\
\boxed{\judgeSortEq{\omega}{\omega'}}
\\
\inferrule*[right=SortEqProp]
           { } 
           {\judgeSortEq{\assert}{\assert}}
\and
\inferrule*[right=SortEqKind]
          { }
          {\judgeSortEq{\kappa}{\kappa}}
\and
% \inferrule*[right=SortEqPolyKind]
%           { }
%           {\judgeSortEq{\bigstar}{\bigstar}}
% \and
\inferrule*[right=SortEqImp]
          {\judgeSortEq{\omega_1}{\omega'_1} \\
           \judgeSortEq{\omega_2}{\omega'_2} }
          {\judgeSortEq{\omega_1 \To \omega_2}{\omega'_1 \To \omega'_2}}
\and
\inferrule*[right=SortEqType]
          {\judgeKeq[\restrictkind{\Delta}]{A}{B}{\bigstar}}
          {\judgeSortEq{A}{B}}
\end{mathpar}
\caption{Well-sorting of Sorts and Contexts}
\label{logic-sort-ok}
\end{figure}

\begin{figure}
\begin{mathpar}
\boxed{\judgeA{p}{\omega}}
\\
\inferrule*[right=TermType]
          {\judgeACtx{\Delta} \\
           \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}}
          {\judgeA{\tau}{\kappa}}
\and
% \inferrule*[right=TermPolytype]
%           {\judgeACtx{\Delta} \\
%            \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
%           {\judgeA{A}{\bigstar}}
\and
\inferrule*[right=TermExpr]
          {\judgeACtx{\Delta} \\
           \judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{A}}
          {\judgeA{e}{A}}
\and
\inferrule*[right=TermHyp]
          {\judgeACtx{\Delta} \\
           u:\omega \in \Delta \\
           (\omega = \assert \vee \omega = \omega' \To \omega'')}
          {\judgeA{u}{\omega}}
\and
\inferrule*[right=TermAbs]
          {\judgeA[\Delta, u:\omega]{p}{\omega'}}
          {\judgeA{\pfun{u}{\omega}{p}}{\omega \To \omega'}}
\and
\inferrule*[right=TermApp]
          {\judgeA{p}{\omega' \To \omega} \\
           \judgeA{q}{\omega'}}
          {\judgeA{p\;q}{\omega}}
\and
\inferrule*[right=TermPropConst]
          {\judgeACtx{\Delta} \\
           c \in \setof{\top, \bot, \emp}}
          {\judgeA{c}{\assert}}
\and
\inferrule*[right=TermPropBinary]
          {\judgeA{p}{\assert} \\
           \judgeA{q}{\assert} \\
           \oplus \in \setof{\land, \vee, \implies, *, \wand}}
          {\judgeA{p \oplus q}{\assert}}
\and
\inferrule*[right=TermPropQuantify]
          {\judgeA[\Delta, u:\omega]{p}{\assert} \\
           Q \in \setof{\forall, \exists}}
          {\judgeA{Q u:\omega.\; p}{\assert}}
\and
\inferrule*[right=TermPointsTo]
          {\judgeA{e}{\reftype{A}} \\
           \judgeA{e'}{A}}
          {\judgeA{e \pointsto_A e'}{\assert}}
\and
\inferrule*[right=TermEqual]
          {\judgeA{p}{\omega} \\
           \judgeA{q}{\omega}}
          {\judgeA{p =_\omega q}{\assert}}
\and
\inferrule*[right=TermSpec]
          {\judgeS{S}}
          {\judgeA{\validprop{S}}{\assert}}
\and
\inferrule*[right=TermEqSort]
          {\judgeSortEq{\omega}{\omega'} \\
           \judgeS{\omega'}}
          {\judgeS{\omega}}
\end{mathpar}
\caption{Well-sorting of Assertions}
\label{logic-prop-ok}
\end{figure}

In the rules \textsc{TermType} and \textsc{TermExpr}, we simply
inherit well-kindedness and well-typedness from the corresponding
judgements for types and terms. To do this, we need not just the
kind-level restriction operator $\restrictkind{\Delta}$, we also need
the type-level restriction operator $\restricttype{\Delta}$, which
picks out the hypotheses of the context which are of sort $A$. This
second restriction operator is also defined in
Figure~\ref{context-ops}.

\begin{figure}
\begin{displaymath}
\begin{array}{lcl}
\restrictkind{\cdot}                 & = & \cdot \\
\restrictkind{\Delta, \alpha:\kappa} & = & \restrictkind{\Delta}, \alpha:\kappa \\
\restrictkind{\Delta, x:A}           & = & \restrictkind{\Delta} \\
\restrictkind{\Delta, u:\assert}     & = & \restrictkind{\Delta} \\
\restrictkind{\Delta, u:\omega \To \omega'} & = & \restrictkind{\Delta} \\[1em]

\restricttype{\cdot}                 & = & \cdot \\
\restricttype{\Delta, \alpha:\kappa} & = & \restricttype{\Delta} \\
\restricttype{\Delta, x:A}           & = & \restricttype{\Delta}, x:A \\
\restricttype{\Delta, u:\assert}     & = & \restricttype{\Delta} \\
\restricttype{\Delta, u:\omega \To \omega'} & = & \restricttype{\Delta} \\
\end{array}
\end{displaymath}
\caption{Auxilliary Context Operations}
\label{context-ops}  
\end{figure}

The rule \textsc{TermHyp} is the hypothesis rule for all variables
which are not of type sort $A$ or kind sort $\kappa$. We restrict the
applicability of this rule so that there will only be one way to
derive a sort for a variable -- types and kinds must use variable rule
from their corresponding judgements. Without this, we would have to
prove a coherence theorem, which is not difficult but would be a
nuisance.
 
The \textsc{TermAbs} and \textsc{TermApp} rules give the lambda-abstraction
and application rules for the function sort $\omega \To \omega'$ -- there
are no surprises here. Finally, there are all the rules giving the sorting
of propositions. The nullary propositions $\top, \bot$, and $\emp$ are
typed with the \textsc{TermPropConst} rule, and the binary propositions
$\land, \vee, \implies, *$, and $\wand$ are typed with the \textsc{TermPropBinary}
rule, requiring their two arguments to both be of sort $\assert$. 

The two quantifiers $\forall u:\omega.\;p$ and $\exists u:\omega.\;p$
are sorted with the \textsc{TermPropQuantify} rule, and the points-to
$e \pointsto_A e'$ and equality $p =_\omega q$ each require that their 
arguments be of the correct sort. Note that $e \pointsto_A e'$ is
restricted to program types, as expected, whereas equality is valid
at any sort. 

Finally, we have the rule $\textsc{TermSpec}$ for the
specification-embedding assertion $\validprop{S}$, which recursively
invokes the well-sorted specification $\judgeS{S}$. This judgement is
defined in Figure~\ref{logic-spec-ok}, and consists of a handful of
rules. The \textsc{SpecTriple} rule asserts that $\spec{p}{c}{a:A}{q}$
is well-kinded when $A$ is a type, $p$ is an assertion, $c$ is a
computation yielding an $A$, and $q$ is an assertion with $a$ as an
extra free variable.  Likewise the \textsc{SpecMTriple} rule does the
same job for monadic expressions, saying that $\mspec{p}{e}{a:A}{q}$,
saying that $e$ must be a term of monadic type $\monad{A}$, but
otherwise as in the \textsc{SpecTriple} rule.  Finally, the remaining
atomic proposition \textsc{SpecAssert} rule recursively calls back into the
assertion well-kinding judgement.




The \textsc{SpecBinary} rules gives well-formedness conditions for the
conjunction ($S \specand S'$), disjunction ($S \specor S'$), and
implication ($S \specimp S'$) over specifications, in each case asking
the subterms to be well-formed specifications. The quantifier rule
\textsc{SpecQuantify} simply extends the context with the newly
quantified variable. Since $\spectype$ is not a sort, this means that
the language of specifications is a multi-sorted first-order logic,
rather than a higher-order logic. There are no technical obstacles to
extending it in this fashion, but we have not felt any strong need to
do so.



\begin{figure}
\begin{mathpar}
\boxed{\judgeS{S}} \\
\inferrule*[right=SpecTriple]
          {\judgeA{p}{\assert} \\
           \judgeA[\Delta]{\comp{c}}{\monad{A}} \\
           \judgeA[\Delta, a:A]{q}{\assert}}
          {\judgeS{\spec{p}{c}{a:A}{q}}}
\and
\inferrule*[right=SpecMTriple]
          {\judgeA{p}{\assert} \\
           \judgeA{e}{\monad{A}} \\
           \judgeA[\Delta, a:A]{q}{\assert}} 
          {\judgeS{\mspec{p}{e}{a:A}{q}}}
\and
\inferrule*[right=SpecAssert]
          {\judgeA{p}{\assert}}
          {\judgeS{\setof{p}}}
\and
\inferrule*[right=SpecQuantify]
          {\judgeS[\Delta, u:\omega]{S} \\ u \in \setof{\forall, \exists}}
          {\judgeS{Q u:\omega.\; S}}
\and
\inferrule*[right=SpecBinary]
          {\judgeS{S_1} \\ \judgeS{S_2} \\ \oplus \in \setof{\specand, \specor, \specimp}}
          {\judgeS{S_1 \oplus S_2}}
\end{mathpar}
\caption{Well-sorting of Specifications}
\label{logic-spec-ok}
\end{figure}

\section{Semantics}

Now, we'll consider the interpretation of the syntax. 

\subsection{Interpretation of Sorts}

We'll start by explaining how to interpret the sorts. Ultimately,
we're going to define assertions to be the powerset of heaps, and
specifications to be upwards-closed sets of assertions, but because we
allow types as sorts, and types may have free type variables, we will
need to give an indexed, recursive definition in order to make
everything work properly.

Therefore, we'll need to give a mutually-recursive definition between
the interpretation the two judgements $\judgeACtx{\Delta}$,
$\judgeA{\Delta}{\omega}$.

\begin{displaymath}
  \begin{array}{lcl}
    \interp{\judgeACtx{\Delta}} & \in & \mbox{Set} \\
    \interp{\judgeSort{\omega}} & \in & \interp{\judgeACtx{\Delta}} \to \mbox{Set} \\[1em]

    \interp{\judgeACtx{\cdot}} & = & \unittype \\
    \interp{\judgeACtx{\Delta, u:\omega}} & = & \sum \delta \in \interp{\judgeACtx{\Delta}}.\; 
                                                  (\interp{\judgeSort{\omega}}\;\delta) \\[1em]
 
    \interp{\judgeSort{\kappa}}\;\delta & = & \interp{\kappa} \\
    \interp{\judgeSort{A}}\;\delta & = & 
       U(\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}\;(\restricttyenv{\Delta}{\delta})) \\
    \interp{\judgeSort{\assert}}\;\delta & = & \powerset{H} \\
    \interp{\judgeSort{\omega \To \omega'}}\;\delta & = &  
       \interp{\judgeSort{\omega}}\;\delta \to \interp{\judgeSort{\omega}}\;\delta \\
  \end{array}
\end{displaymath}

In order to establish that this actually defines a function, we'll
need to prove some supporting lemmas. First, we need to establish that
we an also prove that the context $\Delta$ is well-formed is
$\judgeSort{\omega}$ is derivable:

\begin{lemma}{(Well-sortedness implies well-formed contexts)}
If it is the case that $\judgeSort{\omega}$, then $\judgeACtx{\Delta}$.
\end{lemma}
\begin{proof}
The proof is by a trivial structural induction over the derivation $\judgeSort{\omega}$. 
\end{proof}

Now, this means that the domain of the interpretation function
$\interp{\judgeACtx{\Delta}}$ is always well-defined, given a $\judgeSort{\omega}$. Next,
we need to establish that we get the same result, regardless of \emph{which} derivation
of this judgement we found. 

\begin{lemma}{(Uniqueness of Interpretations)}
We have that:
\begin{enumerate}
\item If we have two derivations $\mathcal{D}_1 :: \judgeACtx{\Delta}$
      and $\mathcal{D}_2 :: \judgeACtx{\Delta}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$
\item If we have two derivations $\mathcal{D}_1 ::\; \judgeSort{\omega}$
      and $\mathcal{D}_2 ::\; \judgeSort{\omega}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$
\end{enumerate}
\end{lemma}

\begin{proof}
We proceed by mutual induction on the size of the derivation $\mathcal{D}_1$

\begin{enumerate}
\item We want to show that if $\mathcal{D}_1 :: \judgeACtx{\Delta}$
      and $\mathcal{D}_2 ::\; \judgeACtx{\Delta}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$.

\begin{itemize}
\item Case \textsc{CtxNil}:
  \begin{eqnproof}
    \eclaim{\mathcal{D}_1 :: \judgeACtx{\cdot}}
           {Hypothesis}
    \eclaim{\mathcal{D}_2 :: \judgeACtx{\cdot}}
           {Hypothesis}
    \eclaim{\interp{\mathcal{D}_1} = 1}
          {Definition of semantics}
    \eclaim{\interp{\mathcal{D}_2} = 1}
          {Definition of semantics}
    \eclaim{\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}}
          {Conclusion}
  \end{eqnproof}

\item Case \textsc{CtxCons}: 
  \begin{eqnproof}
    \eclaim{\mathcal{D}_1 ::\; \judgeACtx{\Delta, u:\omega}}
           {Hypothesis}
    \eclaim{\mathcal{D}_2 ::\; \judgeACtx{\Delta, u:\omega}}
           {Hypothesis}
    \eclaim{\mathcal{D}'_1 ::\; \judgeACtx{\Delta}}
           {Inversion on $\mathcal{D}_1$}
    \eclaim{\mathcal{D}''_1 :: \judgeSort{\omega}}
           {Inversion on $\mathcal{D}_1$}
    \eclaim{\mathcal{D}'_2 ::\; \judgeACtx{\Delta}}
           {Inversion on $\mathcal{D}_2$}
    \eclaim{\mathcal{D}''_2 :: \judgeSort{\omega}}
           {Inversion on $\mathcal{D}_2$}
    \eclaim{\interp{\mathcal{D}'_1} = \interp{\mathcal{D}'_1}}
           {Induction on $\mathcal{D}'_1, \mathcal{D}'_1$} 
    \eclaim{\interp{\mathcal{D}''_1} = \interp{\mathcal{D}''_1}}
           {Mutual Induction on $\mathcal{D}''_1, \mathcal{D}''_1$} 
    \eclaim{\sum \delta \in \interp{\mathcal{D}'_1}.\; \interp{\mathcal{D}''_1}\;\delta =
            \sum \delta \in \interp{\mathcal{D}'_2}.\; \interp{\mathcal{D}''_2}\;\delta}
           {Congruence of Equality}
  \end{eqnproof}
\end{itemize}

\item We want to show if $\mathcal{D}_1 ::\; \judgeSort{\omega}$
      and $\mathcal{D}_2 ::\; \judgeSort{\omega}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$

\begin{itemize}
\item Case \textsc{SortProp}:
  \begin{eqnproof}
    \eclaim{\ms{D}_1 :: \judgeSort{\assert}}
           {Hypothesis}
    \eclaim{\ms{D}_2 :: \judgeSort{\assert}}
           {Hypothesis}
    \eclaim{\ms{D}'_1 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_1$}
    \eclaim{\ms{D}'_2 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_2$}
    \eclaim{\interp{\ms{D}'_1} = \interp{\ms{D}'_2}}
           {Mutual Induction on $\ms{D}'_1, \ms{D}'_2$}
    \eclaim{\interp{\ms{D}_1} = \semfun{\delta \in \interp{\ms{D}'_1}}{\powerset{H}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_2}}{\powerset{H}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_1}}{\powerset{H}}}
           {Equality}
    \eclaim{\interp{\ms{D}_1} = \interp{\ms{D}_2}}
           {Conclusion}
  \end{eqnproof}

\item Case \textsc{SortKind}

  \begin{eqnproof}
    \eclaim{\ms{D}_1 :: \judgeSort{\kappa}}
           {Hypothesis}
    \eclaim{\ms{D}_2 :: \judgeSort{\kappa}}
           {Hypothesis}
    \eclaim{\ms{D}'_1 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_1$}
    \eclaim{\ms{D}'_2 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_2$}
    \eclaim{\interp{\ms{D}'_1} = \interp{\ms{D}'_2}}
           {Mutual Induction on $\ms{D}'_1, \ms{D}'_2$}
    \eclaim{\interp{\ms{D}_1} = \semfun{\delta \in \interp{\ms{D}'_1}}{\interp{\kappa}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_2}}{\interp{\kappa}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_1}}{\interp{\kappa}}}
           {By equality}
    \eclaim{\interp{\ms{D}_1} = \interp{\ms{D}_2}}
           {Conclusion}
  \end{eqnproof}
\end{itemize}

\item Case \textsc{SortType}: 
  \begin{tabbedproof}
  \oo Assume $\ms{D}_1 :: \judgeSort{A}$ and $\ms{D}_2 :: \judgeSort{A}$ \\
  \ooo By inversion on $\ms{D}_1$, we get \\
  \oooo $\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}$ and  \\
  \oooo $\ms{D}''_1 :: \judgeACtx{\Delta}$ \\
  \ooo By inversion on $\ms{D}_2$, we get \\
  \oooo $\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}$ and  \\
  \oooo $\ms{D}''_2 :: \judgeACtx{\Delta}$ \\
  \ooo By mutual induction on $\ms{D}''_1, \ms{D}''_2$, we get $\interp{\ms{D}''_1} = \interp{\ms{D}''_2}$ \\
  \ooo By semantics, $\interp{\ms{D}_1} = 
            \semfun{\delta \in \interp{\ms{D}''_1}}
                   {\interp{\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo By semantics, $\interp{\ms{D}_2} = 
            \semfun{\delta \in \interp{\ms{D}''_2}}
                   {\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo By equality, $\interp{\ms{D}_2} = 
            \semfun{\delta \in \interp{\ms{D}''_1}}
                   {\interp{\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo To show $\interp{\ms{D}_1} = \interp{\ms{D}_2}$, assume $\delta \in \interp{\ms{D}''_1}$\\
  \oooo Now $\interp{\ms{D}_1}\;\delta = 
                \interp{\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Now $\interp{\ms{D}_2}\;\delta = 
                \interp{\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Since type interpretation is coherent, \\
  \oooo \; $\interp{\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}} =
             \interp{\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}$ \\
  \oooo Therefore $\interp{\ms{D}_1}\;\delta = \interp{\ms{D}_2}\;\delta$ \\
  \ooo Therefore $\interp{\ms{D}_1} = \interp{\ms{D}_2}$
  \end{tabbedproof}
\end{enumerate}
\end{proof}


\subsection{Interpretation of Equality Judgement on Sorts}

Now, we'll show that our equality judgement on sorts $\judgeSortEq{\omega}{\omega'}$ is
sound. 

\begin{lemma}{(Soundness of Sort Equality)}
If $\judgeACtx{\Delta}$, $\judgeSort{\omega}$, and $\judgeSort{\omega'}$ are derivable, then if 
$\judgeSortEq{\omega}{\omega'}$ is derivable, then $\interp{\judgeSort{\omega}} = \interp{\judgeSort{\omega'}}$. 
\end{lemma}

\begin{proof}
We do this proof by induction on the equality derivation. 

\begin{itemize}
\item Case \textsc{SortEqProp}
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{\assert}{\assert}$ \\
  \oo Assume $D_1 :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_2 :: \judgeSort{\assert}$ \\
  \oo Assume $D_3 :: \judgeSort{\assert}$ \\
  \ooo By semantics, $\interp{D_2} = \semfun{\delta \in \interp{D_1}}{\powerset{H}}$ \\
  \ooo By semantics, $\interp{D_3} = \semfun{\delta \in \interp{D_1}}{\powerset{H}}$ \\
  \ooo Therefore $\interp{D_2} = \interp{D_3}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqKind}: 
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{\kappa}{\kappa}$ \\
  \oo Assume $D_1 :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_2 :: \judgeSort{\kappa}$ \\
  \oo Assume $D_3 :: \judgeSort{\kappa}$ \\
  \ooo By semantics, $\interp{D_2} = \semfun{\delta \in \interp{D_1}}{\interp{\kappa}}$ \\
  \ooo By semantics, $\interp{D_3} = \semfun{\delta \in \interp{D_1}}{\interp{\kappa}}$ \\
  \ooo Therefore $\interp{D_2} = \interp{D_3}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqImp}: 
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{\omega'_1 \To \omega''_1}{\omega'_2 \To \omega''_2}$ \\
  \oo Assume $D :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_1 :: \judgeSort{\omega_1 \To \omega'_1}$ \\
  \oo Assume $D_2 :: \judgeSort{\omega_2 \To \omega'_2}$ \\
  \ooo By inversion on $E$, we get 
         $E' :: \judgeSortEq{\omega'_1}{\omega'_2}$ and 
         $E'' :: \judgeSortEq{\omega''_1}{\omega''_2}$ \\
  \ooo By inversion on $D_1$, we get $D'_1 :: \judgeSort{\omega'_1}$ 
                                 and $D''_1 :: \judgeSort{\omega''_1}$ \\
  \ooo By inversion on $D_2$, we get $D'_2 :: \judgeSort{\omega'_2}$ 
                                 and $D''_2 :: \judgeSort{\omega''_2}$ \\
  \ooo By induction on $E', D, D'_1, D'_2$, we get 
             $\interp{\judgeSort{\omega'_1}} = \interp{\judgeSort{\omega'_2}}$ \\
  \ooo By induction on $E'', D, D''_1, D''_2$, we get 
             $\interp{\judgeSort{\omega''_1}} = \interp{\judgeSort{\omega''_2}}$ \\
  \ooo By semantics, $\interp{D_1} = \semfun{\delta}{\interp{D'_1}\;\delta \to 
                                                     \interp{D''_1}\;\delta}$ \\
  \ooo By semantics, $\interp{D_2} = \semfun{\delta}{\interp{D'_2}\;\delta \to 
                                                     \interp{D''_2}\;\delta}$ \\
  \ooo We want to show $\interp{D_1} = \interp{D_2}$ \\
  \ooo Assume $\delta \in \interp{D}$ \\
  \oooo Now $\interp{D_1}\;\delta = \interp{D'_1}\;\delta \to \interp{D''_1}\;\delta$ \\
  \oooo Now $\interp{D_2}\;\delta = \interp{D'_2}\;\delta \to \interp{D''_2}\;\delta$ \\
  \oooo By equality, $\interp{D_2}\;\delta = \interp{D'_1}\;\delta \to \interp{D''_1}\;\delta$ \\
  \oooo Therefore, $\interp{D_1}\;\delta = \interp{D_2}\;\delta$ \\
  \ooo Therefore $\interp{D_1} = \interp{D_2}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqType}:
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{A}{B}$ \\
  \oo Assume $D_1 :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_2 :: \judgeSort{A}$ \\
  \oo Assume $D_3 :: \judgeSort{B}$ \\
  \ooo By inversion on $E$, $E' :: \judgeKeq[\restrictkind{\Delta}]{A}{B}{\bigstar}$ \\
  \ooo By soundness of type equality, 
         $\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}} = 
          \interp{\judgeWK[\restrictkind{\Delta}]{B}{\bigstar}}$ \\
  \ooo By semantics, 
          $\interp{D_2} = 
             \semfun{\delta \in \interp{D_1}}
                    {\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                     \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo By semantics, 
          $\interp{D_3} = 
             \semfun{\delta \in \interp{D_1}}
                    {\interp{\judgeWK[\restrictkind{\Delta}]{B}{\bigstar}}
                     \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo We want to show $\interp{D_2} = \interp{D_3}$ \\
  \ooo To do this, assume we have $\delta \in \interp{D_1}$ \\
  \oooo Now $\interp{D_2}\;\delta = 
                 \interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                 \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Now $\interp{D_3}\;\delta = 
                 \interp{\judgeWK[\restrictkind{\Delta}]{B}{\bigstar}}
                 \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo By equality, $\interp{D_3}\;\delta = 
                 \interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                 \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Therefore $\interp{D_2}\;\delta = \interp{D_3}\;\delta$ \\
  \ooo Therefore $\interp{D_2} = \interp{D_3}$ \\
  \end{tabbedproof}

\end{itemize}
\end{proof}

\subsubsection{Interpretation of Terms and Specifications}

The term judgement $\judgeA{p}{\omega}$ is mutually recursively
defined with the specification judgement $\judgeS{S}$. Therefore, when
we give the semantics of these judgements, we need to define them
together. 

\begin{figure}
\begin{displaymath}
\begin{array}{lcl}
\interp{\judgeA{p}{\omega}} & \in & \prod \delta \in \interp{\judgeACtx{\Delta}}.\; \interp{\judgeSort{\omega}}\;\delta \\
\interp{\judgeS{S}} & \in & \interp{\judgeACtx{\Delta}} \to \upset{W(\powerset{H})} \\[1em]

\interp{\judgeA{\tau}{\kappa}}\;\delta & = & 
   \interp{\judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}}\; (\restricttyenv{\Delta}{\delta}) \\
\interp{\judgeA{e}{A}}\;\delta & = & 
   U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{A}}\;
       (\restricttyenv{\Delta}{\delta})\; (K,K))\;
       (\restrictvals{\Delta}{\delta}) \\
\interp{\judgeA{\pfun{u}{\omega'}{p}}{\omega' \To \omega}}\;\delta & = & 
   \semfun{v \in \interp{\judgeSort{\omega'}}}{\interp{\judgeA[\Delta,u:\omega']{p}{\omega}}\;(\delta, v)} \\
\interp{\judgeA{p\;q}{\omega}}\;\delta & = & 
   (\interp{\judgeA{p}{\omega' \To \omega}}\;\delta)\;(\interp{\judgeA{q}{\omega'}}\;\delta) \\
\interp{\judgeA{u}{\omega}}\;\delta & = & \delta(u) \\

\interp{\judgeA{c}{\assert}}\;\delta & = & \interp{c}^0 \\

\interp{\judgeA{p \oplus q}{\assert}}\;\delta & = & 
    \interp{\judgeA{p}{\assert}}\;\delta \;\;\interp{\oplus}^2\;\;
    \interp{\judgeA{q}{\assert}}\;\delta \\

\interp{\judgeA{Q u:\omega.\; q}{\assert}}\;\delta & = & 
    \interp{Q}_{v \in \interp{\judgeSort{\omega}}\;\delta} 
        \interp{\judgeA[\Delta, u:\omega]{p}{\assert}}\;\delta \\

\interp{\judgeA{e \pointsto e'}{\assert}}\;\delta & = & 
    \mbox{let } l = U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{\reftype{A}}}\;(\restricttyenv{\Delta}{\delta}))\;(\restrictvals{\Delta}{\delta}) \\
& &  \mbox{let }v = U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e'}{A}}\;(\restricttyenv{\Delta}{\delta}))\;(\restrictvals{\Delta}{\delta}) \\
& & \setof{(\setof{l}, \semfun{loc}{v \mbox{ when } loc = l})} \\


\interp{\judgeA{e =_\omega e'}{\assert}}\;\delta & = & 
   \mbox{if }\interp{\judgeA{e}{\omega}}\;\delta = \interp{\judgeA{e'}{\omega}}\;\delta 
   \mbox{ then } \top \mbox{ else} \bot \\

\interp{\judgeA{Q u:\omega.\; p}{\assert}}\;\delta & = & 
  \interp{Q}^\infty_{v \in \interp{\judgeSort{\omega}}\;\delta}
    \interp{\judgeA[\Delta, u:\omega]{p}{\assert}}\;(\delta, v) \\

\interp{\judgeA{\validprop{S}}{\assert}}\;\delta & = & 
   \mbox{if } \interp{\judgeS{S}}\;\delta = \top_{\upset{W(\powerset{H})}}
   \mbox{ then } \top
   \mbox{ else } \bot \\[1em]


\interp{\top}^0 & = & \top \\
\interp{\bot}^0 & = & \bot \\
\interp{\emp}^0 & = & I \\[1em]

\interp{\land}^2    & = & \land \\
\interp{\implies}^2 & = & \implies \\
\interp{\vee}^2     & = & \vee \\
\interp{*}^2        & = & * \\
\interp{\wand}^2    & = & \wand \\[1em]

\interp{\forall}^\infty & = & \bigwedge \\
\interp{\exists}^\infty & = & \bigvee \\
\end{array}
\end{displaymath}
\caption{ Interpretation of Terms }
\label{term-interpretation}  
\end{figure}

\begin{figure}
\begin{displaymath}
\begin{array}{lcl}
\interp{\judgeS{S}} & = & \interp{\judgeACtx{\Delta}} \to \upset{W(\powerset{H})} \\ [1em]

\interp{\judgeS{\spec{p}{c}{a:A}{q}}}\;\delta & = & 
   \begin{array}{l}
     \setof{\interp{\judgeA{p}{\assert}}\;\delta} \\
      U(\interp{\judgeC[\restrictkind{\Delta}]{\restricttype{\Delta}}
                       {c}{A}}\;(\restricttyenv{\Delta}{\delta}))\;
       (\restricttyenv{\Delta}{\delta}) \\
     \setof{v.\; \interp{\judgeA[\Delta, a:A]{q}{\assert}}\;(\delta,v)} \\
   \end{array} 
\\[2em]

\interp{\judgeS{\mspec{p}{e}{a:A}{q}}}\;\delta & = & 
   \begin{array}{l}
     \setof{\interp{\judgeA{p}{\assert}}\;\delta} \\
      U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}
                       {e}{A}}\;(\restricttyenv{\Delta}{\delta}))\;
       (\restricttyenv{\Delta}{\delta}) \\
     \setof{v.\; \interp{\judgeA[\Delta, a:A]{q}{\assert}}\;(\delta,v)} \\
   \end{array} 
\\[2em]

\interp{\judgeS{\setof{p}}}\;\delta & = & 
  \mbox{if } \interp{\judgeA{p}{\assert}}\;\delta = \top_{\powerset{H}}
  \mbox{ then } \top 
  \mbox{ else } \bot \\

\interp{\judgeS{S_1 \oplus S_2}}\;\delta & = & 
  \interp{\judgeS{S_1}}\;\delta \;\;\interp{\oplus}\;\; 
  \interp{\judgeS{S_2}}\;\delta \\

\interp{\judgeS{Q u:\omega.\; S}}\;\delta & = & 
  \interp{Q}_{v \in \interp{\judgeSort{\omega}}\;\delta} 
     \interp{\judgeS[\Delta, u:\omega]{S}}\;(\delta, v) \\[1em]

\interp{\specand} & = & \land \\
\interp{\specor}  & = & \vee  \\
\interp{\specimp} & = & \implies \\[1em]

\interp{\forall} & = & \bigwedge \\
\interp{\exists} & = & \bigvee \\

\end{array}
\end{displaymath}
\caption{Interpretation of Specifications}
\label{spec-interpretation}  
\end{figure}


\section{Substitution Theorems}

\subsection{Substitution for Sorts}

\subsubsection{Syntactic Substitution}

\begin{lemma}{(Syntactic Substitution for Sorts)}
If $\judgeA{p}{\omega}$, then we have that:

\begin{enumerate}
\item If $\judgeACtx{\Delta, u:\omega, \Delta'}$, then  
         $\judgeACtx{\Delta, [p/u]\Delta'}$. 
\item If $\judgeSort[\Delta, u:\omega, \Delta']{\omega'}$,  then
         $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}$. 
\end{enumerate}
\end{lemma}
\begin{proof}
This proof follows by mutual structural induction on each derivation. 
Assume $D_0 :: \judgeA{\Delta}{p}{\omega}$. 

\begin{enumerate}
\item We want to show if $D  ::\; \judgeACtx{\Delta, u:\omega, \Delta'}$, then  
                         $D' ::\; \judgeACtx{\Delta, [p/u]\Delta'}$. 
  \begin{itemize}
  \item Case \textsc{CtxNil}: 
    \begin{tabbedproof}
      \oo Assume $D ::\; \judgeACtx{\cdot}$ \\
      \ooo Therefore $\cdot = \Delta, u:\omega, \Delta'$ \\
      \ooo This is a contradiction, hence this case is vacuously true. 
    \end{tabbedproof}

  \item Case \textsc{CtxCons}: 
    \begin{tabbedproof}
      \oo Assume $D ::\; \judgeACtx{\Delta'', u'':\omega''}$ \\
      \ooo Therefore $\Delta, u:\omega, \Delta' = \Delta'', u'':\omega''$ \\
      \ooo By inversion on $D$, $D_1 :: \judgeACtx{\Delta''}$ \\
      \ooo By inversion on $D$, $D_2 :: \judgeSort{\omega''}$ \\
      \ooo We want to show $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo By cases on $\Delta'$: \\
      \oooo If $\Delta' = \cdot$: \\
      \ooooo Then $\Delta'' = \Delta$, and $u = u''$, and $\omega = \omega''$ \\
      \ooooo Then $[p/u]\Delta' = [p/u]\cdot = \cdot$ \\
      \ooooo So $D_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \oooo If $\Delta' = \Delta''', u''':\omega'''$:\\
      \ooooo Then $\Delta'' = \Delta, u:\omega, \Delta'''$ and $u''' = u''$ and $\omega'' = \omega'''$ \\ 
      \ooooo By equality, $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'''}$ \\
      \ooooo By induction on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'''}$ \\ 
      \ooooo By mutual induction on $D_2$, we have 
                 $D'_2 :: \judgeSort[{\Delta, [p/u]\Delta'''}]{[p/u]\omega''}$ \\ 
      \ooooo By rule $\textsc{CtxCons}$ on $D'_1$, $D'_2$, we have 
                 $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \end{tabbedproof}
  \end{itemize}

\item We want to show that if 
         $\judgeSort[\Delta, u:\omega, \Delta']{\omega'}$,  then
         $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}$. 

  \begin{itemize}
  \item Case \textsc{SortKind}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{\kappa}$ \\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo Since $\kappa$ has no free variables, $[p/u]\kappa = \kappa$ \\
      \ooo By rule \textsc{SortKind} on $D'_1$, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{\kappa}$ \\
      \ooo By equality, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}$ \\
    \end{tabbedproof}

  \item Case \textsc{SortProp}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{\assert}$ \\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo Since $\assert$ has no free variables, $[p/u]\assert = \assert$ \\
      \ooo By rule \textsc{SortProp} on $D'_1$, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{\assert}$ \\
      \ooo By equality, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\assert}$ \\
    \end{tabbedproof}

  \item Case \textsc{SortImp}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{\omega_1 \To \omega_2}$ \\
      \ooo By inversion on $D$, we have 
             $D_1 :: \judgeSort[\Delta, u:\omega, \Delta']{\omega_1}$ \\
      \ooo By inversion on $D$, we have 
             $D_2 :: \judgeSort[\Delta, u:\omega, \Delta']{\omega_2}$ \\
      \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_1}$ \\
      \ooo By induction on $D_2$, we have 
             $D'_2 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_2}$ \\
      \ooo By rule \textsc{SortImp}, we have 
            $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_1 \To [p/u]\omega_2}$ \\
      \ooo By definition of substitution, 
            $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u](\omega_1 \To \omega_2)}$ \\
    \end{tabbedproof}

  \item Case \textsc{SortType}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{A}$ \\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By mutual induction on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo By inversion on $D$, we have $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]
                                                        {A}{\bigstar}$ \\
      \ooo Case on $\omega$: \\
      \oooo If $\omega = \kappa$: \\
      \ooooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = 
                     \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
      \ooooo Then $D_0 :: \judgeA[\Delta]{\tau}{\kappa}$  where $p = \tau$ \\
      \ooooo By inversion on $D_0$, we have $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}$ \\
      \ooooo By substitution for types, we have 
               $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                {[\tau/u]A}{\bigstar}$ \\
      \ooooo Since no kind in $\restrictkind{\Delta'}$ has any free variables, 
             $\restrictkind{\Delta'} = \restrictkind{[\tau/u]\Delta'}$ \\
      \ooooo Therefore $D'_2 :: \judgeWK[{\restrictkind{\Delta}, \restrictkind{[\tau/u]\Delta'}}]
                                {[\tau/u]A}{\bigstar}$ \\
      \ooooo By rule \textsc{SortType} on $D'_1$ and $D'_2$, we have 
               $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]A}$ \\
      \oooo If $\omega \not= \kappa$: \\
      \ooooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = 
                   \restrictkind{\Delta, \Delta'}$ \\
      \ooooo Since no kind in $\restrictkind{\Delta'}$ has any free variables, 
             $\restrictkind{\Delta'} = \restrictkind{[\tau/u]\Delta'}$ \\
      \ooooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = 
                   \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \ooooo Therefore $D'_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]
                                       {A}{\bigstar}$ \\
      \ooooo Therefore $u \not\in FV(A)$ \\
      \ooooo Therefore $A = [p/u]A$ \\
      \ooooo Therefore $D'_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]
                                      {[p/u]A}{\bigstar}$ \\
      \ooooo By rule \textsc{SortType} on $D'_1, D'_2$, we have 
              $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]A}$ \\
      
    \end{tabbedproof}
  \end{itemize}
\end{enumerate}
\end{proof}

\subsubsection{Semantics of Sort Substitution}

\begin{lemma}{(Substitution Preserves Meaning)}
If we have that $\judgeA{p}{\omega}$, then 

\begin{enumerate}
\item If $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
      then $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$

\item  $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\omega'}}\;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}}\;(\delta, \delta')$. 
\end{enumerate}
\end{lemma}

\begin{proof}
  We proceed by mutual induction on the derivations of context
  well-formedness and sort well-formedness. 

  As a note, even though contexts are properly maximally nested tuples
  (a la Lisp s-expressions), we will overload the tuple notation and
  treat expressions like $(\delta, \delta')$ as if the comma were a
  proper concatenation that reassociates everything. This is a
  harmless convenience thanks to the fact that tuples are associative
  up to isomorphism.

  \noindent Assume $D_0 :: \judgeA{p}{\omega}$ \\

  \begin{enumerate}
  \item First, we want to show if $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in 
                                   \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
      then $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$
      
      \begin{itemize}
      \item Case \textsc{CtxNil}:
        \begin{tabbedproof}
          \oo Assume $\judgeACtx{\cdot}$ \\
          \ooo Therefore $\cdot = \Delta, u:\omega, \Delta'$ \\
          \ooo This is a contradiction; hence this case is impossible. \\
        \end{tabbedproof}

      \item Case \textsc{CtxCons}: 
        \begin{tabbedproof}
          \oo Assume $D :: \judgeACtx{\Delta_1, u_1:\omega_1}$ \\
          \oo Assume $(\delta, \interp{\judgeA[\Delta]{p}{\omega}}\;\delta, \delta') \in 
                       \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
          \ooo Therefore $\Delta, u:\omega, \Delta' = \Delta_1, u_1:\omega_1$ \\
          \ooo Case analyze $\Delta'$: \\
          \oooo If $\Delta' = \cdot$: \\
          \ooooo Then $\delta' = \unit$ \\
          \ooooo Then $\Delta = \Delta_1$ and $u = u_1$ and $\omega = \omega_1$ \\
          \ooooo By inversion on $D :: \judgeACtx{\Delta_1, u:\omega}$, we get:\\
          \oooooo $D_1 :: \judgeACtx{\Delta}$ \\
          \oooooo $D_2 :: \judgeSort[\Delta]{\omega}$ \\
          \ooooo By definition, $\delta \in \interp{\judgeACtx{\Delta}}$ \\
          \ooooo By definition $[p/u]\cdot = \cdot$, and $\Delta, \cdot = \Delta$ \\
          \ooooo Since $\delta' = \unit$, we have $(\delta, \delta') = \delta$ \\
          \ooooo Therefore $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
          \oooo If $\Delta' = \Delta'', u'':\omega''$: \\
          \ooooo Then $\Delta, u:\omega, \Delta' = \Delta, u:\omega, \Delta'', u'':\omega''$ \\
          \ooooo Then $\delta' = (\delta'', v'')$ \\
          \ooooo By inversion on $D$, we get: \\
          \oooooo $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'', u'':\omega''}$ \\
          \oooooo $D_2 :: \judgeSort[{\Delta, u:\omega, \Delta''}]{\omega''}$ \\
          \ooooo Therefore, $(\delta, \interp{p}{\omega}\;\delta, \delta'') \in 
                             \interp{\Delta, u:\omega, \Delta''}$ \\
          \ooooo Therefore, $v'' \in 
                  \interp{\judgeSort[{\Delta, u:\omega, \Delta''}]{\omega''}}\;
                     (\delta, \interp{p}{\omega}\;\delta, \delta'')$ \\
          \ooooo Then, by induction on $D_1$, we have $(\delta, \delta'') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
          \ooooo Then, by mutual induction on $D_2$, we have \\ 
          \oooox  $\interp{\judgeSort[{\Delta, u:\omega, \Delta''}]{\omega''}} 
                      \;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta'') 
                    = 
                    \interp{\judgeSort[{\Delta, [p/u]\Delta''}]{[p/u]\omega''}}\;(\delta,\delta'')$ \\
          \ooooo Therefore, $v'' \in \interp{\judgeSort[{\Delta, [p/u]\Delta''}]{[p/u]\omega''}}\;(\delta,\delta'')$ \\ 
          \ooooo Therefore, by definition of semantics, 
                   $(\delta, \delta'', v'') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'', [p/u]\omega''}}$ \\
          \ooooo Therefore $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
        \end{tabbedproof}
      \end{itemize}

  \item Now we want to show 
    \begin{displaymath}
      \interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\omega'}}\;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}}\;(\delta, \delta')
    \end{displaymath}

    \begin{itemize}
    \item Case \textsc{SortKind}: 
      \begin{tabbedproof}
        \oo Assume we have $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\kappa}$ \\
        \ooo Then $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\kappa}}\;
                     (\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\kappa}$ \\
        \ooo By syntactic substitution, we have $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By rule \textsc{SortKind}, we have $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}$ \\
        \ooo Since $[p/u]\kappa = \kappa$, we have $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{\kappa}$ \\
        \ooo Then $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}}\;(\delta, \delta') = 
                \interp{\kappa}$ \\
        \ooo So we have: \\
        \ooox $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\kappa}}\;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') =$ \\
        \ooox $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}}\;(\delta, \delta')$ \\
      \end{tabbedproof}

    \item Case \textsc{SortProp}: 
      \begin{tabbedproof}
        \oo Assume we have $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\assert}$ \\
        \ooo Then $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\assert}}\;
                     (\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \powerset{H}$ \\
        \ooo By syntactic substitution, we have $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By rule \textsc{SortProp}, we have $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\assert}$ \\
        \ooo Since $[p/u]\assert = \assert$, we have $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{\assert}$ \\
        \ooo Then $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\assert}}\;(\delta, \delta') = 
                \powerset{H}$ \\
        \ooo So we have: \\
        \ooox $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\assert}}\;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') =$ \\
        \ooox $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\assert}}\;(\delta, \delta')$ \\
      \end{tabbedproof}

    \item Case \textsc{SortImp}: 
      \begin{tabbedproof}
        \oo Assume we have $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\omega_1 \To \omega_2}$ \\
        \ooo Then by inversion on $D$ we have:\\
        \oooo $D_1 :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\omega_1}$ \\
        \oooo $D_2 :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\omega_2}$ \\
        \ooo By semantics, $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta')$\\
        \ooox $= \interp{D_1}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta')
                 \to
                  \interp{D_2}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta')$\\
        \ooo By syntactic substitution on $D_1$, we have
               $D'_1 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_1}$ \\
        \ooo By syntactic substitution on $D_2$, we have
               $D'_2 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_2}$ \\
        \ooo By induction on $D'_1$, we have 
              $\interp{D_1}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
               \interp{D'_1}(\delta, \delta')$ \\
        \ooo By induction on $D'_2$, we have 
              $\interp{D_2}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
               \interp{D'_2}(\delta, \delta')$ \\
        \ooo Therefore $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
                         \interp{D'_1}(\delta, \delta') \to 
                         \interp{D'_2}(\delta, \delta')$ \\
        \ooo By rule \textsc{SortImp} on $D'_1, D'_2$, we have 
              $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_1 \To [p/u]\omega_2}$ \\
        \ooo By definition of substitution, $[p/u]\omega_1 \To [p/u]\omega_2 = [p/u](\omega_1 \To \omega_2)$ \\
        \ooo Therefore $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u](\omega_1 \To \omega_2)}$ \\
        \ooo By semantics, 
              $\interp{D'}(\delta, \delta') = \interp{D'_1}(\delta, \delta') \to 
                                              \interp{D'_2}(\delta, \delta')$ \\
        \ooo Therefore $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') 
                        = \interp{D'}(\delta,\delta')$ \\
      \end{tabbedproof}

    \item Case \textsc{SortType}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{A}$ \\
        \ooo By inversion on $D$, we have: \\
        \oooo $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \oooo $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]{A}{\bigstar}$ \\
        \ooo By semantics, $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
                              \interp{D_2}\;(\restricttyenv{\Delta, u:\omega, \Delta'}
                                                           {(\delta, \interp{\judgeA{p}{\omega}}, \delta')})$ \\
        \ooo Case-analyze $\omega$:\\
        \oooo If $\omega = \kappa$:\\
        \ooooo Then $D_0 :: \judgeA{\tau}{\kappa}$, where $p = \tau$ \\
        \ooooo Then  $D_2 :: \judgeWK[\restrictkind{\Delta, u:\kappa, \Delta'}]{A}{\bigstar}$ \\
        \ooooo By inversion on $D_0$, we have $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}$ \\
        \ooooo By semantics, $\interp{D_0}\;\delta = \interp{D'_0}\;(\restricttyenv{\Delta}{\delta})$\\
        \ooooo This is the result of substituting the canonical witness of $\tau$ filled in\\
        \oooox with the type constructors in $\delta$. \\
        \ooooo Likewise, the interpretation of $D_2$ is the result of substituting $A$ with\\
        \oooox the type constructors in $(\delta, \interp{D_0}\;\delta, \delta')$ \\
        \ooooo By the properties of substitutions, $\interp{D_2}$ is equal to substituting 
               $\tau$ for $u$ in $A$, \\
        \oooox and then substituting the remaining type constructors in 
               $(\delta, \delta')$. \\
        \ooooo Then, the well-kindedness of this comes from the well-kindedness \\
        \oooox of substitution for type constructors. \\
        \oooo If $\omega \not= \kappa$: \\
        \ooooo Then  $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]{A}{\bigstar}$ \\
        \ooooo Because $\omega \not= \kappa$, 
                 $\restrictkind{\Delta, u:\omega, \Delta'} = \restrictkind{\Delta, \Delta'}$ \\
        \ooooo Because kinds have no variables, 
                 $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
        \ooooo Therefore $(\delta, \delta') \in \restrictkind{\Delta, [p/u]\Delta'}$ \\
        \ooooo Because $u \not\in FV(A)$, $A = [p/u]A$ \\
        \ooooo Thus $D_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]{[p/u]A}{\bigstar}$ \\
        \ooooo By mutual induction on $D_1$, we have $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooooo Then by rule \textsc{SortType}, we have $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]A}$ \\
        \ooooo So $\interp{D'}(\delta, \delta') = \interp{D_2}(\restricttyenv{\Delta,[p/u]\Delta'}{\delta, \delta'})$ \\
        \ooooo But then, $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
                          \interp{D'}(\delta, \delta')$ \\

      \end{tabbedproof}
    \end{itemize}
  \end{enumerate}
\end{proof}
  

\subsection{Substitution for Equality Judgement}

\subsubsection{Syntactic Substitution}

\begin{lemma}{(Syntactic Substitution for Equality Judgement)}
If we have that $\judgeA{p}{\omega}$ and $\judgeACtx{\Delta, u:\omega, \Delta'}$, and we have that 
$\judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega_1}{\omega_2}$, 
then $\judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}{[p/u]\omega''}$. 
\end{lemma}

\begin{proof}
Assume $D_0 :: \judgeA{p}{\omega}$, and $D_C :: \judgeACtx{\Delta, u:\omega, \Delta'}$.  
Now we'll proceed by structural induction on the equality judgement. 
\begin{itemize}
\item Case \textsc{SortEqProp}:
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\assert}{\assert}$\\
    \ooo By context substitution on $D_C$, we have $D'_C :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \ooo By rule \textsc{SortEqProp}, we have $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{\assert}{\assert}$ \\
    \ooo By definition of substitution, $\assert = [p/u]\assert$ \\
    \ooo Therefore $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\assert}{[p/u]\assert}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqKind}: 
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\kappa}{\kappa}$\\
    \ooo By context substitution on $D_C$, we have $D'_C :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \ooo By rule \textsc{SortEqKind}, we have $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{\kappa}{\kappa}$ \\
    \ooo By definition of substitution, $\kappa = [p/u]\kappa$ \\
    \ooo Therefore $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}{[p/u]\kappa}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqImp}: 
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'_1 \To \omega''_1}{\omega'_2 \To \omega''_2}$\\
    \ooo By context substitution on $D_C$, we have $D'_C :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \ooo By inversion on $D$, we get \\
    \oooo $E_1 :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'_1}{\omega''_1}$\\
    \oooo $E_2 :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'_2}{\omega''_2}$\\
    \ooo By induction on $E_1$, we have $E'_1 :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'_1}{[p/u]\omega''_1}$\\
    \ooo By induction on $E_2$, we have $E'_2 :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'_2}{[p/u]\omega''_2}$\\
    \ooo By rule \textsc{SortEqImp} with $E'_1, E'_2$, we have  \\
    \ooox $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'_1 \To [p/u]\omega''_1}{[p/u]\omega'_2 \To [p/u]\omega''_2}$\\
    \ooo By definition of substitution, $[p/u]\omega'_1 \To [p/u]\omega''_1 = [p/u](\omega'_1 \To \omega''_1)$\\
    \ooo By definition of substitution, $[p/u]\omega'_2 \To [p/u]\omega''_2 = [p/u](\omega'_2 \To \omega''_2)$\\
    \ooo Therefore 
           $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u](\omega'_1 \To \omega''_1)}{[p/u](\omega'_2 \To \omega''_2)}$\\
  \end{tabbedproof}

\item Case \textsc{SortEqType}:
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{A}{B}$ \\
    \ooo By inversion on $D$, we have $D_1 :: \judgeKeq[{\restrictkind{\Delta, u:\omega, \Delta'}}]{A}{B}{\bigstar}$ \\
    \ooo Case analyze $\omega$: \\
    \oooo When $\omega = \kappa$: \\
    \ooooo We have $\judgeA{\Delta}{\tau}{\kappa}$, where $p = \tau$ \\
    \ooooo By definition, 
           $\restrictkind{\Delta, u:\kappa, \Delta'} = \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
    \ooooo Therefore $D_1 :: \judgeKeq[{\restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}}]{A}{B}{\bigstar}$ \\
    \ooooo By equality rule for types, we have 
           $D'_1 :: \judgeKeq[{\restrictkind{\Delta}, \restrictkind{\Delta'}}]{[\tau/u]A}{[\tau/u]B}{\bigstar}$ \\
    \ooooo Since kinds have no free variables, $\restrictkind{\Delta'} = \restrictkind{[\tau/u]\Delta'}$ \\
    \ooooo Therefore $D'_1 :: \judgeKeq[{\restrictkind{\Delta}, \restrictkind{[\tau/u]\Delta'}}]{[\tau/u]A}{[\tau/u]B}{\bigstar}$ \\
    \ooooo By rule \textsc{SortEqType}, we have 
            $D' :: \judgeSortEq[{\Delta, [\tau/u]\Delta'}]{[\tau/u]A}{[\tau/u]B}$ \\
    \ooooo Therefore $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]A}{[p/u]B}$ \\
    \oooo Otherwise when $\omega \not= \kappa$: \\
    \ooooo By definition, 
           $\restrictkind{\Delta, u:\kappa, \Delta'} = \restrictkind{\Delta}, \restrictkind{\Delta'}$ \\
    \ooooo Since kinds have no free variables, $\restrictkind{\Delta'} = \restrictkind{[p/u]\Delta'}$ \\
    \ooooo Therefore $\restrictkind{\Delta, u:\kappa, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
    \ooooo Since $u \not\in FV(A)$, we have $[p/u]A = A$ \\
    \ooooo Since $u \not\in FV(B)$, we have $[p/u]A = B$ \\
    \ooooo Therefore $D_1 :: \judgeKeq[{\restrictkind{\Delta, [p/u]\Delta'}}]{[p/u]A}{[p/u]B}{\bigstar}$ \\
    \ooooo By rule \textsc{SortEqType}, we have $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]A}{[p/u]B}$\\
  \end{tabbedproof}
\end{itemize}
\end{proof}


\subsection{Substitution for Terms and Specifications}

\subsubsection{Syntactic Substitution}

\begin{lemma}{(Syntactic Substitution for Terms and Specifications)}
Suppose that $D_0 :: \judgeA{p}{\omega}$. Then
\begin{enumerate}
\item If $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, then 
         $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$. 
\item If $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, then 
         $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$. 
\end{enumerate}
\end{lemma}
\begin{proof}
  Assume $D_0 :: \judgeA{p}{\omega}$.
  \begin{enumerate}
  \item We want to show if $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, then 
         $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$.
    \begin{itemize}
    \item Case \textsc{TermType}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{\tau}{\kappa}$, 
            where $q = \tau$ and $\omega' = \kappa$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \ooo By mutual induction on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By inversion on $D$, we have 
                 $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]
                                 {\tau}{\kappa}$ \\
        \ooo Case analysis on $\omega$:\\
        \oooo If $\omega = \kappa'$: \\
        \ooooo Then $D_0 :: \judgeA[\Delta]{\tau'}{\kappa'}$, with $p = \tau'$ \\
        \ooooo By inversion on $D_0$, we have 
                $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau'}{\kappa'}$ \\
        \ooooo Then $\restrictkind{\Delta, u:\kappa', \Delta'} = 
                       \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
        \ooooo Thus $D_2 :: \judgeWK[\restrictkind{\Delta}, u:\kappa', \restrictkind{\Delta'}]
                                   {\tau}{\kappa}$ \\
        \ooooo By type substitution, 
                 $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                  {[\tau'/u]\tau}{\kappa}$ \\
        \ooooo Since $\restrictkind{\Delta'}$ has no free variables in kinds, 
                 $\restrictkind{\Delta'} = \restrictkind{[\tau'/u]\Delta'}$ \\
        \ooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[\tau'/u]\Delta'}]
                                  {[\tau'/u]\tau}{\kappa}$ \\
        \ooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]
                                  {[p/u]\tau}{\kappa}$ \\
        \ooooo By rule \textsc{TermType} on $D'_1, D'_2$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{\kappa}$  \\
        \ooooo Since $[p/u]\kappa = \kappa$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{[p/u]\kappa}$ \\
        \oooo If $\omega \not=\kappa'$: \\
        \ooooo Then $\restrictkind{\Delta, u:\kappa', \Delta'} = 
                       \restrictkind{\Delta}, \restrictkind{\Delta'}$ \\
        \ooooo Then $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                   {\tau}{\kappa}$ \\
        \ooooo So $u \not \in FV(\tau)$ \\
        \ooooo Hence $[p/u]\tau = \tau$ \\
        \ooooo So $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                   {[p/u]\tau}{\kappa}$ \\
        \ooooo Since $\restrictkind{\Delta'}$ has no free variables in kinds, 
                 $\restrictkind{\Delta'} = \restrictkind{[\tau'/u]\Delta'}$ \\
        \ooooo So $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]
                                   {[p/u]\tau}{\kappa}$ \\
        \ooooo Since $[p/u]\kappa = \kappa$,
               $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]
                                   {[p/u]\tau}{[p/u]\kappa}$ \\
        \ooooo By rule \textsc{TermType} on $D'_1, D_2$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{[p/u]\kappa}$  \\
      \end{tabbedproof}

    \item Case \textsc{TermExpr}:
      \begin{tabbedproof}
      \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{e}{A}$, 
           where $q = e$ and $\omega' = A$ \\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo By inversion on $D$, we have 
           $D_2 :: \judgeE[\restrictkind{\Delta, u:\omega, \Delta'}]
                          {\restricttype{\Delta, u:\omega, \Delta'}}{e}{A}$ \\
      \ooo Case analyze $\omega$: \\
      \oooo If $\omega = \kappa$: \\
      \ooooo We have $D_0 :: \judgeA{\tau}{\kappa}$ where $p = \tau$ \\
      \ooooo By inversion on $D_0$, 
             we have $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}$ \\
      \ooooo We have $D_2 :: \judgeE[\restrictkind{\Delta, u:\kappa, \Delta'}]
                                    {\restricttype{\Delta, u:\kappa, \Delta'}}
                                    {e}{A}$ \\ 
      \ooooo Note $\restricttype{\Delta, u:\kappa, \Delta'} = \restricttype{\Delta, \Delta'}$ \\
      \ooooo Therefore $D_2 :: \judgeE[\restrictkind{\Delta, u:\kappa, \Delta'}]
                                    {\restricttype{\Delta, \Delta'}}
                                    {e}{A}$ \\ 
      \ooooo By type substitution, 
                 $D'_2 :: \judgeE[\restrictkind{\Delta, \Delta'}]
                                 {\restricttype{[\tau/u]\Delta, [\tau/u]\Delta'}}
                                 {[\tau/u]e}{[\tau/u]A}$ \\
      \ooooo Since no kind has free variables,  we have
                $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [\tau/u]\Delta'}$ \\
      \ooooo Since $u \not\in FV(\Delta)$, we have
                $\restricttype{[\tau/u]\Delta, [\tau/u]\Delta'} = 
                 \restricttype{\Delta, [\tau/u]\Delta'}$ \\
      \ooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [\tau/u]\Delta'}]
                                 {\restricttype{\Delta, [\tau/u]\Delta'}}
                                 {[\tau/u]e}{[\tau/u]A}$ \\
      \ooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                                 {\restricttype{\Delta, [p/u]\Delta'}}
                                 {[p/u]e}{[p/u]A}$ \\
      \oooo If $\omega = B$: \\
      \ooooo We have $D_0 :: \judgeA[\Delta]{e'}{A}$, where $p = e'$ \\
      \ooooo By inversion on $D_0$, we have 
               $D'_0 :: \judgeE[\restrictkind{\Delta}]
                               {\restricttype{\Delta}}{e}{A}$ \\
      \ooooo By weakening, we have 
               $D''_0 :: \judgeE[\restrictkind{\Delta, u:B, \Delta'}]
                               {\restricttype{\Delta}}{e}{A}$ \\
      \ooooo We also have
              $D_2 :: \judgeE[\restrictkind{\Delta, u:B, \Delta'}]
                             {\restrictkind{\Delta, u:B, \Delta'}}
                             {e}{A}$ \\
      \ooooo By substitution on $D''_0$ into $D'_2$, we have \\
      \ooooo \;\;
              $D'_2 :: \judgeE[\restrictkind{\Delta, u:B, \Delta'}]
                              {\restricttype{\Delta}, \restricttype{\Delta}}
                              {[e'/u]e}{A}$ \\
      \ooooo So $\restrictkind{\Delta, u:B, \Delta'} = \restrictkind{\Delta, \Delta'}$ \\
      \ooooo Since $u:B$ not free in kinds, 
             $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [e'/u]\Delta'}$ \\
      \ooooo Since $u:B$ not free in types, 
             $\restricttype{\Delta, \Delta'} = \restricttype{\Delta, [e'/u]\Delta'}$ \\
      \ooooo Since $u:B$ not free in types, 
             $[e'/u]A = A$ \\
      \ooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [e'/u]\Delta'}]
                               {\restricttype{\Delta, [e'/u]\Delta}}
                               {[e'/u]e}{[e'/u]A}$ \\
      \ooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                               {\restricttype{\Delta, [p/u]\Delta}}
                               {[p/u]e}{[p/u]A}$ \\
      \oooo Otherwise $\omega \not\in \setof{A, \kappa}$:  \\
      \ooooo Since $\omega$ is not a kind, 
               $\restrictkind{\Delta, u:\omega, \Delta'} = \restrictkind{\Delta, \Delta'}$\\
      \ooooo Since $\omega$ is not a type, 
               $\restricttype{\Delta, u:\omega, \Delta'} = \restricttype{\Delta, \Delta'}$ \\
      \ooooo Since kinds have no free variables, 
               $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$  \\
      \ooooo Since types have no non-kinded variables, 
               $\restricttype{\Delta, \Delta'} = \restricttype{\Delta, [p/u]\Delta'}$ \\
      \ooooo Since $u \not\in FV(e)$, $[p/u]e = e$ \\
      \ooooo Since $u \not\in FV(A)$, $[p/u]A = A$ \\
      \ooooo Therefore $D_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                                      {\restricttype{\Delta, [p/u]\Delta'}}
                                      {[p/u]e}{[p/u]A}$ \\
      \ooo Therefore $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                                      {\restricttype{\Delta, [p/u]\Delta'}}
                                      {[p/u]e}{[p/u]A}$ \\
      \ooo By rule \textsc{TermExpr} on $D'_1, D'_2$, we have
            $\judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u]A}$ \\
      \ooo Therefore, 
            $\judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ \\
      \end{tabbedproof}
    
    \item Case \textsc{TermHyp}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{u}{\omega}$ \\
        \ooo By inversion on $D$, we have $m :: \omega = \assert \vee \omega = \omega' \To \omega''$\\
        \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \ooo By mutual induction on $D_1$, $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By iterated weakening on $D_0$, we have $D'_0 :: \judgeA[{\Delta, [p/u]\Delta'}]{p}{\omega}$ \\
        \ooo By definition of substitution, $[p/u]u = p$ \\
        \ooo Since $u \not\in FV(\omega)$, we have $[p/u]\omega = \omega$ \\
        \ooo Therefore $D'_0 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]u}{\omega}$ \\
      \end{tabbedproof}
      
    \item Case \textsc{TermAbs}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{\pfun{u_1}{\omega_1}{q}}{\omega_1 \To \omega_2}$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[\Delta, u:\omega, \Delta', u_1:\omega_1]{q}{\omega_2}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta', u_1:[p/u]\omega_1}]{[p/u]q}{[p/u]\omega_2}$ \\
        \ooo By rule \textsc{TermAbs}, 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{\pfun{u_1}{[p/u]\omega_1}{[p/u]q}}{[p/u]\omega_1 \To [p/u]\omega_2}$ \\
        \ooo By substitution definition, $[p/u]\omega_1 \To [p/u]\omega_2 = [p/u](\omega_1 \To \omega_2)$ \\
        \ooo By substitution definition, $\pfun{u_1}{[p/u]\omega_1}{[p/u]q} = [p/u](\pfun{u_1}{\omega_1}{q})$ \\
        \ooo Therefore 
           $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](\pfun{u_1}{\omega_1}{q})}{[p/u](\omega_1 \To \omega_2)}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermApp}
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{q'\;q''}{\omega'}$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[\Delta, u:\omega, \Delta']{q'}{\omega'' \To \omega'}$ \\
        \ooo By inversion on $D$, we have $D_2 :: \judgeA[\Delta, u:\omega, \Delta']{q''}{\omega''}$ \\
        \ooo By induction on $D_1$, we have $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u](\omega'' \To \omega')}$ \\
        \ooo By induction on $D_2$, we have $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q''}{[p/u]\omega''}$ \\
        \ooo By definition of substitution, $[p/u](\omega'' \To \omega') = [p/u]\omega'' \To [p/u]\omega'$ \\
        \ooo Therefore, $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u]\omega'' \To [p/u]\omega'}$ \\
        \ooo By rule \textsc{TermApp}, we have 
           $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{([p/u]q')\;([p/u]q'')}{[p/u]\omega'}$ \\
        \ooo By definition of substitution, $([p/u]q')\;([p/u]q'') = [p/u](q'\;q'')$ \\
        \ooo Therefore $D' :: \judgeA{\Delta, [p/u]\Delta'}{[p/u](q'\;q'')}{[p/u]\omega'}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermPropConst}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{c}{\assert}$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \ooo By inversion on $D$, we have $c \in \setof{\top, \bot, \emp}$ \\
        \ooo By mutual induction on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By rule \textsc{TermPropConst} on $D_1$ and line 3, we have
            $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{c}{\assert}$ \\
        \ooo By definition of substitution, $[p/u]c = c$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]c}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermPropBinary}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{q_1 \oplus q_2}{\assert}$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[\Delta, u:\omega, \Delta']{q_1}{\assert}$ \\
        \ooo By inversion on $D$, we have $D_2 :: \judgeA[\Delta, u:\omega, \Delta']{q_2}{\assert}$ \\
        \ooo By inversion on $D$, we have $\oplus \in \setof{\land, \implies, \vee, *, \wand}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1}{[p/u]\assert}$ \\
        \ooo By induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_2}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1}{\assert}$ \\
        \ooo Therefore $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_2}{\assert}$ \\
        \ooo By rule \textsc{TermPropBinary} on $D'_1, D'_2$, and line 4, we have: \\
        \oox \;\; $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1 \oplus [p/u]q_2}{\assert}$ \\
        \ooo By definition of substitution, $[p/u](q_1 \oplus q_2) = [p/u]q_1 \oplus [p/u]q_2$ \\
        \ooo Therefore $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](q_1 \oplus q_2)}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermPropQuantify}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{Q u_1:\omega_1.\; q}{\assert}$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[\Delta, u:\omega, \Delta', u_1:\omega_1]{q}{\assert}$ \\
        \ooo By inversion on $D$, we have $Q \in \setof{\forall, \exists}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[\Delta, [p/u]\Delta', u_1:[p/u]\omega_1]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D'_1 :: \judgeA[{\Delta, [p/u]\Delta', u_1:[p/u]\omega_1}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{TermPropQuantify} on $D'_1$ and line 3, we have \\
        \oox $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{Q u_1:[p/u]\omega_1.\;[p/u]q}{\assert}$ \\
        \ooo By definition of substitution, $Q u_1:[p/u]\omega_1.\;[p/u]q = [p/u](Q u:\omega_1.\; q)$ \\
        \ooo Therefore $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](Q u_1:\omega_1.\;q)}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item case \textsc{TermPointsTo}
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta]{e \pointsto_A e'}{\assert}$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[\Delta, u:\omega, \Delta]{e}{\reftype{A}}$ \\
        \ooo By inversion on $D$, we have 
             $D_2 :: \judgeA[\Delta, u:\omega, \Delta]{e'}{A}$ \\
        \ooo By induction on $D_1$, we have
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u]\reftype{A}}$ \\
        \ooo By induction on $D_2$, we have
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e'}{[p/u]A}$ \\
        \ooo By definition of substitution, $[p/u]\reftype{A} = \reftype{([p/u]A)}$ \\
        \ooo Therefore, 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{\reftype{([p/u]A)}}$ \\
        \ooo By rule \textsc{TermPointsTo}, 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e \pointsto_{[p/u]A} [p/u]e'}{\assert}$ \\
        \ooo By definition of substitution, $[p/u]e \pointsto_{[p/u]A} e' = [p/u](e \pointsto_A e')$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](e \pointsto_A e')}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermEqual}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q =_{\omega'} q'}{\assert}$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega}$ \\
        \ooo By inversion on $D$, we have 
             $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q'}{\omega}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega}$ \\
        \ooo By induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u]\omega}$ \\
        \ooo By rule \textsc{TermEqual}, we have 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q =_{[p/u]\omega} [p/u]q'}{\assert}$ \\
        \ooo By definition of substitution, $[p/u]q =_{[p/u]\omega} [p/u]q' = [p/u](q =_\omega q')$\\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](q =_\omega q')}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermEqSort}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega''}$ \\
        \ooo By inversion on $D$, we have 
             $D_2 :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'}{\omega''}$ \\
        \ooo By induction, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega''}$ \\
        \ooo By equality sort substitution, 
             $D'_2 :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}{[p/u]\omega''}$ \\
        \ooo By rule \textsc{TermEqSort}, 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermSpec}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{\validprop{S}}{\assert}$ \\
        \ooo By inversion on $D$, we have
             $D_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$ \\
        \ooo By rule \textsc{TermSpec}, we have 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{\validprop{([p/u]S)}}{\assert}$ \\
        \ooo By definition of substitution, $\validprop{([p/u]S)} = [p/u](\validprop{S})$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](\validprop{S})}{[p/u]\assert}$ \\
      \end{tabbedproof}
    \end{itemize}

  \item We want to show if $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, then 
         $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$. 
    \begin{itemize}
    \item Case \textsc{SpecTriple}
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\spec{q}{c}{a:A}{r}}$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
        \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{\comp{c}}{\monad{A}}$ \\
        \oooo $D_3 :: \judgeA[{\Delta, u:\omega, \Delta', a:A}]{r}{\assert}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By mutual induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\comp{c}}{[p/u]\monad{A}}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]r}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo By definition of substitution, $[p/u]\comp{c} = \comp{[p/u]c}$ \\
        \ooo By definition of substitution, $[p/u]\monad{A} = \monad{([p/u]A)}$ \\
        \ooo Therefore we have:\\
        \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
        \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{\comp{[p/u]c}}{\monad{([p/u]A)}}$ \\
        \oooo $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{SpecTriple} on $D'_1, D'_2, D'_3$, we have \\
        \oox $D' :: \judgeS[{\Delta, [p/u]\Delta'}]
                            {\spec{[p/u]q}{[p/u]c}{a:[p/u]A}{[p/u]r}}$ \\
        \ooo By definition of substitution, we have \\
        \oox $\spec{[p/u]q}{[p/u]c}{a:[p/u]A}{[p/u]r} = [p/u]\spec{q}{c}{a:A}{r}$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]\spec{q}{c}{a:A}{r}}$ \\
      \end{tabbedproof}

    \item case \textsc{SpecMTriple}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\mspec{q}{c}{a:A}{r}}$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
        \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{e}{\monad{A}}$ \\
        \oooo $D_3 :: \judgeA[{\Delta, u:\omega, \Delta', a:A}]{r}{\assert}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By mutual induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u]\monad{A}}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]r}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo By definition of substitution, $[p/u]\monad{A} = \monad{([p/u]A)}$ \\
        \ooo Therefore we have:\\
        \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
        \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{\monad{([p/u]A)}}$ \\
        \oooo $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{SpecTriple} on $D'_1, D'_2, D'_3$, we have \\
        \oox $D' :: \judgeS[{\Delta, [p/u]\Delta'}]
                            {\mspec{[p/u]q}{[p/u]e}{a:[p/u]A}{[p/u]r}}$ \\
        \ooo By definition of substitution, we have \\
        \oox $\mspec{[p/u]q}{[p/u]e}{a:[p/u]A}{[p/u]r} = [p/u]\mspec{q}{e}{a:A}{r}$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]\mspec{q}{e}{a:A}{r}}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecAssert}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\setof{q}}$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
        \ooo By mutual induction on $D_1$, we have 
              $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{SpecAssert}, 
              $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{\validprop{([p/u]q)}}$ \\
        \ooo By definition of substitution, $\validprop{([p/u]q)} = [p/u](\validprop{S})$ \\
        \ooo Therefore 
             $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](\validprop{q})}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecBinary}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_1 \oplus S_2}$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_1}$ \\
        \oooo $D_2 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_2}$ \\
        \oooo $\oplus \in \setof{\specand, \specor, \specimp}$ \\
        \ooo By induction on $D_1$, we have 
               $D'_1 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S_1}$ \\
        \ooo By induction on $D_2$, we have 
               $D'_2 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S_2}$ \\
        \ooo By rule \textsc{SpecBinary} on $D'_1, D'_2$ and line 5, we have \\
        \ooox $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S_1 \oplus [p/u]S_2}$ \\
        \ooo By definition of substitution, $[p/u]S_1 \oplus [p/u]S_2 = [p/u](S_1 \oplus S_2)$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](S_1 \oplus S_2)}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecQuantify}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{Q u':\omega'.\; S}$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeS[{\Delta, u:\omega, \Delta', u':\omega'}]{S}$ \\
        \oooo $Q \in \setof{\forall, \exists}$ \\
        \ooo By induction on $D_1$, we have $D'_1 :: \judgeS[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]S}$ \\
        \ooo By rule \textsc{SpecQuantify}, 
              $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{Q u':[p/u]\omega'.\; [p/u]S}$ \\
        \ooo By definition of substitution, $Q u':[p/u]\omega'.\; [p/u]S = [p/u](Q u':\omega'.\; S)$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](Q u':\omega'.\; S)}$ \\
        
      \end{tabbedproof}
    \end{itemize}
  \end{enumerate}
\end{proof}
  

