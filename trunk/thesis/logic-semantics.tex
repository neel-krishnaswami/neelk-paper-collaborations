\chapter{The Semantics of Separation Logic}

In this chapter, I will describe the semantics of our separation
logic. Rather than working directly with the heap model of separation
logic, we will approach the semantics in a somewhat more modular
style.

First, we will define what we mean by ``semantics of separation logic''
in terms of \emph{BI algebras}, which give an algebraic semantics of
separation logic in the same way that the Heyting algebras give
semantics to intuitionistic logics. Then, we will look at how we can
construct a BI-algebra from sets of elements of an arbitrary partial
commutative monoid, proving that we can satisfy each of the axioms of
a BI algebra.

Then, we will show that our predomain of heaps actually forms a
partial commutative monoid, which means that we can now apply the
theorems and definitions of the previous sections to immediately get
the heap model we want.

With a semantic definition of assertions in hand, we will then move on
to the semantics of specifications. We will again play the algebraic
game, and give a Kripke semantics for specifications. We will also
give a semantic interpretation of Hoare triples which validates the
frame rule and fixed point induction.

After defining the semantics of assertions and specifications, I will
give their syntax.

\section{BI Algebras}

A \emph{BI algebra} is a Heyting algebra with additional residuated
monoidal structure to model the separating conjunction and wand. This
means that a BI algebra is a partial order $(B, \leq)$ with operations
$(\top, \land, \implies, \bot, \vee, I, *, \wand)$ satisfying:

\begin{enumerate}
\item $\forall p \in B.\; p \leq \top$
\item $\forall p \in B.\; \bot \leq p$
\item $\forall p,q,r \in B.$ if $r \leq p$ and $r \leq q$, then
      $r \leq p \land q$ and 
      $p \land q \leq p$ and $p \land q \leq q$
\item $\forall p,q,r \in B.$ if $p \leq r$ and $q \leq r$, then
      $p \vee q \leq r$ and
      $p \leq p \vee q$ and $q \leq p \vee q$.
\item $\forall p, q, r.\; p \land q \leq r \iff p \leq q \implies r$
\item $\forall p.\; p * I = p$
\item $\forall p, q.\; p * q = q * p$
\item $\forall p, q, r.\; (p * q) * r = p * (q * r)$
\item $\forall p, q, r.\; p * q \leq r \iff p \leq q \wand r$
\end{enumerate}

The first five conditions are just the usual conditions for a Heyting
algebra (that it have greatest and least elements, greatest lower
bounds and least upper bounds, and that it have an implication). The
next three are the monoid structure axioms, that say $I$ is the unit,
and that $*$ is commutative and associative. The last axiom asserts
the existence of a wand that is adjoint to the separating conjunction
the same way that the implication is adjoint to the ordinary
conjunction.

In addition, we will also ask that this algebra be \emph{complete},
which means that meets and joins of arbitrary sets of elements be
well-defined.

\begin{enumerate}
\item[10.] $\forall r\in B, P \subseteq B.$ if $(\forall p \in P.\; r \leq p)$, then  
      $r \leq \bigwedge P $ and 
      $\forall p \in P.\; \bigwedge P \leq p$
\item[11.] $\forall r \in B, P \subseteq B.$ if $(\forall p \in P.\; p \leq r)$, then  
      $\bigvee P \leq r$ and 
      $\forall p \in P.\; p \leq \bigvee P$
\end{enumerate}

We will eventually use completeness in order to interpret quantifiers as 
possibly-infinitary conjunctions or disjunctions.
 
\subsection{Partial Commutative Monoids}

A partial commutative monoid is a triple $(M, e, \cdot)$, where $e \in
M$, and $(\cdot)$ is a partial operation from $M \times M$ to $M$. We
will write $m \# m'$ to mean that $m \cdot m'$ is defined. 

Furthermore, the following properties must hold:

\begin{itemize}
\item $e$ is a unit, so that $e \cdot m = m$ and $e \# m$. 
\item $(\cdot)$ is commutative. If $m_1 \# m_2$, then $m_2 \# m_1$ and $m_1 \cdot m_2 = m_2 \cdot m_1$. 
\item $(\cdot)$ is associative. 
  \begin{itemize}
  \item If $m_1 \# m_2$ and $(m_1 \cdot m_2) \# m_3$, then $m_2 \# m_3$ and $m_1 \# (m_2 \cdot m_3)$ and $(m_1 \cdot m_2) \cdot m_3 = m_1 \cdot (m_2 \cdot m_3)$.
  \item If $m_2 \# m_3$ and $m_1 \# (m_2 \cdot m_3)$, then $m_1 \# m_2$ and $(m_1 \cdot m_2) \# m_3$ and $(m_1 \cdot m_2) \cdot m_3 = m_1 \cdot (m_2 \cdot m_3)$.
  \end{itemize}
  
  
\end{itemize}

\subsection{BI-Algebras over Partial Commutative Monoids}

Given a partial commutative monoid, we can show that the powerset $\powerset{M}$ 
forms a BI-algebra. 

\begin{lemma}{(Powersets of Partial Commutative Monoids)}
Given a partial commutative monoid $(M, e, \cdot)$, its powerset
$(\powerset{M}, \subseteq)$ forms a BI-algebra
with the following operations:

\begin{itemize}
\item $\top = M$
\item $p \land q = p \cap q$
\item $p \implies q = \setof{m \in M \;|\;\mbox{if }m \in p \mbox{ then } m \in q}$
\item $\bot = \emptyset$ 
\item $p \vee q = p \cup q$
\item $I = \setof{e}$
\item $p * q = \setof{m \in M\;|\; \exists m_1, m_2.\; 
                       m_1 \# m_2 \mbox{ and } m_1 \in p \mbox{ and } m_2 \in q \mbox{ and } m_1\cdot m_2 = m}$
\item $p \wand q = \{ m \in M \;|\; \forall m' \in p.\; \mbox{if } m \# m' \mbox{ then } m \cdot m' \in q \}$
\item $\bigwedge P = \bigcap P$ 
\item $\bigvee P = \bigcup P$
\end{itemize}
\end{lemma}


\begin{proof}
\begin{enumerate}
\item  We want to show $\forall p \in \powerset{M}.\; p \leq \top$
  \begin{tabbedproof}
        Assume $p \in \powerset{M}$ \\
    \oo By definition of powerset, we have $p \subseteq M$ \\
    \oo By definition of $\top$, we have $p \subseteq \top$ \\
    \oo By definition of $\leq$, we have $p \leq \top$ \\
  \end{tabbedproof}

\item We want to show $\forall p \in B.\; \bot \leq p$
  \begin{tabbedproof}
        Assume $p \in \powerset{M}$ \\ 
    \oo By definition of $\emptyset$, we have $\emptyset \subseteq p$ \\
    \oo By definition of $\bot$, $\leq$, we have $\bot \leq p$ \\
  \end{tabbedproof}

\item We want to show $\forall p,q,r \in \powerset{M}.$ if $r \leq p$ and $r \leq q$, then
      $r \leq p \land q$ and 
      $p \land q \leq p$ and $p \land q \leq q$

   \begin{tabbedproof}
      Assume $p,q,r \in \powerset{M}$ \\
      Assume $r \leq p$, $r \leq q$ \\[1em]

      \oo Expanding definition of $\leq$, we have $r \subseteq p$ and $r \subseteq q$ \\
      \oo By properties of $\cap$, we have $r \cap r \subseteq p \cap q$ \\
      \oo Hence $r \subseteq p \cap q$ \\
      \oo By definition of $\leq$ and $\land$, we have $r \leq p \land q$ \\[1em]
      \oo By properties of $\cap$, we have $p \cap q \subseteq p$ \\
      \oo By definition of $\leq$ and $\land$, we have $p \wedge q \leq p$ \\[1em]
      \oo By properties of $\cap$, we have $p \cap q \subseteq q$ \\
      \oo By definition of $\leq$ and $\land$, we have $p \wedge q \leq q$ \\
   \end{tabbedproof}

\item We want to show $\forall p,q,r \in \powerset{M}.$ if $p \leq r$ and $q \leq r$, then
      $p \vee q \leq r$ and
      $p \leq p \vee q$ and $q \leq p \vee q$.

  \begin{tabbedproof}
    Assume $p, q, r \in \powerset{M}$, $p \leq r$, $q \leq $ \\[1em]
    \oo By definition of $\leq$, we have $p \subseteq r$, $q \subseteq r$ \\
    \oo By set properties, we have $p \cup q \subseteq r$ \\
    \oo By definition of $\leq$, we have $p \vee q \leq r$ \\[1em]

    \oo By set properties we have $p \subseteq p \cup q$ \\
    \oo By definitions of $\leq$ and $\vee$, we have $p \leq p \vee q$ \\[1em]
  
    \oo By set properties, we have $q \subseteq p \cup q$ \\
    \oo By definitions of $\leq$ and $\vee$, we have  $q \leq p \vee q$ \\
  \end{tabbedproof}

\item We want to show $\forall p, q, r \in \powerset{M}.\; p \land q \leq r \iff p \leq q \implies r$

  \begin{tabbedproof}
    Assume $p,q,r \in \powerset{M}$ \\[1em]

    $\To$ direction: \\
    \oo Assume $p \land q \leq r$ \\
    \ooo By definitions of $\leq$ and $\land$, we have $p \cap q \subseteq r$ \\
    \ooo We want to show $p \leq q \implies r$ \\
    \ooo So we want to show $p \subseteq (q \implies r)$ \\
    \ooo So we want to show $\forall m$, if $m \in p$ then $m \in (q \implies r)$ \\
    \ooo Assume $m$ and $m \in p$ \\
    \oooo Want to show $m \in q \implies r$ \\
    \oooo Equivalent to showing if $m \in q$, then $m \in r$ \\
    \oooo Assume $m \in q$ \\
    \ooooo Since $m \in p$ and $m \in q$, we know $m \in p \cap q$. \\
    \ooooo Since $p \cap q \subseteq r$, we know $m \in r$ \\
    \ooo Therefore $p \subseteq q \implies r$ \\
    \ooo By definition of $\leq$, we see $p \leq q \implies r$ \\[1em]

    $\Leftarrow$ direction:\\
    \oo Assume $p \leq q \implies r$ \\
    \ooo By definition of $\leq$, we know $p \subseteq q \implies r$ \\
    \ooo We want to show $p \land q \leq r$ \\
    \ooo So we want to show $p \cap q \subseteq r$ \\
    \ooo So we want to show $\forall m$, if $m \in p \cap q$ then $m \in r$ \\
    \ooo Assume $m \in p \cap q$ \\
    \oooo Hence $m \in p$ and $m \in q$ \\
    \oooo Since $p \subseteq q \implies r$, we know for all $m$, if $m \in p$, then if $m \in q$, then $m \in r$ \\
    \oooo Hence $m \in r$ \\
    \ooo Hence $p \cap q \subseteq r$ \\
    \ooo By definition of $\leq$ and $\land$, we conclude $p \land q \leq r$ \\
  \end{tabbedproof}

\item We want to show $\forall p \in \powerset{M}.\; p * I = p$
  \begin{tabbedproof}
    \oo Assume $p \in \powerset{M}$ \\
    \ooo We want to show $p * I = p$ \\ 
    \ooo This is equivalent to showing for all $m \in M$, that $m \in p * I$ if and only if $m \in p$ \\
    \ooo Assume $m \in M$ \\
    \oooo $\To$ direction: \\
    \ooooo Assume $m \in p * I$ \\
    \ooooo Therefore $\exists m_1, m_2 \in M$ such that \\
    \ooooox $m_1 \# m_2$ and $m_1 \in p$ and $m_2 \in I$ and $m = m_1 \cdot m_2$\\
    \ooooo Let $m_1, m_2$ be witnesses, so that \\
    \oooooo $m_1 \# m_2$ and $m_1 \in p$ and $m_2 \in I$ and $m = m_1 \cdot m_2$\\
    \oooooo Since $I = \setof{e}$, we know $m_2 = e$ \\
    \oooooo By unit property, $m = m_1 \cdot e = m_1$ \\
    \oooooo Since $m_1 \in p$, we know $m \in p$ \\
    \ooo $\From$ direction: \\
    \oooo Assume $m \in p$ \\
    \ooooo We want to show $m \in p * I$ \\ 
    \ooooo So we want to show there are $m_1, m_2$ \\
    \ooooox such that $m_1 \# m_2$ and $m_1 \in p$ and $m_2 \in I$ and $m = m_1 \cdot m_2$ \\
    \ooooo Choose $m_1$ to be $m$, and $m_2$ to be $e$ \\
    \ooooo So we want to show $m \# e$ and $m \in p$ and $e \in I$ and $m = m \cdot e$ \\
    \ooooo By properties of unit, $m \# e$ and $m = m \cdot e$ \\
    \ooooo By definition of $I$, we know $e \in I$ \\
    \ooooo We know $m \in p$ by hypothesis \\
    \ooooo Therefore goal in line 16 met. \\ 
  \end{tabbedproof}

\item We want to show $\forall p, q \in \powerset{M}.\; p * q = q * r$

  \begin{eqnproof}[\mbox{Assume }p,q \in \powerset{M}]
    \eline[p * q]
          {\setof{m \in M\;|\; \exists m_1 \in p, m_2 \in q.\; 
                       m_1 \# m_2 \land m_1\cdot m_2 = m}}
          {Definition}
    \eline{\setof{m \in M\;|\; \exists m_2 \in q, m_1 \in p.\; 
                       m_1 \# m_2 \land m_1\cdot m_2 = m}}
          {Logical manipulation}
    \eline{\setof{m \in M\;|\; \exists m_2 \in q, m_1 \in p.\; 
                       m_2 \# m_1 \land m_2\cdot m_1 = m}}
          {Commutativity}
    \eline{q * p}
          {Definition}    
  \end{eqnproof}

\item We want to show $\forall p, q, r \in \powerset{M}.\; (p * q) * r = p * (q * r)$

  \begin{tabbedproof}
    \oo Assume $p, q, r \in \powerset{M}$ \\
    \oo We want to show $(p * q) * r = p * (q * r)$ \\
    \oo This is equivalent to showing for all $m \in M$, that \\
    \ox $m \in (p * q) * r$ if and only if $ m \in p * (q * r)$ \\
    \oo Assume $m \in M$ \\
    \ooo $\To$ direction: \\
    \oooo Assume $m \in (p * q) * r$ \\
    \ooooo Therefore there are $m_{pq}, m_r$ such that \\
    \ooooox $m_{pq} \# m_r$ and $m = m_{pq} \cdot m_r$ and $m_{pq} \in p * q$ and $m_r \in r$ \\
    \ooooo From $m_{pq} \in p * q$, we know there are $m_p$, $m_q$ such that \\
    \ooooox $m_p \# m_q$ and $m_{pq} = m_p \cdot m_q$ and $m_p \in p$ and $m_q$ in $r$ \\
    \ooooo By $m_{pq} = m_p \cdot m_q$, we know $m = (m_p \cdot m_q) \cdot m_r$ and $(m_p \cdot m_q) \# m_r$\\
    \ooooo Since $m_p \# m_q$ and $(m_p \cdot m_q) \# m_r$, by associativity we know \\
    \ooooox $m_q \# m_r$ and $m_p \# (m_q \cdot m_r)$ and 
            $m = (m_p \cdot m_q) \cdot m_r = m_p \cdot (m_q \cdot m_r)$ \\
    \ooooo Since $m_q \# m_r$ and $m_q \cdot m_r = m_q \cdot m_r$ and $m_q \in q$ and $m_r \in r$, \\
    \ooooox we know $m_q \cdot m_r \in q * r$ \\
    \ooooo Since $m_p \# (m_q \cdot m_r)$ and $m_p \cdot (m_q \cdot m_r) = m_p \cdot (m_q \cdot m_r)$ \\
    \ooooox and $m_p \in p$ and $m_q \cdot m_r \in q * r$,  we know $m_p \cdot (m_q \cdot m_r) \in p * (q * r)$ \\
    \ooooo Therefore $m \in p * (q * r)$ \\
    \ooo $\From$ direction: \\
    \oooo Assume we have $m_p, m_{qr}$ such that \\
    \oooox $m_p \# m_{qr}$ and $m = m_p \cdot m_{qr}$ and $m_p \in p$ and $m_{qr} \in q * r$ \\
    \ooooo Therefore we have $m_q, m_r$ such that \\
    \ooooox $m_q \# m_{r}$ and $m_{qr} = m_q \cdot m_r$ and $m_q \in q$ and $m_r \in r$ \\
    \ooooo From $m_{qr} = m_q \cdot m_r$ we have \\
    \ooooox $m = m_p \cdot (m_q \cdot m_r)$ and $m_p \# (m_q \cdot m_r)$ \\
    \ooooo By associativity with $m_q \# m_{r}$ and $m_p \# (m_q \cdot m_r)$, we have \\
    \ooooox $m_p \# m_q$ and $(m_p \cdot m_q) \# m_r$ and 
            $m = m_p \cdot (m_q \cdot m_r) = (m_p \cdot m_q) \cdot m_r$ \\
    \ooooo Since $m_p \# m_q$ and $m_p \in p$ and $m_q \in q$, we know \\
    \ooooox $(m_p \cdot m_q) \in p * q$ \\
    \ooooo Since $(m_p \cdot m_q) \# m_r$ and $(m_p \cdot m_q) in p * q$ and $m_r \in r$, we have \\ 
    \ooooox $(m_p \cdot m_q) \cdot m_r \in (p * q) * r$ \\
    \ooooo Therefore $m \in (p * q) * r$ \\
  \end{tabbedproof}

\item We want to show that for all $p, q, r \in \powerset{M}$, $p * q \leq r$ if and
only if $p \leq q \wand r$. 

  \begin{tabbedproof}
    Assume $p, q, r \in \powerset{M}$. \\
    \oo First, we will give the $\To$ direction. \\
    \oo Assume $p * q \leq r$ \\
    \oo So we know 
          $\comprehend{m}{\exists m_1, m_2.\; m_1 \# m_2 \mbox{ and } m_1 \in p \mbox{ and } m_2 \in q 
                                             \mbox{ and } m_1 \cdot m_2 = m}
           \subseteq r$ \\
    \oo Thus, $\forall m.\; (\exists m_1, m_2.\; m_1 \# m_2 \mbox{ and } m_1 \in p \mbox{ and } m_2 \in q 
                                             \mbox{ and } m_1 \cdot m_2 = m)$ implies $m \in r$. \\
    \oo By turning existentials on the left into universals, and instantiating $m$, \\
    \ooo
             $\forall m_1, m_2.\; (m_1 \# m_2 \mbox{ and } m_1 \in p \mbox{ and } m_2 \in q) \mbox{ implies } (m_1 \cdot m_2) \in r$ [HYP1] \\
    \oo Now, to show $p \leq q \wand r$, we must show
         for all $m$, if $m \in p$, that $m \in q \wand r$. \\
    \oo Assume $m$, $m \in p$. [HYP2] \\
    \ooo Now, we want to show $m \in \comprehend{m}{\forall m' \in q.\; m\# m' \mbox{ and } m' \mbox{ implies } (m \cdot m') \in r}$ \\
    \ooo This is equivalent to showing $\forall m' \in q.\; m\# m' \mbox{ and } m' \mbox{ implies } (m \cdot m') \in r$ \\
    \ooo Assume $m'$, $m' \in q$, $m \# m'$. [HYP3] \\ 
    \oooo Instantiating [HYP1] with $m$ and $m'$ and the hypotheses in [HYP2] and [HYP3], \\
    \oooo we can conclude $(m \cdot m') \in r$.  \\[1em]

    \oo Now, we will show the $\Leftarrow$ direction. \\
    \oo Assume $p \leq q \wand r$. \\
    \oo So we know, $p \subseteq \comprehend{m}{\forall m' \in q. m \# m' \mbox{ and } m' \in q \mbox{ implies } (m \cdot m') \in r}$ \\
    \oo Therefore $\forall m. m \in p \mbox{ implies } \forall m' \in q.\; m \# m' \mbox{ and } m' \in q \mbox{ implies } (m \cdot m') \in r$.  \\
    \oo Therefore $\forall m, m'.\; m \in p \mbox{ and } m' \in q \mbox{ and } m \# m' \mbox{ implies } (m \cdot m') \in r$ \\
    \oo Therefore $\forall m_o, m, m'.\; m \in p \mbox{ and } m' \in q \mbox{ and } m \# m' \mbox{ and } m_o = m\cdot m' \mbox{ implies } m_o \in r$ \\
    \oo Therefore $\forall m_o, (\exists m, m'.\; m \in p \mbox{ and } m' \in q \mbox{ and } m \# m' \mbox{ and } m_o = m\cdot m') \mbox{ implies } m_o \in r$ \\
    \oo Therefore $\forall m_o, m_o \in (p * q) \mbox{ implies } m_o \in r$ \\
    \oo Therefore $p * q \subseteq r$ \\
    \oo Therefore $p * q \leq r$ \\

  \end{tabbedproof}

\item We want to show $\forall r, P \subseteq B$, if $(\forall p \in P.\; r \leq p)$, then
$r \leq \bigwedge P$ and $\forall p \in P.\; \bigwedge P \leq p$. 

  \begin{tabbedproof}
    \oo Assume $r$, $P$, $P \subseteq B$, and $(\forall p \in P.\; r \leq p)$ \\[1em]
    \ooo First, we want to show $r \leq \bigwedge P$. \\
    \oooo This is equivalent to showing $r \subseteq \bigcap P$ \\
    \oooo This is equivalent to showing that for all $m \in r$, $m \in \bigcap P$. \\
    \oooo Assume $m$, $m \in r$.  \\
    \ooooo Showing $m \in \bigcap P$ is equivalent to $\forall p \in P. m \in p$ \\
    \ooooo Assume $p \in P$.  \\
    \oooooo Instantiating hypothesis with $p$, $r \subseteq p$. \\
    \oooooo This means $\forall m'. m' \in r \implies m' \in p$. \\
    \oooooo Instantiating $m'$ with $m$, we learn $m \in p$. \\
    \oooo Therefore, $r \leq \bigwedge P$. \\[1em]
    \ooo Second, we want to show that $\forall p \in P.\; \bigwedge P \leq p$. \\
    \ooo Assume $p$, $p \in P$. \\
    \oooo Now, we want to show $\bigwedge P \leq p$. \\
    \oooo This is equivalent to showing $\bigcap P \subseteq p$. \\
    \oooo This is equivalent to showing $\forall m.\; m \in \bigcap P \implies m \in p$ \\
    \oooo Assume $m$, $m \in \bigcap P$.  \\
    \ooooo Therefore, $\forall p' \in P.\; m \in p'$. \\
    \ooooo Instantiating $p'$ with $p$, we get $m \in p$. \\
  \end{tabbedproof}

\item We want to show $\forall r, P \subseteq B$, if $(\forall p \in P.\; p \leq r)$, then
$\bigvee P \leq r$ and $\forall p \in P.\; p \leq \bigvee P$. 

  \begin{tabbedproof}
    \oo Assume $r, P \subseteq B$, and $(\forall p \in P.\; p \leq r)$ \\[1em]
    \ooo First, we want to show $\bigvee P \leq r$ \\
    \oooo This is equivalent to showing $\bigcup P \subseteq r$ \\
    \oooo This is equivalent to showing $\forall m.\; m \in \bigcup P \implies m \in r$ \\
    \oooo Assume $m$, $m \in \bigcup P$. \\
    \ooooo $m \in \bigcup P$ is equivalent to $\exists p \in P.\; m \in p$ \\
    \ooooo Suppose $p' \in P$ is the witness, and that $m \in p'$ \\ 
    \oooooo Instantiating the quantifier $p$ in the hypothesis, we get $p' \leq r$ \\
    \oooooo This means $\forall m', m' \in p' \implies m' \in r$ \\
    \oooooo Instantiating the quantifier $m'$ with $m$,  we conclude $m \in r$.  \\
    \oooo Therefore, $\forall m.\; m \in \bigcup P \implies m \in r$ \\[1em]
    \ooo Second, we want to show $\forall p \in P.\; p \leq \bigvee P$. \\
    \oooo Assume $p$, $p \in P$ \\
    \ooooo We want to show $p \leq \bigvee P$ \\
    \ooooo This is equivalent to showing $p \subseteq \bigcup P$ \\
    \ooooo This is equivalent to showing $\forall m.\; m \in p \implies m \in \bigcup P$ \\
    \ooooo This is equivalent to showing $\forall m.\; m \in p \implies \exists p' \in P.\; m \in p'$ \\
    \ooooo Assume $m$, $m \in p$ \\
    \oooooo Take $p'$ to be $p$, since $p \in P$. \\
    \oooooo Thus, $m \in p$ by hypothesis \\
    \oooo Therefore, $p \leq \bigvee P$ \\
  \end{tabbedproof}

\end{enumerate}


\end{proof}

\subsection{Sets of Heaps form a BI algebra}

Now, we will take our predomain $H$ and form a BI algebra from it. To do so, we will
map it with the forgetful functor $U$, so that we forget the partial order structure 
and let $U(H)$ be an ordinary set. 

Now, $U(H) = \sum L \in \powersetfin{Loc}.\; (\prod \sempair{n}{A} \in L.\; \interp{\judgeWK[\cdot]{A}{\bigstar}}\;(*)\;(K,K))$

In what follows, we will usually suppress the $U$, in order to reduce clutter. 

Now, we can define the operations on it as follows: 

\begin{itemize}
\item The unit element $e \triangleq \sempair{\emptyset}{\emptyset}$
\item The operation $(L, f) \cdot (L', g)$ is defined when $L \cap L' = \emptyset$, and
      is equal to 

\begin{displaymath}
 \left(L \cup L', \lambda x.\;\left\{\begin{array}{ll}
                                 f(x) & \mathsf{when}\; x \in L \\
                                 g(x) & \mathsf{when}\; x \in L'
                               \end{array}
                         \right.\right)
 \end{displaymath}
\end{itemize}

The lambda-expression in the operation definition actually defines a
function. Since we know that since $L$ and $L'$ are disjoint, this
means that any element of $x \in L \cup L'$ is exclusively either in
$L$ or $L'$, which means that the definition is unambiguous. Since $f$
and $g$ are well-typed with respect to the index sets $L$ and $L'$
respectively, our new function must be as well.

Now, we can check the properties. 

\begin{itemize}

\item First, we will check that $e$ is a unit. Suppose we have $m = (L, f) \in H$. 

\begin{eqnproof}
  \eline[(\emptyset, \emptyset) \cdot (L, f)]
        {\left(\emptyset \cup L, \lambda x.\; \left\{\begin{array}{ll}
                                                      \emptyset(x) & \mathsf{when}\; x \in \emptyset \\
                                                       f(x) & \mathsf{when}\; x \in L \\
                                                     \end{array}
                                              \right.\right)}
        {Definition}
  \eline{\left(L, \lambda x.\; \begin{array}{ll}
                                  f(x) & \mathsf{when}\; x \in L \\
                               \end{array} \right)}
        {Simplification}
  \eline{\sempair{L}{f}}
        {Simplification}
\end{eqnproof}

\item Second, we will check commutativity. Suppose we have $(L,f) \in H$ and $(L',g) \in H$. 

  First, it's obviously the case that if $L \cap L' = \emptyset$, then $L' \cap L = \emptyset$. 

  \begin{eqnproof}
    \eline[(L,f) \cdot (L',g)] 
          { \left(L \cup L', \lambda x.\;\left\{\begin{array}{ll}
                                 f(x) & \mathsf{when}\; x \in L \\
                                 g(x) & \mathsf{when}\; x \in L'
                               \end{array}
                         \right.\right)}
          {Definition}
    \eline{\left(L' \cup L, \lambda x.\;\left\{\begin{array}{ll}
                                 f(x) & \mathsf{when}\; x \in L \\
                                 g(x) & \mathsf{when}\; x \in L' \\
                               \end{array}
                         \right.\right)}
          {Commutativity of $\cup$}
    \eline{\left(L' \cup L, \lambda x.\;\left\{\begin{array}{ll}
                                 g(x) & \mathsf{when}\; x \in L' \\
                                 f(x) & \mathsf{when}\; x \in L \\
                               \end{array}
                         \right.\right)}
          {Reordering Cases}
    \eline{(L',g) \cdot (L,f)}
          {Definition}
  \end{eqnproof}

\item Now, we will check associativity. Suppose $(L,f)$, $(L',g)$, and $(L'',h)$ are in $H$. 

  First, assume that $L \cap L' = \emptyset$ and that $(L \cup L') \cap L'' = \emptyset$. 
  Then we know that $L \cap L'' = \emptyset$ and $L' \cap L'' = \emptyset$, so we can 
  conclude that $L \cap (L' \cup L'') = \emptyset$. 

  Second, assume that $L' \cap L'' = \emptyset$ and that $L \cap (L' \cup L'') = \emptyset$. 
  Then we know that $L \cap L' = \emptyset$ and $L \cap L'' = \emptyset$, so we can 
  conclude that $(L \cup L') \cap L'' = \emptyset$. 

  \begin{eqnproof}
    \eline[(L,f)\cdot((L',g)\cdot(L'',h))]
          {(L,f)\cdot \left(L' \cup L'', 
                            \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     g(x) & \mathsf{when}\; x \in L' \\
                                     h(x) & \mathsf{when}\; x \in L'' \\
                                  \end{array}\right.\right)}
          {Definition}
     \eline{\left(L \cup (L' \cup L''), 
                            \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     f(x) & \mathsf{when}\; x \in L \\
                                     g(x) & \mathsf{when}\; x \in L' \\
                                     h(x) & \mathsf{when}\; x \in L'' \\
                                  \end{array}\right.\right)}
           {Definition}
     \eline{\left((L \cup L') \cup L'', 
                            \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     f(x) & \mathsf{when}\; x \in L \\
                                     g(x) & \mathsf{when}\; x \in L' \\
                                     h(x) & \mathsf{when}\; x \in L'' \\
                                  \end{array}\right.\right)}
           {Associativity}
      \eline{\left(L \cup L', 
                    \lambda x.\; \left\{
                                  \begin{array}{ll}
                                     f(x) & \mathsf{when}\; x \in L \\
                                     g(x) & \mathsf{when}\; x \in L' \\
                                  \end{array}\right.\right) \cdot (L'', h)}
            {Definition}
    \eline{((L,f)\cdot(L',g))\cdot(L'',h)}
          {Definition}
  \end{eqnproof}
\end{itemize}

Therefore, we can conclude that sets of heaps form a complete BI algebra. 

\section{Semantics of Specifications}

Before we can give the semantics of specifications, we are going to run
into a very sticky issue: our denotational semantics does not validate
the frame property. The formal semantics of the $\newref{A}{e}$
command allocates a new reference by finding the largest numeric id of
any reference in the heap's domain, and then allocating a reference
whose numeric id is one greater than that.

This means that the behavior of the memory allocator is deterministic,
which means that our semantic domain can include awkward programs
which crash if the heap is larger than a certain size. Obviously,
safety monotonicity property cannot hold for such programs, because
extending the heap enough will cause these programs to crash.  
 
On the other hand, we do not actually want to prove the correctness of
any of these pathological programs: all the programs we actually want
to write and prove correct are actually well-behaved.

To do this, we will adapt an idea of Birkedal and
Yang~\cite{birkedal-yang}. They proposed changing the interpretation
of program specifications from a boolean semantics (in which each
specification is either true or false) into a Kripke interpretation.

The modal frame they proposed was one in which worlds are sets of
assertions of separation logic (i.e., elements of a BI algebra).
Intuitively, we can think of each world as ``the set of assertions
that can be safely framed onto this specification''. A specification
is then true when all assertions can be framed onto it, which is how
we will end up justifying the frame rule.

As we did for assertions, we will give this semantics in a modular
way. We will first define a preorder on elements of a BI algebra --- the
extension ordering --- and then use this ordering to give the truth
values as upwards-closed sets of assertions.

\section{World Preorders}

We can define a world preorder $W(B, \worldleq)$ over a BI algebra $B$ as
follows.  The elements of $W(B, \leq)$ are the elements of $B$, and for any
two elements $p$ and $q$, the ordering $p \worldleq q$ is defined as
follows:

\begin{displaymath}
p \worldleq q \iff \exists r.\; p * r = q
\end{displaymath}

To verify the relation $\worldleq$ is a preorder, we need to 
show it is reflexive and transitive. 

$p \worldleq p$ holds because we can take $r$ to be $I$. 


To show transitivity, we must show that $p_1 \worldleq p_3$, given
that $p_1 \worldleq p_2$ and $p_2 \worldleq p_3$.

\begin{tabbedproof}
\oo Assume $p_1 \worldleq p_2$  \\
\oo Assume $p_2 \worldleq p_3$  \\
\ooo By definition of $\worldleq$, $\exists r.\; p_1 * r = p_2$ \\
\ooo By definition of $\worldleq$, $\exists r'.\; p_2 * r' = p_3$ \\
\ooo Let $r$ and $r'$ be the witnesses in lines 3 and 4, so we have \\
\oooo $p_1 * r = p_2$ \\
\oooo $p_2 * r' = p_3$ \\
\oooo Substituting for $p_2$, we get $p_1 * r * r' = p_3$ \\
\oooo Taking as witness $r'' = r * r'$, we show $\exists r''.\; p_1 * r'' = p_3$ \\
\ooo By definition of $\worldleq$, $p_1 \worldleq p_3$ \\
\end{tabbedproof}

\section{Heyting Algebras over Preorders}

Given any preorder $(P, \worldleq)$, we can construct a complete
Heyting algebra by considering the set of its upward-closed subsets
$(\upset{P}, \subseteq)$:

\begin{displaymath}
\upset{P} = 
  \{ S \in \mathcal{P}(P) \;|\;
     \forall p \in S, \forall q \in B. \mbox{ if } p \worldleq q \mbox{ then } q \in S 
  \}
\end{displaymath}

The ordering relation for the Heyting algebra is set inclusion, and
the operations are:

\begin{itemize}
\item $\top = P$
\item $\bot = \emptyset$
\item $S \land S' = S \cap S'$
\item $S \vee S' = S \cup S'$
\item $\bigwedge_{i \in I} S_i = \bigcap_{i \in I} S_i$
\item $\bigvee_{i \in I} S_i = \bigcup_{i \in I} S_i$
\item $S \implies S' = \{ r \in P \;|\; \forall r' \worldgeq r.\; 	
                          \mbox{if } r' \in S \mbox{ then } r' \in S' \}$
\end{itemize}

The idea here is that we will take the world preorder over assertions
(ordered by the extension order $\worldleq$) and use it to define a 
Heyting algebra, whose elements will become the semantics of specifications.


To show that these operations actually form a Heyting algebra, we need
to show that they satisfy the Heyting algebra axioms. First, we need
to show that the meet and join are the greatest lower bounds and least
upper bounds respectively. To do this, we will just show that arbitrary
meets and joins exist, and then the nullary and binary meets and joins
will fall out as a special case.

\begin{lemma}{(Meets in the algebra of specifications)}
If $X \subseteq \upset{P}$, then $\bigwedge X$ defines a meet. 
\end{lemma}

\begin{proof}
We need to show that if for all $i \in I$, $S_i \in \upset{P}$, 
then $\bigwedge_{i \in I} S_i \in \upset{P}$. First, we will verify that 
the intersection of a family of upwards-closed subsets is itself an
upwards-closed subset. 

\begin{tabbedproof}
\oo Assume $\forall i \in I.\; S_i \in \upset{P}$ \\
\ooo We want to show $\bigwedge_{i \in I} S_i \in \upset{P}$ \\ 
\ooo So we want to show for all $x \in \bigwedge_{i \in I} S_i$ and for all $y \in P$, if $x \worldleq y$ then $y \in \bigwedge_{i \in I} S_i$ \\
\ooo Assume $x$, $x \in \bigwedge_{i \in I} S_i$, $y$, $y \in P$, $x \worldleq y$ \\
\oooo Since $\bigwedge_{i \in I} S_i = \bigcap_{i \in I} S_i$, we know 
      $\forall i \in I.\; x \in S_i$ \\
\oooo Assume $i \in I$ \\
\ooooo Since $x \in S_i$, $x \worldleq y$, and $S_i$ is upwards-closed, $y \in S_i$ \\
\oooo Therefore, $\forall i \in I$, $y \in S_i$ \\
\ooo Therefore for all $x \in \bigwedge_{i \in I} S_i$ and for all $y \in P$, if $x \worldleq y$ then $y \in \bigwedge_{i \in I} S_i$ \\
\ooo Which means $\bigwedge_{i \in I} S_i \in \upset{P}$ \\ 
\end{tabbedproof}

\noindent Next, we need to show that the Heyting algebra axiom for meets. 
Stated formally,
this is $\forall S \in \upset{P}$, if $X \subseteq
\upset{P}$ and $(\forall S' \in X.\; S \leq S')$, then $S
\leq \bigwedge X$ and $\forall S' \in X, \bigwedge X \leq S'$.
\\

\begin{tabbedproof}
\oo Assume $S \in \upset{P}, X \subseteq \upset{P},$ and   
           $(\forall S' \in X.\; S \leq S')$ \\
\ooo First, we want to show $S \leq \bigwedge X$ \\
\oooo This is equivalent to showing $\forall p.\; p \in S \implies p \in \bigwedge X$ \\
\oooo Assume $p \in S$ \\
\ooooo We want to show $p \in \bigwedge X$, so we want to show $\forall S' \in X.\; p \in S'$. \\
\ooooo Assume $S' \in X$ \\
\oooooo From the hypothesis in 1, we know $S \leq S'$ \\
\oooooo This means $\forall p.\; p \in S \implies p \in S'$ \\
\oooooo Instantiate the quantifier with $p$ and use hypothesis 4 to conclude $p \in S'$ \\
\oooo Therefore, $\forall p.\; p \in S \implies p \in \bigwedge X$, so $S \leq \bigwedge X$ \\[1em]
\ooo Second, we want to show $\forall S' \in X.\; \bigwedge X \leq S'$ \\
\ooo Assume $S' \in X$ \\
\oooo We want to show $\bigwedge X \leq S'$, so we must show $\forall p.\; p \in \bigwedge X \implies p \in S'$ \\
\oooo Assume $p \in \bigwedge X$ \\
\ooooo Therefore, we know $\forall S' \in X.\; p \in S'$ \\
\ooooo Instantiate the quantifier with $S'$ to conclude $p \in S'$ \\
\oooo Therefore $\bigwedge X \leq S'$ \\
\ooo Therefore $\forall S' \in X.\; \bigwedge X \leq S'$ 
\end{tabbedproof}
\end{proof}



\begin{lemma}{(Joins in the algebra of specifications)}
If $X \subseteq \upset{P}$, then $\bigvee X$ defines an arbitrary join. 
\end{lemma}
\begin{proof}
First, we need to verify the join we defined actually gives us an upward closed set ---
that is, if $X \subseteq \upset{P}$, then $\bigvee{X} \in \upset{P}$

\vspace{0.5em}

\begin{tabbedproof}
\oo Assume  $X \subseteq \upset{P}$ \\
\ooo We want to show $\bigvee{X} \in \upset{P}$ \\
\ooo This means for all $x \in \bigvee{X}, y \in P,$ if $x \worldleq y$ then $y \in \bigvee{X}$\\
\ooo Assume $x \in \bigvee X$, $y \in P$, $x \worldleq y$ \\
\oooo Since $x \in \bigvee X$, we know $\exists S \in X.\; x \in S$ \\
\oooo Let $S$ be the witness of the existential, so $S \in X$ and $x \in S$ \\ 
\ooooo  Since $S$ is upward closed, $x \in S$, and $x \worldleq y$, we know $y \in S$ \\
\ooo Therefore we can conclude $\exists S \in X.\; y \in S$ \\
\ooo Therefore $y \in \bigvee X$ \\
\end{tabbedproof}

\noindent Now, we need to show the Heyting axioms for disjunction. Formally stated, it is $\forall S \in \upset{P}, X \subseteq
\upset{P}$, if $(\forall S' \in X.\; S' \leq S)$, then $\bigvee X \leq
S$ and $\forall S' \in X.\; S' \leq \bigvee X$.

\vspace{0.5em}

\begin{tabbedproof}
\oo Assume $S \in \upset{P}, X \subseteq \upset{P}$, and $\forall S' \in X.\; S' \leq S$ \\
\ooo First, we want to show $\bigvee X \leq S$ \\
\oooo This is the same as $\forall p, p \in \bigvee X \implies p \in S$ \\
\oooo Assume $p \in \bigvee X$ \\
\ooooo This means $\exists S' \in X.\; p \in S'$ \\
\ooooo Let $S'$ be the witness to the existential, so $S' \in X$ and $p \in S'$ \\
\oooooo Instantiating the quantifier in the hypothesis with $S'$, we get $S' \leq S$ \\
\oooooo This means $\forall p \in S', p \in S$ \\
\oooooo Instantiating the quantifier with $p$, we  get $p \in S$ \\
\oooo Therefore $\forall p, p \in \bigvee X \implies p \in S$ \\
\oooo This is equivalent to $\bigvee X \leq S$ \\[1em]

\ooo Second, we want to show $\forall S' \in X.\; S' \leq \bigvee X$ \\
\oooo Assume $S' \in X$ \\
\ooooo We want to show $S' \leq \bigvee X$ \\
\ooooo This means $\forall p \in S', p \in \bigvee X$ \\
\ooooo Assume $p \in S'$ \\
\oooooo We want to show $p \in \bigvee X$ \\
\oooooo This means we must show $\exists S' \in X.\; p \in S'$ \\
\oooooo Witness the existential with $S'$, so we can show $p \in S'$ by hypothesis \\
\oooo  Therefore $\forall S' \in X.\; S' \leq \bigvee X$ \\
\end{tabbedproof}
\end{proof}




\begin{lemma}{(Implication)}
If $S_1, S_2 \in \upset{P}$, then
$S_1 \implies S_2 \in \upset{P}$. 
\end{lemma}

\begin{proof}
First, we will check that the definition gives us an upward closed set.

\vspace{0.5em}

\begin{tabbedproof}
\oo Assume $x \in S_1 \implies S_2$, and that $y \worldgeq x$ \\
\ooo From this, we know $\forall r' \worldgeq x, $ if $r' \in S_1$ then $r' \in S_2$ \\
\ooo We want to show $\forall r' \worldgeq y, $ if $r' \in S_1$ then $r' \in S_2$ \\
\ooo Assume $r' \worldgeq y$ and $r' \in S_1$ \\
\oooo Since $r' \worldgeq y$ and $r' \worldgeq x$, we know $r' \worldgeq x$ \\
\oooo From this  and $r' \in S_1$, we can use the hypothesis in line 2 to get $r' \in S_2$ \\
\ooo Therefore $\forall r' \worldgeq y, $ if $r' \in S_1$ then $r' \in S_2$ \\
\end{tabbedproof}

\noindent Now that we know that $\implies$ has the correct codomain, we need to
verify that it satisfies the adjoint relationship between conjunction and 
implication: 
\begin{displaymath}
S_1 \land S_2 \subseteq R \iff S_1 \subseteq S_2 \implies R
\end{displaymath}

\noindent This is equivalent to showing that 

\begin{displaymath}
(\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R) \iff
(\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R)
\end{displaymath}

\noindent First, let's show the $\Rightarrow$ direction.
\\

\begin{tabular}{ll}
Assume for all $x.\; x \in S_1 \land S_2 \Rightarrow x \in R$ &
(1)
\\

Assume $x \in S_1$ &
(2)
\\

Assume $r' \worldgeq x$ &
(3)
\\

Assume $r' \in S_2$ & 
(4)
\\

$r' \in S_1$ & 
Since $x \in S_1$ and $r' \worldgeq x$ \\

$r' \in S_1 \cap S_2$ & 
Since $r' \in S_1$ and $r' \in S_2$ \\

$r' \in R$ &
By assumption (1) \\

$r' \in S_2 \Rightarrow r' \in R$ &
Implication intro (4) \\

$\forall r' \worldgeq x.\; r' \in S_2 \Rightarrow r' \in R$ &
Universal intro (3) \\

$x \in \{ r \in P \;|\; \forall r' \worldgeq r.\; r' \in S_2 \Rightarrow r' \in R$ &
Comprehension intro \\

$x \in S_2 \implies R$ &
Definition of $\implies$ \\

$\forall x.\; x \in S_1. \Rightarrow x \in S_2 \implies R$ &
Universal intro (2) \\

$(\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R) \Rightarrow (\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R)$ &
Implication intro (1) \\
\end{tabular}
\\

Next, let's show the $\Leftarrow$ direction. 
\\

\begin{tabular}{ll}
Assume $\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R$ &
(1) \\

Assume $x \in S_1 \land S_2$ & 
(2) \\

$x \in S_1$ & 
Since $x \in S_1 \land S_2$ (2)\\

$x \in S_2$ & 
Since $x \in S_1 \land S_2$ (3) \\

$x \in S_2 \implies R$ & 
By (2) and (1) \\

$x \in \{ r \in P \;|\; \forall r' \worldgeq r.\; \mbox{if } r' \in S_2 \mbox{ then } r' \in R \}$ &
Definition of $\implies$ \\

$\forall r' \worldgeq x.\; \mbox{if } r' \in S_2 \mbox{ then } r' \in R$ &
Comprehension instantiation (4) \\

$x \worldgeq x$ & 
Reflexivity (5) \\

$\mbox{if } x \in S_2 \mbox{ then } x \in R$ & 
Instantation of (4) with (5) \\

$x \in R$ & 
Implication elim via (3) \\

$\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R$ & 
Universal/Implication intro (2) \\

$(\forall x.\; x \in S_1 \Rightarrow x \in S_2 \implies R) \Rightarrow (\forall x.\; x \in S_1 \land S_2 \Rightarrow x \in R)$ & 
Implication intro (1) \\
\end{tabular}
\end{proof}

These lemmas establish that $\upset{P}$ forms a complete Heyting algebra. 

\section{Semantic Hoare Triples}

In this section, we will define \emph{semantic Hoare triples}, which will be the basic
elements we will use to define our specification logic. As always, the definition
will come in a piece-wise fashion. We will start by defining ``basic Hoare triples'',
which will be given semantics in a relatively familiar boolean fashion. We will then
use these to define our true Kripke-style semantic Hoare triples. 

\subsection{Basic Hoare Triples}

Since we have a continuation semantics, it is natural to define a
continuation style interpretation of basic Hoare triples, as well.

\subsubsection{Approximating Postconditions}

Given a $Q \in \interp{A} \to \powerset{H}$, we define $Approx(Q)$ as the set:
\begin{displaymath}
  Approx(Q) \triangleq \comprehend{k \in \interp{A} \to H \to O}
                         {\forall v \in \interp{A}, h \in Q(v).\; k\;v\;h = \bot}
\end{displaymath}

These define a set of continuations which ``continuously approximate''
the postcondition $Q$ -- they are the set of continuations which run
forever when given a value and heap in $Q$.  From this set we will
define the function $Best(Q)$, which will be the ``best continuous
approximation'' to Q. (Intuitively, think of this as being like a
closure operator from topology, which finds the smallest open set
containing the given set.)

\begin{displaymath}
  Best(Q) \triangleq \lambda v \in \interp{A}.\; \lambda h \in H.\; 
    \left\{\begin{array}{ll}
             \top & \mbox{when } \exists k \in Approx(Q).\; k\;v\;h = \top \\
             \bot & \mbox{otherwise}
           \end{array}
    \right.
\end{displaymath}
Of course, we have to verify that $Best(Q)$ is actually a continuous function. 

\begin{itemize}
\item First, we need to check that $Best(Q)$ is a monotone function. 

\begin{tabbedproof}
\oo Suppose we have $v \sqsubseteq v'$ and $h \sqsubseteq h'$. \\
\ooo We know $Best(Q)\;v\;h \in O$. Analyzing this by cases, we see \\
\ooo Suppose $Best(Q)\;v\;h = \bot$ \\
\oooo Since $\forall o \in O.\; \bot \sqsubseteq o$, it follows that 
      $\bot \sqsubseteq Best(Q)\;v'\;h'$ \\
\oooo So $Best(Q)\;v\;h \sqsubseteq Best(Q)\;v'\;h'$ \\
\ooo Suppose $Best(Q)\;v\;h = \top$ \\
\oooo By definition of $Best(Q)$, $\exists k \in Approx(Q).\; k\;v\;h = \top$ \\
\oooo Let $k \in Approx(Q)$ be the witness such that $k\;v\;h = \top$ \\ 
\ooooo Since $k$ is monotone, $k\;v\;h \sqsubseteq k\;v'\;h'$ \\
\ooooo So $\top \sqsubseteq k\;v'\;h'$ \\
\ooooo Since $\top$ is maximal in $O$, $k\;v'\;h' = \top$ \\
\ooooo So we can take $k$ to be the witness such that $\exists k.\; k\;v'\;h' = \top$ \\
\oooo Therefore $Best(Q)\;v'\;h' = \top$ \\
\oooo Therefore $Best(Q)\;v\;h \sqsubseteq Best(Q)\;v'\;h'$ \\
\end{tabbedproof}

\item Second, we need to show that $Best(Q)$ preserves limits. 

\begin{tabbedproof}
\oo Suppose we have two chains $v_i$ and $h_i$ such that $i \leq j$
implies $v_i \sqsubseteq v_j$ and $h_i \sqsubseteq h_j$. \\
\ooo We want to show that $\bigsqcup_i Best(Q)\;v_i\;h_i = Best(Q)\;(\sqcup v_i)\;(\sqcup h_i)$ \\
\ooo By excluded middle, either some $k$ in $Approx(Q)$ such that $k\;(\sqcup v_i)\;(\sqcup h_i) = \top$, or not. \\
\ooo Suppose that $\exists k \in Approx(Q).\; k\;(\sqcup v_i)\;(\sqcup h_i) = \top$ \\
\oooo Therefore $Best(Q)\;(\sqcup v_i)\;(\sqcup h_i) = \top$ \\
\oooo By continuity of $k$, $\bigsqcup_i k\;v_i\;h_i = \top$ \\
\oooo Since $O$ is discrete, there is an $n$ such that $k\;v_n\;h_n = \top$ \\
\oooo Therefore, for all $j \geq n$, $Best(Q)\;v_n\;h_n = \top$ \\
\oooo This means $\bigsqcup_i Best(Q)\;v_i\;h_n = \top$ \\
\oooo Therefore $\bigsqcup_i Best(Q)\;v_i\;h_n = Best(Q)\;(\sqcup v_i)\;(\sqcup h_i)$ \\
\ooo Suppose that $\lnot(\exists k \in Approx(Q).\; k\;(\sqcup v_i)\;(\sqcup h_i) = \top$ \\
\oooo This is equivalent to $\forall k \in Approx(Q).\; k\;(\sqcup v_i)\;(\sqcup h_i) = \bot$ \\
\oooo This means $Best(Q)\;(\sqcup v_i)\;(\sqcup h_i) = \bot$ \\
\oooo Now, assume $k \in Approx(Q)$ \\
\ooooo So $k\;(\sqcup v_i)\;(\sqcup h_i) = \bot$ \\
\ooooo By continuity, $\bigsqcup_i k\;v_i\;h_i = \bot$ \\
\ooooo Therefore for all $i$, $k\;v_i\;h_i = \bot$ \\
\oooo So for all $k \in Approx(Q)$ and $i$, we know $k\;v_i\;h_i = \bot$ \\
\oooo This is equivalent to $\forall i.\; \lnot(\exists k \in Approx(Q).\; k\;v_i\;h_i = \top)$\\
\oooo Therefore, for all $i$, we know $Best(Q)\;v_i\;h_i = \bot$ \\
\oooo Therefore, we know $\bigsqcup_i Best(Q)\;v_i\;h_i = \bot$ \\
\oooo So we conclude $\bigsqcup_i Best(Q)\;v_i\;h_i = Best(Q)\;(\sqcup v_i)\;(\sqcup h_i)$\\
\end{tabbedproof}
\end{itemize}
This establishes that $Best(Q)$ is a continuous function. 

Now we will prove a minor lemma about this function, which shows that we
are interpreting the Sierpinski lattice such that the bottom element
is truth, and the top element is falsehood.

\begin{lemma}{(Lattice Order Reverses Approximation Order)}
Suppose $Q$ and $Q'$ are $A$-predicates in $\interp{A} \to \powerset{H}$, and that
for all $a \in \interp{A}$, $Q(a) \subseteq Q'(a)$. Then $\mathit{Best}(Q') \sqsubseteq \mathit{Best}(Q)$. 
\end{lemma}

\begin{tabbedproof}
\oo We want to show $\mathit{Best}(Q') \sqsubseteq \mathit{Best}(Q)$ \\
\oo First, we will observe that $\mathit{Approx}(Q') \subseteq \mathit{Approx}(Q)$ \\
\oo So, suppose that $k \in \mathit{Approx}(Q')$. We want to show $k \in \mathit{Approx}(Q)$. \\
\ooo We want to show that for all $a \in \interp{A}$ and $h \in Q(a)$, $k\;a\;h = \bot$.  \\
\ooo Assume that $a \in \interp{A}$ and $h \in Q(a)$. \\ 
\oooo We know that since $Q(a) \subseteq Q'(a)$, we have $h \in Q'(a)$.  \\
\oooo Therefore since $k \in \mathit{Approx}(Q')$, we know $k\;a\;h = \bot$ \\
\oo Now, we want to show that $\mathit{Approx}(Q') \subseteq \mathit{Approx}(Q)$ \\
\oo So we want to show that for all $a \in \interp{A}$ and $h \in H$, $\mathit{Approx}(Q')\;a\;h \subseteq \mathit{Approx}(Q)\;a\;h$ \\
\oo Assume we have $a \in \interp{A}$ and $h \in H$ \\
\ooo Suppose $\mathit{Approx}(Q')\;a\;h = \top$: \\
\oooo Therefore there is a $k\in\mathit{Approx}(Q')$ such that $k\;a\;h = \top$ \\
\oooo Therefore $k \in \mathit{Approx}(Q)$, and so $\mathit{Approx}(Q)\;a\;h = \top$ \\
\ooo Suppose $\mathit{Approx}(Q')\;a\;h = \bot$: \\
\oooo Therefore for all $k \in \mathit{Approx}(Q')$, we have $k\;a\;h = \top$ \\
\oooo Therefore for all $k \in \mathit{Approx}(Q)$, we have $\mathit{Approx}(Q)\;a\;h = \bot$ \\

\end{tabbedproof}

\subsubsection{Basic Boolean Hoare Triples}

Supposing that $p$ is an element of the BI algebra $\powerset{H}$, $c$ is an element
of the domain of commands $(A \to K) \to K$, and $q$ is an $A$-indexed predicate, of
type $A \to \powerset{H}$, then we can define the basic boolean Hoare triple 
$\basicspec{p}{c}{a:A}{q}$:

\begin{displaymath}
  \basicspec{p}{c}{a:A}{q(a)} \triangleq
    \forall h \in p.\; \left(c\;Best(q)\;h = \bot\right)
\end{displaymath}

If $c$ is given a continuation which will run forever (i.e., equals
$\bot$) whenever it receives a heap in $q$, then given a heap $h \in
p$, $c$ with that continuation and that heap will also run forever.

The reason that we interpret triples this way is to make the fixed
point induction rule a sound rule of inference.



\subsection{Kripke Interpretation}

Now, we can give the Kripke interpretation of semantic triples. Given a semantic
assertion $p$, an element $c$ of the domain of $A$-commands $(A \to K) \to K$, 
and a $A$-predicate $q \in A \to \powerset{H}$, we define the meaning of a 
semantic triple as: 

\begin{displaymath}
  \spec{p}{c}{a:A}{q(a)} \triangleq
    \comprehend{ r \in \powerset{H} }
               {\forall s \sqsupseteq r.\; \basicspec{p * s}{c}{a:A}{q(a) * s}}
\end{displaymath}

\begin{lemma}{(Semantic Triples are Specifications)}
  For suitable $p,c,A$, and $q$, we have that 
$\spec{p}{c}{a:A}{q(a)} \in \upset{\powerset{H}}$
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo We want to show $\spec{p}{c}{a:A}{q(a)} \in \upset{\powerset{H}}$ \\
\oo This is equivalent to $\forall r,s$ if $r \in \spec{p}{c}{a:A}{q(a)}$ and $s \sqsupseteq r$,
then $s \in \spec{p}{c}{a:A}{q}$ \\
\oo Assume $r,s, r \in \spec{p}{c}{a:A}{q(a)}$, and $s \sqsupseteq r$ \\
\ooo $r \in \spec{p}{c}{a:A}{q(a)}$ is equivalent to 
     $\forall s \sqsupseteq r.\; \basicspec{p * s}{c}{a:A}{q(a) * s}$ \\
\ooo We want to show $s \in \spec{p}{c}{a:A}{q}$ \\
\ooo This is equivalent to showing 
     $\forall t \sqsupseteq s.\; \basicspec{p * t}{c}{a:A}{q(a) * t}$ \\
\ooo Assume $t$, $t \sqsupseteq s$ \\
\oooo By transitivity with $t \sqsupseteq s$ and $s \sqsupseteq r$, we know $t \sqsupseteq r$ \\
\oooo Instantiating quantifier in line 4 with $t$, $\basicspec{p * t}{c}{a:A}{q(a) * t}$ \\
\ooo Therefore $\forall t \sqsupseteq s.\; \basicspec{p * t}{c}{a:A}{q(a) * t}$ \\
\ooo Therefore $s \in \spec{p}{c}{a:A}{q}$ \\
\oo Therefore $\forall r,s$ if $r \in \spec{p}{c}{a:A}{q(a)}$ and $s \sqsupseteq r$,
    then $s \in \spec{p}{c}{a:A}{q}$ \\
\oo We have shown $\spec{p}{c}{a:A}{q(a)} \in \upset{\powerset{H}}$ \\ 
\end{tabbedproof}
\end{proof}

\subsubsection{Fixed Point Induction}

The reason we have gone to all this trouble of using continuous
approximations to the postcondition is to create an admissibility
property which will allow us to justify a fixed point induction rule.

\begin{lemma}{(Bottom Satisfies All Specifications)}
We have that $\spec{p}{\bot}{a:A}{q(a)} = \powerset{H}$. 
\end{lemma}
\begin{proof}
\begin{tabbedproof}
\oo We want to show $\spec{p}{\bot}{a:A}{q(a)} = \powerset{H}$ \\
\oo It suffices to show $\forall r \in \powerset{H}, r \in \spec{p}{\bot}{a:A}{q(a)}$ \\
\oo Assume $r \in \powerset{H}$ \\
\ooo We want to show $r \in \spec{p}{\bot}{a:A}{q(a)}$, which is equivalent to 
     $\forall s \sqsupseteq r.\; \basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\ooo Assume $s \sqsupseteq r$ \\
\oooo We want to show $\basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\oooo This is equivalent to $\forall h \in p. \bot\;Best(q)\;h = \bot$ \\
\oooo Assume $h \in p$ \\
\ooooo  By definition of least element, $\bot\;Best(q)\;h = \bot$ \\
\oooo Therefore $\forall h \in p. \bot\;Best(q)\;h = \bot$ \\
\oooo Therefore $\basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\ooo Therefore $\forall s \sqsupseteq r.\; \basicspec{p*s}{\bot}{a:A}{q(a) * s}$ \\
\ooo Therefore $r \in \spec{p}{\bot}{a:A}{q(a)}$ \\
\oo Therefore $\forall r \in \powerset{H}, r \in \spec{p}{\bot}{a:A}{q(a)}$ \\
\oo Therefore $\spec{p}{\bot}{a:A}{q(a)} = \powerset{H}$ \\
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Admissibility of Triple Subsets)}
Define $\spec{p}{-}{a:A}{q(a)}$ to be 

\begin{displaymath}
\spec{p}{-}{a:A}{q(a)} \triangleq
         \comprehend{c \in (A \to K) \to K}
                   { \spec{p}{c}{a:A}{q(a)} = \powerset{H} }
\end{displaymath}

Then, $\spec{p}{-}{a:A}{q(a)}$ forms an admissible subset of $(A \to K) \to K$. 
That is, given a chain $c_i \in \spec{p}{-}{a:A}{q(a)}$, we know that 
$\spec{p}{\sqcup_i c_i}{a:A}{q(a)}$. 
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo Suppose we have a chain $c_i \in \spec{p}{-}{a:A}{q(a)}$. \\
\ooo We want to show that $\sqcup_i c_i \in \spec{p}{\sqcup_i c_i}{a:A}{q(a)}$ \\
\ooo This is equivalent to $\spec{p}{\sqcup c_i}{a:A}{q(a)} = \powerset{H}$ \\
\ooo This is equivalent to 
     $\forall r \in \powerset{H}, s \sqsupseteq r.\; 
         \basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\ooo Assume $r \in \powerset{H}, s \sqsupseteq r$ \\
\oooo We want to show $\basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\oooo This is equivalent to $\forall h \in p * s.\; (\sqcup c_i)\; Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooo Assume $h \in p * s$ \\ 
\ooooo By continuity, we know $(\sqcup c_i)\; Best(\semfun{a}{q(a)*s})\;h = 
                               \bigsqcup (c_i\;Best(\semfun{a}{q(a)*s})\;h)$ \\
\ooooo Suppose $c$ is an element of the chain of $c_i$ \\
\oooooo Then we know $c \in \spec{p}{-}{a:A}{q}$ \\
\oooooo This is equivalent to $\spec{p}{c}{a:A}{q} = \powerset{H}$ \\
\oooooo This is equivalent to $\forall r, s \sqsupseteq r.\; \basicspec{p*s}{c}{a:A}{q(a)*s}$ \\
\oooooo This is equivalent to $\forall r, s \sqsupseteq r, h \in p*s, c\;Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooooo Instantiating quantifiers with $r$, $s$, and $h$, we get $c\;Best(\semfun{a}{q(a)*s})\;h = \bot$\\
\ooooo Therefore $\forall c \in \comprehend{c_i}{i \in \N}$, $c\;Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\ooooo Therefore $\bigsqcup (c_i\;Best(\semfun{a}{q(a)*s})\;h) = \bot$ \\
\ooooo Therefore $(\sqcup c_i)\;Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooo Therefore $\forall h \in p * s.\; (\sqcup c_i)\; Best(\semfun{a}{q(a)*s})\;h = \bot$ \\
\oooo Therefore $\basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\ooo Therefore $\forall r \in \powerset{H}, s \sqsupseteq r.\; 
                   \basicspec{p * s}{\sqcup c_i}{a:A}{q(a) * s}$ \\
\ooo Therefore $\spec{p}{\sqcup c_i}{a:A}{q(a)} = \powerset{H}$ \\
\ooo Therefore $\sqcup_i c_i \in \spec{p}{\sqcup_i c_i}{a:A}{q(a)}$ \\
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Semantic Fixed Point Induction)}
If we know that for all $x$, $\spec{p}{x}{a:A}{q(a)} = \powerset{H}$ implies $\spec{p}{f(x)}{a:A}{q(a)}) = \powerset{H}$, then we know that $\spec{p}{\mathit{fix}(f)}{a:A}{q(a)} = \powerset{H}$
\end{lemma}

\begin{proof}
First, observe that $f^n(\bot)$ forms a chain -- that is, for all $i$, $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$.
\begin{tabbedproof}
\oo We want to show $\forall i$, $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\oo We proceed by induction on $i$ \\
\ooo Case $i = 0$: \\
\oooo We want to show $\bot \sqsubseteq f(\bot)$ \\
\oooo This follows immediately from the fact that $\bot$ is the least element of a domain. \\
\ooo Case $i = j + 1$ \\
\oooo We want to show $f^j(\bot) \sqsubseteq f^{j+1}(\bot) \implies f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\oooo Assume $f^j(\bot) \sqsubseteq f^{j+1}(\bot)$ \\
\ooooo By monotonicity of $f$, $f(f^j(\bot)) \sqsubseteq f(f^{j+1}(\bot))$ \\
\ooooo Therefore $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\oo Therefore $\forall i$, $f^i(\bot) \sqsubseteq f^{i+1}(\bot)$ \\
\end{tabbedproof}

\noindent Now, observe that for every $n$, $f^n(\bot) \in \spec{p}{-}{a:A}{q}$. 

\begin{tabbedproof}
\oo Assume for all $x$, $\spec{p}{x}{a:A}{q(a)} = \powerset{H}$ implies $\spec{p}{f(x)}{a:A}{q(a)}) = \powerset{H}$ \\
\ooo We want to show $\forall n, f^n(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\ 
\ooo We proceed by induction on $n$: \\
\oooo Case $n = 0$ \\
\ooooo We want to show $\bot \in \spec{p}{-}{a:A}{q(a)}$ \\
\ooooo This follows from the fact that bottom satisfies all specifications. \\
\oooo Case $n = m + 1$ \\
\ooooo We want to show $f^m(\bot) \in \spec{p}{-}{a:A}{q} \implies
                        f^{m+1}(\bot) \in \spec{p}{-}{a:A}{q}$ \\
\ooooo Assume $f^m(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\
\oooooo This means $\spec{p}{f^m(\bot)}{a:A}{q(a)} = \powerset{H}$ \\
\oooooo Instantiate line 1 with $f^m(\bot)$, to conclude
          $\spec{p}{f(f^m(\bot))}{a:A}{q(a)}) = \powerset{H}$ \\
\oooooo This means $\spec{p}{f^{m+1}(\bot)}{a:A}{q(a)} = \powerset{H}$ \\
\oooooo This means $f^{m+1}(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\
\ooo Therefore $\forall n, f^n(\bot) \in \spec{p}{-}{a:A}{q(a)}$ \\ 
\end{tabbedproof}
Finally, by the admissibility of $\spec{p}{-}{a:A}{q(a)}$, we know that
$\sqcup f^n(\bot) \in \spec{p}{-}{a:A}{q(a)}$. Since $\sqcup f^n(\bot) = fix(f)$, we 
know that $\spec{p}{\mathit{fix}(f)}{a:A}{q(a)} = \powerset{H}$. 
\end{proof}



\section{The Framing Operator}

One nice feature of the Kripke-style interpretation of specifications
is that it naturally validates higher-order frame rules.  We define
the operation $S \otimes p$, where $S \in \upset{W(\powerset{H})}$ and
$p \in W(\powerset{H})$:
\begin{displaymath}
S \otimes p = \comprehend{ r \in W(\powerset{H}) }{ r * p \in S }
\end{displaymath}
%
The way to understand this is that $S \otimes p$ restricts $S$ to only those
elements which can be extended by $p$. That is, if we think of $S$ as the
set of propositions that can be framed on to a basic triple, then we want
$S \otimes p$ to be only the frames in $S$, such that if we added $p$ to
them we continue to have a frame in $S$. So this operation gives a semantic
interpretation of the frame rule. 

So we need to show that first, $S \otimes p$ actually is an element of
our Heyting algebra of specification truth values, and second, we want
the frame rule to be sound -- we want $S$ to always imply $S \otimes
p$.

\begin{lemma}{(Framing is a Lattice Operation)}
For all $S$ and $p$, we have that $S \otimes p$ is in $\upset{W(\powerset{H}})$,
and that $S \subseteq S \otimes p $.
\end{lemma}
\begin{proof}
To show that $S \otimes p \in \upset{W(\powerset{H})}$, we need to show that for all 
$x,y$, if $x \in S \otimes p$ and $y \sqsupseteq x$, then $y \in S \otimes p$. 

\begin{tabbedproof}
\oo We want to show for all $x,y$, if $x \in S \otimes p$ and $y \sqsupseteq x$, then $y \in S \otimes p$ \\
\oo Assume $x, y, x \in S \otimes p, y \sqsupseteq x$ \\
\ooo From $x \in S \otimes p$, we know $x * p \in S$ \\
\ooo From $y \sqsupseteq x$, we know $\exists r.\; y = x * r$ \\
\ooo Let $r$ be the witness so that $y = x * r$ \\
\oooo Since $S$ is upward closed, $x * p * r \in S$ \\
\oooo Since $x * p * r = (x * r) *p$, we know  $y * p \in S$ \\
\oooo Therefore $y \in S \otimes p$ \\
\end{tabbedproof}

\noindent To show $S \subseteq S \otimes p$, we need to show that if $x \in S$, then $x \in S \otimes p$. 
\begin{tabbedproof}
\oo Assume $x \in S$ \\
\ooo Since $\sqsubseteq$ is the extension ordering, $x \sqsubseteq x * p$ \\   
\ooo Since $S$ is upward closed, $x * p \in S$\\
\ooo Therefore $x \in S \otimes p$ 
\end{tabbedproof}
\end{proof}

\subsection{Framing Commutes With Logical Operators}

\begin{lemma}{(Framing onto Semantic Triples)}
We have that 
\begin{displaymath}
\spec{p}{c}{a:A}{q(a)} \otimes r = \spec{p * r}{c}{a:A}{q(a) * r}  
\end{displaymath}
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo We want to show $\spec{p}{c}{a:A}{q(a)} \otimes r = \spec{p * r}{c}{a:A}{q(a) * r}$. \\
\oo This means $\forall s \in W(\powerset{H}).\; s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ if and
only if $s \in \spec{p * r}{c}{a:A}{q(a) * r}$. \\
\ooo Assume $s \in W(\powerset{H})$ \\
\oooo $\To$ direction: \\
\ooooo Assume $s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ \\
\oooooo This means $s * r \in \spec{p}{c}{a:A}{q(a)}$ \\
\oooooo This means $\forall t \sqsupseteq s * r.\; \basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo We want to show $s \in \spec{p * r}{c}{a:A}{q(a) * r}$ \\
\oooooo So we want $\forall t' \sqsupseteq s.\; \basicspec{p * r * t'}{c}{a:A}{q(a) * r * t'}$\\
\oooooo Assume $t' \in \sqsupseteq s$ \\
\ooooooo Clearly, $t' * r \sqsupseteq s * r$ \\
\ooooooo Instantiate quantifier in 7 with $t' * r$ to conclude
         $\basicspec{p * t' * r}{c}{a:A}{q * t' * r}$ \\
\ooooooo Rearranging, we get $\basicspec{p * r * t'}{c}{a:A}{q * r * t'}$ \\
\oooooo Therefore $\forall t' \sqsupseteq s.\; \basicspec{p * r * t'}{c}{a:A}{q(a) * r * t'}$\\
\oooooo Therefore $s \in \spec{p * r}{c}{a:A}{q(a) * r}$ \\[0.5em]

\oooo $\Leftarrow$ direction: \\
\ooooo Assume $s \in \spec{p * r}{c}{a:A}{q(a) * r}$. \\
\oooooo This means $\forall t \sqsupseteq s.\; \basicspec{p * r * t}{c}{a:A}{q(a) * r * t}$ \\
\oooooo We want to show $s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ \\
\oooooo So we want $s * r \in \spec{p}{c}{a:A}{q(a)}$ \\
\oooooo So we want $\forall t \sqsupseteq s * r.\; \basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo Assume $t \sqsupseteq s * r$ \\
\ooooooo Since $t \sqsupseteq s * r$, we know $\exists u.\; t = s * r * u$ \\
\ooooooo Let $u$ be the witness such that $t = s * r * u$ \\
\ooooooo Now, note that $s * u \sqsupseteq s$ \\
\ooooooo Instantiate quantifier in 18 with $s * u$, so 
         $\basicspec{p * r * s * u}{c}{a:A}{q(a) * r * s * u}$ \\
\ooooooo Rearranging, $\basicspec{p * s * r * u}{c}{a:A}{q(a) * s * r * u}$ \\
\ooooooo By equality in 24, $\basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo Therefore $\forall t \sqsupseteq s * r.\; \basicspec{p * t}{c}{a:A}{q * t}$ \\
\oooooo Therefore $s * r \in \spec{p}{c}{a:A}{q(a)}$ \\
\oooooo Therefore $s \in (\spec{p}{c}{a:A}{q(a)} \otimes r)$ 
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Framing Commutes with Meets)}
We have that 
\begin{displaymath}
\left(\bigwedge_{i \in I} S_i\right) \otimes p = \bigwedge_{i \in I} (S_i \otimes p)
\end{displaymath}
\end{lemma}

\begin{proof}
To show $\left(\bigwedge_{i \in I} S_i\right) \otimes p = \bigwedge_{i \in I} (S_i \otimes p)$,
we need to show $\forall r.\; r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ if
and only if $r \in \bigwedge_{i \in I} (S_i \otimes p)$. 

\begin{tabbedproof}
\oo Assume $r \in W(\powerset{H})$ \\[0.5em]

\ooo $\To$ direction: \\
\oooo Assume $r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ \\
\ooooo From assumption, we know $r * p \in \bigwedge_{i \in I} S_i$ \\
\ooooo This means that $\forall i \in I.\; r * p \in S_i$ \\
\ooooo We want to show $r \in \bigwedge_{i \in I} (S_i \otimes p)$ \\
\ooooo So we want $\forall i \in I.\; r \in (S_i \otimes p)$ \\
\ooooo So we want $\forall i \in I.\; r * p \in S_i$ \\
\ooooo Assume $i \in I$ \\
\oooooo We want to show $r * p \in S_i$ \\
\oooooo Instantiating line 5 with $i$, we get $r * p \in S_i$ \\[0.5em]

\ooo $\Leftarrow$ direction:  \\
\oooo Assume $r \in \bigwedge_{i \in I} (S_i \otimes p)$  \\
\ooooo From this, we know that $\forall i \in I.\; r \in (S_i \otimes p)$ \\
\ooooo We want to show $r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ \\
\ooooo So we want to show $r * p \in \bigwedge_{i \in I} S_i$ \\
\ooooo So we want to show $\forall i \in I.\; r * p \in S_i$ \\
\ooooo Assume $i \in I$ \\
\oooooo Instantiating line 14 with $i$, we get $r \in (S_i \otimes p)$ \\
\oooooo This means $r * p \in S_i$ \\
\ooooo Therefore $\forall i \in I.\; r * p \in S_i$ \\
\ooooo Therefore $r * p \in \bigwedge_{i \in I} S_i$ \\
\ooooo Therefore $r \in \left(\bigwedge_{i \in I} S_i\right) \otimes p$ 
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Framing Commutes with Joins)}
We have that 
\begin{displaymath}
\left(\bigvee_{i \in I} S_i\right) \otimes p = \bigvee_{i \in I} (S_i \otimes p)
\end{displaymath}
\end{lemma}

\begin{proof}
Showing this is equivalent to showing $\forall r.\; r \in
\left(\bigvee_{i \in I} S_i\right) \otimes p$ if and only if $r \in
\bigvee_{i \in I} (S_i \otimes p)$.

\begin{tabbedproof}
\oo Assume $r$ \\[0.5em]
\ooo  $\To$ direction: \\
\oooo Assume $r \in \left(\bigvee_{i \in I} S_i\right) \otimes p$ \\
\oooo This means $r * p \in \bigvee_{i \in I} S_i$ \\
\oooo This means $\exists i \in I.\; r * p \in S_i$ \\
\oooo We want to show $r \in \bigvee_{i \in I} (S_i \otimes p)$ \\
\oooo So we want to show $\exists i \in I.\; r \in (S_i \otimes p)$ \\
\oooo Let $i$ be the witness in 5, such that $r * p \in S_i$ \\
\ooooo From this, we see $r \in (S_i \otimes p)$ \\
\ooooo From this and $i$, we conclude $\exists i \in I.\; r \in (S \otimes p)$ \\
\oooo Therefore $r \in \bigvee_{i \in I} (S_i \otimes p)$ \\[0.5em]

\ooo $\From$ direction: \\
\oooo Assume $r \in \bigvee_{i \in I} (S_i \otimes p)$. \\
\ooooo From this, $\exists i \in I.\; r \in (S_i \otimes p)$ \\
\ooooo We want to show $r \in \left(\bigvee_{i \in I} S_i\right) \otimes p$ \\
\ooooo So we want $r * p \in \bigvee_{i \in I} S_i$ \\
\ooooo So we want $\exists i \in I.\; r * p \in S_i$ \\
\ooooo Let $i \in I$ be the witness in 14, so that $r \in (S_i \otimes p)$ \\
\oooooo From this, $r * p \in S_i$ \\
\oooooo With this and $i \in I$, we know $\exists i \in I.\; r * p \in S_i$ \\
\ooooo Therefore $r * p \in \bigvee_{i \in I} S_i$ \\
\ooooo Therefore $r \in \left(\bigvee_{i \in I} S_i\right) \otimes p$ \\
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Framing Commutes Through Implication)}
We have that
\begin{displaymath}
  (S_1 \implies S_2) \otimes p = (S_1 \otimes p) \implies (S_2 \otimes p) 
\end{displaymath}
\end{lemma}

\begin{proof}
This is equivalent to showing that $\forall r, r \in [(S_1 \implies S_2) \otimes p]$ if and
only if $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$. 

\begin{tabbedproof}
\oo Assume $r$ \\
\ooo $\To$ direction:\\
\oooo Assume $r \in [(S_1 \implies S_2) \otimes p]$ \\
\ooooo This means $r * p \in (S_1 \implies S_2)$ \\
\ooooo This means $\forall s \sqsupseteq r * p,$ if $s \in S_1$ then $s \in S_2$ \\
\ooooo We want to show $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$ \\
\ooooo So we want $\forall s \sqsupseteq r,$ if  $s \in S_1 \otimes p$ then $s \in S_2 \otimes p$ \\
\ooooo Assume $s \sqsupseteq r$ and $s \in S_1 \otimes p$ \\
\oooooo From this $s * p \in S_1$ \\ 
\oooooo Since $s * p \sqsupseteq s$ and $s \sqsupseteq r$, we have $s * p \sqsupseteq r$ \\
\oooooo Instantiating line 5 with $s * p$, we have if $s * p \in S_1$ then $s * p \in S_2$ \\
\oooooo Using this and line 9, we have $s * p \in S_2$ \\
\oooooo From this, we have $s \in S_2 \otimes p$ \\
\ooooo Therefore $\forall s \sqsupseteq r,$ if  $s \in S_1 \otimes p$ then $s \in S_2 \otimes p$ \\
\ooooo Therefore $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$ \\

\ooo $\From$ direction: \\
\oooo Assume $r \in [(S_1 \otimes p) \implies (S_2 \otimes p)]$ \\
\ooooo From this, $\forall s \sqsupseteq r,$ if $s \in (S_1 \otimes p)$, then $s \in (S_2 \otimes p)$ \\
\ooooo We want to show $r \in [(S_1 \implies S_2) \otimes p]$ \\
\ooooo So we want $r * p \in (S_1 \implies S_2)$ \\
\ooooo So we want $\forall s \sqsupseteq r * p$, if $s \in S_1$ then $s \in S_2$ \\
\ooooo Assume $s \sqsupseteq r * p$ and $s \in S_1$ \\
\oooooo From this, $\exists t.\; s = t * r * p$ \\
\oooooo Let $t$ be the witness such that $s = t * r * p$ \\ 
\ooooooo Note $t * r \sqsupseteq r$ \\
\ooooooo Instantiating 18 with $t * r$, we get if $t * r \in (S_1 \otimes p)$, then $t * r \in (S_2 \otimes p)$ \\
\ooooooo From this, we have if $t * r * p \in S_1$ then $t * r * p \in S_2$ \\
\ooooooo So we have if $s \in S_1$, then $s \in S_2$ \\
\ooooooo From this and 22, we have $s \in S_2$ \\
\ooooo Therefore $\forall s \sqsupseteq r * p$, if $s \in S_1$ then $s \in S_2$ \\
\ooooo Therefore $r * p \in (S_1 \implies S_2)$ \\
\ooooo Therefore $r \in [(S_1 \implies S_2) \otimes p]$ 
\end{tabbedproof}
\end{proof}

\section{Syntax of Assertions and Specifications}

In this section, we will give the syntax of specifications and
assertions, and then we will give their semantics.

The syntactic categories are given in Figure~\ref{logic-syntax}. The
sorts $\omega$ include $\assert$, the sort of propositions in
separation logic, the kinds $\kappa$, the polytypes $A$, and
implications over these sorts $\omega \To \omega'$. Note that both
types and kinds are counted as sorts of our logic, which mean that
assertions in separation logic will be permitted to quantify over both
terms and types.  We will need this ability in order to reason properly
about polymorphic programs -- for example, to specify the behavior of
a polymorphic length function on lists.

The terms (for which we will use $p$ $q$ as metavariables) which are
categorized by our sorts are also given in Figure~\ref{logic-syntax}.
They include lambda-abstraction and application for the exponential
sort $\omega \To \omega'$, terms $e$ for the sorts $A$,
type expressions $\tau$ for the sorts $\kappa$. 

Finally, we also have the assertions of separation logic for the sort
$\assert$.  These include the usual propositional logical connectives
--- $\top, p \land q, p \implies q, \bot, p \vee q$ -- as well as the
spatial connectives $\emp, p * q, p \wand q$, and $e \pointsto_A
e'$. Note that the points-to proposition is typed; it indicates that
$e$ is a reference of type $\reftype{A}$ with contents $e'$ of type
$A$.

The quantifiers $\forall u:\omega.\; p$ and $\exists u:\omega.\; p$
are higher-order quantifiers. They can range over all sorts, including
the sort of assertions $\assert$, and so we have the full power of
higher-order separation logic available.  Finally, we have the
\emph{specification embedding assertion} $\validprop{S}$.  This is an
\emph{assertion} that the specification $S$ is true, and is useful for
writing assertions that include facts about the behavior of code.

The specifications $S$ begin with the basic Hoare triple
$\spec{p}{c}{a:A}{q}$, which says that the computation $c$, when run
from a pre-state in $p$, will end in a post-state in $q$, with its
return value named by $a$. Similarly, we have the monadic Hoare triple
form $\mspec{p}{e}{a:A}{q}$ which says that the suspended monadic
computation $e$ (of type $\monad{A}$), will take a pre-state $p$ to a
post-state $q$ if it were to be run. The specification $\setof{p}$ is
the assertion-embedding specification, which says that $p$ is a
tautology of separation logic. 

This does mean that assertions and specifications are mutually
recursive, which means that we will have to give the semantics of 
these two syntaxes simultaneously. This is one of the reasons we
spent the first half of this chapter developing the semantics with
no reference to the intended syntax at all -- I wanted to make sure
the semantic domains were all well-defined before giving the highly
mutually-recursive semantics of the program logic. 

\begin{figure}
\begin{displaymath}
\begin{array}{llcl}
\mbox{Sorts} & \omega & ::= & \omega \To \omega \bnfalt \kappa \bnfalt
A \bnfalt \assert \\[1em]

\mbox{Terms} & 
p,q & ::= & u \bnfalt \pfun{u}{\omega}{p} \bnfalt p\;q \bnfalt \tau \bnfalt e \\
&   &  |  & \top \bnfalt p \land q \bnfalt p \implies q \bnfalt \bot \bnfalt p \vee q \\
&   &  |  & \emp \bnfalt p * q \bnfalt p \wand q \bnfalt p \pointsto_{A} q \\
&   &  |  & \forall u:\omega.\; p \bnfalt \exists u:\omega.\; p \bnfalt p =_\omega q \bnfalt
            \validprop{S} \\[1em]

\mbox{Specifications} & 
S & ::= & \spec{p}{c}{a:A}{q} \bnfalt \mspec{p}{e}{a:A}{q} \bnfalt \setof{P} \\
& &  |  & S \specand S' \bnfalt S \specimp S' \bnfalt S \specor S' \\
& &  |  & \forall u:\omega.\; S \bnfalt \exists u:\omega.\; S \\[1em]

\mbox{Contexts} & 
\Delta & ::= & \cdot \bnfalt \Delta, u:\omega \\[1em]
\end{array}
\end{displaymath}
\caption{Syntax of Assertions and Specifications}
\label{logic-syntax}  
\end{figure}



A context $\Delta$ is a sequence of sorted variables of the form
$u:\omega$. However, the fact that kinds are sorts, and that types are
also sorts which can depend on type variables, means that we need a
judgement to establish whether a sort is well-formed with respect to a
context, and likewise we will need a judgement to establish whether
the context is well-formed.

The judgement $\judgeACtx{\Delta}$, given in
Figure~\ref{logic-sort-ok}, establishes whether a particular context
is well-formed. It is mutually recursive with the judgement
$\judgeSort{\omega}$ (also given in Figure~\ref{logic-sort-ok}), which
judges whether or not the sort $\omega$ is well-formed. This judgement
is purely structural, except for the case when a type is judged
$\judgeSort{A}$, in the rule \textsc{SortType}. In this case, we use
the restriction operator $\restrictkind{\Delta}$ to pick out the
variables of the form $\alpha:\kappa$ out of $\Delta$, and then we
check to see whether $A$ is a well-kinded polytype with respect to
that subset of the context. This operator is defined in
Figure~\ref{context-ops}. 

Finally, we need an equality judgement for sorts, since we have an
equality theory for types. The judgement
$\judgeSortEq{\omega}{\omega'}$, defined in
Figure~\ref{logic-sort-ok}, judges whether two sorts are equal, by
means of an almost-congruence. That is, the rules of this judgement
are all congruence rules, except for the single case
\textsc{SortEqType}, which inherits from the equality judgement for
polytypes.

Now that we have defined what the sorts are, we define what it means
for a term to be well-sorted in context with the judgement
$\judgeA{p}{\omega}$, defined in Figure~\ref{logic-prop-ok}.

\begin{figure}
\begin{mathpar}
\boxed{\judgeACtx{\Delta}} 
\\
\inferrule*[right=CtxNil]
          { }
          {\judgeACtx{\cdot}}
\and
\inferrule*[right=CtxCons]
          {\judgeACtx{\Delta} \\
           \judgeSort{\omega}}
          {\judgeACtx{\Delta, u:\omega}}
\\
\boxed{\judgeSort{\omega}}
\\
\inferrule*[right=SortKind]
          {\judgeACtx{\Delta}}
          {\judgeSort{\kappa}}
% \and
% \inferrule*[right=SortPolyKind]
%           {\judgeACtx{\Delta}}
%           {\judgeSort{\bigstar}}
\and
\inferrule*[right=SortType]
          {\judgeACtx{\Delta} \\
           \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
          {\judgeSort{A}}
\and
\inferrule*[right=SortProp]
          {\judgeACtx{\Delta}}
          {\judgeSort{\assert}}
\and
\inferrule*[right=SortImp]
          {\judgeSort{\omega} \\ \judgeSort{\omega'}}
          {\judgeSort{\omega \To \omega'}}
\\
\boxed{\judgeSortEq{\omega}{\omega'}}
\\
\inferrule*[right=SortEqProp]
           { } 
           {\judgeSortEq{\assert}{\assert}}
\and
\inferrule*[right=SortEqKind]
          { }
          {\judgeSortEq{\kappa}{\kappa}}
\and
% \inferrule*[right=SortEqPolyKind]
%           { }
%           {\judgeSortEq{\bigstar}{\bigstar}}
% \and
\inferrule*[right=SortEqImp]
          {\judgeSortEq{\omega_1}{\omega'_1} \\
           \judgeSortEq{\omega_2}{\omega'_2} }
          {\judgeSortEq{\omega_1 \To \omega_2}{\omega'_1 \To \omega'_2}}
\and
\inferrule*[right=SortEqType]
          {\judgeKeq[\restrictkind{\Delta}]{A}{B}{\bigstar}}
          {\judgeSortEq{A}{B}}
\end{mathpar}
\caption{Well-sorting of Sorts and Contexts}
\label{logic-sort-ok}
\end{figure}

\begin{figure}
\begin{mathpar}
\boxed{\judgeA{p}{\omega}}
\\
\inferrule*[right=TermType]
          {\judgeACtx{\Delta} \\
           \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}}
          {\judgeA{\tau}{\kappa}}
\and
% \inferrule*[right=TermPolytype]
%           {\judgeACtx{\Delta} \\
%            \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
%           {\judgeA{A}{\bigstar}}
\and
\inferrule*[right=TermExpr]
          {\judgeACtx{\Delta} \\
           \judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{A}}
          {\judgeA{e}{A}}
\and
\inferrule*[right=TermHyp]
          {\judgeACtx{\Delta} \\
           u:\omega \in \Delta }
          {\judgeA{u}{\omega}}
\and
\inferrule*[right=TermAbs]
          {\judgeA[\Delta, u:\omega]{p}{\omega'}}
          {\judgeA{\pfun{u}{\omega}{p}}{\omega \To \omega'}}
\and
\inferrule*[right=TermApp]
          {\judgeA{p}{\omega' \To \omega} \\
           \judgeA{q}{\omega'}}
          {\judgeA{p\;q}{\omega}}
\and
\inferrule*[right=TermPropConst]
          {\judgeACtx{\Delta} \\
           c \in \setof{\top, \bot, \emp}}
          {\judgeA{c}{\assert}}
\and
\inferrule*[right=TermPropBinary]
          {\judgeA{p}{\assert} \\
           \judgeA{q}{\assert} \\
           \oplus \in \setof{\land, \vee, \implies, *, \wand}}
          {\judgeA{p \oplus q}{\assert}}
\and
\inferrule*[right=TermPropQuantify]
          {\judgeA[\Delta, u:\omega]{p}{\assert} \\
           Q \in \setof{\forall, \exists}}
          {\judgeA{Q u:\omega.\; p}{\assert}}
\and
\inferrule*[right=TermPointsTo]
          {\judgeA{e}{\reftype{A}} \\
           \judgeA{e'}{A}}
          {\judgeA{e \pointsto_A e'}{\assert}}
\and
\inferrule*[right=TermEqual]
          {\judgeA{p}{\omega} \\
           \judgeA{q}{\omega}}
          {\judgeA{p =_\omega q}{\assert}}
\and
\inferrule*[right=TermSpec]
          {\judgeS{S}}
          {\judgeA{\validprop{S}}{\assert}}
\and
\inferrule*[right=TermEqSort]
          {\judgeSortEq{\omega}{\omega'} \\
           \judgeA{p}{\omega'}}
          {\judgeA{p}{\omega}}
\end{mathpar}
\caption{Well-sorting of Assertions}
\label{logic-prop-ok}
\end{figure}

In the rules \textsc{TermType} and \textsc{TermExpr}, we simply
inherit well-kindedness and well-typedness from the corresponding
judgements for types and terms. To do this, we need not just the
kind-level restriction operator $\restrictkind{\Delta}$, we also need
the type-level restriction operator $\restricttype{\Delta}$, which
picks out the hypotheses of the context which are of sort $A$. This
second restriction operator is also defined in
Figure~\ref{context-ops}.

\begin{figure}
\begin{displaymath}
\begin{array}{lcl}
\restrictkind{\cdot}                 & = & \cdot \\
\restrictkind{\Delta, \alpha:\kappa} & = & \restrictkind{\Delta}, \alpha:\kappa \\
\restrictkind{\Delta, x:A}           & = & \restrictkind{\Delta} \\
\restrictkind{\Delta, u:\assert}     & = & \restrictkind{\Delta} \\
\restrictkind{\Delta, u:\omega \To \omega'} & = & \restrictkind{\Delta} \\[1em]

\restricttype{\cdot}                 & = & \cdot \\
\restricttype{\Delta, \alpha:\kappa} & = & \restricttype{\Delta} \\
\restricttype{\Delta, x:A}           & = & \restricttype{\Delta}, x:A \\
\restricttype{\Delta, u:\assert}     & = & \restricttype{\Delta} \\
\restricttype{\Delta, u:\omega \To \omega'} & = & \restricttype{\Delta} \\[1em]

\restricttyenv{\cdot}{\unit}                     & = & \unit \\ 
\restricttyenv{\Delta, u:\kappa}{(\delta, x)}    & = & (\restricttyenv{\Delta}{\delta}, x) \\
\restricttyenv{\Delta, u:\assert}{(\delta, x)}   & = & \restricttyenv{\Delta}{\delta} \\
\restricttyenv{\Delta, u:A}{(\delta, x)}         & = & \restricttyenv{\Delta}{\delta} \\
\restricttyenv{\Delta,u:\omega \To \omega'}{(\delta, x)} &=& \restricttyenv{\Delta}{\delta} \\[1em]

\restrictvals{\cdot}{\unit}                     & = & \unit                             \\ 
\restrictvals{\Delta, u:\kappa}{(\delta, \tau)} & = & \restrictvals{\Delta}{\delta}      \\
\restrictvals{\Delta, u:\assert}{(\delta, x)}   & = & \restrictvals{\Delta}{\delta}      \\
\restrictvals{\Delta, u:A}{(\delta, x)}         & = & (\restrictvals{\Delta}{\delta}, x) \\
\restrictvals{\Delta, u:\omega \To \omega'}{(\delta, x)} &=& \restrictvals{\Delta}{\delta} \\[1em]
\end{array}
\end{displaymath}
\caption{Auxilliary Context Operations}
\label{context-ops}  
\end{figure}

The rule \textsc{TermHyp} is the hypothesis rule for all variables.
% 
% (There is a minor technical issue here: we can refer to a program
% variable either via the \textsc{TermExpr} rule, or using the
% \textsc{TermHyp} rule. Strictly speaking, this means that well-sorting
% derivations are not unique, and so when we give a semantics, we would
% need to prove a coherence theorem. However, this could easily be
% avoided by adding some syntactic annotation to the use of program
% terms (for instance, by writing $\left\lfloor e \right\rfloor$ or
% similarly for variables), so we will simply let this issue slide.
% 
The \textsc{TermAbs} and \textsc{TermApp} rules give the
lambda-abstraction and application rules for the function sort $\omega
\To \omega'$ -- there are no surprises here. Finally, there are all
the rules giving the sorting of propositions. The nullary propositions
$\top, \bot$, and $\emp$ are typed with the \textsc{TermPropConst}
rule, and the binary propositions $\land, \vee, \implies, *$, and
$\wand$ are typed with the \textsc{TermPropBinary} rule, requiring
their two arguments to both be of sort $\assert$.


The two quantifiers $\forall u:\omega.\;p$ and $\exists u:\omega.\;p$
are sorted with the \textsc{TermPropQuantify} rule, and the points-to
$e \pointsto_A e'$ and equality $p =_\omega q$ each require that their 
arguments be of the correct sort. Note that $e \pointsto_A e'$ is
restricted to program types, as expected, whereas equality is valid
at any sort. 

Finally, we have the rule $\textsc{TermSpec}$ for the
specification-embedding assertion $\validprop{S}$, which recursively
invokes the well-sorted specification $\judgeS{S}$. This judgement is
defined in Figure~\ref{logic-spec-ok}, and consists of a handful of
rules. The \textsc{SpecTriple} rule asserts that $\spec{p}{c}{a:A}{q}$
is well-kinded when $A$ is a type, $p$ is an assertion, $c$ is a
computation yielding an $A$, and $q$ is an assertion with $a$ as an
extra free variable.  Likewise the \textsc{SpecMTriple} rule does the
same job for monadic expressions, saying that $\mspec{p}{e}{a:A}{q}$,
saying that $e$ must be a term of monadic type $\monad{A}$, but
otherwise as in the \textsc{SpecTriple} rule.  Finally, the remaining
atomic proposition \textsc{SpecAssert} rule recursively calls back into the
assertion well-kinding judgement.


The \textsc{SpecBinary} rules gives well-formedness conditions for the
conjunction ($S \specand S'$), disjunction ($S \specor S'$), and
implication ($S \specimp S'$) over specifications, in each case asking
the subterms to be well-formed specifications. The quantifier rule
\textsc{SpecQuantify} simply extends the context with the newly
quantified variable. Since $\spectype$ is not a sort, this means that
the language of specifications is a multi-sorted first-order logic,
rather than a higher-order logic. There are no technical obstacles to
extending it in this fashion, but we have not felt any strong need to
do so.



\begin{figure}
\begin{mathpar}
\boxed{\judgeS{S}} \\
\inferrule*[right=SpecTriple]
          {\judgeA{p}{\assert} \\
           \judgeA[\Delta]{\comp{c}}{\monad{A}} \\
           \judgeA[\Delta, a:A]{q}{\assert}}
          {\judgeS{\spec{p}{c}{a:A}{q}}}
\and
\inferrule*[right=SpecMTriple]
          {\judgeA{p}{\assert} \\
           \judgeA{e}{\monad{A}} \\
           \judgeA[\Delta, a:A]{q}{\assert}} 
          {\judgeS{\mspec{p}{e}{a:A}{q}}}
\and
\inferrule*[right=SpecAssert]
          {\judgeA{p}{\assert}}
          {\judgeS{\setof{p}}}
\and
\inferrule*[right=SpecQuantify]
          {\judgeS[\Delta, u:\omega]{S} \\ u \in \setof{\forall, \exists}}
          {\judgeS{Q u:\omega.\; S}}
\and
\inferrule*[right=SpecBinary]
          {\judgeS{S_1} \\ \judgeS{S_2} \\ \oplus \in \setof{\specand, \specor, \specimp}}
          {\judgeS{S_1 \oplus S_2}}
\end{mathpar}
\caption{Well-sorting of Specifications}
\label{logic-spec-ok}
\end{figure}

\subsection{Substitution Properties}

In the syntax for the program logic, we have systematically made the
decision to forbid the appearance of logical expressions within
program expressions. For example, suppose $P$ is a variable of type
$\assert \To \N$. The typing rules given so far forbid us from
writing an expression of program type $\monad{\N}$ such as $\comp{P(x
  \pointsto y)}$. This is because the restriction operations ensure
that program expressions never use variables whose of logical type,
and since the sort of $P$ is neither a kind nor a type, it cannot
appear within a term typed by the \textsc{TermExpr} rule.

By requiring program expressions to only contain programmatic
subexpressions, we effectively forbid the use of ``ghost expressions''
in our programs. This restriction will simplify the semantics of the
program logic -- as we will see, I intend for the sorts of our logic
to be interpreted in Set. Since the terms of our programming language
are interpreted in CPO, it is not trivial to intermingle logical and
program expressions, and so the simplest course is to forbid this
mixing.

This will not restrict the expressiveness of our program logic
reasoning, since we can always use \emph{propositions} to assert the
equality of a program variable to some non-programmatic expression. In
the previous example, if we had a variable $z : \N$, then we could
write the expression $\comp{z}$ and separately add a proposition that
$z = P(x \pointsto y)$.

The price we must pay for this simplicity is an increase in the
complexity of the substitution theorems of the logic. From a
proof-theoretic point of view, this is entirely to be expected: since
the restriction operations modify the context, they must have unusual
substitution properties.

\subsubsection{Syntactic Substitution Lemmas}

\begin{lemma}{(Syntactic Substitution for Sorts)}
If $\judgeA{p}{\omega}$, then we have that:

\begin{enumerate}
\item If $\judgeACtx{\Delta, u:\omega, \Delta'}$, and $u$ does not occur in any subterm of sort type in $\Delta'$, or $\omega = \kappa$ and $p = \tau$,  then  
         $\judgeACtx{\Delta, [p/u]\Delta'}$. 
\item If $\judgeSort[\Delta, u:\omega, \Delta']{\omega'}$, and $u$ does not occur in any subterm of sort type in $\Delta'$ and $\omega'$, or $\omega = \kappa$ and $p = \tau$, then
         $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}$. 
\end{enumerate}
\end{lemma}

\begin{lemma}{(Syntactic Substitution for Terms and Specifications)}
Suppose that $D_0 :: \judgeA{p}{\omega}$. Then
\begin{enumerate}
\item If $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, 
         and either $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$,
                or $\omega$ is a sort $\kappa$ and $p = \tau$,
                or $\omega$ is a sort $A$ and $p = e$, 
         then 
         $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$. 
\item If $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, 
         and either $u$ does not occur in a type or program expression in $\Delta'$, $q$, or $\omega'$,
                or $\omega$ is a sort $\kappa$ and $p = \tau$,
                or $\omega$ is a sort $A$ and $p = e$, 
         then 
         $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$. 
\end{enumerate}
\end{lemma}

\begin{lemma}{(Syntactic Substitution for Sort Equality Judgement)}
If we have that $\judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega_1}{\omega_2}$, 
         and either $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$,
                or $\omega$ is a sort $\kappa$ and $p = \tau$,
                or $\omega$ is a sort $A$ and $p = e$, 
then $\judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}{[p/u]\omega''}$. 
\end{lemma}


\begin{proof}
The proofs are at the end of the chapter.  
\end{proof}\\

\section{Semantics}

Now, we will consider the interpretation of the syntax. To do this,
we will proceed in stages. First, we will show how to interpret sorts and
contexts by sets, and show that the equality judgement for sorts is
sound. Using this, we will then give interpretation of terms and
specifications, and show that the interpretation is sound with respect
to substitution.

\subsection{Interpretation of Sorts}

We will start by explaining how to interpret the sorts. Ultimately,
we are going to define assertions to be the powerset of heaps, and
specifications to be upward closed sets of assertions, but because we
allow types as sorts, and types may have free type variables, we will
need to give an indexed, recursive definition in order to make
everything work properly.

Therefore, we will need to give a mutually-recursive definition between
the interpretation the two judgements $\judgeACtx{\Delta}$ and 
$\judgeA{\Delta}{\omega}$.

\begin{displaymath}
  \begin{array}{lcl}
    \interp{\judgeACtx{\Delta}} & \in & \mbox{Set} \\
    \interp{\judgeSort{\omega}} & \in & \interp{\judgeACtx{\Delta}} \to \mbox{Set} \\[1em]

    \interp{\judgeACtx{\cdot}} & = & \unittype \\
    \interp{\judgeACtx{\Delta, u:\omega}} & = & \sum \delta \in \interp{\judgeACtx{\Delta}}.\; 
                                                  (\interp{\judgeSort{\omega}}\;\delta) \\[1em]
 
    \interp{\judgeSort{\kappa}}\;\delta & = & \interp{\kappa} \\
    \interp{\judgeSort{A}}\;\delta & = & 
       U(\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}\;(\restricttyenv{\Delta}{\delta})) \\
    \interp{\judgeSort{\assert}}\;\delta & = & \powerset{H} \\
    \interp{\judgeSort{\omega \To \omega'}}\;\delta & = &  
       \interp{\judgeSort{\omega}}\;\delta \to \interp{\judgeSort{\omega}}\;\delta \\
  \end{array}
\end{displaymath}

The semantic brackets are slightly overloaded in this definition. To
interpret a type $A$, we take it to be the set of the elements of the
domain-theoretic interpretation of $A$, and to interpret a kind
$\kappa$, we take it to be the set of closed canonical forms of that
type. Both of these use the interpretations given in the previous
chapter. 

In order to establish that this actually defines a function, we will
need to prove some supporting lemmas. First, we need to establish that
we an also prove that the context $\Delta$ is well-formed is
$\judgeSort{\omega}$ is derivable:

\begin{lemma}{(Well-sortedness implies well-formed contexts)}
If it is the case that $\judgeSort{\omega}$, then $\judgeACtx{\Delta}$.
\end{lemma}
\begin{proof}
The proof is by a trivial structural induction over the derivation $\judgeSort{\omega}$. 
\end{proof}

Now, this means that the domain of the interpretation function
$\interp{\judgeACtx{\Delta}}$ is always well-defined, given a $\judgeSort{\omega}$. Next,
we need to establish that we get the same result, regardless of \emph{which} derivation
of this judgement we found. 

\begin{lemma}{(Uniqueness of Interpretations)}
We have that:
\begin{enumerate}
\item If we have two derivations $\mathcal{D}_1 :: \judgeACtx{\Delta}$
      and $\mathcal{D}_2 :: \judgeACtx{\Delta}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$
\item If we have two derivations $\mathcal{D}_1 ::\; \judgeSort{\omega}$
      and $\mathcal{D}_2 ::\; \judgeSort{\omega}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$
\end{enumerate}
\end{lemma}
\begin{proof}
  The proof is at the end of the chapter.
\end{proof}

\subsubsection{Interpretation of Equality Judgement on Sorts}

Now, we will show that our equality judgement on sorts $\judgeSortEq{\omega}{\omega'}$ is
sound. 

\begin{lemma}{(Soundness of Sort Equality)}
If $\judgeACtx{\Delta}$, $\judgeSort{\omega}$, and $\judgeSort{\omega'}$ are derivable, then if 
$\judgeSortEq{\omega}{\omega'}$ is derivable, then $\interp{\judgeSort{\omega}} = \interp{\judgeSort{\omega'}}$. 
\end{lemma}
\begin{proof}
  The proof is at the end of the chapter. 
\end{proof}

\subsection{Interpretation of Terms and Specifications}

The term judgement $\judgeA{p}{\omega}$ is mutually recursively
defined with the specification judgement $\judgeS{S}$. Therefore, when
we give the semantics of these judgements, we need to define them
together. The definition of the interpretation of these two judgments
is given in Figures~\ref{term-interpretation} and \ref{spec-interpretation}.

\begin{figure}
\begin{displaymath}
\begin{array}{lcl}
\interp{\judgeA{p}{\omega}} & \in & \prod \delta \in \interp{\judgeACtx{\Delta}}.\; \interp{\judgeSort{\omega}}\;\delta \\
\interp{\judgeS{S}} & \in & \interp{\judgeACtx{\Delta}} \to \upset{W(\powerset{H})} \\[1em]

\interp{\judgeA{\tau}{\kappa}}\;\delta & = & 
   \interp{\judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}}\; (\restricttyenv{\Delta}{\delta}) \\
\interp{\judgeA{e}{A}}\;\delta & = & 
   U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{A}}\;
       (\restricttyenv{\Delta}{\delta})\; (K,K))\;
       (\restrictvals{\Delta}{\delta}) \\
\interp{\judgeA{\pfun{u}{\omega'}{p}}{\omega' \To \omega}}\;\delta & = & 
   \semfun{v \in \interp{\judgeSort{\omega'}}}{\interp{\judgeA[\Delta,u:\omega']{p}{\omega}}\;(\delta, v)} \\
\interp{\judgeA{p\;q}{\omega}}\;\delta & = & 
   (\interp{\judgeA{p}{\omega' \To \omega}}\;\delta)\;(\interp{\judgeA{q}{\omega'}}\;\delta) \\
\interp{\judgeA{u}{\omega}}\;\delta & = & \delta(u) \\

\interp{\judgeA{c}{\assert}}\;\delta & = & \interp{c}^0 \\

\interp{\judgeA{p \oplus q}{\assert}}\;\delta & = & 
    \interp{\judgeA{p}{\assert}}\;\delta \;\;\interp{\oplus}^2\;\;
    \interp{\judgeA{q}{\assert}}\;\delta \\

\interp{\judgeA{Q u:\omega.\; q}{\assert}}\;\delta & = & 
    \interp{Q}_{v \in \interp{\judgeSort{\omega}}\;\delta} 
        \interp{\judgeA[\Delta, u:\omega]{p}{\assert}}\;\delta \\

\interp{\judgeA{e \pointsto_A e'}{\assert}}\;\delta & = & 
    \mbox{let } l = \interp{\judgeA{e}{\reftype{A}}}\;\delta \mbox{ in}\\
& & \mbox{let } v = \interp{\judgeA{e'}{A}}\;\delta \mbox{ in} \\

% U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{\reftype{A}}}\;(\restricttyenv{\Delta}{\delta}))\;(\restrictvals{\Delta}{\delta}) \\
% & &  \mbox{let }v = U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e'}{A}}\;(\restricttyenv{\Delta}{\delta}))\;(\restrictvals{\Delta}{\delta}) \\
& & \setof{(\setof{l}, \semfun{loc}{v \mbox{ when } loc = l})} \\


\interp{\judgeA{e =_\omega e'}{\assert}}\;\delta & = & 
   \mbox{if }\interp{\judgeA{e}{\omega}}\;\delta = \interp{\judgeA{e'}{\omega}}\;\delta 
   \mbox{ then } \top \mbox{ else} \bot \\

\interp{\judgeA{Q u:\omega.\; p}{\assert}}\;\delta & = & 
  \interp{Q}^\infty_{v \in \interp{\judgeSort{\omega}}\;\delta}
    \interp{\judgeA[\Delta, u:\omega]{p}{\assert}}\;(\delta, v) \\

\interp{\judgeA{\validprop{S}}{\assert}}\;\delta & = & 
   \mbox{if } \interp{\judgeS{S}}\;\delta = \top_{\upset{W(\powerset{H})}}
   \mbox{ then } \top
   \mbox{ else } \bot \\

\interp{\judgeA{p}{\omega}}\;\delta & = & 
   \interp{\judgeA{p}{\omega'}}\;\delta \mbox{ when } \judgeSortEq{\omega}{\omega'} \\[1em]


\interp{\top}^0 & = & \top \\
\interp{\bot}^0 & = & \bot \\
\interp{\emp}^0 & = & I \\[1em]

\interp{\land}^2    & = & \land \\
\interp{\implies}^2 & = & \implies \\
\interp{\vee}^2     & = & \vee \\
\interp{*}^2        & = & * \\
\interp{\wand}^2    & = & \wand \\[1em]

\interp{\forall}^\infty & = & \bigwedge \\
\interp{\exists}^\infty & = & \bigvee \\
\end{array}
\end{displaymath}
\caption{ Interpretation of Terms }
\label{term-interpretation}  
\end{figure}

\begin{figure}
\begin{displaymath}
\begin{array}{lcl}
\interp{\judgeS{S}} & = & \interp{\judgeACtx{\Delta}} \to \upset{W(\powerset{H})} \\ [1em]

\interp{\judgeS{\spec{p}{c}{a:A}{q}}}\;\delta & = & 
   \begin{array}{l}
     \setof{\interp{\judgeA{p}{\assert}}\;\delta} \\
      \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}
                       {\comp{c}}{A}}\;(\restricttyenv{\Delta}{\delta})\;
       (\restrictvals{\Delta}{\delta}) \\
     \setof{v.\; \interp{\judgeA[\Delta, a:A]{q}{\assert}}\;(\delta,v)} \\
   \end{array} 
\\[2em]

\interp{\judgeS{\mspec{p}{e}{a:A}{q}}}\;\delta & = & 
   \begin{array}{l}
     \setof{\interp{\judgeA{p}{\assert}}\;\delta} \\
       \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}
                       {e}{A}}\;(\restricttyenv{\Delta}{\delta})\;
       (\restrictvals{\Delta}{\delta}) \\
     \setof{v.\; \interp{\judgeA[\Delta, a:A]{q}{\assert}}\;(\delta,v)} \\
   \end{array} 
\\[2em]

\interp{\judgeS{\setof{p}}}\;\delta & = & 
  \mbox{if } \interp{\judgeA{p}{\assert}}\;\delta = \top_{\powerset{H}}
  \mbox{ then } \top 
  \mbox{ else } \bot \\

\interp{\judgeS{S_1 \oplus S_2}}\;\delta & = & 
  \interp{\judgeS{S_1}}\;\delta \;\;\interp{\oplus}\;\; 
  \interp{\judgeS{S_2}}\;\delta \\

\interp{\judgeS{Q u:\omega.\; S}}\;\delta & = & 
  \interp{Q}_{v \in \interp{\judgeSort{\omega}}\;\delta} 
     \interp{\judgeS[\Delta, u:\omega]{S}}\;(\delta, v) \\[1em]

\interp{\specand} & = & \land \\
\interp{\specor}  & = & \vee  \\
\interp{\specimp} & = & \implies \\[1em]

\interp{\forall} & = & \bigwedge \\
\interp{\exists} & = & \bigvee \\

\end{array}
\end{displaymath}
\caption{Interpretation of Specifications}
\label{spec-interpretation}  
\end{figure}

\subsubsection{Do the Restriction Operations Make Sense?}

As the rule \textsc{TermExpr} shows, program expressions can occur
inside within terms, and in type checking them, we only allow
variables of sort type and kind to occur within them. In
Figure~\ref{term-interpretation}, we take advantage of this fact to
interpret expressions in terms by means of 1) taking the denotational
interpretation of the term, and 2) applying the values from the
context to it.

However, there is something a little fishy about this definition.  The
interpretation of sorts goes into Set, and so environments are
products in Set. But the interpretation of a term is a predomain, and
so it wants an environment that is a production in CPO -- so we seem
to have a type error, unless we can find a way to ``unforget'' the
partial order structure that predomains come with. 

In general, this is not possible, since every set can have potentially
many different partial orders upon it, and \emph{a priori} we don't
know which one we will need. However, in our specific situation, we can
recover the correct partial order. This is because all of the domains
we are interested in arise as interpretations of types. So, if we have
the type, we can just re-compute the appropriate predomain. Furtheremore, the
interpretation of sorts tells us that the elements will all lie in the
correct set, since we chose the interpreting sets in the first place by 
taking that predomain and forgetting the partial order structure. Therefore,
we will prove the following two lemmas to ensure that our notation is
well-defined, and not an abuse. 

\begin{lemma}{(Restriction on Kinds Makes Sense)}
If $D :: \judgeACtx{\Delta}$ and $\delta \in \interp{D}$, then 
$\restricttyenv{\Delta}{\delta} \in \interp{\restrictkind{\Delta}}$. 
\end{lemma}
\begin{proof}
  The proof is at the end of the chapter.
\end{proof}


\begin{lemma}{(Restriction for Values Makes Sense)}
\label{value-restriction}
If $\judgeACtx{\Delta}$ and $\delta \in \interp{\judgeACtx{\Delta}}$, 
then $\restrictvals{\Delta}{\delta} \in U(\interp{\restrictkind{\Delta} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta}{\delta}\;(K,K))$
\end{lemma}
\begin{proof}
  The proof is at the end of the chapter.
\end{proof}

% \subsection{Substitution for Sorts}

\subsubsection{Semantics of Sort Substitution}

\begin{lemma}{(Substitution Preserves Meaning)}
Suppose we have that $\judgeA{p}{\omega}$.

\begin{enumerate}
\item If $\judgeACtx{\Delta, u:\omega, \Delta'}$ and either $u$ does not occur in any subterm of sort type in $\Delta'$, or  $\omega = \kappa$ and $p = \tau$, then  $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ if and only if $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$

\item  If $\judgeSort[\Delta, u:\omega, \Delta']{\omega'}$ and and either $u$ does not occur in any subterm of sort type in $\Delta'$ or $\omega'$, or $\omega = \kappa$ and $p = \tau$, then for all $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$, we have 
\begin{displaymath}
\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\omega'}}\;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}}\;(\delta, \delta')
\end{displaymath}
\end{enumerate}
\end{lemma}
\begin{proof}
  The proof is at the end of the chapter.
\end{proof}
  
\subsubsection{Semantics of Term and Spec Substitution}

\begin{lemma}{(Substitution Preserves Meaning)}
If $D_0 :: \judgeA{p}{\omega}$, then we have 

\begin{enumerate}
\item If $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, and either 
  $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$,  
  or $\omega$ is a sort $\kappa$ and $p = \tau$, 
  or $\omega$ is a sort $A$ and $p = e$,
  then there is a $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ such
  that for all $(\delta, \interp{D_0}\;\delta, \delta') \in 
                \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
  we have that $\interp{D}\;(\delta, \interp{D_0}\;\delta, \delta') = \interp{D'}\;(\delta, \delta')$ 

\item If $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, and either 
  $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$,  
  or $\omega$ is a sort $\kappa$ and $p = \tau$, 
  or $\omega$ is a sort $A$ and $p = e$, 
  then there is a $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$ such
  that for all $(\delta, \interp{D_0}\;\delta, \delta') \in 
                \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
  we have that $\interp{D}\;(\delta, \interp{D_0}\;\delta, \delta') = \interp{D'}\;(\delta, \delta')$ 
\end{enumerate}
\end{lemma}
\begin{proof}
  The proof is at the end of the chapter.
\end{proof}




\section{The Program Logic}

\begin{figure}
\begin{mathpar}
  \inferrule*[right=AxEquiv1]
         {\judgeS{\spec{p}{c}{a:A}{q} \specimp \mspec{p}{\comp{c}}{a:A}{q}}} 
         {\validS{\spec{p}{c}{a:A}{q} \specimp \mspec{p}{\comp{c}}{a:A}{q}}} 
\and 
  \inferrule*[right=AxEquiv2]
    {\judgeS{\mspec{p}{c}{a:A}{q} \specimp \spec{p}{\comp{c}}{a:A}{q}}} 
    {\validS{\mspec{p}{c}{a:A}{q} \specimp \spec{p}{\comp{c}}{a:A}{q}}} 
\and

  \inferrule*[right=AxReturn]
    {\judgeS{\spec{P}{e}{a:A}{P \land a = e}}}
    {\validS{\spec{P}{e}{a:A}{P \land a = e}}}
\and

  \inferrule*[right=AxAssign]
    {\judgeS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}}
    {\validS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}}
\and

  \inferrule*[right=AxAlloc]
    {\judgeS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}}
    {\validS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}}
\and

  \inferrule*[right=AxDeref]
    {\judgeS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto_A e' \land a = e'}}}
    {\validS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto_A e' \land a = e'}}}
\and

  \inferrule*[right=AxBind]
            {\validS{\mspec{p}{e}{x:A}{q}} \\
             \validS[\Delta,x:A]{\spec{q}{c}{a:B}{r}} \\
             \judgeA[\Delta,a:A]{q}{\assert}}
            {\validS{\spec{p}{\letv{x}{e}{c}}{a:B}{r}}}
\and

  \inferrule*[right=AxFix]
            {\validS{(\forall x:\monad{A}.\; \mspec{p}x{a:A}{q(a)} \specimp \mspec{p}{e}{a:A}{q})}}
            {\validS{\mspec{p}{\fix{x:\monad{A}}{e}}{a:A}{q}}}
\end{mathpar}
\caption{Basic Axioms of Specification Logic}
\label{spec-logic-axioms-basic}
\end{figure}

\begin{figure}
\begin{mathpar}
  \inferrule*[right=AxExtract]
             {\validS{\setof{r} \specimp \spec{p}{c}{a:A}{q}} \\
              \mbox{$r$ is a pure formula} \\
              \validP{p \implies r}}
             {\validS{\spec{p}{c}{a:A}{q}}}
\and

  \inferrule*[right=AxEmbed]
             {\validS{\setof{r} \specimp \spec{p \land r}{c}{a:A}{q}}}
             {\validS{\setof{r} \specimp \spec{p}{c}{a:A}{q}}}
\and

  \inferrule*[right=AxUseValid]
             { }
             {\validS{\setof{\validprop{S}} \specimp S}}
\and

  \inferrule*[right=AxForgetEx]
             {\validS[\Delta, u:\omega]{\spec{p}{c}{a:A}{q}} \\ u\not\in\mathrm{FV}(c) \\ u\not\in\mathrm{FV}(q)}
             {\validS{\spec{\exists u:\omega.\;p}{c}{a:A}{q}}}
\and
  \inferrule*[right=AxEquality]
             {\validS{\setof{r} \specimp \spec{p}{c[e/x]}{a:A}{q}} \\
              \validP{r \implies e =_A e'} }
             {\judgeS{\setof{r} \specimp \spec{p}{c[e'/x]}{a:A}{q}}}

\and
  \inferrule*[right=AxConsequence]
             {\validS{\spec{p'}{c}{a:A}{q'}} \\ \validP{p \implies p'} \\ \validP{q' \implies q}}
             {\validS{\spec{p}{c}{a:A}{q}}}
  
\and

  \inferrule*[right=AxDisjunction]
             {\validS{\spec{p}{c}{a:A}{q}} \\
              \validS{\spec{p'}{c}{a:A}{q'}}}
             {\validS{\spec{p \vee p'}{c}{a:A}{q \vee q'}}}
\and

  \inferrule*[right=AxEmbedAssert]
             {\validP{p}}
             {\validS{\setof{p}}}

\and
\inferrule*[right=AxFrame]
          {\judgeS{S} \\ \judgeA{r}{\assert} }
          {\validS{S \specimp S \otimes r}}
\and
\mbox{(+ all of the axioms of intuitionistic logic)}
\end{mathpar}
\caption{Structural Axioms of the Program Logic}
\label{spec-logic-axioms-structural}
\end{figure}

\begin{figure}
\begin{mathpar}
  \inferrule*{\validS{S}}
             {\validP{\validprop{S}}}
\and
  \inferrule*{\judgeP{\Delta}{p}{\assert}}
             {\validP{\validprop{\setof{p}} \implies p}}
\and 
  \inferrule*{\judgeEqA{p}{q}{\omega}}
             {\validP{p =_\omega q}}
\\
  \mbox{(plus axioms of higher-order separation logic)}
\end{mathpar}
\caption{Axioms of Assertion Logic}
\label{assertion-logic-axioms}  
\end{figure}

\begin{figure}
\begin{mathpar}
\inferrule*[]
          {\judgeA{p}{\omega}}
          {\judgeEqA{p}{p}{\omega}}
\and
\inferrule*[]
          {\judgeEqA{p}{q}{\omega}}
          {\judgeEqA{q}{p}{\omega}}
\and
\inferrule*[]
          {\judgeEqA{p}{q}{\omega} \\ \judgeEqA{q}{r}{\omega}}
          {\judgeEqA{p}{r}{\omega}}
\and
\inferrule*[]
          {\judgeA{(\fun{x}{\omega}{p})\;q}{\omega'} \\
           \mbox{$q$ satisfies conditions of substitution theorem}}
          {\judgeEqA{(\fun{x}{\omega}{p})\;q}{[q/x]p}{\omega'}}
\and
\inferrule*[]
          {\judgeEqA[\Delta, x:\omega]{p\;x}{p'\;x}{\omega'}}
          {\judgeEqA{\fun{x}{\omega}{p}}{\fun{x}{\omega}{p'}}{\omega \To \omega'}}
\and 
\inferrule*[]
          {\judgeEqA{p}{p'}{\omega \To \omega'} \\
           \judgeEqA{q}{q'}{\omega}}
          {\judgeEqA{p\;q}{p'\;q'}{\omega'}}
\and
\inferrule*[]
          {x:\omega \in \Delta}
          {\judgeEqA{x}{x}{\omega}}
\and
\inferrule*[]
          {\judgeKeq[\restrictkind{\Delta}]{\tau}{\tau'}{\kappa}}
          {\judgeEqA{\tau}{\tau'}{\kappa}}
\and
\inferrule*[]
          {\judgeEq[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{e'}{A}}
          {\judgeEqA{e}{e'}{A}}
\and 
\inferrule*[]
          {\validP{p \iff q}}
          {\judgeEqA{p}{q}{\assert}}
\and
\inferrule*[]
          {\judgeEqA{p}{q}{\omega} \\ \judgeSortEq{\omega}{\omega'}}
          {\judgeEqA{p}{q}{\omega'}}
\end{mathpar}
\caption{Equality Judgement for Assertions}
\label{assertion-equality}  
\end{figure}


My program logic consists of three judgments:

\begin{enumerate}
\item $\validP{p}$, which asserts that a proposition $p$ is valid.

\item $\validS{S}$, which asserts that a specification $S$ is valid.

\item $\judgeEqA{p}{q}{\omega}$, which asserts that $p$ and $q$ are validly equal.
\end{enumerate}
%

\noindent The semantics of these three judgments is given as follows:
\begin{enumerate}
\item An assertion $\judgeP{\Delta}{p}{\assert}$ is valid, if and only if
for all $\delta \in \interp{\judgeACtx{\Delta}}$,
$\interp{\judgeP{\Delta}{p}{\assert}}\;\delta = \top$.

\item Similarly, a specification $\judgeS{S}$ is valid if and only
if, for all $\delta \in \interp{\judgeACtx{\Delta}}$,
$\interp{\judgeS{S}}\;\delta = \top$.

\item Finally, two assertion terms $\judgeA{p}{\omega}$ and
$\judgeA{q}{\omega}$ are validly equal, if and only if for all $\delta
\in \interp{\judgeACtx{\Delta}}$,
$\interp{\judgeP{\Delta}{p}{\assert}}\;\delta$ is equal to
$\interp{\judgeP{\Delta}{p}{\assert}}\;\delta$
\end{enumerate}

So this says that for any assignment of the free variables, a valid
assertion $p$ must be true, and similarly a valid specification $S$
must be true. Likewise, two syntactic terms $p$ and $q$ are validly
equal if their interpretations are equal under all environments. 

The program logic consists of a set of three mutually-recursive
judgments for deriving valid assertions, specifications, and
equalities. In Figure~\ref{spec-logic-axioms-basic}, I give the
primitive rules for deriving valid specifications of commands, and
Figure~\ref{spec-logic-axioms-structural}, I give a collection of
structural axioms.  In Figure~\ref{assertion-logic-axioms}, I give
some of the rules for deriving valid assertions, and in
Figure~\ref{assertion-equality}, I give rules for deriving equalities
between terms.

In Figure~\ref{spec-logic-axioms-basic}, the \textsc{AxEquiv1} and
\textsc{AxEquiv2} axioms assert the equivalence of Hoare triples over
commands and monadic expressions.  The \textsc{AxReturn} axiom asserts
that when we return a value $e$, we can strengthen the postcondition
with the assertion that the return value is $e$. The \textsc{AxAssign}
axiom asserts that if $e$ points to something in the precondition, the
command $e := e'$ ensures that in the postcondition $e \pointsto
e'$. The \textsc{AxAlloc} axiom asserts that allocating a new
reference $\newref{A}{e}$ will allocate a new pointer which is the
return value $a$, and that $a \pointsto e$ will be star'd onto the
postcondition. The \textsc{AxDeref} rule asserts that if $e \pointsto
e'$ in the precondition, then in the postcondition $e \pointsto e'$
will continue to hold, and that the return value $a = e'$.

The \textsc{AxBind} rule is the sequential composition rule of this
logic.  Because of the monadic nature of our programming language, we
can name and bind intermediate results, but of course there is a side-condition
to ensure that variables do not escape their scopes. 

Finally the \textsc{AxFix} rule is a fixed point induction rule for
this calculus. As in LCF, this rule looks like an induction without a
base case, which makes sense since this program logic is a partial
correctness calculus. This rule generalizes to all the pointed types,
but the syntactic overhead for stating the rules gets higher as the
types get larger.

In Figure~\ref{spec-logic-axioms-structural}, the \textsc{AxExtract}
rule takes a pure consequence of a precondition, and lifts it to
hypothetical assertion of the validity of an assertion. The intuition
for this rule is that to show the Hoare triple, we must assume $p$,
and so this means we might as well assume $r$ generally while proving
this triple. Conversely, The \textsc{AxEmbed} rule says that if we
have assumed the validity of an assertion, it does no harm to assume
it while proving a Hoare triple. The \textsc{AxUseValid} axiom states
that if we know that the assertion $\validprop{S}$ is valid, then we
may as well assume that $S$ is valid, and the \textsc{AxEmbedAssert}
says that valid assertions can be embedded in specifications. 

The \textsc{AxEquality} rule lets us rewrite programs using equational
reasoning, and the \textsc{AxForgetEx} axiom lets us drop existentials
from preconditions. The \textsc{AxConsequence} rule is just the rule
of consequence, and the \textsc{AxDisjunction} rule is just the rule
of disjunction, both familiar from Hoare logic. However, it is worth
pointing out that my language does \emph{not} validate the rule of
conjunction, as a consequence of having a language with a continuation
semantics.

Finally, the \textsc{AxFrame} schema gives the frame rule. My logic
supports the higher-order frame rule, and so we need to define a
syntactic frame operator $\Frame{S}{r}$ to act on arbitrary
specifications.
\begin{displaymath}
  \begin{array}{lcl}
    \Frame{\spec{p}{c}{a:A}{q}}{r}    & = & \spec{p * r}{c}{a:A}{q * r} \\
    \Frame{\mspec{p}{c}{a:A}{q}}{r}   & = & \mspec{p * r}{c}{a:A}{q * r} \\
    \Frame{\setof{p}}{r}              & = & \setof{p} \\
    \Frame{(S_1 \specand S_2)}{r}      & = & \Frame{S_1}{r} \specand \Frame{S_2}{r} \\
    \Frame{(S_1 \specor S_2)}{r}       & = & \Frame{S_1}{r} \specor \Frame{S_2}{r} \\
    \Frame{(S_1 \specimp S_2)}{r}      & = & \Frame{S_1}{r} \specimp \Frame{S_2}{r} \\
    \Frame{(\forall x:\omega.\; S)}{r} & = & \forall x:\omega.\; (\Frame{S}{r}) \\
    \Frame{(\exists x:\omega.\; S)}{r} & = & \exists x:\omega.\; (\Frame{S}{r}) \\
  \end{array}
\end{displaymath}
This is just the familiar action of the frame rule on Hoare triples. It
does nothing to the validity assertion $\setof{p}$, and distributes over all 
the other connectives. 

Framing is well-defined, and corresponds precisely to the semantic frame rule
we considered earlier in the chapter. 

\begin{prop}{(Syntactic Well-Formedness of Frame Operator)}
If $\judgeS{S}$ and $\judgeA{p}{\assert}$, then
we define $\judgeS{\Frame{S}{p}}$.  
\end{prop}
\begin{proof}
  By structural induction on specifications.
\end{proof}

More interesting than the syntactic well-formedness of the frame
operator is its semantic well-formedness. 

\begin{lemma}{(Syntactic Framing is Semantic Framing)}
If $\judgeS{S}$ and $\judgeA{r}{\assert}$, then for all $\delta \in \interp{\Delta}$, 
$\interp{\judgeS{\Frame{S}{r}}}\;\delta = 
\Frame{\interp{\judgeS{S}}\;\delta}{\interp{\judgeA{r}{\assert}}\;\delta}$ \\
\end{lemma}
\begin{proof}
  The proof is at the end of the chapter.
\end{proof}\\

The distinctive axioms of the assertion logic are far fewer. In
Figure~\ref{assertion-logic-axioms}, I give only three rules tailored
to this particular program logic. One for embedding specifications in
assertions, another for extracting assertions out of specifications,
and the last says that equality derivations entail equality
assertions. All the other rules are just the axioms of higher-order
separation logic.

Likewise, the valid equality judgment in
Figure~\ref{assertion-equality} is fairly minimal: it contains the
$\beta$ and $\eta$ rules for functions, as well as inheriting the
equality judgments for types and terms.

With all the buildup so far, it is easy to prove the following soundness
theorem:

\begin{theorem}{(Soundness of the Program Logic)}
  \begin{enumerate}
  \item If $\validP{p}$, then $\judgeA{p}{\assert}$ is valid.

  \item If $\validS{S}$, the $\judgeS{S}$ is valid.

  \item If $\judgeEqA{p}{q}{\omega}$, then $p$ and $q$ are validly equal.
  \end{enumerate}
\end{theorem}

\begin{proof}
  The proof of these three theorems follows from a mutual structural
  induction.  The soundness of each atomic rule for the two validity
  judgements is proven in the next section. The soundness of the rules
  for equality are a consequence of the equality rules we have already
  proven, and the cartesian closure of Set.  
\end{proof}

\section{Related Work}

There are two immediate predecessors to the proof system in this
dissertation. 

First, there is the work of Reynolds on specification logic for
Algol~\cite{spec-logic}. Idealized Algol~\cite{idealized-algol}
combines a call-by-name functional language, together with a type of
imperative computations whose operations correspond to the
while-language (i.e., it does not have higher-order store). This
stratification ensures that Algol features a powerful equational
theory which validates both the $\beta$- and $\eta$-rules of the
lambda-calculus. 

Specification logic extends Hoare logic~\cite{hoare-logic} to deal
with these new features, by viewing Hoare triples as the atomic
propositions of a first-order logic of specifications. Then, the user
of the logic can specify the behavior of a higher-order function using
an implications over triples, using the hypothesis of an implication
to specify the behavior of arguments of command type. In short,
specification logic can be viewed as a synthesis of LCF~\cite{lcf} with
  Hoare logic.

One of the motivations for the language design in my dissertation was
to see if the analogy between the computation type in Algol and the
monadic type discipline could be extended to a full higher-order
programming language, with features like higher-order store. This has
worked fantastically well. The semantics of the logic of this
dissertation is (suprisingly) \emph{simpler} than original
specification logic, even though the programming language itself is a
much more complex one than idealized Algol.

In particular, one of the main sources of complexity in usages of
specification logic have simply vanished from this logic. Algol has
assignable variables (like C or Java, though of course this reverses
the chronology), and so specification logic had to account for their
update with assertions about so-called ``good variable''
conditions. Since ML-like languages do not have assignable variables,
this means that all aliasing is confined to the heap. As a result, the
entire machinery of good variables is simply absent from my system.
So all aliasing and interference is confined to the heap, and
separation logic works quite well for specifying and reasoning about
this interference.

The other line of work I make use is on algebraic models of separation
logic. I give a very concrete model of separation logic in this
chapter, and am able to interpret higher-order quantification due to
the fact that the lattice of propositions is complete. This is
probably best understood as an instantiation of Biering~\emph{et
  al.}'s hyperdoctrine model of higher-order separation
logic. Likewise, my semantic domain for specifications makes use of
the techniques introduced by Birkedal and Yang~\cite{birkedal-yang} to
model higher-order frame rules.

Happily, though, most of this machinery stays ``under the hood'' to
ensure that the logic looks simple to the user.  As an example of this
phenomenon, we use TT-closure~\cite{tt-closure} to force the
admissibility of Hoare triples. This lets us give a simple rule for
fixed-point induction, without having to specify conditions on
admissible predicates (which is especially problematic in a setting
with predicate variables).

\subsection{Other Program Logics}

\subsubsection{Parkinson's Separation Logic for Java}

Parkinson developed a version of separation logic for Java in his
doctoral dissertation~\cite{parkinson-thesis}. His logic does not
feature a sophisticated specification logic; instead, he tries to use
the traditional notion of behavioral
subtyping~\cite{behavioral-subtyping} in order to deviate less
dramatically from the standard syntax of Hoare logic. However, strict
behavioral subtyping is very restrictive --- it essentially forces an
object-oriented program to ``look like'' a first-order program --- and
many object-oriented idioms (i.e., which correspond to higher-order
programming patterns) cannot be specified or proven correct in this 
framework 

Parkinson recovers flexibility through the use of a very clever
non-standard model of Hoare logic. The idea, described in Parkinson
and Bierman~\cite{parkinson-bierman-05}, is to admit a form of
second-order existential quantification, with a very unusual semantic
interpretation. Their ``abstract predicate families'' are predicates
defined on objects, whose definition varies according to the
\emph{concrete} class of the predicate. That is, their abstract
predicates ``dynamically dispatch'' to different definitions,
depending on the class of the object indexing the predicate. As a
result, they can re-use the proof rules of behavioral subtyping, even
though different classes can be given entirely different invariants.

While this is clearly a very natural idea for the specification of
object-oriented programs, I think that a richer language of
specifications and a more conventional interpretation of existentials
and universals is likely to be desirable in practice. This is because
modern OO languages like C\# and Scala also contain support for
first-class functions, which means that program logics should directly
support reasoning about higher-order programs.

\subsubsection{Hoare Type Theory}

Nanevski, Morisett and Birkedal have developed Hoare Type
Theory~\cite{htt, nanevski08}, which is an elegant and sophisticated
dependently-typed functional language that, like our system, uses a
monadic discipline to control effects.  Unlike our work, HTT takes
advantage of type dependency to directly integrate specifications into
the types of computation terms.

Nanevski, Ahmad, Morisett and Birkedal~\cite{abstract-htt} have
proposed using the existential quantification of their type theory to
hide data representations, giving examples such as a malloc/free style
memory allocator. Nanevski and Vafeidis~\cite{nanevski-victor-10} give
a proof of a modern congruence closure algorithm, illustrating that
their system can verify some of the most complex imperative algorithms
known.

In general, I think that this line of work represents the future of
the design of high-level imperative programming languages, but the
particular features of HTT's design have some shortcomings which make
a direct comparison with my work somewhat challenging.

In particular, HTT uses an indexed family of monads to represent
computations.  That is, a computation has a type $e :
\spec{P}{-}{a:A}{Q(a)}$, where $P$ and $Q$ are predicates on the
heap. This means that higher-order imperative programs may need to 
refer to terms of computation type in their pre- and post-conditions.
In the original formulation of HTT, which is predicative, this causes
size issues to arise which make even writing  

This difficulty has been overcome by Petersen~\emph{et al.}, who give
an impredicative model of Hoare Type Theory. However, Svendsen
[personal communication] says that in an impredicative setting, the
weaker elimination rules for existentials mean that proofs involving
existentially quantified code become difficult to do.

These issues simply do not arise in my system, since specifications
are kept strictly separate from types. This suggests that an
interesting future direction would be to study a version of Hoare Type
Theory in which there is an ordinary monadic type of computations,
together with a predicates on terms of monadic type which equip it
with pre- and post-conditions. 

\subsubsection{Regional Logic and Ownership}

In addition to systems based on separation, there is also a line of
research based on the concept of object invariants and ownership.  The
Java modeling language (JML)~\cite{jml} and the Boogie
methodology~\cite{boogie} are two of the most prominent systems based
on this research stream. In Boogie, each object tracks its owner
object with a ghost field, and the ownership discipline enforces that
the heap have a tree structure. This allows the calculation of frame
properties without explosions due to aliasing, even though the
specification language remains ordinary first-order logic.

\section{Correctness Proofs}

\subsection{Substitution Theorems}

\subsubsection{Syntactic Substitution Theorems}

\begin{lemma*}{(Syntactic Substitution for Sorts)}
If $\judgeA{p}{\omega}$, then we have that:

\begin{enumerate}
\item If $\judgeACtx{\Delta, u:\omega, \Delta'}$, and $u$ does not occur in any subterm of sort type in $\Delta'$, or $\omega = \kappa$ and $p = \tau$,  then  
         $\judgeACtx{\Delta, [p/u]\Delta'}$. 
\item If $\judgeSort[\Delta, u:\omega, \Delta']{\omega'}$, and $u$ does not occur in any subterm of sort type in $\Delta'$ and $\omega'$, or $\omega = \kappa$ and $p = \tau$, then
         $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}$. 
\end{enumerate}
\end{lemma*}


\begin{proof}
This proof follows by mutual structural induction on each derivation. 
Assume $D_0 :: \judgeA{p}{\omega}$
\begin{enumerate}
\item We want to show if $D  ::\; \judgeACtx{\Delta, u:\omega, \Delta'}$, then  
                         $D' ::\; \judgeACtx{\Delta, [p/u]\Delta'}$. 
  \begin{itemize}
  \item Case \textsc{CtxNil}: 
    \begin{tabbedproof}
      \oo Assume $D ::\; \judgeACtx{\cdot}$ \\
      \oo Assume $u$ does not occur in any subterm of sort type, or $\omega = \kappa$ and $p = \tau$ \\
      \ooo Therefore $\cdot = \Delta, u:\omega, \Delta'$ \\
      \ooo This is a contradiction, hence this case is vacuously true. 
    \end{tabbedproof}

  \item Case \textsc{CtxCons}: 
    \begin{tabbedproof}
      \oo Assume $D ::\; \judgeACtx{\Delta'', u'':\omega''}$ \\
      \oo Assume $u$ does not occur in any subterm of sort type in $\Delta''$, or $\omega = \kappa$ and $p = \tau$ \\
      \ooo Therefore $\Delta, u:\omega, \Delta' = \Delta'', u'':\omega''$ \\
      \ooo By inversion on $D$, $D_1 :: \judgeACtx{\Delta''}$ \\
      \ooo By inversion on $D$, $D_2 :: \judgeSort{\omega''}$ \\
      \ooo We want to show $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo By cases on $\Delta'$: \\
      \oooo If $\Delta' = \cdot$: \\
      \ooooo Then $\Delta'' = \Delta$, and $u = u''$, and $\omega = \omega''$ \\
      \ooooo Then $[p/u]\Delta' = [p/u]\cdot = \cdot$ \\
      \ooooo So $D_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \oooo If $\Delta' = \Delta''', u''':\omega'''$:\\
      \ooooo So either $u$ does not occur in any subterm of sort type in $\Delta'''$ and $\omega'''$, \\
      \ooooox or $\omega = \kappa$ and $p = \tau$ \\ 
      \ooooo Then $\Delta'' = \Delta, u:\omega, \Delta'''$ and $u''' = u''$ and $\omega'' = \omega'''$ \\ 
      \ooooo By equality, $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'''}$ \\
      \ooooo By induction on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'''}$ \\ 
      \ooooo By mutual induction on $D_2$, we have 
                 $D'_2 :: \judgeSort[{\Delta, [p/u]\Delta'''}]{[p/u]\omega''}$ \\ 
      \ooooo By rule $\textsc{CtxCons}$ on $D'_1$, $D'_2$, we have 
                 $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \end{tabbedproof}
  \end{itemize}

\item We want to show that if 
         $\judgeSort[\Delta, u:\omega, \Delta']{\omega'}$,  
         and $u$ does not occur in any subterm of sort type in $\Delta'$ and $\omega'$, or 
         $\omega = \kappa$ and $p = \tau$, then
         $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}$. 

  \begin{itemize}
  \item Case \textsc{SortKind}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{\kappa}$ \\
      \oo Assume $u$ does not occur in any subterm of sort type in $\Delta'$ and $\omega'$, \\
      \ox or $\omega = \kappa$ and $p = \tau$\\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo By rule \textsc{SortKind} on $D'_1$, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{\kappa}$ \\
      \ooo Since $\kappa$ has no free variables, $[p/u]\kappa = \kappa$ \\
      \ooo By equality, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}$ \\
    \end{tabbedproof}

  \item Case \textsc{SortProp}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{\assert}$ \\
      \oo Assume $u$ does not occur in any subterm of sort type in $\Delta'$ and $\omega'$, \\
      \ox or $\omega = \kappa$ and $p = \tau$\\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo Since $\assert$ has no free variables, $[p/u]\assert = \assert$ \\
      \ooo By rule \textsc{SortProp} on $D'_1$, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{\assert}$ \\
      \ooo By equality, we have 
             $\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\assert}$ \\
    \end{tabbedproof}

  \item Case \textsc{SortImp}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{\omega_1 \To \omega_2}$ \\
      \oo Assume $u$ does not occur in any subterm of sort type in $\Delta'$ and $\omega'$, \\
      \ox or $\omega = \kappa$ and $p = \tau$\\
      \ooo By inversion on $D$, we have 
             $D_1 :: \judgeSort[\Delta, u:\omega, \Delta']{\omega_1}$ \\
      \ooo By inversion on $D$, we have 
             $D_2 :: \judgeSort[\Delta, u:\omega, \Delta']{\omega_2}$ \\
      \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_1}$ \\
      \ooo By induction on $D_2$, we have 
             $D'_2 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_2}$ \\
      \ooo By rule \textsc{SortImp}, we have 
            $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_1 \To [p/u]\omega_2}$ \\
      \ooo By definition of substitution, 
            $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u](\omega_1 \To \omega_2)}$ \\
    \end{tabbedproof}

  \item Case \textsc{SortType}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeSort[\Delta, u:\omega, \Delta']{A}$ \\
      \oo Assume $u$ does not occur in any subterm of sort type in $\Delta'$ and $\omega'$, \\
      \ox or $\omega = \kappa$ and $p = \tau$\\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By mutual induction on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo By inversion on $D$, we have $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]
                                                        {A}{\bigstar}$ \\
      \ooo Case on $\omega$ and the disjunction on line 2: \\
      \oooo If $\omega$ is a kind and $\omega = \kappa$ and $p = \tau$: \\
      \ooooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = 
                     \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
      \ooooo Then $D_0 :: \judgeA[\Delta]{\tau}{\kappa}$  where $p = \tau$ \\
      \ooooo By inversion on $D_0$, we have $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}$ \\
      \ooooo By substitution for types, we have 
               $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                {[\tau/u]A}{\bigstar}$ \\
      \ooooo Since no kind in $\restrictkind{\Delta'}$ has any free variables, 
             $\restrictkind{\Delta'} = \restrictkind{[\tau/u]\Delta'}$ \\
      \ooooo Therefore $D'_2 :: \judgeWK[{\restrictkind{\Delta}, \restrictkind{[\tau/u]\Delta'}}]
                                {[\tau/u]A}{\bigstar}$ \\
      \ooooo By rule \textsc{SortType} on $D'_1$ and $D'_2$, we have 
               $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]A}$ \\
      \oooo If $\omega$ is a kind $\kappa$ and $u$ does not occur in any subterm of sort type: \\
      \ooooo Then $u \not\in \mathrm{FV}(A)$ \\
      \ooooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = 
                     \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
      \ooooo Since $u$ does not occur in $A$, we have $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                                        {A}{\bigstar}$ \\
      \ooooo Since $u$ does not occur in $A$ or $\Delta'$, $A = [p/u]A$ and $\Delta' = [p/u]\Delta'$ \\
      \ooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[[p/u]\Delta'}]
                                                        {[p/u]A}{\bigstar}$ \\
      \ooooo By rule \textsc{SortType}, we have $\judgeSort[\Delta, [p/u]\Delta']{[p/u]A}$ \\
      \oooo If $\omega \not= \kappa$: \\
      \ooooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = 
                   \restrictkind{\Delta, \Delta'}$ \\
      \ooooo Since no kind in $\restrictkind{\Delta'}$ has any free variables, 
             $\restrictkind{\Delta'} = \restrictkind{[p/u]\Delta'}$ \\
      \ooooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = 
                   \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \ooooo Therefore $D'_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]
                                       {A}{\bigstar}$ \\
      \ooooo Therefore $u \not\in FV(A)$ \\
      \ooooo Therefore $A = [p/u]A$ \\
      \ooooo Therefore $D'_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]
                                      {[p/u]A}{\bigstar}$ \\
      \ooooo By rule \textsc{SortType} on $D'_1, D'_2$, we have 
              $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]A}$ 
      
    \end{tabbedproof}
  \end{itemize}
\end{enumerate}
\end{proof}

\begin{lemma*}{(Syntactic Substitution for Sort Equality Judgement)}
If we have that $\judgeA{p}{\omega}$ and $\judgeACtx{\Delta, u:\omega, \Delta'}$, and we have that 
$\judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega_1}{\omega_2}$, 
then $\judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}{[p/u]\omega''}$. 
\end{lemma*}

\begin{proof}
Assume $D_0 :: \judgeA{p}{\omega}$, and $D_C :: \judgeACtx{\Delta, u:\omega, \Delta'}$.  
Now we will proceed by structural induction on the equality judgement. 
\begin{itemize}
\item Case \textsc{SortEqProp}:
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\assert}{\assert}$\\
    \ooo By context substitution on $D_C$, we have $D'_C :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \ooo By rule \textsc{SortEqProp}, we have $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{\assert}{\assert}$ \\
    \ooo By definition of substitution, $\assert = [p/u]\assert$ \\
    \ooo Therefore $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\assert}{[p/u]\assert}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqKind}: 
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\kappa}{\kappa}$\\
    \ooo By context substitution on $D_C$, we have $D'_C :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \ooo By rule \textsc{SortEqKind}, we have $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{\kappa}{\kappa}$ \\
    \ooo By definition of substitution, $\kappa = [p/u]\kappa$ \\
    \ooo Therefore $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}{[p/u]\kappa}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqImp}: 
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'_1 \To \omega''_1}{\omega'_2 \To \omega''_2}$\\
    \ooo By context substitution on $D_C$, we have $D'_C :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
    \ooo By inversion on $D$, we get \\
    \oooo $E_1 :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'_1}{\omega''_1}$\\
    \oooo $E_2 :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'_2}{\omega''_2}$\\
    \ooo By induction on $E_1$, we have $E'_1 :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'_1}{[p/u]\omega''_1}$\\
    \ooo By induction on $E_2$, we have $E'_2 :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'_2}{[p/u]\omega''_2}$\\
    \ooo By rule \textsc{SortEqImp} with $E'_1, E'_2$, we have  \\
    \ooox $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'_1 \To [p/u]\omega''_1}{[p/u]\omega'_2 \To [p/u]\omega''_2}$\\
    \ooo By definition of substitution, $[p/u]\omega'_1 \To [p/u]\omega''_1 = [p/u](\omega'_1 \To \omega''_1)$\\
    \ooo By definition of substitution, $[p/u]\omega'_2 \To [p/u]\omega''_2 = [p/u](\omega'_2 \To \omega''_2)$\\
    \ooo Therefore 
           $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u](\omega'_1 \To \omega''_1)}{[p/u](\omega'_2 \To \omega''_2)}$\\
  \end{tabbedproof}

\item Case \textsc{SortEqType}:
  \begin{tabbedproof}
    \oo Assume $D :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{A}{B}$ \\
    \ooo By inversion on $D$, we have $D_1 :: \judgeKeq[{\restrictkind{\Delta, u:\omega, \Delta'}}]{A}{B}{\bigstar}$ \\
    \ooo Case analyze $\omega$: \\
    \oooo When $\omega = \kappa$: \\
    \ooooo We have $\judgeA{\Delta}{\tau}{\kappa}$, where $p = \tau$ \\
    \ooooo By definition, 
           $\restrictkind{\Delta, u:\kappa, \Delta'} = \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
    \ooooo Therefore $D_1 :: \judgeKeq[{\restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}}]{A}{B}{\bigstar}$ \\
    \ooooo By equality rule for types, we have 
           $D'_1 :: \judgeKeq[{\restrictkind{\Delta}, \restrictkind{\Delta'}}]{[\tau/u]A}{[\tau/u]B}{\bigstar}$ \\
    \ooooo Since kinds have no free variables, $\restrictkind{\Delta'} = \restrictkind{[\tau/u]\Delta'}$ \\
    \ooooo Therefore $D'_1 :: \judgeKeq[{\restrictkind{\Delta}, \restrictkind{[\tau/u]\Delta'}}]{[\tau/u]A}{[\tau/u]B}{\bigstar}$ \\
    \ooooo By rule \textsc{SortEqType}, we have 
            $D' :: \judgeSortEq[{\Delta, [\tau/u]\Delta'}]{[\tau/u]A}{[\tau/u]B}$ \\
    \ooooo Therefore $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]A}{[p/u]B}$ \\
    \oooo Otherwise when $\omega \not= \kappa$: \\
    \ooooo By definition, 
           $\restrictkind{\Delta, u:\kappa, \Delta'} = \restrictkind{\Delta}, \restrictkind{\Delta'}$ \\
    \ooooo Since kinds have no free variables, $\restrictkind{\Delta'} = \restrictkind{[p/u]\Delta'}$ \\
    \ooooo Therefore $\restrictkind{\Delta, u:\kappa, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
    \ooooo Since $u \not\in FV(A)$, we have $[p/u]A = A$ \\
    \ooooo Since $u \not\in FV(B)$, we have $[p/u]A = B$ \\
    \ooooo Therefore $D_1 :: \judgeKeq[{\restrictkind{\Delta, [p/u]\Delta'}}]{[p/u]A}{[p/u]B}{\bigstar}$ \\
    \ooooo By rule \textsc{SortEqType}, we have $D' :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]A}{[p/u]B}$\\
  \end{tabbedproof}
\end{itemize}
\end{proof}



\begin{lemma*}{(Syntactic Substitution for Terms and Specifications)}
Suppose that $D_0 :: \judgeA{p}{\omega}$. Then
\begin{enumerate}
\item If $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, 
         and either $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$,
                or $\omega$ is a sort $\kappa$ and $p = \tau$,
                or $\omega$ is a sort $A$ and $p = e$, 
         then 
         $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$. 
\item If $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, 
         and either $u$ does not occur in a type or program expression in $\Delta'$, $q$, or $\omega'$,
                or $\omega$ is a sort $\kappa$ and $p = \tau$,
                or $\omega$ is a sort $A$ and $p = e$, 
         then 
         $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$. 
\end{enumerate}
\end{lemma*}
\begin{proof}
  Before we begin this proof, we make a minor observation. Namely,
  suppose $u$ does not occur in a type or program expression in
  $\Delta'$, $q$, or $\omega'$, or $\omega$ is a sort $\kappa$ and $p
  = \tau$, or $\omega$ is a sort $A$ and $p = e$. Then, it follows
  that either $u$ does not appear in a sort in $\Delta'$ or $\omega'$,
  or $\omega = \kappa$ and $p = \tau$.  This is because if $u$ is a
  variable of a sort $C$, then it won't appear in any sorts (which can
  only depend on type variables of some sort $\kappa$). This means
  that the three-way hypothesis in this lemma is stronger than the
  substitution theorem for contexts and sorts needs. 

  Now, assume $D_0 :: \judgeA{p}{\omega}$.
  \begin{enumerate}
  \item We want to show if $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, then 
         $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$.
    \begin{itemize}
    \item Case \textsc{TermType}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{\tau}{\kappa}$, 
            where $q = \tau$ and $\omega' = \kappa$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \oox and $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]
                                 {\tau}{\kappa}$ \\
        \ooo By substitution on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo Case analysis on $\omega$:\\
        \oooo If $\omega = \kappa'$: \\
        \ooooo Then we have either $D_0 :: \judgeA[\Delta]{\tau'}{\kappa'}$, with $p = \tau'$, or\\
        \oooox $u$ does not occur free in $\tau$ \\
        \ooooo If $D_0 :: \judgeA[\Delta]{\tau'}{\kappa'}$, with $p = \tau'$: \\
        \oooooo By inversion on $D_0$, we have 
                $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau'}{\kappa'}$ \\
        \oooooo Then $\restrictkind{\Delta, u:\kappa', \Delta'} = 
                       \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
        \oooooo Thus $D_2 :: \judgeWK[\restrictkind{\Delta}, u:\kappa', \restrictkind{\Delta'}]
                                   {\tau}{\kappa}$ \\
        \oooooo By type substitution, 
                 $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                  {[\tau'/u]\tau}{\kappa}$ \\
        \oooooo Since $\restrictkind{\Delta'}$ has no free variables in kinds, 
                 $\restrictkind{\Delta'} = \restrictkind{[\tau'/u]\Delta'}$ \\
        \oooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[\tau'/u]\Delta'}]
                                  {[\tau'/u]\tau}{\kappa}$ \\
        \oooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]
                                  {[p/u]\tau}{\kappa}$ \\
        \oooooo By rule \textsc{TermType} on $D'_1, D'_2$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{\kappa}$  \\
        \oooooo Since $[p/u]\kappa = \kappa$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{[p/u]\kappa}$ \\
        \ooooo If $u$ does not occur free in $\tau$: \\
        \oooooo Then $\restrictkind{\Delta, u:\kappa', \Delta'} = 
                       \restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}$ \\
        \oooooo Thus $D_2 :: \judgeWK[\restrictkind{\Delta}, u:\kappa', \restrictkind{\Delta'}]
                                   {\tau}{\kappa}$ \\
        \oooooo Since $u$ does not occur in $\tau$, and kinds have no free variables, \\
        \ooooox we have $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]{\tau}{\kappa}$ \\
        \oooooo Since $\restrictkind{\Delta'}$ has no free variables in kinds, 
                 $\restrictkind{\Delta'} = \restrictkind{[\tau'/u]\Delta'}$ \\
        \oooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[\tau'/u]\Delta'}]
                                  {\tau}{\kappa}$ \\
        \oooooo Since $u$ does not occur in $\tau$, $\tau = [\tau'/u]\tau$ \\
        \oooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[\tau'/u]\Delta'}]
                                  {[\tau'/u]\tau}{\kappa}$ \\
        \oooooo Hence $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]
                                  {[p/u]\tau}{\kappa}$ \\
        \oooooo By rule \textsc{TermType} on $D'_1, D'_2$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{\kappa}$  \\
        \oooooo Since $[p/u]\kappa = \kappa$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{[p/u]\kappa}$ \\
        \oooo If $\omega \not=\kappa'$: \\
        \ooooo Then $\restrictkind{\Delta, u:\kappa', \Delta'} = 
                       \restrictkind{\Delta}, \restrictkind{\Delta'}$ \\
        \ooooo Then $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                   {\tau}{\kappa}$ \\
        \ooooo So $u \not \in FV(\tau)$ \\
        \ooooo Hence $[p/u]\tau = \tau$ \\
        \ooooo So $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                   {[p/u]\tau}{\kappa}$ \\
        \ooooo Since $\restrictkind{\Delta'}$ has no free variables in kinds, 
                 $\restrictkind{\Delta'} = \restrictkind{[\tau'/u]\Delta'}$ \\
        \ooooo So $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]
                                   {[p/u]\tau}{\kappa}$ \\
        \ooooo Since $[p/u]\kappa = \kappa$,
               $D_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]
                                   {[p/u]\tau}{[p/u]\kappa}$ \\
        \ooooo By rule \textsc{TermType} on $D'_1, D_2$, we have 
                  $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{[p/u]\kappa}$  \\
      \end{tabbedproof}

    \item Case \textsc{TermExpr}:
      \begin{tabbedproof}
      \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{e}{A}$, 
           where $q = e$ and $\omega' = A$ \\
      \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
      \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
      \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
      \ooo By inversion on $D$, we have 
           $D_2 :: \judgeE[\restrictkind{\Delta, u:\omega, \Delta'}]
                          {\restricttype{\Delta, u:\omega, \Delta'}}{e}{A}$ \\
      \ooo By substitution on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
      \ooo Case analyze $\omega$: \\
      \oooo If $\omega = \kappa$: \\
      \ooooo So either $u$ does not occur in a type or program expression in $e$, \\
      \oooox or $p = \tau$ \\
      \ooooo If $p = \tau:$ \\
      \oooooo We have $D_0 :: \judgeA{\tau}{\kappa}$ where $p = \tau$ \\
      \oooooo By inversion on $D_0$, 
             we have $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}$ \\
      \oooooo We have $D_2 :: \judgeE[\restrictkind{\Delta, u:\kappa, \Delta'}]
                                    {\restricttype{\Delta, u:\kappa, \Delta'}}
                                    {e}{A}$ \\ 
      \oooooo Note $\restricttype{\Delta, u:\kappa, \Delta'} = \restricttype{\Delta, \Delta'}$ \\
      \oooooo Therefore $D_2 :: \judgeE[\restrictkind{\Delta, u:\kappa, \Delta'}]
                                    {\restricttype{\Delta, \Delta'}}
                                    {e}{A}$ \\ 
      \oooooo By type substitution, 
                 $D'_2 :: \judgeE[\restrictkind{\Delta, \Delta'}]
                                 {\restricttype{[\tau/u]\Delta, [\tau/u]\Delta'}}
                                 {[\tau/u]e}{[\tau/u]A}$ \\
      \oooooo Since no kind has free variables,  we have
                $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [\tau/u]\Delta'}$ \\
      \oooooo Since $u \not\in FV(\Delta)$, we have
                $\restricttype{[\tau/u]\Delta, [\tau/u]\Delta'} = 
                 \restricttype{\Delta, [\tau/u]\Delta'}$ \\
      \oooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [\tau/u]\Delta'}]
                                 {\restricttype{\Delta, [\tau/u]\Delta'}}
                                 {[\tau/u]e}{[\tau/u]A}$ \\
      \oooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                                 {\restricttype{\Delta, [p/u]\Delta'}}
                                 {[p/u]e}{[p/u]A}$ \\
      \ooooo If $u$ does not occur in $e$: \\
      \oooooo We have $D_2 :: \judgeE[\restrictkind{\Delta, u:\kappa, \Delta'}]
                                    {\restricttype{\Delta, u:\kappa, \Delta'}}
                                    {e}{A}$ \\
      \oooooo Hence we have $D_2 :: \judgeE[\restrictkind{\Delta}, u:\kappa, \restrictkind{\Delta'}]
                                           {\restricttype{\Delta}, \restricttype{Delta'}}
                                           {e}{A}$ \\
      \oooooo Since $u$ does not occur, we can find \\
      \ooooox $D'_2 :: \judgeE[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                           {\restricttype{\Delta}, \Delta''}
                                           {e}{A}$ \\
      \ooooox where $\Delta'' \subseteq \restricttype{\Delta'}$ and $u$ does not occur in $\Delta''$\\
      \oooooo Since no kind has free type variables, $\restrictkind{\Delta'} = \restrictkind{[p/u]\Delta'}$ \\
      \oooooo Since $u$ does not occur in $\Delta''$, we have $\Delta'' = \restrictkind{[p/u]\Delta''}$ \\
      \oooooo Since $u$ does not occur in $A$ or $e$, $A = [p/u]A$ and $e = [p/u]e$ \\
      \oooooo Hence by weakening,  \\ 
      \ooooox $D''_2 :: \judgeE[\restrictkind{\Delta}, \restrictkind{\Delta'}]
                                                    {\restricttype{\Delta}, \restricttype{[p/u]\Delta'}}
                                                    {[p/u]e}{[p/u]A}$ \\
       
      \oooo If $\omega = B$: \\
      \ooooo So either $u$ does not occur in $e$ or $A$, or $p = e'$\\
      \ooooo Suppose $p = e'$:\\
      \oooooo We have $D_0 :: \judgeA[\Delta]{e'}{A}$, where $p = e'$ \\
      \oooooo By inversion on $D_0$, we have 
               $D'_0 :: \judgeE[\restrictkind{\Delta}]
                               {\restricttype{\Delta}}{e}{A}$ \\
      \oooooo By weakening, we have 
               $D''_0 :: \judgeE[\restrictkind{\Delta, u:B, \Delta'}]
                               {\restricttype{\Delta}}{e}{A}$ \\
      \oooooo We also have
              $D_2 :: \judgeE[\restrictkind{\Delta, u:B, \Delta'}]
                             {\restrictkind{\Delta, u:B, \Delta'}}
                             {e}{A}$ \\
      \oooooo By substitution on $D''_0$ into $D'_2$, we have \\
      \oooooo \;\;
              $D'_2 :: \judgeE[\restrictkind{\Delta, u:B, \Delta'}]
                              {\restricttype{\Delta}, \restricttype{\Delta}}
                              {[e'/u]e}{A}$ \\
      \oooooo So $\restrictkind{\Delta, u:B, \Delta'} = \restrictkind{\Delta, \Delta'}$ \\
      \oooooo Since $u:B$ not free in kinds, 
             $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [e'/u]\Delta'}$ \\
      \oooooo Since $u:B$ not free in types, 
             $\restricttype{\Delta, \Delta'} = \restricttype{\Delta, [e'/u]\Delta'}$ \\
      \oooooo Since $u:B$ not free in types, 
             $[e'/u]A = A$ \\
      \oooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [e'/u]\Delta'}]
                               {\restricttype{\Delta, [e'/u]\Delta}}
                               {[e'/u]e}{[e'/u]A}$ \\
      \oooooo Therefore 
               $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                               {\restricttype{\Delta, [p/u]\Delta}}
                               {[p/u]e}{[p/u]A}$ \\
      \ooooo Suppose $u$ does not occur in $e$ or $A$: \\
      \oooooo We have $D_2 :: \judgeE[\restrictkind{\Delta, u:B, \Delta'}]
                                     {\restricttype{\Delta, u:B, \Delta'}}
                                     {e}{A}$ \\
      \oooooo We know $\restrictkind{\Delta, u:B, \Delta'} = \restrictkind{\Delta}, \restrictkind{\Delta'}$\\
      \oooooo Since kinds have no free vars, $\restrictkind{\Delta'} = \restrictkind{[p/u]\Delta'}$ \\
      \oooooo We know $\restricttype{\Delta, u:B, \Delta'} = \restricttype{\Delta}, u:B, \restricttype{\Delta'}$\\
      \oooooo Since types are non-dependent, $\restricttype{\Delta'} = \restricttype{[p/u]\Delta'}$ \\
      \oooooo Since $u$ does not occur in $e$, we know $e = [p/u]e$ \\
      \oooooo Since $u$ does not occur in $A$, we know $A = [p/u]A$ \\
      \oooooo Hence $D_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                                   {\restricttype{\Delta, u:B, [p/u]\Delta'}}
                                   {[p/u]e}{[p/u]A}$ \\
      \oooooo Since $u$ does not occur, we can strengthen $D_2$ to derive \\
      \ooooox $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                              {\restricttype{\Delta, [p/u]\Delta'}}
                              {[p/u]e}{[p/u]A}$ \\
      \oooo Otherwise $\omega \not\in \setof{A, \kappa}$:  \\
      \ooooo Since $\omega$ is not a kind, 
               $\restrictkind{\Delta, u:\omega, \Delta'} = \restrictkind{\Delta, \Delta'}$\\
      \ooooo Since $\omega$ is not a type, 
               $\restricttype{\Delta, u:\omega, \Delta'} = \restricttype{\Delta, \Delta'}$ \\
      \ooooo Since kinds have no free variables, 
               $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$  \\
      \ooooo Since types have no non-kinded variables, 
               $\restricttype{\Delta, \Delta'} = \restricttype{\Delta, [p/u]\Delta'}$ \\
      \ooooo Since $u \not\in FV(e)$, $[p/u]e = e$ \\
      \ooooo Since $u \not\in FV(A)$, $[p/u]A = A$ \\
      \ooooo Therefore $D_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                                      {\restricttype{\Delta, [p/u]\Delta'}}
                                      {[p/u]e}{[p/u]A}$ \\
      \ooooo Take this to be $D'_2$ \\
      \ooo Therefore $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]
                                      {\restricttype{\Delta, [p/u]\Delta'}}
                                      {[p/u]e}{[p/u]A}$ \\
      \ooo By rule \textsc{TermExpr} on $D'_1, D'_2$, we have
            $\judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u]A}$ \\
      \ooo Therefore, 
            $\judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ \\
      \end{tabbedproof}
    
    \item Case \textsc{TermHyp}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{u}{\omega}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have $m :: \omega = \assert \vee \omega = \omega' \To \omega''$\\
        \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \ooo By mutual induction on $D_1$, $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By iterated weakening on $D_0$, we have $D'_0 :: \judgeA[{\Delta, [p/u]\Delta'}]{p}{\omega}$ \\
        \ooo By definition of substitution, $[p/u]u = p$ \\
        \ooo Since $u \not\in FV(\omega)$, we have $[p/u]\omega = \omega$ \\
        \ooo Therefore $D'_0 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]u}{\omega}$ \\
      \end{tabbedproof}
      
    \item Case \textsc{TermAbs}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{\pfun{u_1}{\omega_1}{q}}{\omega_1 \To \omega_2}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[\Delta, u:\omega, \Delta', u_1:\omega_1]{q}{\omega_2}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta', u_1:[p/u]\omega_1}]{[p/u]q}{[p/u]\omega_2}$ \\
        \ooo By rule \textsc{TermAbs}, 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{\pfun{u_1}{[p/u]\omega_1}{[p/u]q}}{[p/u]\omega_1 \To [p/u]\omega_2}$ \\
        \ooo By substitution definition, $[p/u]\omega_1 \To [p/u]\omega_2 = [p/u](\omega_1 \To \omega_2)$ \\
        \ooo By substitution definition, $\pfun{u_1}{[p/u]\omega_1}{[p/u]q} = [p/u](\pfun{u_1}{\omega_1}{q})$ \\
        \ooo Therefore 
           $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](\pfun{u_1}{\omega_1}{q})}{[p/u](\omega_1 \To \omega_2)}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermApp}
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{q'\;q''}{\omega'}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[\Delta, u:\omega, \Delta']{q'}{\omega'' \To \omega'}$ \\
        \ooo By inversion on $D$, we have $D_2 :: \judgeA[\Delta, u:\omega, \Delta']{q''}{\omega''}$ \\
        \ooo By induction on $D_1$, we have $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u](\omega'' \To \omega')}$ \\
        \ooo By induction on $D_2$, we have $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q''}{[p/u]\omega''}$ \\
        \ooo By definition of substitution, $[p/u](\omega'' \To \omega') = [p/u]\omega'' \To [p/u]\omega'$ \\
        \ooo Therefore, $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u]\omega'' \To [p/u]\omega'}$ \\
        \ooo By rule \textsc{TermApp}, we have 
           $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{([p/u]q')\;([p/u]q'')}{[p/u]\omega'}$ \\
        \ooo By definition of substitution, $([p/u]q')\;([p/u]q'') = [p/u](q'\;q'')$ \\
        \ooo Therefore $D' :: \judgeA{\Delta, [p/u]\Delta'}{[p/u](q'\;q'')}{[p/u]\omega'}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermPropConst}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{c}{\assert}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \ooo By inversion on $D$, we have $c \in \setof{\top, \bot, \emp}$ \\
        \ooo By mutual induction on $D_1$, we have $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By rule \textsc{TermPropConst} on $D_1$ and line 3, we have
            $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{c}{\assert}$ \\
        \ooo By definition of substitution, $[p/u]c = c$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]c}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermPropBinary}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{q_1 \oplus q_2}{\assert}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[\Delta, u:\omega, \Delta']{q_1}{\assert}$ \\
        \ooo By inversion on $D$, we have $D_2 :: \judgeA[\Delta, u:\omega, \Delta']{q_2}{\assert}$ \\
        \ooo By inversion on $D$, we have $\oplus \in \setof{\land, \implies, \vee, *, \wand}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1}{[p/u]\assert}$ \\
        \ooo By induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_2}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1}{\assert}$ \\
        \ooo Therefore $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_2}{\assert}$ \\
        \ooo By rule \textsc{TermPropBinary} on $D'_1, D'_2$, and line 4, we have: \\
        \oox \;\; $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1 \oplus [p/u]q_2}{\assert}$ \\
        \ooo By definition of substitution, $[p/u](q_1 \oplus q_2) = [p/u]q_1 \oplus [p/u]q_2$ \\
        \ooo Therefore $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](q_1 \oplus q_2)}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermPropQuantify}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta']{Q u_1:\omega_1.\; q}{\assert}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[\Delta, u:\omega, \Delta', u_1:\omega_1]{q}{\assert}$ \\
        \ooo By inversion on $D$, we have $Q \in \setof{\forall, \exists}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[\Delta, [p/u]\Delta', u_1:[p/u]\omega_1]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D'_1 :: \judgeA[{\Delta, [p/u]\Delta', u_1:[p/u]\omega_1}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{TermPropQuantify} on $D'_1$ and line 3, we have \\
        \oox $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{Q u_1:[p/u]\omega_1.\;[p/u]q}{\assert}$ \\
        \ooo By definition of substitution, $Q u_1:[p/u]\omega_1.\;[p/u]q = [p/u](Q u:\omega_1.\; q)$ \\
        \ooo Therefore $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](Q u_1:\omega_1.\;q)}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item case \textsc{TermPointsTo}
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[\Delta, u:\omega, \Delta]{e \pointsto_A e'}{\assert}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[\Delta, u:\omega, \Delta]{e}{\reftype{A}}$ \\
        \ooo By inversion on $D$, we have 
             $D_2 :: \judgeA[\Delta, u:\omega, \Delta]{e'}{A}$ \\
        \ooo By induction on $D_1$, we have
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u]\reftype{A}}$ \\
        \ooo By induction on $D_2$, we have
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e'}{[p/u]A}$ \\
        \ooo By definition of substitution, $[p/u]\reftype{A} = \reftype{([p/u]A)}$ \\
        \ooo Therefore, 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{\reftype{([p/u]A)}}$ \\
        \ooo By rule \textsc{TermPointsTo}, 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e \pointsto_{[p/u]A} [p/u]e'}{\assert}$ \\
        \ooo By definition of substitution, $[p/u]e \pointsto_{[p/u]A} e' = [p/u](e \pointsto_A e')$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](e \pointsto_A e')}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermEqual}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q =_{\omega'} q'}{\assert}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega}$ \\
        \ooo By inversion on $D$, we have 
             $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q'}{\omega}$ \\
        \ooo By induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega}$ \\
        \ooo By induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u]\omega}$ \\
        \ooo By rule \textsc{TermEqual}, we have 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q =_{[p/u]\omega} [p/u]q'}{\assert}$ \\
        \ooo By definition of substitution, $[p/u]q =_{[p/u]\omega} [p/u]q' = [p/u](q =_\omega q')$\\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](q =_\omega q')}{[p/u]\assert}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermEqSort}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have 
             $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega''}$ \\
        \ooo By inversion on $D$, we have 
             $D_2 :: \judgeSortEq[{\Delta, u:\omega, \Delta'}]{\omega'}{\omega''}$ \\
        \ooo By induction, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega''}$ \\
        \ooo By equality sort substitution, 
             $D'_2 :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}{[p/u]\omega''}$ \\
        \ooo By rule \textsc{TermEqSort}, 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ \\
      \end{tabbedproof}

    \item Case \textsc{TermSpec}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{\validprop{S}}{\assert}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have
             $D_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$ \\
        \ooo By rule \textsc{TermSpec}, we have 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{\validprop{([p/u]S)}}{\assert}$ \\
        \ooo By definition of substitution, $\validprop{([p/u]S)} = [p/u](\validprop{S})$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore 
             $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](\validprop{S})}{[p/u]\assert}$ \\
      \end{tabbedproof}
    \end{itemize}

  \item We want to show if $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, 
        and either $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, 
        or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$,
        then 
         $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$. 
    \begin{itemize}
    \item Case \textsc{SpecTriple}
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\spec{q}{c}{a:A}{r}}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
        \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{\comp{c}}{\monad{A}}$ \\
        \oooo $D_3 :: \judgeA[{\Delta, u:\omega, \Delta', a:A}]{r}{\assert}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By mutual induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\comp{c}}{[p/u]\monad{A}}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]r}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo By definition of substitution, $[p/u]\comp{c} = \comp{[p/u]c}$ \\
        \ooo By definition of substitution, $[p/u]\monad{A} = \monad{([p/u]A)}$ \\
        \ooo Therefore we have:\\
        \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
        \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{\comp{[p/u]c}}{\monad{([p/u]A)}}$ \\
        \oooo $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{SpecTriple} on $D'_1, D'_2, D'_3$, we have \\
        \oox $D' :: \judgeS[{\Delta, [p/u]\Delta'}]
                            {\spec{[p/u]q}{[p/u]c}{a:[p/u]A}{[p/u]r}}$ \\
        \ooo By definition of substitution, we have \\
        \oox $\spec{[p/u]q}{[p/u]c}{a:[p/u]A}{[p/u]r} = [p/u]\spec{q}{c}{a:A}{r}$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]\spec{q}{c}{a:A}{r}}$ \\
      \end{tabbedproof}

    \item case \textsc{SpecMTriple}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\mspec{q}{c}{a:A}{r}}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
        \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{e}{\monad{A}}$ \\
        \oooo $D_3 :: \judgeA[{\Delta, u:\omega, \Delta', a:A}]{r}{\assert}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By mutual induction on $D_2$, we have 
             $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u]\monad{A}}$ \\
        \ooo By mutual induction on $D_1$, we have 
             $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]r}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo By definition of substitution, $[p/u]\monad{A} = \monad{([p/u]A)}$ \\
        \ooo Therefore we have:\\
        \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
        \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{\monad{([p/u]A)}}$ \\
        \oooo $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{SpecTriple} on $D'_1, D'_2, D'_3$, we have \\
        \oox $D' :: \judgeS[{\Delta, [p/u]\Delta'}]
                            {\mspec{[p/u]q}{[p/u]e}{a:[p/u]A}{[p/u]r}}$ \\
        \ooo By definition of substitution, we have \\
        \oox $\mspec{[p/u]q}{[p/u]e}{a:[p/u]A}{[p/u]r} = [p/u]\mspec{q}{e}{a:A}{r}$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]\mspec{q}{e}{a:A}{r}}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecAssert}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\setof{q}}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
        \ooo By mutual induction on $D_1$, we have 
              $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\assert}$ \\
        \ooo By definition of substitution, $[p/u]\assert = \assert$ \\
        \ooo Therefore $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
        \ooo By rule \textsc{SpecAssert}, 
              $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{\validprop{([p/u]q)}}$ \\
        \ooo By definition of substitution, $\validprop{([p/u]q)} = [p/u](\validprop{S})$ \\
        \ooo Therefore 
             $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](\validprop{q})}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecBinary}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_1 \oplus S_2}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_1}$ \\
        \oooo $D_2 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_2}$ \\
        \oooo $\oplus \in \setof{\specand, \specor, \specimp}$ \\
        \ooo By induction on $D_1$, we have 
               $D'_1 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S_1}$ \\
        \ooo By induction on $D_2$, we have 
               $D'_2 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S_2}$ \\
        \ooo By rule \textsc{SpecBinary} on $D'_1, D'_2$ and line 5, we have \\
        \ooox $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S_1 \oplus [p/u]S_2}$ \\
        \ooo By definition of substitution, $[p/u]S_1 \oplus [p/u]S_2 = [p/u](S_1 \oplus S_2)$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](S_1 \oplus S_2)}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecQuantify}:
      \begin{tabbedproof}
        \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{Q u':\omega'.\; S}$ \\
        \oo Assume $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$, \\
        \ox or $\omega$ is a sort $\kappa$ and $p = \tau$, or $\omega$ is a sort $A$ and $p = e$ \\
        \ooo By inversion on $D$, we have \\
        \oooo $D_1 :: \judgeS[{\Delta, u:\omega, \Delta', u':\omega'}]{S}$ \\
        \oooo $Q \in \setof{\forall, \exists}$ \\
        \ooo By induction on $D_1$, we have $D'_1 :: \judgeS[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]S}$ \\
        \ooo By rule \textsc{SpecQuantify}, 
              $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{Q u':[p/u]\omega'.\; [p/u]S}$ \\
        \ooo By definition of substitution, $Q u':[p/u]\omega'.\; [p/u]S = [p/u](Q u':\omega'.\; S)$ \\
        \ooo Therefore $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](Q u':\omega'.\; S)}$ \\
      \end{tabbedproof}
    \end{itemize}
  \end{enumerate}
\end{proof}
  
\subsubsection{Interpretation of Sorts}

\begin{lemma}{(Well-sortedness implies well-formed contexts)}
If it is the case that $\judgeSort{\omega}$, then $\judgeACtx{\Delta}$.
\end{lemma}
\begin{proof}
The proof is by a trivial structural induction over the derivation $\judgeSort{\omega}$. 
\end{proof}

\begin{lemma*}{(Uniqueness of Interpretations)}
We have that:
\begin{enumerate}
\item If we have two derivations $\mathcal{D}_1 :: \judgeACtx{\Delta}$
      and $\mathcal{D}_2 :: \judgeACtx{\Delta}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$
\item If we have two derivations $\mathcal{D}_1 ::\; \judgeSort{\omega}$
      and $\mathcal{D}_2 ::\; \judgeSort{\omega}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$
\end{enumerate}
\end{lemma*}
\begin{proof}
We proceed by mutual induction on the size of the derivation $\mathcal{D}_1$

\begin{enumerate}
\item We want to show that if $\mathcal{D}_1 :: \judgeACtx{\Delta}$
      and $\mathcal{D}_2 ::\; \judgeACtx{\Delta}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$.

\begin{itemize}
\item Case \textsc{CtxNil}:
  \begin{eqnproof}
    \eclaim{\mathcal{D}_1 :: \judgeACtx{\cdot}}
           {Hypothesis}
    \eclaim{\mathcal{D}_2 :: \judgeACtx{\cdot}}
           {Hypothesis}
    \eclaim{\interp{\mathcal{D}_1} = 1}
          {Definition of semantics}
    \eclaim{\interp{\mathcal{D}_2} = 1}
          {Definition of semantics}
    \eclaim{\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}}
          {Conclusion}
  \end{eqnproof}

\item Case \textsc{CtxCons}: 
  \begin{eqnproof}
    \eclaim{\mathcal{D}_1 ::\; \judgeACtx{\Delta, u:\omega}}
           {Hypothesis}
    \eclaim{\mathcal{D}_2 ::\; \judgeACtx{\Delta, u:\omega}}
           {Hypothesis}
    \eclaim{\mathcal{D}'_1 ::\; \judgeACtx{\Delta}}
           {Inversion on $\mathcal{D}_1$}
    \eclaim{\mathcal{D}''_1 :: \judgeSort{\omega}}
           {Inversion on $\mathcal{D}_1$}
    \eclaim{\mathcal{D}'_2 ::\; \judgeACtx{\Delta}}
           {Inversion on $\mathcal{D}_2$}
    \eclaim{\mathcal{D}''_2 :: \judgeSort{\omega}}
           {Inversion on $\mathcal{D}_2$}
    \eclaim{\interp{\mathcal{D}'_1} = \interp{\mathcal{D}'_1}}
           {Induction on $\mathcal{D}'_1, \mathcal{D}'_1$} 
    \eclaim{\interp{\mathcal{D}''_1} = \interp{\mathcal{D}''_1}}
           {Mutual Induction on $\mathcal{D}''_1, \mathcal{D}''_1$} 
    \eclaim{\sum \delta \in \interp{\mathcal{D}'_1}.\; \interp{\mathcal{D}''_1}\;\delta =
            \sum \delta \in \interp{\mathcal{D}'_2}.\; \interp{\mathcal{D}''_2}\;\delta}
           {Congruence of Equality}
  \end{eqnproof}
\end{itemize}

\item We want to show if $\mathcal{D}_1 ::\; \judgeSort{\omega}$
      and $\mathcal{D}_2 ::\; \judgeSort{\omega}$, 
      then $\interp{\mathcal{D}_1} = \interp{\mathcal{D}_2}$

\begin{itemize}
\item Case \textsc{SortProp}:
  \begin{eqnproof}
    \eclaim{\ms{D}_1 :: \judgeSort{\assert}}
           {Hypothesis}
    \eclaim{\ms{D}_2 :: \judgeSort{\assert}}
           {Hypothesis}
    \eclaim{\ms{D}'_1 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_1$}
    \eclaim{\ms{D}'_2 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_2$}
    \eclaim{\interp{\ms{D}'_1} = \interp{\ms{D}'_2}}
           {Mutual Induction on $\ms{D}'_1, \ms{D}'_2$}
    \eclaim{\interp{\ms{D}_1} = \semfun{\delta \in \interp{\ms{D}'_1}}{\powerset{H}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_2}}{\powerset{H}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_1}}{\powerset{H}}}
           {Equality}
    \eclaim{\interp{\ms{D}_1} = \interp{\ms{D}_2}}
           {Conclusion}
  \end{eqnproof}

\item Case \textsc{SortKind}

  \begin{eqnproof}
    \eclaim{\ms{D}_1 :: \judgeSort{\kappa}}
           {Hypothesis}
    \eclaim{\ms{D}_2 :: \judgeSort{\kappa}}
           {Hypothesis}
    \eclaim{\ms{D}'_1 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_1$}
    \eclaim{\ms{D}'_2 :: \judgeACtx{\Delta}}
           {Inversion on $\ms{D}_2$}
    \eclaim{\interp{\ms{D}'_1} = \interp{\ms{D}'_2}}
           {Mutual Induction on $\ms{D}'_1, \ms{D}'_2$}
    \eclaim{\interp{\ms{D}_1} = \semfun{\delta \in \interp{\ms{D}'_1}}{\interp{\kappa}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_2}}{\interp{\kappa}}}
           {Semantics}
    \eclaim{\interp{\ms{D}_2} = \semfun{\delta \in \interp{\ms{D}'_1}}{\interp{\kappa}}}
           {By equality}
    \eclaim{\interp{\ms{D}_1} = \interp{\ms{D}_2}}
           {Conclusion}
  \end{eqnproof}
\end{itemize}

\item Case \textsc{SortType}: 
  \begin{tabbedproof}
  \oo Assume $\ms{D}_1 :: \judgeSort{A}$ and $\ms{D}_2 :: \judgeSort{A}$ \\
  \ooo By inversion on $\ms{D}_1$, we get \\
  \oooo $\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}$ and  \\
  \oooo $\ms{D}''_1 :: \judgeACtx{\Delta}$ \\
  \ooo By inversion on $\ms{D}_2$, we get \\
  \oooo $\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}$ and  \\
  \oooo $\ms{D}''_2 :: \judgeACtx{\Delta}$ \\
  \ooo By mutual induction on $\ms{D}''_1, \ms{D}''_2$, we get $\interp{\ms{D}''_1} = \interp{\ms{D}''_2}$ \\
  \ooo By semantics, $\interp{\ms{D}_1} = 
            \semfun{\delta \in \interp{\ms{D}''_1}}
                   {\interp{\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo By semantics, $\interp{\ms{D}_2} = 
            \semfun{\delta \in \interp{\ms{D}''_2}}
                   {\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo By equality, $\interp{\ms{D}_2} = 
            \semfun{\delta \in \interp{\ms{D}''_1}}
                   {\interp{\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo To show $\interp{\ms{D}_1} = \interp{\ms{D}_2}$, assume $\delta \in \interp{\ms{D}''_1}$\\
  \oooo Now $\interp{\ms{D}_1}\;\delta = 
                \interp{\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Now $\interp{\ms{D}_2}\;\delta = 
                \interp{\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                      \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Since type interpretation is coherent, \\
  \oooo \; $\interp{\ms{D}'_1 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}} =
             \interp{\ms{D}'_2 :: \judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}$ \\
  \oooo Therefore $\interp{\ms{D}_1}\;\delta = \interp{\ms{D}_2}\;\delta$ \\
  \ooo Therefore $\interp{\ms{D}_1} = \interp{\ms{D}_2}$
  \end{tabbedproof}
\end{enumerate}
\end{proof}

\begin{lemma*}{(Soundness of Sort Equality)}
If $\judgeACtx{\Delta}$, $\judgeSort{\omega}$, and $\judgeSort{\omega'}$ are derivable, then if 
$\judgeSortEq{\omega}{\omega'}$ is derivable, then $\interp{\judgeSort{\omega}} = \interp{\judgeSort{\omega'}}$. 
\end{lemma*}

\begin{proof}
We do this proof by induction on the equality derivation. 

\begin{itemize}
\item Case \textsc{SortEqProp}
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{\assert}{\assert}$ \\
  \oo Assume $D_1 :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_2 :: \judgeSort{\assert}$ \\
  \oo Assume $D_3 :: \judgeSort{\assert}$ \\
  \ooo By semantics, $\interp{D_2} = \semfun{\delta \in \interp{D_1}}{\powerset{H}}$ \\
  \ooo By semantics, $\interp{D_3} = \semfun{\delta \in \interp{D_1}}{\powerset{H}}$ \\
  \ooo Therefore $\interp{D_2} = \interp{D_3}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqKind}: 
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{\kappa}{\kappa}$ \\
  \oo Assume $D_1 :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_2 :: \judgeSort{\kappa}$ \\
  \oo Assume $D_3 :: \judgeSort{\kappa}$ \\
  \ooo By semantics, $\interp{D_2} = \semfun{\delta \in \interp{D_1}}{\interp{\kappa}}$ \\
  \ooo By semantics, $\interp{D_3} = \semfun{\delta \in \interp{D_1}}{\interp{\kappa}}$ \\
  \ooo Therefore $\interp{D_2} = \interp{D_3}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqImp}: 
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{\omega'_1 \To \omega''_1}{\omega'_2 \To \omega''_2}$ \\
  \oo Assume $D :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_1 :: \judgeSort{\omega_1 \To \omega'_1}$ \\
  \oo Assume $D_2 :: \judgeSort{\omega_2 \To \omega'_2}$ \\
  \ooo By inversion on $E$, we get 
         $E' :: \judgeSortEq{\omega'_1}{\omega'_2}$ and 
         $E'' :: \judgeSortEq{\omega''_1}{\omega''_2}$ \\
  \ooo By inversion on $D_1$, we get $D'_1 :: \judgeSort{\omega'_1}$ 
                                 and $D''_1 :: \judgeSort{\omega''_1}$ \\
  \ooo By inversion on $D_2$, we get $D'_2 :: \judgeSort{\omega'_2}$ 
                                 and $D''_2 :: \judgeSort{\omega''_2}$ \\
  \ooo By induction on $E', D, D'_1, D'_2$, we get 
             $\interp{\judgeSort{\omega'_1}} = \interp{\judgeSort{\omega'_2}}$ \\
  \ooo By induction on $E'', D, D''_1, D''_2$, we get 
             $\interp{\judgeSort{\omega''_1}} = \interp{\judgeSort{\omega''_2}}$ \\
  \ooo By semantics, $\interp{D_1} = \semfun{\delta}{\interp{D'_1}\;\delta \to 
                                                     \interp{D''_1}\;\delta}$ \\
  \ooo By semantics, $\interp{D_2} = \semfun{\delta}{\interp{D'_2}\;\delta \to 
                                                     \interp{D''_2}\;\delta}$ \\
  \ooo We want to show $\interp{D_1} = \interp{D_2}$ \\
  \ooo Assume $\delta \in \interp{D}$ \\
  \oooo Now $\interp{D_1}\;\delta = \interp{D'_1}\;\delta \to \interp{D''_1}\;\delta$ \\
  \oooo Now $\interp{D_2}\;\delta = \interp{D'_2}\;\delta \to \interp{D''_2}\;\delta$ \\
  \oooo By equality, $\interp{D_2}\;\delta = \interp{D'_1}\;\delta \to \interp{D''_1}\;\delta$ \\
  \oooo Therefore, $\interp{D_1}\;\delta = \interp{D_2}\;\delta$ \\
  \ooo Therefore $\interp{D_1} = \interp{D_2}$ \\
  \end{tabbedproof}

\item Case \textsc{SortEqType}:
  \begin{tabbedproof}
  \oo Assume $E :: \judgeSortEq{A}{B}$ \\
  \oo Assume $D_1 :: \judgeACtx{\Delta}$ \\
  \oo Assume $D_2 :: \judgeSort{A}$ \\
  \oo Assume $D_3 :: \judgeSort{B}$ \\
  \ooo By inversion on $E$, $E' :: \judgeKeq[\restrictkind{\Delta}]{A}{B}{\bigstar}$ \\
  \ooo By soundness of type equality, 
         $\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}} = 
          \interp{\judgeWK[\restrictkind{\Delta}]{B}{\bigstar}}$ \\
  \ooo By semantics, 
          $\interp{D_2} = 
             \semfun{\delta \in \interp{D_1}}
                    {\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                     \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo By semantics, 
          $\interp{D_3} = 
             \semfun{\delta \in \interp{D_1}}
                    {\interp{\judgeWK[\restrictkind{\Delta}]{B}{\bigstar}}
                     \;\restricttyenv{\Delta}{\delta}\;(K,K)}$ \\
  \ooo We want to show $\interp{D_2} = \interp{D_3}$ \\
  \ooo To do this, assume we have $\delta \in \interp{D_1}$ \\
  \oooo Now $\interp{D_2}\;\delta = 
                 \interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                 \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Now $\interp{D_3}\;\delta = 
                 \interp{\judgeWK[\restrictkind{\Delta}]{B}{\bigstar}}
                 \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo By equality, $\interp{D_3}\;\delta = 
                 \interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}
                 \;\restricttyenv{\Delta}{\delta}\;(K,K)$ \\
  \oooo Therefore $\interp{D_2}\;\delta = \interp{D_3}\;\delta$ \\
  \ooo Therefore $\interp{D_2} = \interp{D_3}$ \\
  \end{tabbedproof}

\end{itemize}
\end{proof}

\begin{lemma*}{(Substitution Preserves Meaning)}
If $D_0 :: \judgeA{p}{\omega}$, then we have 

\begin{enumerate}
\item If $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, and either 
  $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$,  
  or $\omega$ is a sort $\kappa$ and $p = \tau$, 
  or $\omega$ is a sort $A$ and $p = e$,
  then there is a $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ such
  that for all $(\delta, \interp{D_0}\;\delta, \delta') \in 
                \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
  we have that $\interp{D}\;(\delta, \interp{D_0}\;\delta, \delta') = \interp{D'}\;(\delta, \delta')$ 

\item If $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, and either 
  $u$ does not occur in a type or program expression in $\Delta'$, $q$ or $\omega'$,  
  or $\omega$ is a sort $\kappa$ and $p = \tau$, 
  or $\omega$ is a sort $A$ and $p = e$, 
  then there is a $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$ such
  that for all $(\delta, \interp{D_0}\;\delta, \delta') \in 
                \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
  we have that $\interp{D}\;(\delta, \interp{D_0}\;\delta, \delta') = \interp{D'}\;(\delta, \delta')$ 
\end{enumerate}
\end{lemma*}
\begin{proof}
  Assume $D_0 :: \judgeA{p}{\omega}$. Now we proceed by mutual structural induction.
  
  \begin{enumerate}
  \item We want to show if $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$, then
  then there is a $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ such
  that for all $(\delta, \interp{D_0}\;\delta, \delta') \in 
                \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
  we have that $\interp{D}\;(\delta, \interp{D_0}\;\delta, \delta') = \interp{D'}\;(\delta, \delta')$ 
  \begin{itemize}
  \item Case \textsc{TermType}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{\tau}{\kappa}$ \\
      \oo By substitution, $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\tau}{\kappa}$ \\
      \oo By inversion on $D$, we have 
          $D_1 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]{\tau}{\kappa}$ \\
      \oo By inversion on $D'$, we have 
          $D'_1 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]{[p/u]\tau}{\kappa}$ \\
      \oo Assume $(\delta, \interp{D_0}, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oo By semantics, we have 
          $\interp{D}(\delta, \interp{D_0}\;\delta, \delta) = 
            \interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\;\delta, \delta')}$ \\
      \oo By semantics, we have 
          $\interp{D'}(\delta, \delta) = 
            \interp{D'_1}\;\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}$ \\
      \oo We want to show 
          $\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\;\delta, \delta')} = \interp{D'_1}\;\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}$ \\
      \oo Case analyze $\omega$:\\
      \ooo If $\omega = \kappa'$ and $p = \tau'$:\\
      \oooo Then $D_0 :: \judgeA{\tau'}{\kappa'}$, where $p = \tau'$ \\
      \oooo By inversion, we have $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau'}{\omega'}$ \\
      \oooo By definition, $\interp{D_0}\;\delta = \interp{D'_0}\;\restricttyenv{\Delta}{\delta'}$\\
      \oooo Let $\theta = \restricttyenv{\Delta}{\delta}$, and
                $\theta' = \restricttyenv{\Delta'}{\delta'}$ \\
      \oooo Then $\interp{D_0}\;\theta = \theta(\tau')$ \\
      \oooo Therefore $\restricttyenv{\Delta, u:\kappa, \Delta'}{(\delta, \interp{D_0}\delta, \delta')} = 
                       (\theta, \theta(\tau'), \theta')$ \\
      \oooo By definition $\interp{D_1}\;(\theta, \theta(\tau'), \theta') = (\theta, \theta(\tau'), \theta')(\tau)$ \\
      \oooo By definition $\interp{D'_1}\;\theta') = (\theta, \theta')([\tau'/u]\tau)$ \\
      \oooo By properties of substitution, $(\theta, \theta(\tau'), \theta')(\tau) = (\theta, \theta')([\tau'/u]\tau)$ \\
      \oooo Therefore 
            $\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\;\delta, \delta')} = \interp{D'_1}\;\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}$ \\
      \ooo If $\omega \not= \kappa$: \\
      \oooo Then $\restrictkind{\Delta, u:\omega, \Delta'} = \restrictkind{\Delta, \Delta'}$ \\
      \oooo Since kinds have no free variables, $\restrictkind{\Delta, \Delta'} = 
                                                 \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \oooo Similarly, $\restricttyenv{\Delta'}{\delta'} = \restricttyenv{[p/u]\Delta'}{\delta'}$\\
      \oooo Then $\restricttyenv{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\;\delta, \delta')}
                 =\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}$ \\
      \oooo Then, since $u \not\in FV(\tau)$, we have $\tau = [p/u]\tau$ \\
      \oooo Therefore, $D_1 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]{[p/u]\tau}{\kappa}$ \\
      \oooo By coherence, $\interp{D_1} = \interp{D'_1}$ \\
      \oooo Therefore 
            $\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\;\delta, \delta')} = \interp{D'_1}\;\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}$ \\
      \ooo If $\omega = \kappa'$ and $u$ does not occur in $\Delta'$ or $\tau$:\\
      \oooo Since $u$ does not occur, we can strengthen $D_1$ to get \\
      \ooox $D'_1 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]{\tau}{\kappa}$ \\
      \oooo Furthermore, we know $\interp{D_1}\;(\restricttyenv{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\;\delta, \delta')}) = \interp{D'_1}\;(\restricttyenv{\Delta, \Delta'}{(\delta, \delta')})$ \\
      \oooo We know $[p/u]\Delta' = \Delta'$, and $[p/u]\tau = \tau$ and $[p/u]\kappa = \kappa$ \\
      \ooox so $D'_1 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{[p/u]\Delta'}]{[p/u]\tau}{[p/u]\kappa}$ \\
      \oooo Hence $D'_1 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]{[p/u]\tau}{[p/u]\kappa}$ \\
      \oooo Hence $\interp{D}(\delta, \interp{D_0}\delta, \delta') = \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}


  \item Case \textsc{TermExpr}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{e}{A}$ \\
      \oo By substitution theorem, $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u]A}$ \\
      \oo By inversion on $D$, we have 
           $D_1 :: \judgeE[\restrictkind{\Delta, u:\omega, \Delta'}]{\restricttype{\Delta, u:\omega, \Delta'}}{e}{A}$ \\
      \oo By inversion on $D'$, we have
           $D_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]{\restricttype{\Delta, [p/u]\Delta'}}{[p/u]e}{[p/u]A}$ \\
      \oo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                   \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oo By semantics, \\
      \ox $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
             U(\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}
                                           {(\delta, \interp{D_0}\delta, \delta')})
             \;\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')}$\\
      \oo By semantics, \\
      \ox $\interp{D'}(\delta, \delta') = 
             U(\interp{D_2}\;\restricttyenv{\Delta, [p/u]\Delta'}
                                           {(\delta, \delta')})
             \;\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$\\
      \oo We want to show:\\
      \ox $U(\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}
                                           {(\delta, \interp{D_0}\delta, \delta')})
             \;\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')}
             =$ \\
      \ox $U(\interp{D_2}\;\restricttyenv{\Delta, [p/u]\Delta'}
                                           {(\delta, \delta')})
             \;\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$\\

      \oo Case on $\omega$: \\
      \ooo If $\omega = \kappa$ and $p = \tau$: \\
      \oooo Then $D_0 :: \judgeA{\tau}{\kappa}$, where $p = \tau$ \\
      \oooo Then by inversion on $D_0$, we have 
            $D'_0 :: \judgeWK[\restrictkind{\Delta, u:\kappa, \Delta'}]{\tau}{\kappa}$ \\
      \oooo By semantics, $\interp{D_0}\;\delta = \interp{D'_0}\;\restricttyenv{\Delta}{\delta'}$\\
      \oooo Let $\theta = \restricttyenv{\Delta}{\delta}$, and
                $\theta' = \restricttyenv{\Delta'}{\delta'}$ \\
      \oooo Then $\interp{D'_0}\;\theta = \theta(\tau)$ \\
      \oooo Therefore, $\interp{D_1}\;\restricttyenv{\Delta, u:\kappa, \Delta'}{(\delta, \interp{D_0}\;\delta, \delta')} = \interp{D_1}\;(\theta, \theta(\tau), \theta')$ \\
      \oooo By semantic substitution for terms, 
            $\interp{D_1}\;(\theta, \theta(\tau), \theta') = \interp{D'_2}\;(\theta,\theta')$ \\
      \oooox where $D'_2 :: \judgeE[\restrictkind{\Delta, \Delta'}]{\restricttype{[p/u]\Delta, [p/u]\Delta'}}{[p/u]e}{[p/u]A}$ \\
      \oooo Since $u \not\in FV(\Delta)$, we have $[p/u]\Delta = \Delta$ \\
      \oooo Since kinds have no free variables, $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \oooo Therefore, $D'_2 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]{\restricttype{\Delta, [p/u]\Delta'}}{[p/u]e}{[p/u]A}$ \\
      \oooo By coherence, $\interp{D'_2} = \interp{D_2}$ \\
      \oooo Therefore $U(\interp{D_1}\;(\theta, \theta(\tau), \theta')) = U(\interp{D_2})\;(\theta,\theta'))$ \\
      \oooo Now, we want to show $\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')} = \restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$\\
      \oooo Since $\interp{D_0}\delta$ is a type, and not a value, it follows that \\
      \oooox $\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')} = 
             (\restrictvals{\Delta}{\delta}), (\restrictvals{\Delta'}{\delta'})$ \\
      \oooo Since substitution can't change sorts, $\restrictvals{\Delta'}{\delta'} = \restrictvals{[p/u]\Delta'}{\delta'}$ \\
      \oooo Therefore $\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')} = \restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$\\
      \oooo Therefore we have: \\
      \oooox $U(\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}
                                           {(\delta, \interp{D_0}\delta, \delta')})
             \;\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')}
             =$ \\
      \oooox $U(\interp{D_2}\;\restricttyenv{\Delta, [p/u]\Delta'}
                                           {(\delta, \delta')})
             \;\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$\\

      \ooo If $\omega = B$ and $p = e'$: \\
      \oooo Therefore $D_0 :: \judgeA{e'}{B}$, where $p = e'$ \\
      \oooo By inversion on $D_0$, we have 
            $D'_0 :: \judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e'}{B}$ \\
      \oooo By semantics, $\interp{D_0}\;\delta = U(\interp{D'_0}\;\restricttyenv{\Delta}{\delta})\;\restrictvals{\Delta}{\delta}$ \\
      \oooo Next, since $B$ is not a kind, 
            $\restrictkind{\Delta, u:B, \Delta'} = \restrictkind{\Delta, \Delta'}$ \\
      \oooo Since substitution can't change sorts, $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \oooo Likewise, since $B$ is not a kind, $\restricttyenv{\Delta, u:B, \Delta'}{(\delta, \interp{D_0}\delta, \delta')}
            = \restricttyenv{\Delta, \Delta'}{(\delta, \delta')}$ \\
      \oooo Next, since substitution can't change sorts
            $\restricttyenv{\Delta, \Delta'}{(\delta, \delta')} = 
             \restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}$ \\
      \oooo Now, we know each component of $\restrictvals{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta, \delta')}$ is an element of \\
      \ooox a predomain mapped into Set by $U$. \\
      \oooo Since $U$ distributes over $\to$ in predomains, there is a tuple $\eta$ such that \\
      \oooox $U(\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')})\;\restrictvals{\Delta,u:B,\Delta'}{(\delta,\interp{D_0}\delta,\delta')} = $ \\
      \oooox $U(\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')}\;\eta)$ \\
      \oooox and $U(\eta) = \restrictvals{\Delta,u:B,\Delta'}{(\delta,\interp{D_0}\delta,\delta')}$ \\
      \oooo By abuse of notation, we will write \\
      \oooox $U(\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')})\;\restrictvals{\Delta,u:B,\Delta'}{(\delta,\interp{D_0}\delta,\delta')} = $ \\
      \oooox $U(\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')}\;\restrictvals{\Delta,u:B,\Delta'}{(\delta,\interp{D_0}\delta,\delta')})$ \\
      \oooo This is unambiguous since $U$ distributes over products, too. \\
      \oooo By a similar argument, $U(\interp{D'_0}\;\restricttyenv{\Delta}{\delta})\;\restrictvals{\Delta}{\delta'} = U(\interp{D'_0}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta})$ \\
      \oooo Now, this means that \\
      \oooox $U(\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')}\;\restrictvals{\Delta,u:B,\Delta'}{(\delta,\interp{D_0}\delta,\delta')}) =$ \\
      \oooox $U(\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')}\;\restrictvals{\Delta,u:B,\Delta'}{(\delta, \interp{D'_0}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta},\delta')})$ \\
      \oooo By weakening and semantic substitution, we get: \\
      \oooox $\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')}\;\restrictvals{\Delta,u:B,\Delta'}{(\delta, \interp{D'_0}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta},\delta')} =$ \\
      \oooox $\interp{D'_2}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta,\interp{D_0}\delta,\delta')}\;
                             \restrictvals{\Delta,\Delta'}{(\delta,\delta')}$ \\
      \oooo where $D'_2 :: \judgeE[\restrictkind{\Delta,u:B,\Delta'}]
                                  {\restricttype{\Delta,u:B,\Delta'}}{[p/u]e}{A}$ \\
      \oooo Since term variables do not occur in kinds or types, we have \\
      \oooox $D'_2 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                                  {\restricttype{\Delta,[p/u]\Delta'}}{[p/u]e}{[p/u]A}$ \\
      \oooo By coherence $\interp{D'_2} = \interp{D_2}$ \\
      \oooo Therefore \\
      \oooox $\interp{D_1}\;\restricttyenv{\Delta,u:B,\Delta'}{(\delta, \interp{D_0}\delta,\delta')}\;\restrictvals{\Delta,u:B,\Delta'}{(\delta, \interp{D'_0}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta},\delta')} =$ \\
      \oooox $\interp{D_2}\;\restricttyenv{\Delta,[p/u]\Delta'}{(\delta,\delta')}\;
                             \restrictvals{\Delta,[p/u]\Delta'}{(\delta,\delta')}$ \\
      \oooo Therefore:\\
      \ooox $U(\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}
                                           {(\delta, \interp{D_0}\delta, \delta')})
             \;\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')}
             =$ \\
      \ooox $U(\interp{D_2}\;\restricttyenv{\Delta, [p/u]\Delta'}
                                           {(\delta, \delta')})
             \;\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$\\
      \ooo If $\omega \not= B$ or $\omega \not=\kappa$: \\
      \oooo Since $\omega$ is not a kind, $\restrictkind{\Delta, u:\omega, \Delta'} = 
                       \restrictkind{\Delta, \Delta'}$ \\
      \oooo Since kinds have no free variables, 
              $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \oooo Since $\omega$ is not a type, 
              $\restricttype{\Delta, u:\omega, \Delta'} = \restricttype{\Delta, \Delta'}$ \\
      \oooo Since types have only type variables within them,
              $\restricttype{\Delta, \Delta'} = \restricttype{\Delta, [p/u]\Delta'}$ \\
      \oooo Since $u \not\in FV(e)$, we have $e = [p/u]e$ \\
      \oooo Since $u \not\in FV(A)$, we have $A = [p/u]A$ \\
      \oooo Therefore $D_1 :: \judgeE[\restrictkind{\Delta, [p/u]\Delta'}]{\restricttype{\Delta, [p/u]\Delta'}}{[p/u]e}{[p/u]A}$ \\
      \oooo Then by coherence, $\interp{D_1} = \interp{D_2}$ \\
      \oooo Likewise, since $\omega$ is not a kind, 
            $\restricttyenv{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta,\delta')} = 
             \restricttyenv{\Delta, \Delta'}{(\delta, \delta')}$ \\
      \oooo Since substitution does not change sorts into type sorts,
            $\restricttyenv{\Delta, \Delta'}{\delta, \delta'} = 
             \restricttyenv{\Delta, [p/u]\Delta'}{\delta, \delta'}$ \\
      \oooo Similarly, since $\omega$ is not a type,
            $\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')} =
             \restrictvals{\Delta, \Delta'}{(\delta, \delta')}$ \\
      \oooo Since $u$ does not occur in $\Delta'$, 
            $\restrictvals{\Delta, \Delta'}{(\delta, \delta')} =
             \restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$ \\
      \oooo Therefore we can conclude:\\
      \ooox $U(\interp{D_1}\;\restricttyenv{\Delta, u:\omega, \Delta'}
                                           {(\delta, \interp{D_0}\delta, \delta')})
             \;\restrictvals{\Delta, u:\omega, \Delta'}{(\delta, \interp{D_0}\delta, \delta')}
             =$ \\
      \ooox $U(\interp{D_2}\;\restricttyenv{\Delta, [p/u]\Delta'}
                                           {(\delta, \delta')})
             \;\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')}$\\
      \ooo If $u$ does not occur in $\Delta'$, $q$ or $\omega'$: \\
      \oooo Then we can strengthen $D$ to derive a fresh $E :: \judgeA[\Delta, \Delta']{q}{\omega'}$\\
      \ooox such that $\interp{D}(\delta, \interp{D_0}\delta, \delta') = \interp{E}(\delta, \delta')$ \\
      \oooo Since $u$ does not occur, $[p/u]\Delta' = \Delta$ and $[p/u]q = q$ and $[p/u]\omega' = \omega'$\\
      \oooo Hence $E :: \judgeA[\Delta, [p/u]\Delta']{[p/u]q}{[p/u]\omega'}$\\
      \oooo This is the conclusion we want. \\
    \end{tabbedproof}

  \item Case \textsc{TermHyp}:
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{u}{\omega}$ \\
      \ooo By weakening on $D_0$, we have $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{p}{\omega}$ \\
      \ooo Note that since $u \not\in FV(\omega)$, we have $\omega = [p/u]\omega$ \\
      \ooo Note that by definition of substitution, $[p/u] = p$ \\
      \ooo Therefore $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]u}{[p/u]\omega}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                   \interp{\Delta, u:\omega, \Delta'}$ \\
      \oooo By semantics, $\interp{D}\;(\delta, \interp{D_0}\delta, \delta') = \interp{D_0}\delta$\\
      \oooo By properties of weakening, $\interp{D'}(\delta,\delta') = \interp{D_0}\delta$ \\
      \oooo Therefore $\interp{D}\;(\delta, \interp{D_0}\delta, \delta') = \interp{D'}(\delta,\delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermAbs}:
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{\pfun{u'}{\omega'}{q}}{\omega' \To \omega''}$ \\
      \ooo By substitution on $D$, we have 
           $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\pfun{u'}{\omega'}{q}}{[p/u](\omega' \To \omega'')}$ \\
      \ooo By inversion on $D$, we have 
           $D_1 :: \judgeA[{\Delta, u:\omega, \Delta', u':\omega'}]{q}{\omega''}$ \\
      \ooo By inversion on $D'$, we have 
           $D_2 :: \judgeA[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]q}{[p/u]\omega''}$ \\
      \ooo By induction on $D_1$, we have a $D'_2$ such that \\
      \ooo $\forall (\delta, \interp{D_0}\delta, \delta', v) \in \interp{\judgeACtx{\Delta, u:\omega, \Delta', u':\omega'}}$ \\
      \ooox $\interp{D_1}\;(\delta, \interp{D_0}\delta, \delta', v) = 
             \interp{D'_2}\;(\delta, \delta', v)$ \\
      \ooo Where $D'_2 :: \judgeA[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]q}{[p/u]\omega''}$ \\
      \ooo By coherence $\interp{D'_2} = \interp{D_2}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                   \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo By semantics, 
            $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
             \semfun{v}{\interp{D_1}(\delta, \interp{D_0}\delta, \delta', v)}$ \\
      \oooo By semantics,
            $\interp{D'}(\delta, \delta') = 
               \semfun{v}{\interp{D_2}(\delta, \delta', v)}$ \\
      \oooo By equalities in line 6 and 8, 
              $\interp{D}(\delta, \interp{D_0}\delta, \delta') =  
              \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermApp}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q'\;q''}{\omega'}$ \\
      \ooo By substitution on $D$, we have $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](q'\;q'')}{[p/u]\omega'}$ \\
      \ooo By inversion on $D$, we have: \\
      \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q'}{\omega'' \To \omega'}$ \\
      \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q''}{\omega''}$ \\
      \ooo By inversion on $D'$, we have: \\
      \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u]\omega'' \To [p/u]\omega'}$ \\
      \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q''}{[p/u]\omega''}$ \\
      \ooo By induction hypothesis on $D_1$, we have $D''_1$ such that \\
      \ooox $\forall (\delta, \interp{D_0}\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}, \interp{D_1}(\delta, \interp{D_1}\delta, \delta') = \interp{D''_1}(\delta,\delta')$\\
      \ooox where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u]\omega'' \To [p/u]\omega'}$ \\
      \ooo By induction hypothesis on $D_2$, we have $D''_2$ such that \\
      \ooox $\forall (\delta, \interp{D_0}\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}, \interp{D_2}(\delta, \interp{D_2}\delta, \delta') = \interp{D''_2}(\delta,\delta')$\\
      \ooox where $D''_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q''}{[p/u]\omega''}$ \\
      \ooo By coherence $\interp{D'_1} = \interp{D''_2}$ \\
      \ooo By coherence $\interp{D'_2} = \interp{D''_2}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                   \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
             (\interp{D_1}(\delta, \interp{D_0}\delta, \delta'))\;
             (\interp{D_2}(\delta, \interp{D_0}\delta, \delta'))$ \\
      \oooo By semantics $\interp{D'}(\delta, \delta') = 
             (\interp{D'_1}(\delta, \delta'))\;
             (\interp{D'_2}(\delta, \delta'))$ \\
      \oooo By coherence and IH,  
            $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
             (\interp{D'_1}(\delta, \delta'))\;
             (\interp{D'_2}(\delta, \delta'))$ \\
      \oooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                       \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermPropConst}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{c}{\assert}$ \\
      \ooo By substitution on $D$, we have $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{c}{\assert}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = \interp{c}^0$ \\
      \oooo By semantics, $\interp{D'}(\delta, \delta') = \interp{c}^0$ \\
      \oooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                       \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermPropBinary}:
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q_1 \oplus q_2}{\assert}$ \\
      \oo By substitution, $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](q_1 \oplus q_2)}{\assert}$ \\
      \ooo By inversion on $D$, we have \\
      \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q_1}{\assert}$ \\
      \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q_1}{\assert}$ \\
      \ooo By inversion on $D'$, we have \\
      \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1}{\assert}$ \\
      \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_2}{\assert}$ \\
      \ooo By induction on $D_1$, we have $D''_1$ such that \\
      \ooox $\forall (\delta, \interp{D_0}\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}, \interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
             \interp{D''_1}(\delta, \delta')$ \\
      \ooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_1}{\assert}$ \\
      \ooo By induction on $D_2$, we have $D''_2$ such that \\
      \ooox $\forall (\delta, \interp{D_0}\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}, \interp{D_2}(\delta, \interp{D_0}\delta, \delta') = 
             \interp{D''_2}(\delta, \delta')$ \\
      \ooo where $D''_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q_2}{\assert}$ \\
      \ooo By coherence, $\interp{D'_1} = \interp{D''_1}$ \\
      \ooo By coherence, $\interp{D'_2} = \interp{D''_2}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo Then $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                  \interp{D_1}(\delta, \interp{D_0}\delta, \delta') \;\interp{\oplus}^2 \;
                  \interp{D_2}(\delta, \interp{D_0}\delta, \delta')$ \\
      \oooo Then by coherence and IH, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                \interp{D'_1}(\delta, \delta') \;\interp{\oplus}^2 \;
                \interp{D'_2}(\delta, \delta')$ \\
      \oooo By semantics, $\interp{D'}(\delta, \delta') = 
                \interp{D'_1}(\delta, \delta') \;\interp{\oplus}^2 \;
                \interp{D'_2}(\delta, \delta')$ \\
      \oooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermPropQuantify}:
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{Q u':\omega'. q}{\assert}$ \\
      \oo By substitution on $D$, we have 
           $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](Q u':\omega'. q)}{\assert}$ \\
      \ooo By inversion on $D$ we have
           $D_1 :: \judgeA[{\Delta, u:\omega, \Delta', u':\omega'}]{q}{\assert}$ \\
      \ooo By inversion on $D'$ we have
           $D_2 :: \judgeA[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]q}{\assert}$ \\
      \ooo By induction on $D_1$, we have $D'_2$ such that \\
      \ooox $\forall (\delta, \interp{D_0}\delta, \delta', v) \in 
                     \interp{\judgeACtx{\Delta, u:\omega, \Delta', u':\omega'}}, 
              \interp{D_1}(\delta, \interp{D_0}\delta, \delta', v) = 
              \interp{D'_2}(\delta, \delta', v)$ \\
      \ooo where $D'_2 :: \judgeA[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]q}{\assert}$ \\
      \ooo By coherence $\interp{D_2} = \interp{D'_2}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                     \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \oooox $\interp{Q}^\infty_{v \in \interp{\judgeSort[\Delta, u:\omega, \Delta']{\omega'}}(\delta, \interp{D_0}\delta, \delta')}
                \interp{D_1}
                (\delta, \interp{D_0}\delta, \delta', v)$ \\
      \oooo By substitution for sorts, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \oooox $\interp{Q}^\infty_{v \in \interp{\judgeSort[\Delta, [p/u]\Delta']{[p/u]\omega'}}(\delta, \delta')}
                \interp{D_1}(\delta, \interp{D_0}\delta, \delta', v)$ \\
      \oooo By induction, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \oooox $\interp{Q}^\infty_{v \in \interp{\judgeSort[\Delta, [p/u]\Delta']{[p/u]\omega'}}(\delta, \delta')}
                \interp{D''_1}(\delta, \delta', v)$ \\
      \oooo By coherence, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \oooox $\interp{Q}^\infty_{v \in \interp{\judgeSort[\Delta, [p/u]\Delta']{[p/u]\omega'}}(\delta, \delta')}
                \interp{D'_1}(\delta, \delta', v)$ \\
      \oooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') =  
                           \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermPointsTo}:
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{e \pointsto_A e'}{\assert}$ \\
      \oo By substitution on $D$, we have $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](e \pointsto_A e')}{\assert}$ \\
      \ooo By inversion on $D$, we have: \\
      \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{e}{\reftype{A}}$ \\
      \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{e'}{A}$ \\
      \ooo By inversion on $D'$, we have: \\
      \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u](\reftype{A})}$ \\
      \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e'}{[p/u]A}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                     \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo By induction on $D_1$, we have $D''_1$ such that \\
      \ooooo $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
              \interp{D''_1}(\delta, \delta')$ \\
      \oooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u](\reftype{A})}$ \\
      \oooo By induction on $D_1$, we have $D''_1$ such that \\
      \ooooo $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
              \interp{D''_1}(\delta, \delta')$ \\
      \oooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u](\reftype{A})}$ \\
      \oooo By coherence, $\interp{D'_1} = \interp{D''_1}$ \\
      \oooo By coherence, $\interp{D'_2} = \interp{D''_2}$ \\
      \oooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \ooooox let $l = \interp{D_1}(\delta, \interp{D_0}, \delta')$ in \\
      \ooooox let $v = \interp{D_2}(\delta, \interp{D_0}, \delta')$ in \\
      \oooooox $\setof{(\setof{l}, \semfun{loc}{v \mbox{ when }loc = l})}$ \\
      \oooo By induction and coherence, we get $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \ooooox let $l = \interp{D'_1}(\delta, \delta')$ in \\
      \ooooox let $v = \interp{D'_2}(\delta, \delta')$ in \\
      \oooooox $\setof{(\setof{l}, \semfun{loc}{v \mbox{ when }loc = l})}$ \\
      \oooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                       \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermEqual}:
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{q =_{\omega'} q'}{\assert}$ \\
      \oo By substitution on $D$, we have $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](q =_{\omega'} q')}{\assert}$ \\
      \ooo By inversion on $D$, we have: \\
      \oooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\omega'}$ \\
      \oooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q'}{\omega'}$ \\
      \ooo By inversion on $D'$, we have: \\
      \oooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u](\omega')}$ \\
      \oooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q'}{[p/u]A}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                     \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo By induction on $D_1$, we have $D''_1$ such that \\
      \ooooo $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
              \interp{D''_1}(\delta, \delta')$ \\
      \oooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u](\omega')}$ \\
      \oooo By induction on $D_1$, we have $D''_1$ such that \\
      \ooooo $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
              \interp{D''_1}(\delta, \delta')$ \\
      \oooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u](\omega')}$ \\
      \oooo By coherence, $\interp{D'_1} = \interp{D''_1}$ \\
      \oooo By coherence, $\interp{D'_2} = \interp{D''_2}$ \\
      \oooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \oooox if $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
                  \interp{D_2}(\delta, \interp{D_0}\delta, \delta')$ \\
      \oooox then $\top$ \\
      \oooox else $\bot$ \\
      \oooo By induction and coherence, we get $\interp{D}(\delta, \interp{D_0}\delta, \delta') = $ \\
      \oooox if $\interp{D'_1}(\delta, \delta') = 
                 \interp{D'_2}(\delta, \delta')$ \\
      \oooox then $\top$ \\
      \oooox else $\bot$ \\
      \oooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                       \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}


  \item Case \textsc{TermSpec}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{\validprop{S}}{\assert}$ \\
      \oo By substitution on $D$, we have 
          $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\validprop{S}}{\assert}$ \\
      \oo By inversion on $D$ we have 
          $D_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$ \\
      \oo By inversion on $D'$ we have 
          $D'_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$ \\
      \oo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                     \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \ooo By mutual induction on $D_1$, we have $D''_1$ such that \\
      \ooox $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
            \interp{D''_1}(\delta, \delta')$\\
      \ooo where $D''_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$ \\
      \ooo By coherence $\interp{D''_1} = \interp{D'_1}$ \\
      \ooo So $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
               \interp{D'_1}(\delta, \delta')$ \\
      \ooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
            \mbox{if}(\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = \top_{\upset{W(\powerset{H})}}, \top, \bot)$ \\
      \ooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
            \mbox{if}(\interp{D'_1}(\delta, \delta') = \top_{\upset{W(\powerset{H})}}, \top, \bot)$ \\
      \ooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{TermEqSort}:
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega,\Delta'}]{q}{\omega'}$ \\
      \oo By substitution on $D$, we have 
          $D' :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega'}$ \\
      \ooo By inversion on $D$, we have \\
      \oooo $D_1 :: \judgeA[{\Delta, u:\omega,\Delta'}]{q}{\omega''}$ \\
      \oooo $D_2 :: \judgeSortEq[{\Delta, u:\omega,\Delta'}]{\omega'}{\omega''}$ \\
      \ooo By inversion on $D'$, we have \\
      \oooo $D'_1 ::      \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega''}$ \\
      \oooo $D'_2 :: \judgeSortEq[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}{[p/u]\omega''}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                   \interp{\judgeACtx{\Delta, u:\omega,\Delta'}}$ \\
      \oooo By induction hypothesis, there is $D''_1$ such that \\
      \oooox $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
              \interp{D''_1}(\delta, \delta')$ \\
      \oooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{[p/u]\omega''}$ \\
      \oooo By coherence $\interp{D''_1} = \interp{D'_1}$ \\
      \oooo Therefore $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = 
                       \interp{D'_1}(\delta, \delta')$ \\
      \oooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                       \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}
  \end{itemize}

\item Now we want to show if $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S}$, then
  then there is a $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]S}$ such
  that for all $(\delta, \interp{D_0}\;\delta, \delta') \in 
                \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
  we have that $\interp{D}\;(\delta, \interp{D_0}\;\delta, \delta') = \interp{D'}\;(\delta, \delta')$ 

  \begin{itemize}
  \item Case \textsc{SpecTriple}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\spec{q}{c}{a:A}{r}}$ \\
      \oo By substitution on $D$, we have $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]\spec{q}{c}{a:A}{r}}$ \\
      \oo By inversion on $D$, we have \\
      \ooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
      \ooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{\comp{c}}{\monad{A}}$ \\
      \ooo $D_3 :: \judgeA[{\Delta, u:\omega, \Delta', a:A}]{r}{\assert}$ \\
      \oo By inversion on $D'$, we have \\ 
      \ooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\                  
      \ooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\comp{c}}{[p/u](\monad{A})}$ \\  
      \ooo $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[[p/u]r}{\assert}$ \\       
      \oo By inversion on $D_2$, we have \\
      \ooo $D_4 :: \judgeE[\restrictkind{\Delta,u:\kappa,\Delta'}]
                           {\restricttype{\Delta,u:\kappa,\Delta'}}{\comp{c}}{\monad{A}}$ \\
      \oo By inversion on $D'_2$, we have \\
      \ooo $D'_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                           {\restricttype{\Delta,[p/u]\Delta'}}{[p/u]\comp{c}}{[p/u](\monad{A})}$ \\
      \oo Assume $(\delta, \interp{D_0}\;\delta, \delta')\in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \ooo By induction hypothesis, \\
      \oooo $\interp{D_1}(\delta, \interp{D_0}, \delta') = \interp{D''_1}(\delta, \delta')$\\
      \oooo $\interp{D_2}(\delta, \interp{D_0}, \delta') = \interp{D''_2}(\delta, \delta')$\\
      \oooo $\forall v.\; \interp{D_3}(\delta, \interp{D_0}, \delta', v) = \interp{D''_3}(\delta, \delta', v)$\\
      \ooo Where \\ 
      \oooo $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\                  
      \oooo $D''_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]\comp{c}}{[p/u](\monad{A})}$ \\  
      \oooo $D''_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[[p/u]r}{\assert}$ \\      
      \ooo By coherence, \\
      \oooo $\interp{D'_1} = \interp{D''_1}$\\
      \oooo $\interp{D'_2} = \interp{D''_2}$\\
      \oooo $\interp{D'_3} = \interp{D''_3}$\\
      \ooo By semantics, $\interp{D_2}(\delta, \interp{D_0}\delta, \delta') =$ \\
      \oooox             $U(\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                                      {(\delta, \interp{D_0}\delta, \delta')}))\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')})$\\
      \ooo This equals $U(\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                                      {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}))$\\
      \ooo because of the restriction property. \\
      \ooo Likewise, $\interp{D'_2}(\delta, \delta') = 
                       U(\interp{D'_4}\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}
                                      \restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooo Now, by cases on $\omega$: \\
      \oooo If $\omega = \kappa$: \\
      \ooooo By properties, $\restrictvals{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')} = 
                              \restricttyenv{\Delta, [p/u]\Delta'}{\delta, \delta'}$ \\
      \ooooo $\restricttype{\Delta, u:\omega, \Delta'} = 
              \restricttype{\Delta, \Delta'}$ \\
      \ooooo With these equations, plus substitution for types, \\
      \oooooo $\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}) =$\\
      \ooooox $\interp{D''_4}(\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')})\;
                          (\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooooo Where $D''_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                         {\restricttype{\Delta,[p/u]\Delta'}}{[p/u]\comp{c}}{[p/u](\monad{A})}$\\
      \ooooo By coherence $\interp{D''_4} = \interp{D'_4}$ \\

      \oooo When $\omega = B$: \\
      \ooooo By definitions, $\restrictkind{\Delta, u:B, \Delta'} = 
                              \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \ooooo By definitions, $\restricttyenv{\Delta, u:B, \Delta'}
                                            {(\delta, \interp{D_0}\delta, \delta')} =
                              \restricttyenv{\Delta, [p/u]\Delta'}
                                            {(\delta, \delta')}$ \\ 
      \ooooo With these equations, plus substitution for values, \\
      \oooooo $\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}) =$\\
      \ooooox $\interp{D''_4}(\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')})\;
                          (\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooooo Where $D''_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                         {\restricttype{\Delta,[p/u]\Delta'}}{[p/u]\comp{c}}{[p/u](\monad{A})}$\\
      \ooooo By coherence $\interp{D''_4} = \interp{D'_4}$ \\
      \oooo When $\omega \not= B$ and $\omega \not=\kappa$: \\
      \ooooo By definitions, $\restrictkind{\Delta, u:\omega, \Delta'} =
                              \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \ooooo By definitions, $\restricttype{\Delta, u:\omega, \Delta'} =
                              \restricttype{\Delta, [p/u]\Delta'}$ \\
      \ooooo By definitions, $\restricttyenv{\Delta, u:\omega, \Delta'}
                                            {(\delta, \interp{D_0}\delta, \delta')} = 
                              \restricttyenv{\Delta, [p/u]\Delta'}
                                            {(\delta, \delta')}$ \\
      \ooooo By definitions, $\restrictvals{\Delta, u:\omega, \Delta'}
                                           {(\delta, \interp{D_0}\delta, \delta')} = 
                              \restrictvals{\Delta, [p/u]\Delta'}
                                           {(\delta, \delta')}$ \\
      \ooooo Since $u \not\in FV(\comp{c})$, we have $\comp{c} = [p/u]\comp{c}$ \\
      \ooooo Since $u \not\in FV(\monad{A})$, we have $\monad{A} = [p/u](\monad{A})$ \\
      \ooooo With these equations, \\
      \oooooo $\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}) =$\\
      \ooooox $\interp{D_4}(\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')})\;
                          (\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooooo Where $D_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                             {\restricttype{\Delta,[p/u]\Delta'}}
                             {[p/u]\comp{c}}
                             {[p/u](\monad{A})}$\\
      \ooooo By coherence $\interp{D_4} = \interp{D'_4}$ \\
      \ooo By semantics, $\interp{D}(\delta, \interp{D_0}, \delta') = $  \\
      \oooo let $P = \interp{D_1}(\delta, \interp{D_0}\delta, \delta')$ in \\
      \oooo let $C = \interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')})$ in\\
      \oooo let $Q = \semfun{v}{\interp{D_3}(\delta, \interp{D_0}\delta, \delta', v)}$ in \\
      \oooox $\spec{P}{C}{a:A}{Q(a)}$ \\
      \ooo By equations, $\interp{D}(\delta, \interp{D_0}, \delta') = $  \\
      \oooo let $P = \interp{D'_1}(\delta, \delta')$ in \\
      \oooo let $C = \interp{D'_4}(\restricttyenv{\Delta, [p/u]\Delta'}
                                          {(\delta, \delta')})\;
                                       (\restrictvals{\Delta, [p/u]\Delta'}
                                                     {(\delta, \delta')})$ in\\
      \oooo let $Q = \semfun{v}{\interp{D'_3}(\delta, \delta', v)}$ in \\
      \oooox $\spec{P}{C}{a:A}{Q(a)}$ \\
      \ooo Therefore $\interp{D}(\delta, \interp{D_0}, \delta') = \interp{D'}(\delta,\delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{SpecMTriple}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\mspec{q}{c}{a:A}{r}}$ \\
      \oo By substitution on $D$, we have $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]\mspec{q}{c}{a:A}{r}}$ \\
      \oo By inversion on $D$, we have \\
      \ooo $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
      \ooo $D_2 :: \judgeA[{\Delta, u:\omega, \Delta'}]{e}{\monad{A}}$ \\
      \ooo $D_3 :: \judgeA[{\Delta, u:\omega, \Delta', a:A}]{r}{\assert}$ \\
      \oo By inversion on $D'$, we have \\ 
      \ooo $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\                  
      \ooo $D'_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u](\monad{A})}$ \\  
      \ooo $D'_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[[p/u]r}{\assert}$ \\       
      \oo By inversion on $D_2$, we have \\
      \ooo $D_4 :: \judgeE[\restrictkind{\Delta,u:\kappa,\Delta'}]
                           {\restricttype{\Delta,u:\kappa,\Delta'}}{e}{\monad{A}}$ \\
      \oo By inversion on $D'_2$, we have \\
      \ooo $D'_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                           {\restricttype{\Delta,[p/u]\Delta'}}{[p/u]e}{[p/u](\monad{A})}$ \\
      \oo Assume $(\delta, \interp{D_0}\;\delta, \delta')\in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \ooo By induction hypothesis, \\
      \oooo $\interp{D_1}(\delta, \interp{D_0}, \delta') = \interp{D''_1}(\delta, \delta')$\\
      \oooo $\interp{D_2}(\delta, \interp{D_0}, \delta') = \interp{D''_2}(\delta, \delta')$\\
      \oooo $\forall v.\; \interp{D_3}(\delta, \interp{D_0}, \delta', v) = \interp{D''_3}(\delta, \delta', v)$\\
      \ooo Where \\ 
      \oooo $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\                  
      \oooo $D''_2 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]e}{[p/u](\monad{A})}$ \\  
      \oooo $D''_3 :: \judgeA[{\Delta, [p/u]\Delta', a:[p/u]A}]{[[p/u]r}{\assert}$ \\      
      \ooo By coherence, \\
      \oooo $\interp{D'_1} = \interp{D''_1}$\\
      \oooo $\interp{D'_2} = \interp{D''_2}$\\
      \oooo $\interp{D'_3} = \interp{D''_3}$\\
      \ooo By semantics, $\interp{D_2}(\delta, \interp{D_0}\delta, \delta') =$ \\
      \oooox             $U(\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                                      {(\delta, \interp{D_0}\delta, \delta')}))\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')})$\\
      \ooo This equals $U(\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                                      {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}))$\\
      \ooo because of the restriction property. \\
      \ooo Likewise, $\interp{D'_2}(\delta, \delta') = 
                       U(\interp{D'_4}\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')}
                                      \restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooo Now, by cases on $\omega$: \\
      \oooo If $\omega = \kappa$: \\
      \ooooo By properties, $\restrictvals{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')} = 
                              \restricttyenv{\Delta, [p/u]\Delta'}{\delta, \delta'}$ \\
      \ooooo $\restricttype{\Delta, u:\omega, \Delta'} = 
              \restricttype{\Delta, \Delta'}$ \\
      \ooooo With these equations, plus substitution for types, \\
      \oooooo $\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}) =$\\
      \ooooox $\interp{D''_4}(\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')})\;
                          (\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooooo Where $D''_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                         {\restricttype{\Delta,[p/u]\Delta'}}{[p/u]e}{[p/u](\monad{A})}$\\
      \ooooo By coherence $\interp{D''_4} = \interp{D'_4}$ \\

      \oooo When $\omega = B$: \\
      \ooooo By definitions, $\restrictkind{\Delta, u:B, \Delta'} = 
                              \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \ooooo By definitions, $\restricttyenv{\Delta, u:B, \Delta'}
                                            {(\delta, \interp{D_0}\delta, \delta')} =
                              \restricttyenv{\Delta, [p/u]\Delta'}
                                            {(\delta, \delta')}$ \\ 
      \ooooo With these equations, plus substitution for values, \\
      \oooooo $\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}) =$\\
      \ooooox $\interp{D''_4}(\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')})\;
                          (\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooooo Where $D''_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                         {\restricttype{\Delta,[p/u]\Delta'}}{[p/u]e}{[p/u](\monad{A})}$\\
      \ooooo By coherence $\interp{D''_4} = \interp{D'_4}$ \\
      \oooo When $\omega \not= B$ and $\omega \not=\kappa$: \\
      \ooooo By definitions, $\restrictkind{\Delta, u:\omega, \Delta'} =
                              \restrictkind{\Delta, [p/u]\Delta'}$ \\
      \ooooo By definitions, $\restricttype{\Delta, u:\omega, \Delta'} =
                              \restricttype{\Delta, [p/u]\Delta'}$ \\
      \ooooo By definitions, $\restricttyenv{\Delta, u:\omega, \Delta'}
                                            {(\delta, \interp{D_0}\delta, \delta')} = 
                              \restricttyenv{\Delta, [p/u]\Delta'}
                                            {(\delta, \delta')}$ \\
      \ooooo By definitions, $\restrictvals{\Delta, u:\omega, \Delta'}
                                           {(\delta, \interp{D_0}\delta, \delta')} = 
                              \restrictvals{\Delta, [p/u]\Delta'}
                                           {(\delta, \delta')}$ \\
      \ooooo Since $u \not\in FV(e)$, we have $e = [p/u]e$ \\
      \ooooo Since $u \not\in FV(\monad{A})$, we have $\monad{A} = [p/u](\monad{A})$ \\
      \ooooo With these equations, \\
      \oooooo $\interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')}) =$\\
      \ooooox $\interp{D_4}(\restricttyenv{\Delta, [p/u]\Delta'}{(\delta, \delta')})\;
                          (\restrictvals{\Delta, [p/u]\Delta'}{(\delta, \delta')})$ \\
      \ooooo Where $D_4 :: \judgeE[\restrictkind{\Delta,[p/u]\Delta'}]
                             {\restricttype{\Delta,[p/u]\Delta'}}
                             {[p/u]e}
                             {[p/u](\monad{A})}$\\
      \ooooo By coherence $\interp{D_4} = \interp{D'_4}$ \\
      \ooo By semantics, $\interp{D}(\delta, \interp{D_0}, \delta') = $  \\
      \oooo let $P = \interp{D_1}(\delta, \interp{D_0}\delta, \delta')$ in \\
      \oooo let $C = \interp{D_4}(\restricttyenv{\Delta, u:\omega, \Delta'}
                                          {(\delta, \interp{D_0}\delta, \delta')})\;
                                       (\restrictvals{\Delta, u:\omega, \Delta'}
                                                     {(\delta, \interp{D_0}\delta, \delta')})$ in\\
      \oooo let $Q = \semfun{v}{\interp{D_3}(\delta, \interp{D_0}\delta, \delta', v)}$ in \\
      \oooox $\spec{P}{C}{a:A}{Q(a)}$ \\
      \ooo By equations, $\interp{D}(\delta, \interp{D_0}, \delta') = $  \\
      \oooo let $P = \interp{D'_1}(\delta, \delta')$ in \\
      \oooo let $C = \interp{D'_4}(\restricttyenv{\Delta, [p/u]\Delta'}
                                          {(\delta, \delta')})\;
                                       (\restrictvals{\Delta, [p/u]\Delta'}
                                                     {(\delta, \delta')})$ in\\
      \oooo let $Q = \semfun{v}{\interp{D'_3}(\delta, \delta', v)}$ in \\
      \oooox $\spec{P}{C}{a:A}{Q(a)}$ \\
      \ooo Therefore $\interp{D}(\delta, \interp{D_0}, \delta') = \interp{D'}(\delta,\delta')$ \\
    \end{tabbedproof}


  \item Case \textsc{SpecBinary}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_1 \oplus S_2}$ \\
      \oo By substitution, $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](S_1 \oplus S_2)}$ \\
      \oo By inversion on $D$, we have \\
      \ooo $D_1 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_1}$ \\
      \ooo $D_2 :: \judgeS[{\Delta, u:\omega, \Delta'}]{S_2}$ \\
      \oo By inversion on $D'$, we have \\
      \ooo $D'_1 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](S_1)}$ \\
      \ooo $D'_2 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](S_2)}$ \\
      \oo Assume $(\delta, \interp{D_0}, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \ooo By induction, we have $D''_1$ such that \\
      \ooox $\interp{D_1}(\delta, \interp{D_0}, \delta') = \interp{D''_1}(\delta, \delta')$ \\
      \ooo where $D''_1 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](S_1)}$ \\
      \ooo By induction, we have $D''_2$ such that \\
      \ooox $\interp{D_2}(\delta, \interp{D_0}, \delta') = \interp{D''_2}(\delta, \delta')$ \\
      \ooo where $D''_2 :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u](S_2)}$ \\
      \ooo By coherence $\interp{D'_1} = \interp{D''_1}$ \\
      \ooo By coherence $\interp{D'_2} = \interp{D''_2}$ \\
      \ooo By semantics, $\interp{D}(\delta, \interp{D_0}, \delta') = 
                          \interp{D_1}(\delta, \interp{D_0}\delta, \delta') \;\interp{\oplus}\;
                          \interp{D_2}(\delta, \interp{D_0}\delta, \delta')$ \\
      \ooo By IH and coherence, $\interp{D}(\delta, \interp{D_0}, \delta') = 
                          \interp{D'_1}(\delta,\delta') \;\interp{\oplus}\;
                          \interp{D'_2}(\delta,\delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{SpecAssert}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeS[{\Delta, u:\omega, \Delta'}]{\setof{q}}$ \\
      \oo Assume $D' :: \judgeS[{\Delta, [p/u]\Delta'}]{[p/u]\setof{q}}$ \\
      \ooo By inversion on $D$, we have $D_1 :: \judgeA[{\Delta, u:\omega, \Delta'}]{q}{\assert}$ \\
      \ooo By inversion on $D'$, we have $D'_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                   \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \ooo By mutual IH, $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') =
                          \interp{D''_1}(\delta, \delta')$ \\
      \ooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u]q}{\assert}$ \\
      \ooo By coherence $\interp{D'_1} = \interp{D''_1}$ \\
      \ooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') =$ 
              if $\interp{D_1}(\delta, \interp{D_0}\delta, \delta') = \top_{\powerset{H}}$ then $\top$ else $\bot$ \\
      \ooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') =$ 
              if $\interp{D'_1}(\delta, \delta') = \top_{\powerset{H}}$ then $\top$ else $\bot$ \\
      \ooo By semantics, $\interp{D'}(\delta, \delta') =$ 
              if $\interp{D'_1}(\delta, \delta') = \top_{\powerset{H}}$ then $\top$ else $\bot$ \\
      \ooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                      \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}

  \item Case \textsc{SpecQuantify}: 
    \begin{tabbedproof}
      \oo Assume $D :: \judgeA[{\Delta, u:\omega, \Delta'}]{Q u':\omega'.\; q}{\assert}$ \\
      \oo Assume $D':: \judgeA[{\Delta, [p/u]\Delta'}]{[p/u](Q u':\omega'.\;q)}{\assert}$ \\
      \ooo By inversion on $D$, we have 
            $D_1 :: \judgeA[{\Delta, u:\omega, \Delta', u':\omega'}]{q}{\assert}$ \\
      \ooo By inversion on $D'$, we have 
            $D'_1 :: \judgeA[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]q}{\assert}$ \\
      \ooo Assume $(\delta, \interp{D_0}\delta, \delta') \in 
                   \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
      \oooo By IH, $\forall v.\; \interp{D_1}(\delta, \interp{D_0}\delta, \delta', v) = 
                    \interp{D''_1}(\delta, \delta', v)$ \\
      \oooo where $D''_1 :: \judgeA[{\Delta, [p/u]\Delta', u':[p/u]\omega'}]{[p/u]q}{\assert}$ \\
      \oooo By coherence $\interp{D'_1} = \interp{D''_1}$ \\
      \oooo By semantics, $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                  \interp{Q}_{v \in \interp{\judgeSort[\Delta, u:\omega, \Delta']{\omega'}}(\delta, \interp{D_0}\delta, \delta')}
                      \interp{D_1}(\delta, \interp{D_0}\delta, \delta', v)$ \\
      \oooo By substitution for sorts, and IH $\interp{D}(\delta, \interp{D_0}\delta, \delta')=$\\
      \oooox $\interp{Q}_{v \in \interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}}(\delta, \delta')}
                      \interp{D'_1}(\delta, \delta', v)$ \\
      \oooo Therefore $\interp{D}(\delta, \interp{D_0}\delta, \delta') = 
                       \interp{D'}(\delta, \delta')$ \\
    \end{tabbedproof}
  \end{itemize}
\end{enumerate}
\end{proof}


\subsubsection{The Restriction Operations}

\begin{lemma*}{(Restriction on Kinds Makes Sense)}
If $D :: \judgeACtx{\Delta}$ and $\delta \in \interp{D}$, then 
$\restricttyenv{\Delta}{\delta} \in \interp{\restrictkind{\Delta}}$. 
\end{lemma*}
\begin{proof}
We proceed by induction on $D$. \\
\begin{itemize}
\item Case \textsc{CtxNil}:
  \begin{tabbedproof}
    \oo Assume $D :: \judgeACtx{\cdot}$ \\
    \oo Assume $\delta \in \interp{D}$ \\
    \ooo Then $\interp{D} = 1$, and $\delta = \unit$ \\
    \ooo By semantics, $\restrictkind{\cdot} = \cdot$ \\
    \ooo By semantics, $\restricttyenv{\cdot}{\unit} = \unit$ \\
    \ooo So $\interp{\restrictkind{\cdot}} = 1$\\
    \ooo So $\restricttyenv{\cdot}{\unit} \in \interp{\restrictkind{\cdot}}$ \\
  \end{tabbedproof}

\item Case \textsc{CtxCons}:
  \begin{tabbedproof}
    \oo Assume $D :: \judgeACtx{\Delta, u:\omega}$ \\
    \oo Assume $(\delta, x) \in \interp{D}$ \\
    \ooo By inversion on $D$, we have \\
    \oooo $D_1 :: \judgeACtx{\Delta}$ \\
    \oooo $D_2 :: \judgeSort{\omega}$ \\
    \ooo By semantics $\delta \in \interp{\judgeACtx{\Delta}}$ \\
    \ooo By semantics $x \in \interp{\judgeSort{\omega}}\delta$ \\
    \ooo By cases on $\omega$: \\
    \oooo If $\omega = \kappa$: \\
    \ooooo Then $\restrictkind{\Delta, u:\kappa} = \restrictkind{\Delta}, u:\kappa$ \\
    \ooooo Then $x \in \interp{\kappa}$ \\
    \ooooo Then $\restricttyenv{\Delta, u:\kappa}{(\delta,x)} = 
                (\restricttyenv{\Delta}{\delta}, x)$ \\
    \ooooo By induction, $\restricttyenv{\Delta}{\delta} \in \interp{\restrictkind{\Delta}}$ \\
    \ooooo By definition, $\interp{\restrictkind{\Delta, u:\kappa}} = \interp{\restrictkind{\Delta}} \times \interp{\kappa}$ \\
    \ooooo Therefore $(\restricttyenv{\Delta}{\delta}, x) \in \interp{\restrictkind{\Delta}} \times \interp{\kappa}$ \\
    \oooo If $\omega \not= \kappa$: \\
    \ooooo Then $\restrictkind{\Delta, u:\kappa} = \restrictkind{\Delta}$ \\
    \ooooo Then $\restricttyenv{\Delta, u:\kappa}{(\delta,x)} = 
                \restricttyenv{\Delta}{\delta}$ \\
    \ooooo By induction, $\restricttyenv{\Delta}{\delta} \in \interp{\restrictkind{\Delta}}$ \\
    \ooooo Therefore $\restricttyenv{\Delta, u:\omega}{(\delta, x)} \in \interp{\restrictkind{\Delta, u:\omega}}$ \\
  \end{tabbedproof}
\end{itemize}
\end{proof}

\begin{lemma*}{(Restriction for Values Makes Sense)}
\label{value-restriction}
If $\judgeACtx{\Delta}$ and $\delta \in \interp{\judgeACtx{\Delta}}$, 
then $\restrictvals{\Delta}{\delta} \in U(\interp{\restrictkind{\Delta} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta}{\delta}\;(K,K))$
\end{lemma*}
\begin{proof}
As before, we proceed by induction on $\judgeACtx{\Delta}$. 
\begin{itemize}
\item Case \textsc{CtxNil}: 
  \begin{tabbedproof}
    \oo Assume $D :: \judgeACtx{\cdot}$ \\
    \oo Assume $\delta \in \interp{\cdot}$ \\
    \ooo By semantics, $\interp{\cdot} = 1$ \\
    \ooo Therefore $\delta = \unit$ \\
    \ooo By semantics, $\restrictkind{\cdot} = \cdot$ \\
    \ooo By semantics, $\restricttype{\cdot} = \cdot$ \\
    \ooo By semantics, $\restricttyenv{\cdot}{\delta} = \unit$ \\
    \ooo Now, let $\eta = \unit$ in CPO. \\
    \ooo Then $\interp{\restrictkind{\cdot} \vdash \restricttype{\cdot}}\;\unit\;(K,K) = 1$ in CPO \\
    \ooo Since $U(1) = 1$, we have $\eta \in \interp{\restrictkind{\Delta} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta}{\delta}\;
            (K,K)$ \\
  \end{tabbedproof}

\item Case \textsc{CtxCons}: 
  \begin{tabbedproof}
    \oo Assume $D :: \judgeACtx{\Delta, u:\omega}$ \\
    \oo Assume $(\delta, x) \in \interp{\judgeACtx{\Delta, u:\omega}}$ \\
    \ooo By inversion on $D$: \\
    \oooo $D_1 :: \judgeACtx{\Delta}$ \\
    \oooo $D_2 :: \judgeSort{\omega}$ \\
    \ooo By semantics, $\delta \in \interp{D_1 :: \judgeACtx{\Delta}}$ \\
    \ooo By semantics, $x \in \interp{D_2 :: \judgeSort{\omega}}\;\delta$ \\
    \ooo By induction, there exists an $\eta$ such that \\
    \oooo $\restricttyenv{\Delta}{\delta} \in 
             U(\interp{\restrictkind{\Delta} \vdash \restricttype{\Delta}}\;
                      \restricttyenv{\Delta}{\delta}\;(K,K))$ and \\
    \ooo Case analyze $\omega$: \\
    \oooo If $\omega = \kappa$: \\
    \ooooo Then $\restrictkind{\Delta, u:\kappa} = \restrictkind{\Delta}, u:\kappa$ \\
    \ooooo Then $\restricttyenv{\Delta,u:\kappa}{(\delta,x)} = (\restricttyenv{\Delta}{\delta}, x)$ \\
    \ooooo Then $\restricttype{\Delta, u:\kappa} = \restricttype{\Delta}$ \\
    \ooooo Then $\restricttyenv{\Delta, u:\kappa}{(\delta, x)} = \restricttyenv{\Delta}{\delta}$ \\
    \ooooo By weakening, $\interp{\restrictkind{\Delta} \vdash
                              \restricttype{\Delta}}\; \restricttyenv{\Delta}{\delta} 
                          = 
                          \interp{\restrictkind{\Delta}, u:\kappa \vdash
                              \restricttype{\Delta}}\;
                      (\restricttyenv{\Delta}{\delta}, x)$\\
    \ooooo So $\restrictvals{\Delta}{\delta} \in U(\interp{\restrictkind{\Delta}, u:\kappa \vdash
                              \restricttype{\Delta}}\;
                      (\restricttyenv{\Delta}{\delta}, x)\;(K,K))$\\
    \ooooo So $\restrictvals{\Delta}{\delta} \in U(\interp{\restrictkind{\Delta}, u:\kappa \vdash
                              \restricttype{\Delta}}\;
                      \restricttyenv{\Delta,u:\kappa}{(\delta, x)}\;(K,K))$\\
    \ooooo So $\restrictvals{\Delta}{\delta} \in U(\interp{\restrictkind{\Delta}, u:\kappa \vdash
                              \restricttype{\Delta, u:\kappa}}\;
                      \restricttyenv{\Delta,u:\kappa}{(\delta, x)}\;(K,K))$\\
    \ooooo So $\restrictvals{\Delta}{\delta} \in U(\interp{\restrictkind{\Delta, u:\kappa} \vdash
                              \restricttype{\Delta, u:\kappa}}\;
                      \restricttyenv{\Delta,u:\kappa}{(\delta, x)}\;(K,K))$\\
    \ooooo Therefore 
        $\restricttyenv{\Delta,u:\kappa}{\delta,x} \in U(\interp{\restrictkind{\Delta, u:\kappa} \vdash
                                                                 \restricttype{\Delta, u:\kappa}}\;
                      \restricttyenv{\Delta,u:\kappa}{(\delta, x)}\;(K,K))$\\
    \oooo If $\omega = A$: \\
    \ooooo Then $\restrictkind{\Delta, u:A} = \restrictkind{\Delta}$ \\
    \ooooo Then $\restricttyenv{\Delta,u:A}{(\delta,x)} = \restricttyenv{\Delta}{\delta}$ \\
    \ooooo Then $\restricttype{\Delta, u:A} = \restricttype{\Delta}, u:A$ \\
    \ooooo Then $\restricttyenv{\Delta, u:A}{(\delta, x)} = (\restricttyenv{\Delta}{\delta}, x)$ \\
    \ooooo By equality,  
           $\interp{\restrictkind{\Delta} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta}{\delta}
            = 
            \interp{\restrictkind{\Delta, u:A} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta}{(\delta, x)}$ \\
    \ooooo So $\restrictvals{\Delta}{\delta} \in \interp{\restrictkind{\Delta, u:A} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta,u:A}{(\delta, x)}$ \\
    \ooooo Also, $x \in \interp{\judgeSort{A}}\;\delta$ \\
    \ooooo Therefore $x \in U(\interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}\;
                              \restricttyenv{\Delta}{\delta}\;(K,K))$ \\
    \ooooo Therefore $x \in U(\interp{\judgeWK[\restrictkind{\Delta, u:A}]{A}{\bigstar}}\;
                               \restricttyenv{\Delta, u:A}{(\delta, x)}\;(K,K))$ \\
    \ooooo Let $T \in CPO = \interp{\judgeWK[\restrictkind{\Delta, u:A}]{A}{\bigstar}}\;
                               \restricttyenv{\Delta, u:A}{(\delta, x)}\;(K,K)$ \\
    \ooooo Now, $\sqsubseteq_T$ is an order for the predomain, and $x \in U(T)$. \\
    \ooooo Therefore, $(\restrictvals{\Delta}{\delta}, x) \in 
                         U(\interp{\restrictkind{\Delta, u:A} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta, u:A}{(\delta, x)}) \times U(T)$ \\
    \ooooo Therefore, $(\restrictvals{\Delta}{\delta}, x) \in 
                         U(\interp{\restrictkind{\Delta, u:A} \vdash \restricttype{\Delta}}\;
            \restricttyenv{\Delta, u:A}{(\delta, x)} \times T)$ \\
    \ooooo Therefore, $(\restrictvals{\Delta}{\delta}, x) \in 
                         U(\interp{\restrictkind{\Delta, u:A} \vdash \restricttype{\Delta, u:A}}\;
            \restricttyenv{\Delta, u:A}{(\delta, x)})$ \\
    \ooooo Therefore, $\restrictvals{\Delta, u:A}{(\delta,x)} \in 
                         U(\interp{\restrictkind{\Delta, u:A} \vdash \restricttype{\Delta, u:A}}\;
            \restricttyenv{\Delta, u:A}{(\delta, x)})$ \\

    \oooo If $\omega \not= A$ and $\omega \not= \kappa$: \\
    \ooooo Then $\restrictkind{\Delta, u:\omega} = \restrictkind{\Delta}$ \\
    \ooooo Then $\restricttyenv{\Delta,u:\omega}{(\delta,x)} = \restricttyenv{\Delta}{\delta}$ \\
    \ooooo Then $\restricttype{\Delta, u:\omega} = \restricttype{\Delta}$ \\
    \ooooo Then $\restricttyenv{\Delta, u:\omega}{(\delta, x)} = \restricttyenv{\Delta}{\delta}$ \\
    \ooooo Therefore, $\restrictvals{\Delta,u:\omega}{(\delta,x)} \in 
              \interp{\restrictkind{\Delta, u:\omega} \vdash
                      \restricttype{\Delta, u:\omega}}\;
                     \restricttyenv{\Delta, u:\omega}{(\delta,x)}\;(K,K)$ \\

  \end{tabbedproof}
\end{itemize}
\end{proof}

\subsubsection{Semantics of Substitution}

\begin{lemma*}{(Substitution Preserves Meaning)}
Suppose we have that $\judgeA{p}{\omega}$.

\begin{enumerate}
\item If $\judgeACtx{\Delta, u:\omega, \Delta'}$ and either $u$ does not occur in any subterm of sort type in $\Delta'$, or  $\omega = \kappa$ and $p = \tau$, then  $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ if and only if $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$

\item  If $\judgeSort[\Delta, u:\omega, \Delta']{\omega'}$ and and either $u$ does not occur in any subterm of sort type in $\Delta'$ or $\omega'$, or $\omega = \kappa$ and $p = \tau$, then for all $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$, we have 
\begin{displaymath}
\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\omega'}}\;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}}\;(\delta, \delta')
\end{displaymath}
\end{enumerate}
\end{lemma*}
\begin{proof}
  We proceed by mutual induction on the derivations of context
  well-formedness and sort well-formedness. 

  As a note, even though contexts are properly maximally nested tuples
  (a la Lisp s-expressions), we will overload the tuple notation and
  treat expressions like $(\delta, \delta')$ as if the comma were a
  proper concatenation that reassociates everything. This is a
  harmless convenience thanks to the fact that tuples are associative
  up to isomorphism.

  \noindent Assume $D_0 :: \judgeA{p}{\omega}$ \\

  \begin{enumerate}
  \item First, we want to show $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in 
                                   \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$, 
      if and only if $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$
      
      \begin{itemize}
      \item Case \textsc{CtxNil}:
        \begin{tabbedproof}
          \oo Assume $\judgeACtx{\cdot}$ \\
          \ooo Therefore $\cdot = \Delta, u:\omega, \Delta'$ \\
          \ooo This is a contradiction; hence this case is impossible. \\
        \end{tabbedproof}

      \item Case \textsc{CtxCons}: 
        \begin{tabbedproof}
          \oo Assume $D :: \judgeACtx{\Delta_1, u_1:\omega_1}$ \\
          \oo Assume either $u$ does not occur in any subterm of sort type in $\Delta'$, \\
          \ox or $\omega = \kappa$ and $p = \tau$ \\
          \oo Therefore $\Delta, u:\omega, \Delta' = \Delta_1, u_1:\omega_1$ \\
          \oo $\Rightarrow$ direction:\\
          \ooo Assume $(\delta, \interp{\judgeA[\Delta]{p}{\omega}}\;\delta, \delta') \in 
                       \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
          \oooo Case analyze $\Delta'$: \\
          \ooooo If $\Delta' = \cdot$: \\
          \oooooo Then $\delta' = \unit$ \\
          \oooooo Then $\Delta = \Delta_1$ and $u = u_1$ and $\omega = \omega_1$ \\
          \oooooo By inversion on $D :: \judgeACtx{\Delta_1, u:\omega}$, we get:\\
          \ooooooo $D_1 :: \judgeACtx{\Delta}$ \\
          \ooooooo $D_2 :: \judgeSort[\Delta]{\omega}$ \\
          \oooooo By definition, $\delta \in \interp{\judgeACtx{\Delta}}$ \\
          \oooooo By definition $[p/u]\cdot = \cdot$, and $\Delta, \cdot = \Delta$ \\
          \oooooo Since $\delta' = \unit$, we have $(\delta, \delta') \simeq \delta$ \\
          \oooooo Therefore $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
          \ooooo If $\Delta' = \Delta'', u'':\omega''$: \\
          \oooooo Then $\Delta, u:\omega, \Delta' = \Delta, u:\omega, \Delta'', u'':\omega''$ \\
          \oooooo Then $\delta' = (\delta'', v'')$ \\
          \oooooo By inversion on $D$, we get: \\
          \ooooooo $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'', u'':\omega''}$ \\
          \ooooooo $D_2 :: \judgeSort[{\Delta, u:\omega, \Delta''}]{\omega''}$ \\
          \oooooo Therefore, $(\delta, \interp{p}{\omega}\;\delta, \delta'') \in 
                             \interp{\Delta, u:\omega, \Delta''}$ \\
          \oooooo Therefore, $v'' \in 
                  \interp{\judgeSort[{\Delta, u:\omega, \Delta''}]{\omega''}}\;
                     (\delta, \interp{p}{\omega}\;\delta, \delta'')$ \\
          \oooooo Then, by induction on $D_1$, we have $(\delta, \delta'') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
          \oooooo Then, by mutual induction on $D_2$, we have \\ 
          \ooooox  $\interp{\judgeSort[{\Delta, u:\omega, \Delta''}]{\omega''}} 
                      \;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta'') 
                   $ \\
          \ooooox equals $\interp{\judgeSort[{\Delta, [p/u]\Delta''}]{[p/u]\omega''}}\;(\delta,\delta'')$ \\
          \oooooo Therefore, $v'' \in \interp{\judgeSort[{\Delta, [p/u]\Delta''}]{[p/u]\omega''}}\;(\delta,\delta'')$ \\ 
          \oooooo Therefore, 
                   $(\delta, \delta'', v'') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'', [p/u]\omega''}}$ \\
          \oooooo Therefore $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
          \oo $\Leftarrow$ direction:\\
          \ooo Assume $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
          \ooo Case analyze $\Delta'$: \\
          \oooo If $\Delta' = \cdot$: \\
          \ooooo Then $\delta' = \unit$ \\
          \ooooo Hence $\delta \in \interp{D_1 :: \judgeACtx{\Delta}}$ \\
          \ooooo Hence $(\delta, \interp{\judgeA{p}{\omega}}\;\delta) \in \interp{\judgeACtx{\Delta, u:\omega}}$ \\
          \oooo If $\Delta' = \Delta'', u'':[p/u]\omega''$: \\
          \ooooo Then $\delta' =\delta'', v$ \\
          \ooooo Hence $(\delta, \delta'') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta''}}$ \\
          \ooooo Hence $v \in \interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega''}}$ \\
          \ooooo By inversion on $D$, we have \\
          \ooooox $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta''}$ \\
          \ooooox $D_2 :: \judgeSort[{\Delta, u:\omega, \Delta''}]{\omega''}$ \\
          \ooooo By induction, we know that $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta'') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta''}}$ \\
          \ooooo By induction, we know that $\interp{\judgeSort[{\Delta,[p/u]\Delta''}]{[p/u]\omega''}}(\delta,\delta'')$ \\
          \oooox equals $\interp{\judgeSort[\Delta, u:\omega, \Delta'']{\omega''}}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta'')$ \\
          \ooooo Hence $v \in \interp{\judgeSort[\Delta, u:\omega, \Delta'']{\omega''}}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta'')$ \\
          \ooooo Hence $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta'', v) \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'', u'':\omega''}}$ \\
        \end{tabbedproof}
      \end{itemize}

  \item Now we want to show 
    \begin{displaymath}
      \interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\omega'}}\;(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega'}}\;(\delta, \delta')
    \end{displaymath}

    \begin{itemize}
    \item Case \textsc{SortKind}: 
      \begin{tabbedproof}
        \oo Assume we have $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\kappa}$ \\
        \oo By substitution we have $D_1 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\kappa}$ \\
        \oo Assume we have $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
        \oo Therefore we know $\judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \oo Therefore we know $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \oo By induction $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
        \oo Then $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\kappa}}\;
                     (\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\kappa}$ \\
        \oo Then $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{\kappa}}\;
                     (\delta, \delta') = \interp{[p/u]\kappa}$ \\
        \oo However, $[p/u]\kappa = \kappa$ \\
        \oo Hence $\interp{\kappa} = \interp{[p/u]\kappa}$ \\
        \oo Hence $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\kappa}}\;
                     (\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') $ \\
        \ox equals $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{\kappa}}\;
                     (\delta, \delta')$ \\
      \end{tabbedproof}

    \item Case \textsc{SortProp}: 
      \begin{tabbedproof}
        \oo Assume we have $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\assert}$ \\
        \oo Assume we have $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
        \ooo By substitution,  $D_1 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\assert}$ \\
        \ooo Therefore we know $\judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \ooo Therefore we know $\judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo By induction $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
        \ooo Then $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\assert}}\;
                     (\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = \interp{\assert}$ \\
        \ooo Then $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{\assert}}\;
                     (\delta, \delta') = \interp{[p/u]\assert}$ \\
        \ooo However, $[p/u]\assert = \assert$ \\
        \ooo Hence $\interp{\assert} = \interp{[p/u]\assert} = \powerset{H}$ \\
        \ooo Hence $\interp{\judgeSort[{\Delta, u:\omega, \Delta'}]{\assert}}\;
                     (\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') $ \\
        \oox equals $\interp{\judgeSort[{\Delta, [p/u]\Delta'}]{\assert}}\;
                     (\delta, \delta')$ \\
      \end{tabbedproof}

    \item Case \textsc{SortImp}: 
      \begin{tabbedproof}
        \oo Assume we have $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\omega_1 \To \omega_2}$ \\
        \oo Assume we have $(\delta, \delta') \in \interp{\judgeACtx{\Delta, [p/u]\Delta'}}$ \\
        \oo By substitution we have $E :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u](\omega_1 \To \omega_2)}$ \\
        \oo Then by inversion on $D$ we have:\\
        \ooo $D_1 :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\omega_1}$ \\
        \ooo $D_2 :: \judgeSort[{\Delta, u:\omega, \Delta'}]{\omega_2}$ \\
        \oo Then by inversion on $E$ we have:\\
        \ooo $E_1 :: \judgeSort[{\Delta ,[p/u]\Delta'}]{[p/u]\omega_1}$ \\
        \ooo $E_2 :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]\omega_2}$ \\
        \oo Therefore we know $\judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \oo By induction we know $(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') \in \interp{\judgeACtx{\Delta, u:\omega, \Delta'}}$ \\
        \oo By semantics, $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta')$\\
        \oox $= \interp{D_1}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta')
                 \to
                  \interp{D_2}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta')$\\
        \oo By semantics, $\interp{E}(\delta, \delta')$\\
        \oox $= \interp{E_1}(\delta, \delta')
                 \to
                  \interp{E_2}(\delta, \delta')$\\
        \oo By induction, we have 
              $\interp{D_1}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
               \interp{E_1}(\delta, \delta')$ \\
        \oo By induction, we have 
              $\interp{D_2}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
               \interp{E_2}(\delta, \delta')$ \\
        \oo Therefore $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
                        \interp{E}(\delta, \delta')$ \\
      \end{tabbedproof}



    \item Case \textsc{SortType}: 
      \begin{tabbedproof}
        \oo Assume $D :: \judgeSort[{\Delta, u:\omega, \Delta'}]{A}$ \\
        \oo By substitution, we have $D' :: \judgeSort[{\Delta, u:\omega, \Delta'}]{[p/u]A}$ \\
        \oo By inversion on $D$, we have: \\
        \ooo $D_1 :: \judgeACtx{\Delta, u:\omega, \Delta'}$ \\
        \ooo $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]{A}{\bigstar}$ \\
        \oo By inversion on $D'$ and the fact that $u$ either does not occur in $A$ \\
        \ox or $\omega = \kappa$ and $p = \tau$, together with substitution, we have: \\
        \ooo $D'_1 :: \judgeACtx{\Delta, [p/u]\Delta'}$ \\
        \ooo $D'_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]{[p/u]A}{\bigstar}$ \\
        \oo By semantics, 
             $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
              \interp{D_2}\;(\restricttyenv{\Delta, u:\omega, \Delta'}
             {(\delta, \interp{\judgeA{p}{\omega}}, \delta')})$ \\
        \oo Case-analyze $\omega$:\\
        \ooo If $\omega = \kappa$ and $u$ occurs:\\
        \oooo Then $D_0 :: \judgeA{\tau}{\kappa}$, where $p = \tau$ \\
        \oooo Then  $D_2 :: \judgeWK[\restrictkind{\Delta, u:\kappa, \Delta'}]{A}{\bigstar}$ \\
        \oooo By inversion on $D_0$, we have $D'_0 :: \judgeWK[\restrictkind{\Delta}]{\tau}{\kappa}$ \\
        \oooo By semantics, $\interp{D_0}\;\delta = \interp{D'_0}\;(\restricttyenv{\Delta}{\delta})$\\
        \oooo Let $\theta$ = $\restricttyenv{\Delta}{\delta}$ \\
        \oooo Then $\interp{D'_0}\;\theta$ = $\theta(\tau)$ \\ 
        \oooo Likewise, $\interp{D_2}(\delta,\theta(\tau), \delta') = \interp{\judgeWK[\restrictkind{\Delta,u:\omega,\Delta'}]{A}{\bigstar}}\;(\restricttyenv{\Delta,u:\kappa,\Delta'}{[\delta, \theta(\tau), \delta']})$ \\
        \oooo Hence $\interp{D_2}(\delta,\theta(\tau),\delta) = (\theta, u:\theta(\tau), \restricttyenv{\Delta'}{\delta'})(A)$\\
        \oooo By definition of substitutions, 
                 $\interp{D_2}(\delta,\theta(\tau),\delta) = (\theta, \restricttyenv{\Delta'}{\delta'})([\tau/u]A)$\\
        \oooo By weakening on $D'_0$, we have $D'_0 :: \judgeWK[\Delta, \Delta']{\tau}{\kappa}$\\
        \oooo By substitution of $D'_0$ into $D'_2$, we get
               $D'_3 :: \judgeWK[\restrictkind{\Delta, \Delta'}]{[\tau/u]A}{\bigstar}$ \\
        \oooo Since kinds have no free variables, 
               $D'_3 :: \judgeWK[\restrictkind{\Delta, [\tau/u]\Delta'}]{[\tau/u]A}{\bigstar}$ \\
        \oooo By definition, $\interp{D'_3}\;(\theta, \restricttyenv{\Delta'}{\delta'}) = 
                               (\theta, \restricttyenv{\Delta'}{\delta'})([\tau/u]A)$ \\
        \oooo Therefore $\interp{D'_3}\;(\theta, \restricttyenv{\Delta'}{\delta'}) = 
                         \interp{D_2}\;(\theta, \restricttyenv{\Delta'}{\delta'})$ \\
        \oooo By semantics, $\interp{D'}(\delta,\delta') = \interp{D'_3}\;(\theta, \restricttyenv{\Delta'}{\delta'})$ \\
        \oooo Therefore $\interp{D}(\delta, \interp{\judgeA{\tau}{\kappa}}\;\delta, \delta') = 
                          \interp{D'}(\delta,\delta')$ \\
        \ooo If $\omega \not= \kappa$: \\
        \oooo Then  $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]{A}{\bigstar}$ \\
        \oooo Because $\omega \not= \kappa$, 
                 $\restrictkind{\Delta, u:\omega, \Delta'} = \restrictkind{\Delta, \Delta'}$ \\
        \oooo Because kinds have no variables, 
                 $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
        \oooo Therefore $(\delta, \delta') \in \restrictkind{\Delta, [p/u]\Delta'}$ \\
        \oooo Because $u \not\in FV(A)$, $A = [p/u]A$ \\
        \oooo Thus $D_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]{[p/u]A}{\bigstar}$ \\
        \oooo Then by rule \textsc{SortType}, we have $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]A}$ \\
        \oooo So $\interp{D'}(\delta, \delta') = \interp{D_2}(\restricttyenv{\Delta,[p/u]\Delta'}{\delta, \delta'})$ \\
        \oooo But then, $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
                          \interp{D'}(\delta, \delta')$ \\
        \ooo If $u$ does not occur in $A$: \\
        \oooo Then  $D_2 :: \judgeWK[\restrictkind{\Delta, u:\omega, \Delta'}]{A}{\bigstar}$ \\
        \oooo We know $\restrictkind{\Delta, u:\omega, \Delta'} = \restrictkind{\Delta}, u:\omega, \restrictkind{\Delta'}$ \\
        \oooo Since $u$ does not occur, we can strengthen to $D'_2 :: \judgeWK[\restrictkind{\Delta}, \restrictkind{\Delta'}]{A}{\bigstar}$ \\
        \oooo Because kinds have no variables, 
                 $\restrictkind{\Delta, \Delta'} = \restrictkind{\Delta, [p/u]\Delta'}$ \\
        \oooo Therefore $(\delta, \delta') \in \restrictkind{\Delta, [p/u]\Delta'}$ \\
        \oooo Because $u \not\in FV(A)$, $A = [p/u]A$ \\
        \oooo Thus $D_2 :: \judgeWK[\restrictkind{\Delta, [p/u]\Delta'}]{[p/u]A}{\bigstar}$ \\
        \oooo Then by rule \textsc{SortType}, we have $D' :: \judgeSort[{\Delta, [p/u]\Delta'}]{[p/u]A}$ \\
        \oooo So $\interp{D'}(\delta, \delta') = \interp{D_2}(\restricttyenv{\Delta,[p/u]\Delta'}{\delta, \delta'})$ \\
        \oooo But then, $\interp{D}(\delta, \interp{\judgeA{p}{\omega}}\;\delta, \delta') = 
                          \interp{D'}(\delta, \delta')$ \\

      \end{tabbedproof}
    \end{itemize}
  \end{enumerate}
\end{proof}




\subsection{Soundness of Assertion Logic Axioms}

\begin{lemma}{(Getting Specs Into Assertions)} 
  If $\judgeS{S}$ is valid, then $\judgeA{\validprop{S}}{\assert}$ is valid. 
\end{lemma}
\begin{proof}
  Assume we have a suitable environment $\delta$. By hypothesis we know
$\interp{\judgeS{S}}\;\delta$ $=$ $\top$ in the specification lattice. However,
we know the interpretation of $\interp{\judgeA{\validprop{S}}{\assert}}\;\delta$ is 
equal to $\IfThenElse{\interp{\judgeS{S}}\;\delta = \top}{\top}{\bot}$, so it 
follows that $\interp{\judgeA{\validprop{S}}{\assert}}\;\delta = \top$ in the assertion
lattice. Hence it is true for all substitutions, and is therefore valid. 
\end{proof}\\

\begin{lemma}{(Getting Assertions out of Specs)}
If $\judgeA{p}{\assert}$, then $\judgeA{\validprop{\setof{p}} \implies p}{\assert}$ is valid. 
\end{lemma}
\begin{proof}
\begin{tabbedproof}
\oo Assume we have $\judgeA{p}{\assert}$ and a suitable $\delta$. \\ 
\oo We want to show that $\interp{\judgeA{\validprop{\setof{p}} \implies
    p}{\assert}}\;\delta$ is equal to $\top$.  \\
\oo This is equivalent to every $h \in H$ being in 
    $\interp{\judgeA{\validprop{\setof{p}} \implies p}{\assert}}\;\delta$ \\
\oo From the semantics of implication, we want to show that \\ 
\ooo if $h \in \interp{\judgeA{\validprop{\setof{p}}}{\assert}}\;\delta$, 
     then  $h \in \interp{\judgeA{p}{\assert}}\;\delta$. \\
\oo Assume we have an $h \in \interp{\judgeA{\validprop{\setof{p}}}{\assert}}\;\delta$. \\
\ooo We know  $\IfThenElse{\interp{\judgeS{\setof{p}}}\;\delta = \top}{\top}{\bot}$ \\
\ooo Since we have an $h$ in this set,  $\interp{\judgeS{\setof{p}}}\;\delta = \top$. \\
\ooo However,  $\interp{\judgeS{\setof{p}}}\;\delta = \IfThenElse{\interp{\judgeA{p}{\assert}}\;\delta = \top}{\top}{\bot}$ \\
\ooo So $\interp{\judgeA{p}{\assert}}\;\delta = \top$. \\ 
\ooo Since this is the full set of heaps $H$, it follows that $h \in \interp{\judgeA{p}{\assert}}\;\delta$. 
\end{tabbedproof}
\end{proof}


\begin{lemma}{(Soundness of Equality)}
  If $\judgeEqA{p}{q}{\omega}$ is a valid equality, then $\judgeA{p =_\omega q}{\assert}$ is valid.
\end{lemma}
\begin{proof}
\begin{tabbedproof}
\oo Assume $\judgeEqA{p}{q}{\omega}$ is a valid equality \\
\oo Assume we have a suitable $\delta$. \\ 
\ooo Then we know that $\interp{\judgeA{p}{\assert}}\;\delta = \interp{\judgeA{q}{\omega}}\;\delta$. \\
\ooo By semantics $\interp{\judgeA{p =_\omega q}{\assert}}\;\delta = \IfThenElse{\interp{\judgeA{p}{\omega}}\;\delta = \interp{\judgeA{q}{\omega}}\;\delta}{\top}{\bot}$ \\
\ooo Therefore $\interp{\judgeA{p =_\omega q}{\assert}}\;\delta = \top$ \\
\oo Therefore $\judgeA{p =_\omega q}{\assert}$ is valid.
\end{tabbedproof}
\end{proof}

\subsection{Soundness of Program Logic Axioms}

\begin{lemma}{(Validity and Classical and Intuitionistic Implication)}
The statement that $\judgeS{S_1 \specimp S_2}$ is valid is logically equivalent to: if
for all $\delta$ and $r$, if $r \in \interp{\judgeS{S_1}}\;\delta$ then $r \in \interp{\judgeS{S_2}}\;\delta$  
\end{lemma}

\begin{proof}
  \begin{tabbedproof}
    \oo $\To$ direction:\\
    \ooo Assume $\judgeS{S_1 \specimp S_2}$ is valid\\
    \oooo We want to show for all $\delta$ and $r$, if $r \in \interp{\judgeS{S_1}}\;\delta$, then 
          $r \in \interp{\judgeS{S_2}}\;\delta$ \\
    \oooo Assume $\delta$ is an appropriate substitution, and $r$ such that $r \in \interp{\judgeS{S_1}}\;\delta$ \\
    \ooooo We want to show $r \in \interp{\judgeS{S_2}}\;\delta$ \\
    \oooooo From the hypothesis we know that $\interp{\judgeS{S_1 \specimp S_2}}\;\delta = \top$ \\
    \oooooo So we know for all $r$ and $s \worldgeq r$, that \\
    \oooooox if $s \in \interp{\judgeS{S_1}}\;\delta$ then $s \in \interp{\judgeS{S_2}}\;\delta$ \\
    \oooooo Since $r \worldgeq r$, we know if $r \in \interp{\judgeS{S_1}}\;\delta$ then $s \in \interp{\judgeS{S_2}}\;\delta$ \\
    \oooooo Since $r \in \interp{\judgeS{S_1}}\;\delta$, we know that $r \in \interp{\judgeS{S_2}}\;\delta$ \\
    \oo $\From$ direction:\\
    \ooo Assume for all $\delta$ and $r$, if $r \in \interp{\judgeS{S_1}}\;\delta$, then 
          $r \in \interp{\judgeS{S_2}}\;\delta$ \\
    \oooo We want to show for all $\delta$ that $\interp{\judgeS{S_1 \specimp S_2}}\;\delta = \top$ \\
    \oooo Assume $\delta$ is a suitable substitution \\
    \ooooo So we want to show $\interp{\judgeS{S_1 \specimp S_2}}\;\delta = \top$ \\
    \ooooo So we want to show for all $r$ and $s \worldgeq r$, that \\
    \ooooox if $s \in \interp{\judgeS{S_1}}\;\delta$ then $s \in \interp{\judgeS{S_2}}\;\delta$ \\
    \ooooo Assume $r$ and $s$ such that $s \worldgeq r$ and $s \in \interp{\judgeS{S_1}}\;\delta$ \\
    \oooooo Instantiate the quantifier in the hypothesis with $\delta$ and $s$, so we learn \\
    \oooooox if $s \in \interp{\judgeS{S_1}}\;\delta$ then $s \in \interp{\judgeS{S_2}}\;\delta$ \\
    \oooooo Since $s \in \interp{\judgeS{S_1}}\;\delta$ we can conclude $s \in \interp{\judgeS{S_2}}\;\delta$ \\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Equivalence of the Two Forms of Triples)}
We have that $\judgeS{\spec{p}{c}{a:A}{q}}$ is valid if and only if $\judgeS{\mspec{p}{\comp{c}}{a:A}{q}}$ is valid.
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo We want to show that for all suitable $\delta$, $\judgeS{\spec{p}{c}{a:A}{q}} = \top$  \\
\ox iff $\judgeS{\mspec{p}{\comp{c}}{a:A}{q}} = \top$  \\
\oo Now, let \\
\oox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
\oox $E = \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}
                  {[c]}{A}} \;(\restricttyenv{\Delta}{\delta})
                            \;(\restrictvals{\Delta}{\delta})$ \\
\oox $C = \interp{\judgeC[\restrictkind{\Delta}]{\restricttype{\Delta}}
                  {c}{A}} \;(\restricttyenv{\Delta}{\delta})
                          \;(\restrictvals{\Delta}{\delta})$ \\
\oox $Q = \semfun{v}{\interp{\judgeA[\Delta, a:A]{q}{\assert}}\;(\delta,v)}$ \\
\oo Observe that $E = C$, from the semantics of $\comp{c}$ \\
\oo $\Rightarrow$: Assume $\judgeS{\spec{p}{c}{a:A}{q}}$ is valid \\
\ooo Hence the semantic spec $\spec{P}{C}{a}{Q(a)} = \top$ \\
\ooo Hence $\spec{P}{E}{a}{Q(a)} = \top$ \\
\oo $\Leftarrow$: Assume $\judgeS{\mspec{p}{\comp{c}}{a:A}{q}}$ is valid \\
\ooo Hence the semantic spec $\spec{P}{E}{a}{Q(a)} = \top$ \\
\ooo Hence $\spec{P}{C}{a}{Q(a)} = \top$
\end{tabbedproof}
\end{proof}


\begin{lemma}{(Return Value Axiom)}
The schema $\judgeS{\spec{P}{e}{a:A}{P \land a = e}}$ is valid.
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo We want to show that for all suitable $\delta$, $\interp{\spec{P}{e}{a:A}{P \land a = e}}\;\delta = \top$ \\
\oo Now let \\
\oox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
\oox $C = \interp{\judgeC[\restrictkind{\Delta}]{\restricttype{\Delta}}
                  {e}{A}} \;(\restricttyenv{\Delta}{\delta})
                          \;(\restrictvals{\Delta}{\delta})$ \\
\oox $E = \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}
                  {e}{A}} \;(\restricttyenv{\Delta}{\delta})
                          \;(\restrictvals{\Delta}{\delta})$ \\
\oox $Q = \semfun{v}{\interp{\judgeA[\Delta, a:A]{P \land a = e}{\assert}}\;(\delta,v)}$ \\
\oo We want to show that $\spec{P}{C}{a}{Q(a)} = \top$ \\
\oo So we want to show that for all $R$, we have $R \in \spec{P}{C}{a}{Q(a)}$ \\
\oo Hence it suffices to show that $\basicspec{P * R}{C}{v}{P \land \interp{a = e}\;(\delta,v) * R}$ \\
\oo So we want to show that for all $h \in P * R$, we have $C\;\mathit{Best}(\semfun{v}{P \land \interp{a = e * R}\;(\delta,v)})\;h = \bot$ \\
\oo Assume we have $h \in P * R$ \\
\ooo Next, observe that $C\;k\;h = k\;E\;h$ \\
\ooo To show that $\mathit{Best}(\semfun{a}{P \land a = e * R})\;E\;h = \bot$, \\
\oox we need to show that $k\;\;E\;h = \bot$, for every $k \in \mathit{Approx}(\semfun{a}{P \land a = e *R})$ \\
\ooo So assume $k \in \mathit{Approx}(\semfun{v}{P \land \interp{a = e}\;(\delta,v) * R})$ \\
\oooo Therefore for all $v \in \interp{A}$, and $h \in Q(v) * R$, we know $k\;v\;h = \bot$ \\
\oooo We know $E \in \interp{A}$ \\
\oooo So we need to show that given $h \in P * R$, we have $h \in Q(E) * R$ \\
\ooooo Assume we have $h \in P * R$ \\
\ooooo So we need to show $h \in (P \land \interp{a = e}\;(\delta,E)) * R$ \\
\ooooo Note that $\interp{a = e}\;(\delta,E) = \top$ if $E = E$, which is true \\
\ooooo Hence $P = (P \land \interp{a = e}\;(\delta,E))$ \\
\ooooo Hence we need to show $h \in P * R$ \\
\ooooo This is a hypothesis, so we are done \\
\end{tabbedproof}
\end{proof}


\begin{lemma}{(Assignment Axiom)}
$\judgeS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}$ is valid  
\end{lemma}
\begin{proof}
  \begin{tabbedproof}
    \oo Assume $\delta \in \interp{\judgeACtx{\Delta}}$ \\
    \ooo We want to show $\interp{\judgeS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}}\;\delta = \top$ \\
    \ooo So we want to show $\forall r.\; r \in \interp{\judgeS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}}\;\delta$ \\
    \ooo Assume $r$ \\
    \oooo We want to show $r \in \interp{\judgeS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}}\;\delta$ \\
    \oooo Let $\theta = \restricttyenv{\Delta}{\delta}$ \\
    \oooo Let $\gamma = \restrictvals{\Delta}{\delta}$ \\
    \oooo Let $P = \interp{\judgeA{e \pointsto_A -}{\assert}}\;\delta$ \\
    \oooo Let $C = \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{\comp{e := e'}}{\monad{A}}}\;\theta\;\gamma$ \\
    \oooo Let $E = \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{\reftype{A}}}\;\theta\;\gamma$ \\
    \oooo Let $E' = \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e'}{A}}\;\theta\;\gamma$ \\
    \oooo let $Q = \semfun{v}{\interp{\judgeA{e \pointsto_A e'}{\assert}}\;(\delta, v)}$ \\
    \oooo We want to show $r \in \spec{P}{C}{a:A}{Q(a)}$ \\
    \oooo We want to show $\forall s \sqsupseteq r.\; \basicspec{P * s}{C}{a:A}{Q(a) * s}$ \\
    \oooo Assume $s \sqsupseteq r$ \\
    \ooooo We want to show $\basicspec{P * s}{C}{a:A}{Q(a) * s}$ \\
    \ooooo We want to show $\forall h \in (P * s).\; C\;Best(\semfun{a}{Q(a) * s})\;h = \bot$ \\
    \ooooo Assume $h \in P * s$ \\
    \oooooo By semantics $h \in P * s$ means $\exists h_1, h_2.\; h_1 \in P$, $h_2 \in s$, and
            $h_1 \# h_2$ \\
    \oooooo By semantics of assertions, $h_1 \in P$ means 
            $\exists v \in \interp{\judgeWK[\restrictkind{\Delta}]{A}{\bigstar}}\;\theta.\;
               h_1 = [E:v]$ \\
    \oooooo Expanding definitions, 
             $C = \semfun{k}{\semfun{h}{k\;\unit\;\mbox{if } E\in\domain{h} \mbox{ then } [h|E:E'] \mbox{ else }\top}}$ \\
    \oooooo Therefore $C\;Best(\semfun{a}{Q(a) * s})\;h = $ \\
    \oooooox $\mbox{if }E\in\domain{h_1 \cdot h_2} \mbox{ then }Best(\semfun{a}{Q(a) * s})\;\unit\;[h_1 \cdot h_2|E:E'] \mbox{ else } \top$ \\
    \oooooo Since $E \in \domain{h_1}$, we know $C\;Best(\semfun{a}{Q(a) * s})\;h = $ \\
    \oooooox $Best(\semfun{a}{Q(a) * s})\;\unit\;[h_1 \cdot h_2|E:E']$ \\
    \oooooo Therefore we want to show $Best(\semfun{a}{Q(a) * s})\;\unit\;[h_1 \cdot h_2|E:E'] = \bot$ \\
    \oooooo So we must show $\lnot \exists k \in Approx(\semfun{a}{Q(a) * s}).\; k\;\unit\;[h_1 \cdot h_2|E'] = \top$ \\
    \oooooo So we must show $\forall k \in Approx(\semfun{a}{Q(a) * s}).\; k\unit\;[h_1\cdot h_2|E:E'] = \bot$ \\
    \oooooo Assume $k \in Approx(\semfun{a}{Q(a) * s})$ \\
    \ooooooo Since $[h_1\cdot h_2|E:E'] = [E:E']\cdot h_2$, we want 
             $k\unit\;([E:E']\cdot h_2) = \bot$ \\
    \ooooooo Now, $k \in Approx(\semfun{a}{Q(a) * s})$ means $\forall v, h \in (Q(v) * s)\; k\;v\;h = \bot$ \\
    \ooooooo Now, instantiate the quantifier with $\unit$ and $[E:E']\cdot h_2$ \\
    \ooooooo Now we must check $[E:E']\cdot h_2 \in Q(\unit) * s$ \\
    \ooooooo We will check that $[E:E'] \in Q(\unit)$ and $h_2 \in s$ \\
    \ooooooo By semantics of assertions $Q(\unit) = \setof{[E:E']}$, so $[E:E'] \in Q(\unit)$ \\
    \ooooooo From line 19, $h_2 \in s$ \\
    \ooooooo Since $[E:E']$ has the same domain as $h_1$, we know $[E:E'] \# h_2$ \\
    \ooooooo Therefore $[E:E']\cdot h_2 \in Q(\unit) * s$ \\
    \ooooooo Therefore $k\unit\;[h_1\cdot h_2|E:E'] = \bot$ \\
    \oooooo Therefore $\forall k \in Approx(\semfun{a}{Q(a) * s}).\; k\unit\;[h_1\cdot h_2|E:E'] = \bot$ \\
    \oooooo Therefore $\lnot \exists k \in Approx(\semfun{a}{Q(a) * s}).\; k\;\unit\;[h_1 \cdot h_2|E'] = \top$ \\
    \oooooo Therefore $Best(\semfun{a}{Q(a) * s})\;\unit\;[h_1 \cdot h_2|E:E'] = \bot$ \\
    \ooooo Therefore $\forall h \in (P * s).\; C\;Best(\semfun{a}{Q(a) * s})\;h = \bot$ \\
    \ooooo Therefore $\basicspec{P * s}{C}{a:A}{Q(a) * s}$ \\
    \oooo Therefore $\forall s \sqsupseteq r.\; \basicspec{P * s}{C}{a:A}{Q(a) * s}$ \\
    \oooo Therefore $r \in \spec{P}{C}{a:A}{Q(a)}$ \\
    \ooo Therefore $\forall r.\; r \in \interp{\judgeS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}}\;\delta$ \\
    \ooo Therefore $\interp{\judgeS{\spec{e \pointsto_A -}{e := e'}{a:\unittype}{e \pointsto_A e'}}}\;\delta = \top$ \\
  \end{tabbedproof}
\end{proof}



\begin{lemma}{(Allocation Axiom)}
If $\judgeS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}$ is valid
\end{lemma}
\begin{proof}
  \begin{tabbedproof}
    \oo Assume $\delta \in \interp{\judgeACtx{\Delta}}$ \\
    \ooo We want to show $\interp{\judgeS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}}\delta = \top$ \\
    \ooo So we want to show $\forall r.\; r \in \interp{\judgeS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}}\delta$ \\
    \ooo Assume $r$, \\
    \oooo So we want to show $r \in \interp{\judgeS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}}\delta$ \\
    \oooo Let $\Theta = \restrictkind{\Delta}$ \\
    \oooo Let $\theta = \restricttyenv{\Delta}{\delta}$ \\
    \oooo Let $\Gamma = \restricttype{\Delta}$ \\
    \oooo Let $\gamma = \restrictvals{\Delta}{\delta}$ \\
    \oooo Let $C = \interp{\judgeE{\Gamma}{\comp{\newref{A}{e}}}{\monad{\reftype{A}}}\;\theta}\;\gamma$ \\
    \oooo Let $E = \interp{\judgeE{\Gamma}{e}{A}\;\theta}\;\gamma$ \\
    \oooo Let $Q = \semfun{v}{\interp{\judgeA[\Delta, a:\reftype{A}]{a \pointsto_A e}{\assert}}\;(\delta, v)}$ \\
    \oooo So we want to show $r \in \spec{I}{C}{a:A}{Q(a)}$ \\
    \oooo So we want to show $\forall s \sqsupseteq r.\; \basicspec{s}{C}{a:A}{Q(a)*s}$ \\
    \oooo Assume $s \sqsupseteq r$ \\
    \ooooo We want to show $\basicspec{s}{C}{a:A}{Q(a)*s}$ \\
    \ooooo We want to show $\forall h \in s.\; C\;Best(\semfun{a}{Q(a)*s})\;h = \bot$ \\
    \ooooo Assume $h \in s$ \\
    \oooooo Expanding definitions, $C\;Best((\semfun{a}{Q(a)*s})\;h = $ \\
    \oooooox let $l = (\max(\domain{h})+1, [\theta(A)])$ in $Best(\semfun{a}{Q(a)*s})\;l\;[h|l:E]$ \\
    \oooooo So let $l = (\max(\domain{h})+1, [\theta(A)])$ \\
    \oooooo We want to show $Best(\semfun{a}{Q(a)*s})\;l\;[h|l:E] = \bot$ \\
    \oooooo To show this, we must show $\lnot (\exists k \in Approx(\semfun{a}{Q(a)*s}).\;k\;l\;[h|l:E] = \top)$ \\
    \oooooo So we must show $\forall k \in Approx(\semfun{a}{Q(l)*s}).\;k\;l\;[h|l:E] = \bot)$ \\
    \oooooo Assume $k \in Approx(\semfun{a}{Q(a)*s})$ \\
    \ooooooo This means $\forall v, h \in Q(v)*s.\; k\;v\;h = \bot$ \\
    \ooooooo Instantiate $v$ with $l$, and $h$ with $[l:E]\cdot h$ \\
    \ooooooo Now we must check $[l:E]\cdot h \in Q(l) * s$ \\
    \ooooooo So we will check $[l:E] \in Q(l)$ and $h \in s$ \\
    \ooooooo Expanding definitions, $Q(l) = \setof{[l:E]}$, so $[l:E] \in Q(l)$ \\
    \ooooooo From line 18, $h \in s$ \\
    \ooooooo Since $l$ is bigger than anything in $\domain{h}$, it follows $[l:E] \# h$ \\
    \ooooooo Therefore $[l:E]\cdot h \in Q(l) * s$ \\
    \ooooooo Therefore $k\;l\;([l:E]\cdot h) = \bot$ \\
    \oooooo Therefore $\forall k \in Approx(\semfun{a}{Q(l)*s}).\;k\;l\;[h|l:E] = \bot)$ \\
    \ooooo Therefore $\forall h \in s.\; C\;Best(\semfun{a}{Q(a)*s})\;h = \bot$ \\
    \ooooo Therefore $\basicspec{s}{C}{a:A}{Q(a)*s}$ \\
    \oooo Therefore $\forall s \sqsupseteq r.\; \basicspec{s}{C}{a:A}{Q(a)*s}$ \\
    \oooo Therefore $r \in \spec{I}{C}{a:A}{Q(a)}$ \\
    \ooo Therefore $\forall r.\; r \in \interp{\judgeS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}}\delta$ \\
    \ooo Therefore $\interp{\judgeS{\spec{\emp}{\newref{A}{e}}{a:\reftype{A}}{a \pointsto e}}}\delta = \top$ \\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Read Axiom)}
We have that $\judgeS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto_A e' \land a = e'}}$ is valid.\end{lemma}
\begin{proof}
  \begin{tabbedproof}
    \oo Assume $\delta \in \interp{\judgeACtx{\Delta}}$ \\
    \ooo We want to show $\interp{\judgeS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto e' \land a = e'}}}\delta = \top$ \\
    \ooo So we want to show $\forall r.\; r \in \interp{\judgeS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto e' \land a = e'}}}\delta$ \\
    \ooo Assume $r$, \\
    \oooo So we want to show $r \in r \in \interp{\judgeS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto e' \land a = e'}}}\delta$ \\
    \oooo Let $\Theta = \restrictkind{\Delta}$ \\
    \oooo Let $\theta = \restricttyenv{\Delta}{\delta}$ \\
    \oooo Let $\Gamma = \restricttype{\Delta}$ \\
    \oooo Let $\gamma = \restrictvals{\Delta}{\delta}$ \\
    \oooo Let $P = \interp{\judgeA{e \pointsto_A e'}{\assert}}\;\delta$ \\
    \oooo Let $C = \interp{\judgeE{\Gamma}{\comp{!e}}{\monad{A}}\;\theta}\;\gamma$ \\
    \oooo Let $E = \interp{\judgeE{\Gamma}{e}{\reftype{A}}\;\theta}\;\gamma$ \\
    \oooo Let $E' = \interp{\judgeE{\Gamma}{e'}{A}\;\theta}\;\gamma$ \\
    \oooo Let $Q = \semfun{v}{\interp{\judgeA[\Delta, a:\reftype{A}]{e \pointsto_A e' \land a = e'}{\assert}}\;(\delta, v)}$ \\
    \oooo So we want to show $r \in \spec{P}{C}{a:A}{Q(a)}$ \\
    \oooo So we want to show $\forall s \sqsupseteq r.\; \basicspec{P*s}{C}{a:A}{Q(a)*s}$ \\
    \oooo Assume $s \sqsupseteq r$ \\
    \ooooo We want to show $\basicspec{P*s}{C}{a:A}{Q(a)*s}$ \\
    \ooooo We want to show $\forall h \in P*s.\; C\;Best(\semfun{a}{Q(a)*s})\;h = \bot$ \\
    \ooooo Assume $h \in P*s$ \\
    \oooooo There are $h_1$ and $h_2$ such that $h_1 \in P$, and $h_2 \in s$, and $h_1 \# h_2$ \\
    \oooooo Expanding definitions, $C\;Best(\semfun{a}{Q(a)*s})\;(h_1 \cdot h_2) = $ \\
    \oooooox if $E \in \domain{h}$ then $Best(\;(h\;E)\;h$ else $\top$ \\
    \oooooo From definition of $P$, $h_1 = [E:E']$ \\
    \oooooo Hence $E \in \domain{h_1}$, so $E \in \domain{h_1 \cdot h_2}$ \\
    \oooooo Hence $C\;Best((\semfun{a}{Q(a)*s})\;(h_1 \cdot h_2) = 
                   Best(\semfun{a}{Q(a)*s})\;(h\;E)\;h$ \\
    \oooooo So we want to show $Best(\semfun{a}{Q(a)*s})\;(h\;E)\;h = \bot$ \\
    \oooooo To show this, we must show $\lnot(\exists k \in Approx(\semfun{a}{Q(a)*s}).\; (h\;E)\;h = \top)$ \\
    \oooooo So we want $\forall k \in Approx(\semfun{a}{Q(a)*s}).\; (h\;E)\;h = \bot)$ \\
    \oooooo Assume $k \in Approx(\semfun{a}{Q(a)*s})$ \\
    \ooooooo So we know $\forall v, h \in Q(v)*s.\; k\;v\;h = \bot$ \\
    \ooooooo Instantiate with $v$ with $(h\;E)$, and $h$ with $h$ \\
    \ooooooo So we must show $h \in Q(h\;E)*s$ \\
    \ooooooo So we will check $h_1 \in Q(h\;E)$ and $h_2 \in s$, since $h_1 \cdot h_2 = h$ \\
    \ooooooo So we want to check $h_1 \in \interp{\judgeA{e \pointsto_A e'}{\assert}}\;\delta = P$ \\
    \ooooooox and also $h_1 \in \interp{\judgeA[\Gamma,a:A]{a = e'}{\assert}}(\delta,h\;E)$ \\
    \ooooooo We know $h_1 \in P$ by assumption \\
    \ooooooo Since $h\;E = E' = \interp{\judgeA{e'}{A}}\delta$, we know 
              $\interp{\judgeA[\Gamma,a:A]{a = e'}{\assert}}(\delta,h\;E) = H$ \\
    \ooooooo Therefore $h_1 \in \interp{\judgeA[\Gamma,a:A]{a = e'}{\assert}}(\delta,h\;E)$ \\
    \ooooooo We know $h_2 \in s$ by assumption\\
    \ooooooo Therefore $h \in Q(h\;E)*s$ \\
    \ooooooo Therefore we know $k\;(h\;E)\;h = \bot$ \\
    \oooooo Therefore $\forall k \in Approx((\semfun{a}{Q(a)*s}).\; (h\;E)\;h = \bot$ \\
    \oooooo Therefore $Best(\semfun{a}{Q(a)*s})\;(h\;E)\;h = \bot$ \\
    \ooooo Therefore $\forall h \in P*s.\; C\;Best(\semfun{a}{Q(a)*s})\;h = \bot$ \\
    \ooooo Therefore $\basicspec{P*s}{C}{a:A}{Q(a)*s}$ \\
    \oooo Therefore $\forall s \sqsupseteq r.\; \basicspec{P*s}{C}{a:A}{Q(a)*s}$ \\
    \oooo Therefore $r \in \spec{P}{C}{a:A}{Q(a)}$ \\
    \ooo Therefore $\forall r.\; r \in \interp{\judgeS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto e' \land a = e'}}}\delta$ \\
    \ooo Therefore $\interp{\judgeS{\spec{e \pointsto_A e'}{!e}{a:A}{e \pointsto e' \land a = e'}}}\delta = \top$ \\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Sequential Composition Axiom)}
Suppose $\judgeS{\mspec{p}{e}{x:A}{q}}$ is valid, and $\judgeS[\Delta,x:A]{\spec{q}{c}{a:B}{r}}$ is valid, and $x \not\in \FV{r}$. Then $\judgeS{\spec{p}{\letv{x}{e}{c}}{a:B}{r}}$ is valid. 
\end{lemma}

\begin{proof}
  \begin{tabbedproof}
    \oo Assume $\judgeS{\mspec{p}{e}{x:A}{q}}$ is valid \\
    \oo Assume $\judgeS[\Delta,x:A]{\spec{q}{c}{a:B}{r}}$ is valid\\
    \ooo Assume $\delta \in \interp{\judgeACtx{\Delta}}$ \\
    \oooo We want to show $\interp{\judgeS{\spec{p}{\letv{x}{e}{c}}{a:B}{r}}}\delta = \top$\\
    \oooo So we want $\forall t.\; t \in \interp{\judgeS{\spec{p}{\letv{x}{e}{c}}{a:B}{r}}}\delta$ \\
    \oooo Assume $t$ \\
    \ooooo Let $\Theta$ = $\restrictkind{\Delta}$ \\
    \ooooo Let $\theta$ = $\restricttyenv{\Delta}{\delta}$ \\
    \ooooo Let $\Gamma$ = $\restricttype{\Delta}$ \\
    \ooooo Let $\gamma$ = $\restrictvals{\Delta}{\delta}$ \\
    \ooooo Let $E = \interp{\judgeE{\Gamma}{e}{\monad{A}}}\;\theta\;\gamma$ \\
    \ooooo Let $F = \semfun{v}{\interp{\judgeE{\Gamma,x:A}{\comp{c}}{\monad{B}}}\;\theta\;(\gamma,v)}$ \\
    \ooooo Let $P = \interp{\judgeA{p}{\assert}}\delta$ \\
    \ooooo Let $Q = \semfun{v}{\interp{\judgeA[\Delta,x:A]{q}{\assert}}\;\delta}$ \\
    \ooooo Let $R = \semfun{v}{\semfun{v'}{\interp{\judgeA[\Delta,x:A,a:B]{q}{\assert}}\;(\delta, v, v')}}$ \\
    \ooooo Let $R' = \semfun{v'}{\interp{\judgeA[\Delta,a:B]{q}{\assert}}\;(\delta, v')}$ \\
    \ooooo Note $\forall v.\; R\;v = R'$ since $x \not\in \FV{r}$ \\
    \ooooo Let $C = \interp{\judgeE{\Gamma}{\comp{\letv{x}{e}{c}}}{\monad{B}}}\;\delta$ \\
    \ooooo By semantics, $C = F^*(E)$ \\
    \ooooo By definition of monadic lift, $C = \semfun{k}{E\;(\semfun{v}{F\;v\;k})}$ \\
    \ooooo So we want to show $t \in \spec{P}{C}{a:A}{R'(a)}$ \\
    \ooooo So we want $\forall u \sqsupseteq t.\; \basicspec{P * u}{C}{a:A}{(R'(a) * u)}$ \\
    \ooooo Assume $u \sqsupseteq t$ \\
    \oooooo So we want to show $\forall h \in P * u.\; C\;Best(\semfun{a}{R'(a) * u})\;h = \bot$\\
    \oooooo Assume $h \in P * u$ \\
    \ooooooo So we want to show $E\;(\semfun{v}{F\;v\;Best(\semfun{a}{R'(a)*u})})\;h = \bot$ \\
    \ooooooo We know $\judgeS{\mspec{p}{e}{x:A}{q}}$ is valid \\
    \ooooooo Instantiating with the environment $\delta$, we get $\forall t.\; t \in \spec{P}{E}{a:A}{Q(a)}$ \\
    \ooooooo Thus $\forall t, u \sqsupseteq t.\; \basicspec{P * u}{E}{a:A}{Q(a) * u}$ \\
    \ooooooo Thus $\forall t, u \sqsupseteq t, h \in P * u, E\;Best(\semfun{a}{Q(a) * u})\;h = \bot$ \\
    \ooooooo Instantiating, we get $E\;Best(\semfun{a}{Q(a) * u})\;h = \bot$ \\
    \ooooooo So it suffices to show $(\semfun{v}{F\;v\;Best(\semfun{a}{R'(a)*u})}) \sqsubseteq 
                                Best(\semfun{a}{Q(a) * u})$ \\
    \ooooooo To do this, we can show $(\semfun{v}{F\;v\;Best(\semfun{a}{R'(a)*u})}) \in Approx(\semfun{a}{Q(a) * u})$ \\
    \ooooooo To do this, we must show $\forall v, h \in Q(v) * u, F\;v\;Best(\semfun{a}{R'(a)*u})\;h = \bot$ \\
    \ooooooo Assume $v, h \in Q(v) * u$ \\
    \oooooooo We know $\judgeS[\Delta,x:A]{\spec{q}{c}{a:B}{r}}$ is valid\\
    \oooooooo Instantiating with the environment $(\delta, v)$, we get \\
    \oooooooox $\forall v, t, u \sqsupseteq t, h \in Q(v) * u, (F\;v)\;Best(\semfun{a}{R\;v\;a * u})\;h = \bot$ \\
    \oooooooo Instantiating, we get $(F\;v)\;Best(\semfun{a}{R\;v\;a * u})\;h = \bot$ \\
    \oooooooo By equality, we get $(F\;v)\;Best(\semfun{a}{R'(a) * u})\;h = \bot$ \\
    \ooooooo Therefore $\forall v, h \in Q(v) * u, F\;v\;Best(\semfun{a}{R'(a)*u})\;h = \bot$ \\
    \ooooooo Therefore $(\semfun{v}{F\;v\;Best(\semfun{a}{R'(a)*u})}) \sqsubseteq 
                                Best(\semfun{a}{Q(a) * u})$ \\
    \ooooooo Therefore $(\semfun{v}{F\;v\;Best(\semfun{a}{R'(a)*u})}) \in Approx(\semfun{a}{Q(a) * u})$ \\                        
    \ooooooo Therefore $E\;(\semfun{v}{F\;v\;Best(\semfun{a}{R'(a)*u})})\;h = \bot$ \\
    \oooooo Therefore $\forall h \in P * u.\; C\;Best(\semfun{a}{R'(a) * u})\;h = \bot$\\
    \ooooo Therefore $\forall u \sqsupseteq t.\; \basicspec{P * u}{C}{a:A}{(R'(a) * u)}$ \\
    \ooooo Therefore $t \in \spec{P}{C}{a:A}{R'(a)}$ \\
    \oooo Therefore $\forall t.\; t \in \interp{\judgeS{\spec{p}{\letv{x}{e}{c}}{a:B}{r}}}\delta$ \\
    \oooo Therefore $\interp{\judgeS{\spec{p}{\letv{x}{e}{c}}{a:B}{r}}}\delta = \top$\\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Fixed Point Induction)}
We have that if 
\begin{displaymath}
   S \triangleq 
   \judgeS{(\forall x:\monad{A}.\; \mspec{p}x{a:A}{q(a)} \specimp \mspec{p}{e}{a:A}{q})}
\end{displaymath}
\noindent is valid, then 
\begin{displaymath}
  S' \triangleq \judgeS{\mspec{p}{\fix{x:\monad{A}}{e}}{a:A}{q}}
\end{displaymath}
is valid.
\end{lemma}

\begin{proof}
  \begin{tabbedproof}
    \oo Let $S = \forall x:\monad{A}.\; \mspec{p}x{a:A}{q(a)} \specimp \mspec{p}{e}{a:A}{q}$\\
    \oo Let $S' = \mspec{p}{\fix{x:\monad{A}}{e}}{a:A}{q}$ \\
    \oo Assume $\delta \in \interp{\judgeACtx{\Delta}}$ \\
    \ooo So we want to show $\interp{S'}\;\delta = \top$ \\
    \ooo Let $P = \interp{\judgeA{P}{\assert}}\;\delta$ \\
    \ooo Let $C = \interp{\judgeA{\fix{x:\monad{A}}{e}}{\monad{A}}}\;\delta$ \\
    \ooo Let $Q = \semfun{v}{\interp{\judgeA[\Delta,a:A]{q}{\assert}}\;(\delta,v)}$ \\
    \ooo Let $F(v) = \interp{\judgeA[\Delta,a:A]{e}{\monad{A}}}\;(\delta,v)$ \\
    \ooo So we want to show $\spec{P}{C}{a:A}{Q(a)} = \top$ \\
    \ooo We know $\interp{S}\;\delta = \top$ \\
    \ooo Thus for all $v$, we know $\interp{\mspec{p}x{a:A}{q(a)} \specimp \mspec{p}{e}{a:A}{q}}\;(\delta,v) = \top$ \\
    \ooo Thus we know for all $v$, $r$, and $s \sqsupseteq r$, \\
    \ooox if $s \in \interp{\mspec{p}x{a:A}{q(a)}}\;(\delta,v)$ then $s \in \interp{\mspec{p}{e}{a:A}{q}}\;(\delta,v)$ \\
    \ooo Since $x \not\in \FV{p}$, we know for all $v$, 
         $\interp{\judgeA[\Delta,x:\monad{A}]{p}{\assert}}\;(\delta,v) = P$ \\
    \ooo Since $x \not\in \FV{q}$, we know for all $v$, 
         $\semfun{v'}{\interp{\judgeA[\Delta,x:\monad{A}, a:A]{q}{\assert}}\;(\delta,v,v')} = Q$ \\
    \ooo Thus we know for all $v$, $r$, and $s \sqsupseteq r$, \\
    \ooox if $s \in  \spec{P}{v}{a:A}{Q(a)}$ then 
             $s \in \spec{P}{F(v)}{a:A}{Q(a)}$ \\
    \ooo This implies that for all $v$, if $\spec{P}{F(v)}{a:A}{Q(a)} = \top $ 
                                        then $\spec{P}{F(v)}{a:A}{Q(a)} = \top$ \\
    \ooo Then by the semantic fixed point theorem, 
          $\spec{P}{fix(F)}{a:A}{Q(a)} = \top$ \\
    \ooo So $\spec{P}{C}{a:A}{Q(a)} = \top$ \\
    \ooo Therefore $\interp{S'}\;\delta = \top$ \\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Assumptions From Preconditions)}
If we know that $\judgeS{\setof{r} \specimp \spec{p}{c}{a:A}{q}}$ is
valid, $r$ is a pure formula of separation logic, and we know that $p
\implies r$ is a valid truth of separation logic, then
$\judgeS{\spec{p}{c}{a:A}{q}}$ is valid.
\end{lemma}

\begin{proof}
  \begin{tabbedproof}
    \oo Assume $\judgeS{\setof{r} \specimp \spec{p}{c}{a:A}{q}}$ is valid \\
    \oo Assume $p \implies r$ is a valid truth of separation logic \\
    \ooo Now, we know that for all $\delta$, $\interp{\judgeS{\setof{r} \specimp \spec{p}{c}{a:A}{q}}}\;\delta$ is $\top$\\
    \ooo Now, we want to show for all $\delta$, that $\interp{\judgeS{\spec{p}{c}{a:A}{q}}}\;\delta = \top$ \\
    \ooo Assume $\delta$ is an environment \\
    \oooo So we want to show for all $r$, and all $s \worldgeq r$, that $\basicspec{P*s}{C}{a}{Q(a) * s}$ holds\\
    \ooox where \\
    \oooox $R = \interp{\judgeA{r}{\assert}}\;\delta$ \\
    \oooox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
    \oooox $C = \interp{\judgeC[\restrictkind{\Delta}]{\restricttype{\Delta}}{c}{A}}\;\theta\;\gamma$ \\
    \oooox $Q = \semfun{v}{\interp{\judgeA[\Delta,a:A]{q}{\assert}}\;(\delta,v)}$ \\
    \oooox $\theta = \restricttyenv{\Delta}{\delta}$ \\
    \oooox $\gamma = \restrictvals{\Delta}{\delta}$ \\
    \oooo To show $\basicspec{P*s}{C}{a}{Q(a)*s}$, we must show 
          $\forall h \in P * s.\; c\; (Best(\semfun{a}{Q(a)*s}))\;h = \bot$ \\
    \oooo Assume $h \in P * s$ \\
    \ooooo Since $p \implies r$ is a valid truth, we know $P \implies R$ and so $h \in R * s$ \\
    \ooooo Since $R$ is pure, we know $h \in R \land s$ \\
    \ooooo So we know $h \in R$ \\
    \ooooo Since $R$ is pure it is either $\emptyset$ or $H$, and since we know $h \in R$, $R = H$ \\
    \ooooo Therefore we know that $\interp{\judgeS{\setof{r}}}\;\delta = \top$ \\
    \ooooo Therefore we know that $\interp{\judgeS{\spec{p}{c}{a:A}{q}}}\;\delta = \top$ \\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Assumptions Into Preconditions)}
If we know that $\judgeS{\setof{r} \specimp \spec{p \land r}{c}{a:A}{q}}$ is
valid, then $\judgeS{\setof{r} \specimp \spec{p}{c}{a:A}{q}}$ is valid.
\end{lemma}

\begin{proof}
\begin{tabbedproof}
  \oo Assume $\judgeS{\setof{r} \specimp \spec{p \land r}{c}{a:A}{q}}$ is valid. \\
  \ooo This is equivalent to for all $\delta$ and $s$ if $s \in \interp{\setof{r}}\;\delta$, then $s \in \interp{\spec{p \land r}{c}{a:A}{q}}\;\delta$. \\
  \ooo We want to show that $\judgeS{\setof{r} \specimp \spec{p}{c}{a:A}{q}}$ is valid \\
  \ooo This is equivalent to showing for all $\delta$ and $s$, if $s \in \interp{\setof{r}}\;\delta$, then $s \in \interp{\spec{p}{c}{a:A}{q}}\;\delta$. \\
  \ooo Assume we have $\delta$ and $s$ such that $s \in \interp{\setof{r}}\;\delta$. \\
  \oooo We want to show $s \in \interp{\spec{p}{c}{a:A}{q}}\;\delta$ is valid. \\
  \oooo So we want to show for all $t \worldgeq s$, that $\basicspec{P*t}{C}{a}{Q(a) * t}$ holds\\
  \ooox where \\
  \oooox $R = \interp{\judgeA{r}{\assert}}\;\delta$ \\
  \oooox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
  \oooox $C = \interp{\judgeC[\restrictkind{\Delta}]{\restricttype{\Delta}}{c}{A}}\;\theta\;\gamma$ \\
  \oooox $Q = \semfun{v}{\interp{\judgeA[\Delta,a:A]{q}{\assert}}\;(\delta,v)}$ \\
  \oooox $\theta = \restricttyenv{\Delta}{\delta}$ \\
  \oooox $\gamma = \restrictvals{\Delta}{\delta}$ \\
  \oooo Assume $t \worldgeq s$, and $h \in P * t$. \\
  \ooooo We want to show that $C\;\mathit{Best}(\semfun{a}{Q(a) * s})\;h = \bot$ \\
  \ooooo Since $s \in \interp{\spec{p \land r}{c}{a:A}{q}}\;\delta$, we know $C\;\mathit{Best}(\semfun{a}{Q(a) * s})\;h = \bot$ if  $h \in (P \land R) * t$. \\
  \ooooo Since we assumed that $\interp{\setof{r}}\;\delta$ was non-empty, this means that $\interp{r}\;\delta = \top = H$. \\
  \ooooo Hence $h \in (P \land R) * t$. \\
  \ooooo Hence $C\;\mathit{Best}(\semfun{a}{Q(a) * s})\;h = \bot$ \\ 
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Getting Specs Out of Assertions)}
We have that $\judgeS{\setof{\validprop{S}} \specimp S}$ is valid.
\end{lemma}
\begin{proof}
  \begin{tabbedproof}
    \oo We want to show $\judgeS{\setof{\validprop{S}} \specimp S}$ is valid \\
    \oo Equivalently, we need for all $\delta$ and $r$, if $r \in \interp{\judgeS{\setof{\validprop{S}}}}\;\delta$\\
    \ox    then $r \in \interp{\judgeS{S}}\;\delta$ \\
    \oo Assume we have a suitable $\delta$ and $r$ such that $r \in \interp{\judgeS{\setof{\validprop{S}}}}\;\delta$ \\
    \ooo From the semantics, we know $\interp{\judgeS{\setof{\validprop{S}}}}\;\delta$ is either $\top$ or $\bot$ \\
    \ooo Since $r \in \interp{\judgeS{\setof{\validprop{S}}}}\;\delta$, we know it is non-empty, hence \\
    \ooox $\interp{\judgeS{\setof{\validprop{S}}}}\;\delta = \top$ \\
    \ooo Therefore, we know that $\interp{\judgeA{\validprop{S}}{\assert}}\;\delta = H$ \\
    \ooo Therefore, we know that $\interp{\judgeS{S}}\;\delta = \top$ \\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Existential Dropping)}
If $\judgeS{\spec{\exists u:\omega.\;p}{c}{a:A}{q}}$ is valid, then 
   $\judgeS[\Delta, u:\omega]{\spec{p}{c}{a:A}{q}}$ is valid. 
\end{lemma}

\begin{proof}
  \begin{tabbedproof}
    \oo Assume $\judgeS{\spec{\exists u:\omega.\;p}{c}{a:A}{q}}$ is valid \\
    \ooo We want to show $\judgeS[\Delta, u:\omega]{\spec{p}{c}{a:A}{q}}$ is valid \\
    \ooo So we want to show for all $\delta' = (\delta, v)$, that $\interp{\judgeS[\Delta, u:\omega]{\spec{p}{c}{a:A}{q}}}\;\delta' = \top$ \\
    \ooo Assume we have a suitable $\delta' = (\delta, v)$ \\ 
    \oooo We want to show for all $r$, that $r \in \spec{P}{C}{a}{Q(a)}$ \\
    \oooo where \\
    \oooox $P = \interp{\judgeA[\Delta, u:\omega]{p}{\assert}}\;\delta'$ \\
    \oooox $C = \interp{\judgeC[\restrictkind{\Delta, u:\omega}]{\restricttype{\Delta, u:\omega}}{c}{A}}\;\theta'\;\gamma'$ \\
    \oooox $Q = \semfun{v'}{\interp{\judgeA[\Delta, u:\omega]{q}{\assert}}\;(\delta',v')}$\\
    \oooox $\theta' = \restricttyenv{\Delta, u:\omega}{\delta'}$ \\
    \oooox $\gamma' = \restricttyenv{\Delta, u:\omega}{\delta'}$ \\
    \oooox $\theta = \restricttyenv{\Delta}{\delta}$ \\
    \oooox $\gamma = \restrictvals{\Delta}{\delta}$ \\
    \oooo We also know that $C = \interp{\judgeC[\restrictkind{\Delta}]{\restricttype{\Delta}}{c}{A}}\;\delta$ \\
    \oooo and that $Q = \semfun{v'}{\interp{\judgeA{q}{\assert}}\;(\delta,v')}$\\
    \oooo So now we must show for all $s \worldgeq r$, that $\basicspec{P * s}{C}{a}{Q(a) * s}$ holds\\
    \oooo Now assume $s$ such that $s \worldgeq r$ \\
    \ooooo We need for all $h \in \basicspec{P * s}{C}{a}{Q(a) * s}$, that 
             $C\;Best(\semfun{a}{Q(a) * s})\;h = \bot$ \\
    \ooooo We know $\spec{\exists u:\omega.\;p}{c}{a:A}{q}$ is valid \\
    \ooooo So we know for all $r$, that $r \in \spec{P'}{C}{a}{Q(a)}$ \\
    \oooox where $P' = \bigvee_{v \in \interp{\judgeSort{\omega}}\;\delta} \interp{\judgeA[\Delta, u:\omega]{p}{\assert}}\;(\delta, v)$ \\
    \ooooo Since $P = \interp{\judgeA[\Delta,u:\omega]{p}{\assert}}\;(\delta, v)$, we know $P \subseteq P'$ \\
    \ooooo Therefore $h \in P' * s$, and so $C\;Best(\semfun{a}{Q(a) * s})\;h = \bot$ \\
    
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Disjunction Rule)}
If $\judgeS{\spec{p}{c}{a:A}{q}}$ is valid and 
   $\judgeS{\spec{p'}{c}{a:A}{q'}}$ is valid, 
then $\judgeS{\spec{p \vee p'}{c}{a:A}{q \vee q'}}$ is valid. 
\end{lemma}

\begin{proof}
  \begin{tabbedproof}
    \oo Assume $\judgeS{\spec{p}{c}{a:A}{q}}$ is valid \\
    \oo Assume $\judgeS{\spec{p'}{c}{a:A}{q'}}$ is valid \\

    \oo Assume $\delta \in \interp{\judgeACtx{\Delta}}$ \\
    \ooo We want to show $\interp{\judgeS{\spec{p \vee p'}{c}{a:A}{q \vee q'}}}\delta = \top$ \\
    \ooo So we want to show $\forall r.\; r \in \interp{\judgeS{\spec{p \vee p'}{c}{a:A}{q \vee q'}}}\delta$ \\
    \ooo Assume $r$, \\
    \oooo So we want to show $r \in\interp{\judgeS{\spec{p \vee p'}{c}{a:A}{q \vee q'}}}\delta$ \\
    \oooo Let $\Theta = \restrictkind{\Delta}$ \\
    \oooo Let $\theta = \restricttyenv{\Delta}{\delta}$ \\
    \oooo Let $\Gamma = \restricttype{\Delta}$ \\
    \oooo Let $\gamma = \restrictvals{\Delta}{\delta}$ \\
    \oooo Let $P'' = \interp{\judgeA{p \vee p'}{\assert}}\;\delta$ \\
    \oooo Let $C = \interp{\judgeE{\Gamma}{[c]}{\monad{A}}}\;\theta\;\gamma$ \\
    \oooo Let $Q'' = \semfun{v}{\interp{\judgeA[\Delta,a:A]{q \vee q'}{\assert}}\;(\delta, v)}$ \\
    \oooo So we want to show $r \in \spec{P''}{C}{a:A}{Q''(a)}$ \\
    \oooo So we want to show $\forall s \sqsupseteq r.\; \basicspec{P'' * s}{C}{a:A}{Q''(a) * s}$ \\
    \oooo Assume $s \sqsupseteq r$ \\
    \ooooo We want to show $\basicspec{P'' * s}{C}{a:A}{Q''(a) * s}$ \\
    \ooooo We want to show $\forall h \in P'' * s.\; C\;Best(\semfun{a}{Q''(a) * s})\;h = \bot$ \\
    \ooooo Assume $h \in P'' * s$ \\
    \oooooo Therefore there are $h_1 \in P''$ and $h_2 \in s$ such that $h = h_1 \cdot h_2$ \\
    \oooooo We know $P'' = \interp{\judgeA{p \vee p'}{\assert}}\;\delta = 
                           \interp{\judgeA{p}{\assert}}\;\delta \vee 
                           \interp{\judgeA{p'}{\assert}}\;\delta$ \\ 
    \oooooo Call $P = \interp{\judgeA{p}{\assert}}\;\delta$ and $P' = \interp{\judgeA{p'}{\assert}}\;\delta$ \\
    \oooooo Call $Q = \interp{\judgeA{q}{\assert}}\;\delta$ and $Q' = \interp{\judgeA{q'}{\assert}}\;\delta$ \\
    \oooooo By the definition of $\vee$, we know that $h_1 \in P$ or $h_1 \in P'$ \\
    \oooooo Suppose $h_1 \in P$: \\
    \ooooooo We know by assumption that $\basicspec{P * s}{C}{a:A}{Q(a) * s}$ \\
    \ooooooo We know that $h = h_1 \cdot h_2 \in P * s$ \\
    \ooooooo Hence $C\;\mathit{Best}(\semfun{a}{Q(a) * s})\;h = \bot$ \\
    \ooooooo For any $a$, $Q(a) \subseteq Q''(a)$, \\
    \ooooooo Hence $\mathit{Best}(\semfun{a}{Q''(a) * s}) \sqsubseteq \mathit{Best}(\semfun{a}{Q(a) * s})$ \\ 
    \ooooooo Since $C$ is continuous, $C\;\mathit{Best}(\semfun{a}{Q''(a) * s})\;h = \bot$ \\
    \oooooo Suppose $h_1 \in P'$: \\
    \ooooooo We know by assumption that $\basicspec{P' * s}{C}{a:A}{Q(a) * s}$ \\
    \ooooooo We know that $h = h_1 \cdot h_2 \in P' * s$ \\
    \ooooooo Hence $C\;\mathit{Best}(\semfun{a}{Q'(a) * s})\;h = \bot$ \\
    \ooooooo For any $a$, $Q'(a) \subseteq Q''(a)$ \\
    \ooooooo Hence $\mathit{Best}(\semfun{a}{Q''(a) * s}) \sqsubseteq \mathit{Best}(\semfun{a}{Q'(a) * s})$ \\
    \ooooooo Since $C$ is continuous, $C\;\mathit{Best}(\semfun{a}{Q''(a) * s})\;h = \bot$ \\
  \end{tabbedproof}
\end{proof}

\begin{lemma}{(Equality Substitution)}
If $\judgeS{\setof{r} \specimp \spec{p}{c[e/x]}{a:A}{q}}$ is valid and
$\validP{r \implies e =_A e'}$ is valid, then $\judgeS{\setof{r} \specimp \spec{p}{c[e'/x]}{a:A}{q}}$ is valid.
\end{lemma}

\begin{proof}
This rule follows as a consequence of the restriction lemmas we proved earlier. 

\begin{tabbedproof}
\oo Assume $\judgeS{\setof{r} \specimp \spec{p}{c[e/x]}{a:A}{q}}$ is valid. \\
\ooo This is equivalent to assuming for all $\delta$ and $s$, if $s \in \interp{\setof{r}}\;\delta$, then $s \in \interp{\spec{p}{c[e/x]}{a:A}{q}}\;\delta$. \\
\ooo Assume $\delta$, $r$, and $s \in \interp{\setof{r}}\;\delta$ \\
\oooo Let \\
\oooox $C = \interp{c[e/x]}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta}$ \\
\oooox $C' = \interp{c[e'/x]}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta}$ \\
\oooox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
\oooox $Q = \semfun{v}{\interp{\judgeA[\Delta,a:A]{q}{\assert}}\;(\delta,v)}$ \\
\oooo Therefore we know that $R = \interp{r}\;\delta = \top = H$. \\
\oooo Therefore it follows that $\interp{\judgeA{e =_A e'}{\assert}}\;\delta = H$ \\
\oooo Therefore we know that $U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{A}}\;\restricttyenv{\Delta}{\delta})\;\restrictvals{\Delta}{\delta}$ equals \\
\ooox $U(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e'}{A}}\;\restricttyenv{\Delta}{\delta})\;\restrictvals{\Delta}{\delta}$ \\
\oooo By Lemma~\ref{value-restriction}, we know that 
$(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{A}}\;\restricttyenv{\Delta}{\delta})\;\restrictvals{\Delta}{\delta}$ equals \\
\ooox $(\interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e'}{A}}\;\restricttyenv{\Delta}{\delta})\;\restrictvals{\Delta}{\delta}$, using lambda-notation for CPO \\
\oooo Since substitution is sound, $\interp{c[e/x]}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta}  = \interp{c[e'/x]}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta}$, or $C = C'$\\
\oooo By hypothesis, $s \in \interp{\spec{p}{c[e/x]}{a:A}{q}}\;\delta$. \\
\oooo So for all $t \worldgeq s, h \in P * t$, we have $C\;\mathit{Best}(\semfun{v}{Q(v) * t})\;h = \bot$ \\
\oooo Since $C = C'$, we know for all $t \worldgeq s, h \in P * t$, we have $C'\;\mathit{Best}(\semfun{v}{Q(v) * t})\;h = \bot$ \\
\oooo Therefore, $s \in \interp{\spec{p}{c[e'/x]}{a:A}{q}}\;\delta$. \\
\end{tabbedproof}
\end{proof}

\begin{lemma}{(Case Analysis)}
  Suppose $\judgeS[\Delta,x:A]{\mspec{p \land e =_{A+B} \inl(x)}{e_A}{a:C}{q}}$ is valid,
      and $\judgeS[\Delta,y:B]{\mspec{p \land e =_{A+B} \inr(y)}{e_B}{a:C}{q}}$ is valid.

Then $\judgeS{\mspec{p}{\Case{e}{x}{e_A}{y}{e_B}}{a:C}{q}}$ is valid. 
\end{lemma}

\begin{proof}
\begin{tabbedproof}
\oo Assume $\judgeS[\Delta,x:A]{\mspec{p \land e =_{A+B} \inl(x)}{e_A}{a:C}{q}}$ is valid. \\
\oo Assume $\judgeS[\Delta,y:B]{\mspec{p \land e =_{A+B} \inr(y)}{e_B}{a:C}{q}}$ is valid. \\
\ooo We want to show $\judgeS{\mspec{p}{\Case{e}{x}{e_A}{y}{e_B}}{a:C}{q}}$ is valid. \\
\ooo So we want to show that for all $\delta, s$, $s \in \interp{\judgeS{\mspec{p}{\Case{e}{x}{e_A}{y}{e_B}}{a:C}{q}}}\;\delta$ \\
\ooo Assume $\delta$ and $s$, and $h \in P * s$, letting \\
\ooox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
\ooox $Q = \semfun{v}{\interp{\judgeA[\Delta, a:C]{p}{\assert}}\;(\delta,v)}$ \\
\ooox $C_A = \semfun{v}{\interp{\judgeE[\restrictkind{\Delta, x:A}]{\restricttype{\Delta, x:A}}{e_A}{\monad{C}}}\;\restricttyenv{\Delta,x:A}{(\delta,v)}\;\restrictvals{\Delta, x:A}{(\delta,v)}}$ \\
\ooox $C_B = \semfun{v}{\interp{\judgeE[\restrictkind{\Delta, y:B}]{\restricttype{\Delta, y:B}}{e_B}{\monad{C}}}\;\restricttyenv{\Delta,y:B}{(\delta,v)}\;\restrictvals{\Delta, y:B}{(\delta,v)}}$ \\
\ooox $E = \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{A+B}}\;\restricttyenv{\Delta}{\delta}\;\restrictvals{\Delta}{\delta}$ \\
\oooo We want to show $[C_A,C_B](E)\;\mathit{Best}(\semfun{v}{Q(v)*s})\;h = \bot$\\
\oooo Suppose $E = \inl(u)$ for some $u$: \\
\ooooo Then we want to show that $C_A\;u\;\mathit{Best}(\semfun{v}{Q(v)*s})\;h = \bot$\\
\ooooo We know $\judgeS[\Delta,x:A]{\mspec{p \land e =_{A+B} \inl(x)}{e_A}{a:C}{q}}$ is valid. \\
\ooooo So for all $h \in (P \land \interp{e =_{A+B} \inl(x)}\;(\delta,\inl(u))) * s$, $C_A\;u\;\mathit{Best}(\semfun{v}{Q(v)*s})\;h = \bot$\\
\ooooo Since $E=\inl(u)$, we know that $\top = \interp{\judgeA[\Delta,x:A]{e=_{A+B}\inl(x)}{\assert}}\;(\delta,\inl(u))$\\
\ooooo Since equality is pure, $h \in \interp{p \land e =_{A+B} \inl(x)}\;(\delta,\inl(u)) * s$ \\
\ooooo Therefore $C_A\;u\;\mathit{Best}(\semfun{v}{Q(v)*s})\;h = \bot$\\
\oooo Suppose $E = \inr(u)$ for some $u$:  \\
\ooooo Then we want to show that $C_B\;u\;\mathit{Best}(\semfun{v}{Q(v)*s})\;h = \bot$\\
\ooooo We know $\judgeS[\Delta,y:B]{\mspec{p \land e =_{A+B} \inr(x)}{e_A}{a:C}{q}}$ is valid. \\
\ooooo So for all $h \in (P \land \interp{e =_{A+B} \inr(x)}\;(\delta,\inr(u))) * s$, $C_B\;u\;\mathit{Best}(\semfun{v}{Q(v)*s})\;h = \bot$\\
\ooooo Since $E=\inr(u)$, we know that $\top = \interp{\judgeA[\Delta,y:B]{e=_{A+B}\inr(x)}{\assert}}\;(\delta,\inr(u))$\\
\ooooo Since equality is pure, $h \in \interp{p \land e =_{A+B} \inr(x)}\;(\delta,\inr(u)) * s$ \\
\ooooo Therefore $C_B\;u\;\mathit{Best}(\semfun{v}{Q(v)*s})\;h = \bot$\\

\end{tabbedproof}
\end{proof}

\begin{lemma}{(The Rule of Consequence)}
If $\judgeS{\spec{p}{c}{a:A}{q}}$ is valid and $\judgeA{p' \implies p}{\assert}$ is valid
and $\judgeA{q \implies q'}{\assert}$ is valid, then $\judgeS{\spec{p'}{c}{a:A}{q'}}$ is valid.
\end{lemma}
\begin{proof}
\begin{tabbedproof}
\oo Assume $\judgeS{\spec{p}{c}{a:A}{q}}$ is valid \\
\oo Assume $\judgeA{p' \implies p}{\assert}$ is valid \\
\oo Assume $\judgeA{q \implies q'}{\assert}$ is valid \\
\oo Assume $\delta \in \interp{\judgeACtx{\Delta}}$ \\
\ooo We want to show $\forall r.\; r \in \judgeS{\spec{p'}{c}{a:A}{q'}}$ \\
\ooo Assume $r$, and let \\
\ooox $\Theta = \restrictkind{\Delta}$ \\
\ooox $\theta = \restricttyenv{\Delta}{\delta}$ \\
\ooox $\Gamma = \restricttype{\Delta}$ \\
\ooox $\gamma = \restrictvals{\Delta}{\delta}$ \\
\ooox $P = \interp{\judgeA{p}{\assert}}\delta$ \\
\ooox $P' = \interp{\judgeA{p'}{\assert}}\delta$ \\
\ooox $C = \interp{\judgeC{\Gamma}{c}{A}}\;\theta\;\gamma$ \\
\ooox $Q = \semfun{v}{\interp{\judgeA[\Delta,a:A]{q}{\assert}}\;(\delta,v)}$ \\
\ooox $Q' = \semfun{v}{\interp{\judgeA[\Delta,a:A]{q}{\assert}}\;(\delta,v)}$ \\
\ooo We know $\interp{\judgeA{p' \implies p}{\assert}}\;\delta = P' \implies P$. \\
\ooo We know $\interp{\judgeA{q \implies q'}{\assert}}\;\delta = Q \implies Q'$. \\
\ooo So we want to show that $\forall s \sqsupseteq r.\; \basicspec{P' * s}{C}{a:A}{Q'(a) * s}$ \\
\ooo Assume $s \sqsupseteq r$, and $h \in P' * s$ \\
\oooo Hence $\exists$ $h_1$ and $h_2$ such that $h_1 \# h_2$ and $h = h_1 \cdot h_2$ 
     and $h_1 \in P'$ and $h_2 \in s$ \\
\oooo Since $P'$ is a subset of $P$, $h_1 \in P$. So $h \in P * s$ \\
\oooo Therefore $C\;\mathit{Best}(\semfun{a}{Q(a) * s})\;h = \bot$ \\
\oooo For any $a$, we know that $Q(a) \subseteq Q'(a)$ \\
\oooo Hence  we know that $\mathit{Best}(\semfun{a}{Q'(a) * s}) \sqsupseteq \mathit{Best}(\semfun{a}{Q(a) * s})$ \\
\oooo Hence by continuity, $C\;\mathit{Best}(\semfun{a}{Q'(a) * s})\;h = \bot$ \\
\ooo Hence $\forall s \sqsupseteq r.\; \basicspec{P' * s}{C}{a:A}{Q'(a) * s}$ \\
\ooo Hence $\forall r.\; r \in \interp{\judgeS{\spec{p'}{c}{a:A}{q'}}}\;\delta$ \\



\end{tabbedproof}
\end{proof}


\subsection{The Syntactic Frame Property}

We have defined a \emph{syntactic} frame operator $\Frame{S}{r}$ on
specifications.

\begin{displaymath}
  \begin{array}{lcl}
    \Frame{\spec{p}{c}{a:A}{q}}{r}    & = & \spec{p * r}{c}{a:A}{q * r} \\
    \Frame{\mspec{p}{c}{a:A}{q}}{r}   & = & \mspec{p * r}{c}{a:A}{q * r} \\
    \Frame{\setof{p}}{r}              & = & \setof{p} \\
    \Frame{(S_1 \specand S_2)}{r}      & = & \Frame{S_1}{r} \specand \Frame{S_2}{r} \\
    \Frame{(S_1 \specor S_2)}{r}       & = & \Frame{S_1}{r} \specor \Frame{S_2}{r} \\
    \Frame{(S_1 \specimp S_2)}{r}      & = & \Frame{S_1}{r} \specimp \Frame{S_2}{r} \\
    \Frame{(\forall x:\omega.\; S)}{r} & = & \forall x:\omega.\; (\Frame{S}{r}) \\
    \Frame{(\exists x:\omega.\; S)}{r} & = & \exists x:\omega.\; (\Frame{S}{r}) \\
  \end{array}
\end{displaymath}

\begin{prop*}{(Syntactic Well-Formedness of Frame Operator)}
If $\judgeS{S}$ and $\judgeA{p}{\assert}$, then
we define $\judgeS{\Frame{S}{p}}$.  
\end{prop*}
\begin{proof}
  By structural induction on specifications.
\end{proof}

More interesting than the syntactic well-formedness of the frame
operator is its semantic well-formedness. 

\begin{lemma*}{(Syntactic Framing is Semantic Framing)}
If $\judgeS{S}$ and $\judgeA{r}{\assert}$, then for all $\delta \in \interp{\Delta}$, 
$\interp{\judgeS{\Frame{S}{r}}}\;\delta = 
\Frame{\interp{\judgeS{S}}\;\delta}{\interp{\judgeA{r}{\assert}}\;\delta}$ \\
\end{lemma*}

\begin{proof}
  This proof proceeds by induction on the derivation of $S$. 

  \begin{itemize}
  \item Case \textsc{SpecTriple}: 
    \begin{tabbedproof}
      \oo We know $\judgeS{\spec{p}{c}{a:A}{q}}$ \\
      \oo By the semantics of triples, we know that 
          $\interp{\judgeS{\spec{p}{c}{a:A}{q}}}\;\delta = \spec{P}{C}{a}{Q(a)}$ \\ 
          % $\spec{p}[c}{a:A}{q}\;\delta = \spec{P}{C}{a}{Q(a)}$ \\
      \ox where \\
      \oox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
      \oox $C = \interp{\judgeC[\restrictkind{\Delta}]{\restricttype{\Delta}}{c}{A}}\;\theta\;\gamma$ \\
      \oox $Q = \semfun{v}{(\interp{\judgeA[\Delta, a:A]{q}{\assert}}\;(\delta, v))}$ \\
      \oox $\theta = \restricttyenv{\Delta}{\delta}$ \\
      \oox $\gamma = \restrictvals{\Delta}{\delta}$ \\
      \oo Now from the definition of syntactic framing, we know that $\Frame{S}{r} = \spec{p * r}{c}{a:A}{q(a) * r}$ \\
      \oo By semantics of triples, we know that \\
      \oox $\interp{\judgeS{\spec{p * r}{c}{a:A}{q * r}}}\;\delta = \spec{P * R}{C}{a}{Q(a) * R}$ \\ 
      \ox where $R = \interp{\judgeA{r}{\assert}}\;\delta$ \\
      \oo By lemma we know that $\spec{P * R}{C}{a}{Q(a) * R} = \Frame{\spec{P}{C}{a}{Q(a)}}{R}$ 
          semantically \\
      \oo Therefore $\interp{\judgeS{\Frame{\spec{p}{c}{a:A}{q}}{r}}}\;\delta = $ \\
      \oox $\Frame{\interp{\judgeS{\spec{p}{c}{a:A}{q}}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$
    \end{tabbedproof}

  \item Case \textsc{SpecMTriple}
    \begin{tabbedproof}
      \oo We know $\judgeS{\mspec{p}{e}{a:A}{q}}$ \\
      \oo By the semantics of triples, we know that 
          $\interp{\judgeS{\mspec{p}{e}{a:A}{q}}}\;\delta = \mspec{P}{E}{a}{Q(a)}$ \\ 
      \ox where \\
      \oox $P = \interp{\judgeA{p}{\assert}}\;\delta$ \\
      \oox $E = \interp{\judgeE[\restrictkind{\Delta}]{\restricttype{\Delta}}{e}{\monad{A}}}\;\theta\;\gamma$ \\
      \oox $Q = \semfun{v}{(\interp{\judgeA[\Delta, a:A]{q}{\assert}}\;(\delta, v))}$ \\
      \oox $\theta = \restricttyenv{\Delta}{\delta}$ \\
      \oox $\gamma = \restrictvals{\Delta}{\delta}$ \\
      \oo Now from the definition of syntactic framing, we know that $\Frame{S}{r} = \mspec{p * r}{e}{a:A}{q(a) * r}$ \\
      \oo By semantics of triples, we know that \\
      \oox $\interp{\judgeS{\mspec{p * r}{e}{a:A}{q * r}}}\;\delta = \mspec{P * R}{e}{a}{Q(a) * R}$ \\ 
      \ox where $R = \interp{\judgeA{r}{\assert}}\;\delta$ \\
      \oo By lemma we know that $\mspec{P * R}{E}{a}{Q(a) * R} = \Frame{\mspec{P}{E}{a}{Q(a)}}{R}$ 
          semantically \\
      \oo Therefore $\interp{\judgeS{\Frame{\mspec{p}{c}{a:A}{q}}{r}}}\;\delta = 
                     \Frame{\interp{\judgeS{\mspec{p}{c}{a:A}{q}}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$
    \end{tabbedproof}

    \item Case \textsc{SpecAssert}
      \begin{tabbedproof}
        \oo We know $\judgeS{\setof{p}}$ \\
        \oo So we also know that $\Frame{\setof{p}}{r} = \setof{p}$ \\
        \oo Therefore, $\interp{\judgeS{\setof{p}}}\;\delta$ is either $\top$ or $\bot$, depending on
            whether $\interp{\judgeA{p}{\assert}}\;\delta$ is $H$ or $\emptyset$ \\
        \oo Now, we will do a case analysis on the meaning of $\setof{p}$ \\
        \ooo If $\interp{\judgeS{\setof{p}}}\;\delta = \top$ \\
        \oooo Then, since $S \subseteq \Frame{S}{R}$ for all $S$ and $R$, and $\top$ is maximal, we know that \\
        \oooox $\top = \Frame{\top}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
        \oooo So $\interp{\judgeS{\Frame{\setof{p}}{r}}}\;\delta = \Frame{\interp{\judgeS{\setof{p}}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
        \ooo If $\interp{\judgeS{\setof{p}}}\;\delta = \bot$ \\
        \oooo Then, since $\bot$ is the empty set, and since $\Frame{S}{r} = \comprehend{p}{p * r \in S}$, \\
        \ooooo we know $\bot = \Frame{\bot}{\interp{\judgeA{r}{\assert}}\;\delta}$ \\
        \oooo  So we know $\interp{\judgeS{\Frame{\setof{p}}{r}}}\;\delta = \Frame{\interp{\judgeS{\setof{p}}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecBinary}
      \begin{tabbedproof}
        \oo We know $\judgeS{S_1 \otimes S_2}$, where $\oplus \in \setof{\specand, \specor, \specimp}$ \\
        \oo We also know that $\Frame{(S_1 \oplus S_2)}{r} = (\Frame{S_1}{r}) \oplus (\Frame{S_2}{r})$ \\
        \oo By the semantics, we know \\
        \oox $\interp{\judgeS{S_1 \oplus S_2}}\;\delta = \interp{\judgeS{S_1}}\;\delta \interp{\oplus} \; \interp{\judgeS{S_2}}\;\delta$ \\
        \oo By the semantics, we know that \\
        \oox $\interp{\judgeS{\Frame{(S_1 \oplus S_2)}{r}}}\;\delta = 
                                            (\interp{\judgeS{\Frame{S_1}{r}}}\;\delta) \interp{\oplus}
                                            (\interp{\judgeS{\Frame{S_2}{r}}}\;\delta)$ \\
        \oo By induction, we know $\interp{\judgeS{\Frame{S_1}{r}}}\;\delta = 
                                   \Frame{\interp{\judgeS{S_1}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
        \oo By induction, we know $\interp{\judgeS{\Frame{S_2}{r}}}\;\delta = 
                                   \Frame{\interp{\judgeS{S_2}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\

        \oo Therefore, we know $\interp{\judgeS{\Frame{(S_1 \oplus S_2)}{r}}}\;\delta = $ \\
        \oox                   $(\Frame{\interp{\judgeS{S_1}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}) 
                                 \interp{\oplus} 
                                (\Frame{\interp{\judgeS{S_2}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)})$ \\
        \oo Therefore we know $\interp{\judgeS{\Frame{(S_1 \oplus S_2)}{r}}}\;\delta = $ \\
        \oox $\Frame{(\interp{\judgeS{S_1}}\;\delta \;\interp{\oplus}\; \interp{\judgeS{S_2}}\;\delta)}
                    {(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
        \oo Therefore we know $\interp{\judgeS{\Frame{(S_1 \oplus S_2)}{r}}}\;\delta = $ \\
        \oox $\Frame{\interp{\judgeS{S_1 \oplus S_2}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
      \end{tabbedproof}

    \item Case \textsc{SpecQuantify}:
      \begin{tabbedproof}
        \oo We know $\judgeS{Q u:\omega.\; S}$, where $Q \in \setof{\forall, \exists}$ \\
        \oo We also know that $\Frame{(Q u:\omega.\; S)}{r} = Q u:\omega.\; (\Frame{S}{r})$ \\
        \oo By the semantics, we know that $\interp{\judgeS{Q u:\omega.\; (\Frame{S}{r)}}}\;\delta = $ \\
        \oox $\interp{Q}_{v \in \interp{\judgeSort{\omega}}\;\delta} \interp{\judgeS[\Delta, u:\omega]{\Frame{S}{r}}}\;(\delta, v)$\\
        \oo By induction, we know that for all appropriate $\delta'$, 
               $\interp{\judgeS[\Delta, u:\omega]{\Frame{S}{r}}}\;\delta' = $ \\
        \oox $\Frame{\interp{\judgeS[\Delta, u:\omega]{S}}\;\delta'}{\interp{\judgeA[\Delta, u:\omega]{r}{\assert}}\;\delta'}$ \\
        \oo Now, if $\delta' = (\delta, v)$, then $\interp{\judgeA[\Delta, u:\omega]{r}{\assert}}\;\delta' = 
                                                   \interp{\judgeA{r}{\assert}}\;\delta$ since $u \not\in \FV{r}$ \\
        \oo So we know $\interp{\judgeS{Q u:\omega.\; (\Frame{S}{r)}}}\;\delta = $ \\
        \oox $\interp{Q}_{v \in \interp{\judgeSort{\omega}}\;\delta} (\Frame{\interp{\judgeS[\Delta, u:\omega]{S}}\;(\delta,v)}{\interp{\judgeA{r}{\assert}}\;\delta})$ \\
        \oo Since framing distributes through meets, we know $\interp{\judgeS{Q u:\omega.\; (\Frame{S}{r)}}}\;\delta = $ \\
        \oox $\Frame{(\interp{Q}_{v \in \interp{\judgeSort{\omega}}\;\delta} \interp{\judgeS[\Delta, u:\omega]{S}}\;(\delta,v))}{\interp{\judgeA{r}{\assert}}\;\delta})$ \\
        \oo So we know $\interp{\judgeS{Q u:\omega.\; (\Frame{S}{r)}}}\;\delta = $ \\
        \oox $\Frame{\interp{\judgeS{Q u:\omega.\;S}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
        \oo So we know $\interp{\judgeS{\Frame{(Q u:\omega.\; S)}{r}}}\;\delta = $ \\
        \oox $\Frame{\interp{\judgeS{Q u:\omega.\;S}}\;\delta}{(\interp{\judgeA{r}{\assert}}\;\delta)}$ \\
        
      \end{tabbedproof}
  \end{itemize}
\end{proof}




